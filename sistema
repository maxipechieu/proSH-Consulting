<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Seguridad e Higiene - Argentina</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .module-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .module-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        .module-card .module-icon {
            transition: transform 0.4s ease;
            display: inline-block;
        }
        .module-card:hover .module-icon {
            transform: scale(1.15) rotate(8deg);
        }
        .hidden { display: none !important; }
        .risk-matrix {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 2px;
            background: #e5e7eb;
            max-width: 400px;
        }
        .risk-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 600;
        }
        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
            cursor: help;
            margin-left: 6px;
            position: relative;
        }
        .info-icon:hover {
            background: #2563eb;
        }
        .info-bubble {
            display: none;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 25px;
            background: #1e293b;
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: normal;
            width: 300px;
            max-width: 90vw;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            line-height: 1.5;
        }
        .info-bubble::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #1e293b;
        }
        .info-icon:hover .info-bubble {
            display: block;
        }
        .offline-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            z-index: 1000;
        }
        .signature-pad {
            border: 2px dashed #d1d5db;
            cursor: crosshair;
        }
        #inspectionModal {
            animation: fadeIn 0.3s ease-in-out;
        }
        #imageModal {
            animation: fadeIn 0.2s ease-in-out;
        }
        #imageModal img {
            animation: zoomIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes zoomIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        @media print {
            .no-print { display: none !important; }
        }
        
        /* Splash Screen Styles */
        #splashScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #06b6d4 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.5s ease-in-out;
            overflow: hidden;
        }
        
        #splashScreen.fade-out {
            animation: fadeOut 1s ease-in-out forwards;
        }
        
        /* Ocultar el contenido principal mientras se muestra el splash */
        body.splash-active {
            overflow: hidden;
            max-height: 100vh;
        }
        
        body.splash-active > *:not(#splashScreen) {
            visibility: hidden;
            opacity: 0;
        }
        
        .splash-logo {
            width: 140px;
            height: 140px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: scaleIn 0.8s ease-out;
            margin-bottom: 2rem;
        }
        
        .splash-logo i {
            font-size: 4rem;
            color: #1e40af;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .splash-content {
            text-align: center;
            color: white;
            animation: slideUp 1s ease-out;
            max-width: 600px;
            padding: 0 2rem;
            pointer-events: none;
            user-select: none;
        }
        
        .splash-title {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .splash-subtitle {
            font-size: 1.125rem;
            margin-bottom: 2rem;
            opacity: 0.95;
        }
        
        .splash-developer {
            font-size: 0.875rem;
            opacity: 0.9;
            margin-top: 2rem;
        }
        
        .splash-loading {
            margin-top: 2rem;
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }
        
        .splash-loading-dot {
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            animation: loadingDots 1.4s ease-in-out infinite;
        }
        
        .splash-loading-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .splash-loading-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes scaleIn {
            from {
                transform: scale(0);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }
        
        @keyframes loadingDots {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1.2);
                opacity: 1;
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
                visibility: hidden;
            }
        }
        
        /* Calendar Styles */
        .calendar-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            max-width: 900px;
            margin: 0 auto;
            overflow: hidden;
        }
        .calendar-header {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .calendar-title {
            color: white;
            font-size: 1.25rem;
            font-weight: 700;
        }
        .calendar-nav {
            display: flex;
            gap: 0.5rem;
        }
        .calendar-nav button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .calendar-nav button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e5e7eb;
            border: 1px solid #e5e7eb;
        }
        .calendar-day-header {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            padding: 0.75rem;
            text-align: center;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .calendar-day {
            background: white;
            min-height: 80px;
            padding: 0.5rem;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .calendar-day:hover {
            background: #f3f4f6;
            transform: scale(1.02);
        }
        .calendar-day.other-month {
            background: #f9fafb;
            color: #9ca3af;
        }
        .calendar-day.today {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border: 2px solid #3b82f6;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.4);
        }
        .calendar-day-number {
            font-weight: 700;
            font-size: 0.95rem;
            margin-bottom: 0.4rem;
            color: #1f2937;
        }
        .calendar-event {
            font-size: 0.65rem;
            padding: 2px 5px;
            margin-bottom: 2px;
            border-radius: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 600;
        }
        .calendar-event.expired {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            border-left: 3px solid #dc2626;
        }
        .calendar-event.warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
            border-left: 3px solid #f59e0b;
        }
        .calendar-event.upcoming {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e40af;
            border-left: 3px solid #3b82f6;
        }
        .calendar-event.training {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            border-left: 3px solid #10b981;
        }
        .calendar-event.extinguisher {
            background: linear-gradient(135deg, #fee2e2 0%, #fca5a5 100%);
            color: #7f1d1d;
            border-left: 3px solid #ef4444;
        }
        .calendar-more {
            font-size: 0.65rem;
            color: #6b7280;
            font-weight: 600;
            margin-top: 2px;
        }
        .calendar-legend {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            flex-wrap: wrap;
            border-top: 2px solid #e5e7eb;
            font-size: 0.75rem;
            background: #f9fafb;
        }
        .calendar-legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .calendar-legend-color {
            width: 18px;
            height: 18px;
            border-radius: 4px;
        }
        
        /* Calendar Collapsible Styles */
        .calendar-collapsible {
            transition: max-height 0.5s ease-in-out;
            overflow: hidden;
        }
        
        #toggleCalendarBtn {
            transition: all 0.3s ease;
        }
        
        #toggleCalendarBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        
        #toggleCalendarIcon {
            transition: transform 0.3s ease;
            display: inline-block;
        }
        
        /* ========== HEADER STICKY ========== */
        .main-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .header-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logo-icon {
            width: 48px;
            height: 48px;
            background: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .logo-text h1 {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
            margin: 0;
            line-height: 1.2;
        }
        
        .logo-text p {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.9);
            margin: 0;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .menu-toggle {
            display: none;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .menu-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* ========== SIDEBAR ========== */
        .sidebar {
            position: fixed;
            left: 0;
            top: 80px;
            width: 280px;
            height: calc(100vh - 80px);
            background: white;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            transition: transform 0.3s ease;
            z-index: 900;
        }
        
        .sidebar.closed {
            transform: translateX(-100%);
        }
        
        .sidebar-header {
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            border-bottom: 1px solid #d1d5db;
        }
        
        .sidebar-header h3 {
            font-size: 0.95rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }
        
        .sidebar-nav {
            padding: 1rem 0;
        }
        
        .sidebar-nav-item {
            display: flex;
            align-items: center;
            padding: 0.875rem 1.5rem;
            color: #4b5563;
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
            border-left: 4px solid transparent;
        }
        
        .sidebar-nav-item:hover {
            background: linear-gradient(90deg, #eff6ff 0%, #dbeafe 100%);
            border-left-color: #2563eb;
            color: #2563eb;
        }
        
        .sidebar-nav-item i {
            width: 24px;
            margin-right: 0.75rem;
            font-size: 1.1rem;
        }
        
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 80px;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 850;
        }
        
        .sidebar-overlay.active {
            display: block;
        }
        
        /* ========== MAIN CONTENT ========== */
        .main-content {
            margin-left: 280px;
            padding: 100px 2rem 2rem 2rem;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }
        
        .main-content.expanded {
            margin-left: 0;
        }
        
        /* ========== ESTABLISHMENT SELECTOR IN SIDEBAR ========== */
        .sidebar-establishment {
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-bottom: 2px solid #e5e7eb;
        }
        
        .sidebar-establishment label {
            display: block;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        
        .sidebar-establishment select {
            width: 100%;
            padding: 0.625rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.875rem;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .sidebar-establishment select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .sidebar-establishment p {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.5rem;
            margin-bottom: 0;
        }
        
        /* ========== CALENDAR TOGGLE ========== */
        .calendar-toggle-section {
            cursor: pointer;
            background: white;
            border-radius: 16px;
            padding: 1.5rem 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        
        .calendar-toggle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .calendar-toggle-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .calendar-toggle-title i {
            color: #2563eb;
        }
        
        .calendar-toggle-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #2563eb;
            color: #2563eb;
            background: white;
        }
        
        .calendar-toggle-btn:hover {
            background: #2563eb;
            color: white;
        }
        
        .calendar-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .calendar-content.expanded {
            max-height: 2000px;
            padding-top: 1.5rem;
            border-top: 2px solid #f3f4f6;
            margin-top: 1rem;
        }
        
        /* ========== RESPONSIVE ========== */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                height: 100vh !important;
                top: 0 !important;
                padding-top: 80px;
                overflow-y: auto;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .menu-toggle {
                display: block;
            }
        }
        
        @media (max-width: 768px) {
            .header-container {
                padding: 0.75rem 1rem;
            }
            
            .logo-text h1 {
                font-size: 1rem;
            }
            
            .logo-text p {
                display: none;
            }
            
            .main-content {
                padding: 90px 1rem 1rem 1rem;
            }
            
            /* Estilos para botones m√°s peque√±os en m√≥viles */
            button, .btn, input[type="submit"], input[type="button"] {
                font-size: 0.8rem !important;
                padding: 0.4rem 0.8rem !important;
                min-height: 32px;
            }
            
            /* Botones principales */
            .bg-blue-600, .bg-green-600, .bg-red-600, .bg-yellow-600, 
            .bg-purple-600, .bg-indigo-600, .bg-pink-600 {
                padding: 0.4rem 0.8rem !important;
                font-size: 0.75rem !important;
            }
            
            /* Iconos en botones */
            button i, .btn i {
                font-size: 0.9rem !important;
            }
            
            /* Calendario - navegaci√≥n */
            .calendar-nav button {
                width: 32px !important;
                height: 32px !important;
                font-size: 0.9rem !important;
            }
            
            .calendar-title {
                font-size: 1rem !important;
            }
            
            .calendar-header {
                padding: 1rem !important;
            }
            
            .calendar-day {
                min-height: 60px !important;
                padding: 0.3rem !important;
            }
            
            .calendar-day-number {
                font-size: 0.75rem !important;
            }
            
            .calendar-event {
                font-size: 0.55rem !important;
                padding: 1px 3px !important;
            }
            
            /* M√≥dulos principales */
            .module-card {
                padding: 1rem !important;
            }
            
            .module-card h3 {
                font-size: 0.95rem !important;
            }
            
            .module-icon {
                font-size: 1.5rem !important;
            }
            
            /* Formularios */
            input[type="text"], input[type="number"], input[type="date"], 
            input[type="email"], input[type="tel"], select, textarea {
                font-size: 0.85rem !important;
                padding: 0.4rem !important;
            }
            
            /* Tablas */
            table {
                font-size: 0.75rem !important;
            }
            
            th, td {
                padding: 0.4rem !important;
            }
            
            /* Modales */
            .modal-content {
                max-width: 95% !important;
                margin: 0.5rem !important;
            }
            
            /* Modal de Inspecci√≥n - Ajustes especiales para m√≥viles */
            #inspectionModal .bg-white.rounded-lg {
                max-height: 85vh !important;
                margin: 0.5rem !important;
            }
            
            #inspectionModal h2 {
                font-size: 1rem !important;
            }
            
            #inspectionModal .p-3 {
                padding: 0.75rem !important;
            }
            
            #inspectionModal button {
                font-size: 0.75rem !important;
                padding: 0.35rem 0.6rem !important;
            }
            
            #inspectionModal .text-2xl {
                font-size: 1.5rem !important;
            }
            
            /* Modal de Calendario de Eventos */
            #calendarEventsModal .bg-white.rounded-lg {
                max-height: 85vh !important;
                margin: 0.5rem !important;
            }
            
            /* Modal de Documentos */
            #documentModal .bg-white.rounded-lg {
                max-height: 85vh !important;
                margin: 0.5rem !important;
            }
            
            #documentModal h3 {
                font-size: 1rem !important;
            }
            
            /* T√≠tulos */
            h1 {
                font-size: 1.25rem !important;
            }
            
            h2 {
                font-size: 1.1rem !important;
            }
            
            h3 {
                font-size: 0.95rem !important;
            }
            
            /* Espaciado reducido */
            .space-y-6 > * + * {
                margin-top: 1rem !important;
            }
            
            .space-y-4 > * + * {
                margin-top: 0.75rem !important;
            }
            
            /* Grid responsive */
            .grid {
                gap: 0.75rem !important;
            }
            
            /* Contenido del modal de inspecci√≥n */
            #inspectionModal .text-lg {
                font-size: 0.9rem !important;
            }
            
            #inspectionModal .text-sm {
                font-size: 0.75rem !important;
            }
            
            #inspectionModal .text-base {
                font-size: 0.85rem !important;
            }
            
            #inspectionModal img {
                max-height: 150px !important;
            }
            
            #inspectionModal .space-y-4 > * + * {
                margin-top: 0.5rem !important;
            }
            
            #inspectionModal .space-y-2 > * + * {
                margin-top: 0.35rem !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50 splash-active">
    <!-- Splash Screen -->
    <div id="splashScreen">
        <div class="splash-logo">
            <i class="fas fa-shield-alt"></i>
        </div>
        
        <div class="splash-content">
            <h1 class="splash-title">Sistema de Seguridad e Higiene</h1>
            <p class="splash-subtitle">Gesti√≥n Integral seg√∫n Normativa Argentina</p>
            
            <div style="opacity: 0.85; font-size: 0.875rem; line-height: 1.6; margin-top: 2rem;">
                <p style="margin-bottom: 0.5rem;"><strong>Normativas:</strong> Ley 19.587 | Dec. 351/79 | Ley 24.557</p>
                <p>Resoluciones SRT 295/03, 905/15, 960/15 y m√°s</p>
            </div>
            
            <div class="splash-developer">
                <p style="font-weight: 600; margin-bottom: 0.25rem;">Desarrollado por Maximiliano Pechieu</p>
                <p style="opacity: 0.8;">T√©cnico en Seguridad y Salud Ocupacional</p>
            </div>
            
            <div class="splash-loading">
                <div class="splash-loading-dot"></div>
                <div class="splash-loading-dot"></div>
                <div class="splash-loading-dot"></div>
            </div>
        </div>
    </div>

    <!-- Offline Indicator -->
    <div id="offlineIndicator" class="offline-indicator bg-green-500 text-white">
        <i class="fas fa-bolt"></i> Modo Online
    </div>

    <!-- Main Container -->
    <div class="min-h-screen">
        <!-- ========== HEADER STICKY ========== -->
        <header class="main-header no-print">
            <div class="header-container">
                <div class="logo-section">
                    <button class="menu-toggle" onclick="toggleSidebar()" aria-label="Toggle menu">
                        <i class="fas fa-bars fa-lg"></i>
                    </button>
                    <div class="logo-icon">
                        <i class="fas fa-shield-alt" style="color: #2563eb;"></i>
                    </div>
                    <div class="logo-text">
                        <h1>Sistema de Seguridad e Higiene</h1>
                        <p>Ley 19.587 | Dec. 351/79 | Argentina</p>
                    </div>
                </div>
                <div class="header-actions">
                    <button onclick="showHome()" class="btn" style="background: rgba(255, 255, 255, 0.2); border: none; color: white; padding: 0.75rem 1.25rem; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                        <i class="fas fa-home"></i> Inicio
                    </button>
                </div>
            </div>
        </header>
        
        <!-- ========== SIDEBAR ========== -->
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
        <aside class="sidebar no-print" id="sidebar">
            <!-- Selector de Establecimiento -->
            <div class="sidebar-establishment">
                <label>
                    <i class="fas fa-building" style="margin-right: 0.5rem; color: #2563eb;"></i>
                    Seleccionar Establecimiento
                </label>
                <select id="establishmentSelect" onchange="loadEstablishment()">
                    <option value="">Todos los establecimientos...</option>
                </select>
                <p>
                    <i class="fas fa-filter" style="margin-right: 0.25rem;"></i>
                    Filtra: inspecciones, capacitaciones, EPP, etc.
                </p>
            </div>
            
            <nav class="sidebar-nav">
                <a class="sidebar-nav-item" onclick="showHome()">
                    <i class="fas fa-home"></i>
                    <span>P√°gina Principal</span>
                </a>
                <a class="sidebar-nav-item" onclick="showModule('checklist')">
                    <i class="fas fa-clipboard-check"></i>
                    <span>Checklist Inspecci√≥n</span>
                </a>
                <a class="sidebar-nav-item" onclick="showModule('actions')">
                    <i class="fas fa-tasks"></i>
                    <span>Gestor de Acciones</span>
                </a>
                <a class="sidebar-nav-item" onclick="showModule('fireload')">
                    <i class="fas fa-fire"></i>
                    <span>Carga de Fuego</span>
                </a>
                <a class="sidebar-nav-item" onclick="showModule('extinguishers')">
                    <i class="fas fa-fire-extinguisher"></i>
                    <span>Gesti√≥n de Extintores</span>
                </a>
                <a class="sidebar-nav-item" onclick="showModule('riskmatrix')">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Matriz de Riesgos</span>
                </a>
                <a class="sidebar-nav-item" onclick="showModule('training')">
                    <i class="fas fa-graduation-cap"></i>
                    <span>Capacitaciones</span>
                </a>
                <a class="sidebar-nav-item" onclick="showModule('incidents')">
                    <i class="fas fa-ambulance"></i>
                    <span>Incidentes</span>
                </a>
                <a class="sidebar-nav-item" onclick="showModule('ppe')">
                    <i class="fas fa-hard-hat"></i>
                    <span>EPP</span>
                </a>
                <a class="sidebar-nav-item" onclick="showModule('dashboard')">
                    <i class="fas fa-chart-line"></i>
                    <span>Dashboard KPI</span>
                </a>
                <a class="sidebar-nav-item" onclick="showModule('documents')">
                    <i class="fas fa-folder-open"></i>
                    <span>Gesti√≥n Documental</span>
                </a>
                <a class="sidebar-nav-item" onclick="showModule('rgrl')">
                    <i class="fas fa-file-alt"></i>
                    <span>RGRL - Formulario A</span>
                </a>
                <a class="sidebar-nav-item" onclick="showModule('rgrlObras')">
                    <i class="fas fa-hard-hat"></i>
                    <span>RGRL - Form. B (Obras)</span>
                </a>
                
                <!-- Herramientas Adicionales -->
                <div style="padding: 1rem 1.5rem; background: #f9fafb; margin-top: 1rem;">
                    <p style="font-size: 0.75rem; font-weight: 700; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">Herramientas</p>
                </div>
                <a class="sidebar-nav-item" onclick="showModule('jsa')">
                    <i class="fas fa-file-signature"></i>
                    <span>JSA / Permisos</span>
                </a>
                <a class="sidebar-nav-item" onclick="showModule('sds')">
                    <i class="fas fa-flask"></i>
                    <span>Qu√≠micos/SDS</span>
                </a>
                <a class="sidebar-nav-item" onclick="showModule('environmental')">
                    <i class="fas fa-thermometer-half"></i>
                    <span>Mediciones Ambientales</span>
                </a>
                <a class="sidebar-nav-item" onclick="showModule('evacuation')">
                    <i class="fas fa-door-open"></i>
                    <span>Plan de Evacuaci√≥n</span>
                </a>
                <a class="sidebar-nav-item" onclick="showModule('contractors')">
                    <i class="fas fa-user-tie"></i>
                    <span>Contratistas</span>
                </a>
                <a class="sidebar-nav-item" onclick="showModule('maintenance')">
                    <i class="fas fa-wrench"></i>
                    <span>Mantenimiento</span>
                </a>
                <a class="sidebar-nav-item" onclick="showModule('medical')">
                    <i class="fas fa-heartbeat"></i>
                    <span>Vigilancia de Salud</span>
                </a>
                <a class="sidebar-nav-item" onclick="showModule('niosh')">
                    <i class="fas fa-weight"></i>
                    <span>NIOSH</span>
                </a>
                <a class="sidebar-nav-item" onclick="showModule('vehicles')">
                    <i class="fas fa-truck"></i>
                    <span>Veh√≠culos</span>
                </a>
                <a class="sidebar-nav-item" onclick="showModule('machinery')">
                    <i class="fas fa-cogs"></i>
                    <span>Maquinaria</span>
                </a>
                <a class="sidebar-nav-item" onclick="showModule('datamanagement')">
                    <i class="fas fa-database"></i>
                    <span>Gesti√≥n de Datos</span>
                </a>
                
                <!-- Acerca de -->
                <div style="padding: 1rem 1.5rem; background: #f9fafb; margin-top: 1rem;">
                    <p style="font-size: 0.75rem; font-weight: 700; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">Informaci√≥n</p>
                </div>
                <a class="sidebar-nav-item" onclick="showModule('about')">
                    <i class="fas fa-info-circle"></i>
                    <span>Acerca de</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- Home View -->
            <div id="homeView" class="space-y-8">
                <!-- Calendar Widget -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-calendar-alt text-blue-600"></i> Calendario de Vencimientos y Eventos</h2>
                            <p class="text-sm text-gray-600 mt-1">Vencimientos, inspecciones y capacitaciones de todos los establecimientos</p>
                        </div>
                        <button onclick="toggleMainCalendar()" id="toggleCalendarBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition flex items-center gap-2">
                            <span id="toggleCalendarIcon">‚ñº</span>
                            <span id="toggleCalendarText">Mostrar Calendario</span>
                        </button>
                    </div>
                    
                    <!-- Contenido del Calendario (colapsable) -->
                    <div id="mainCalendarContent" class="calendar-collapsible" style="max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out;">
                        <div class="flex items-center justify-center gap-4 mb-4">
                            <button onclick="mainCalendarPreviousMonth()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                                ‚Üê Anterior
                            </button>
                            <button onclick="mainCalendarToday()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                                Hoy
                            </button>
                            <button onclick="mainCalendarNextMonth()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                                Siguiente ‚Üí
                            </button>
                        </div>
                        
                        <h3 id="mainCalendarMonthYear" class="text-xl font-bold text-center mb-4"></h3>
                        
                        <!-- Headers de d√≠as -->
                        <div class="grid grid-cols-7 gap-1 mb-1">
                            <div class="text-center font-bold text-sm text-gray-700 bg-blue-100 p-2 rounded">Dom</div>
                            <div class="text-center font-bold text-sm text-gray-700 bg-blue-100 p-2 rounded">Lun</div>
                            <div class="text-center font-bold text-sm text-gray-700 bg-blue-100 p-2 rounded">Mar</div>
                            <div class="text-center font-bold text-sm text-gray-700 bg-blue-100 p-2 rounded">Mi√©</div>
                            <div class="text-center font-bold text-sm text-gray-700 bg-blue-100 p-2 rounded">Jue</div>
                            <div class="text-center font-bold text-sm text-gray-700 bg-blue-100 p-2 rounded">Vie</div>
                            <div class="text-center font-bold text-sm text-gray-700 bg-blue-100 p-2 rounded">S√°b</div>
                        </div>
                        
                        <!-- Grid del Calendario -->
                        <div id="mainCalendarDays" class="grid grid-cols-7 gap-1"></div>
                        
                        <!-- Leyenda -->
                        <div class="mt-4 flex flex-wrap gap-4 text-sm">
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-red-500 rounded"></div>
                                <span>Vencido</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-yellow-400 rounded"></div>
                                <span>Por vencer (30 d√≠as)</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-green-400 rounded"></div>
                                <span>Capacitaci√≥n</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-purple-400 rounded"></div>
                                <span>Inspecci√≥n</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-blue-400 rounded"></div>
                                <span>D√≠a actual</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Establishment Selector -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4"><i class="fas fa-building text-blue-600"></i> Establecimiento Actual</h2>
                    <div class="bg-blue-50 p-4 rounded-lg mb-4">
                        <p class="text-sm text-gray-700">
                            <i class="fas fa-info-circle text-blue-600"></i>
                            Selecciona un establecimiento en el <strong>men√∫ lateral izquierdo</strong> para filtrar toda la informaci√≥n del sistema.
                        </p>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="showNewEstablishment()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition flex-1">
                            <i class="fas fa-plus-circle"></i> Nuevo Establecimiento
                        </button>
                    </div>
                    <div id="currentEstablishment" class="mt-4 p-4 bg-blue-50 rounded-lg hidden">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-bold text-lg">Datos del Establecimiento</h3>
                            <div class="flex gap-2">
                                <button onclick="editEstablishment()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm font-semibold transition">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button onclick="deleteEstablishment()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm font-semibold transition">
                                    üóëÔ∏è Eliminar
                                </button>
                                <button onclick="exportEstablishmentSummary()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm font-semibold transition">
                                    <i class="fas fa-file-export"></i> Exportar Resumen
                                </button>
                            </div>
                        </div>
                        <div id="establishmentDetails" class="grid md:grid-cols-2 gap-2 text-sm"></div>
                    </div>
                </div>

                <!-- Modules Grid -->
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Module 1: Checklist -->
                    <div class="module-card bg-white rounded-lg shadow-md p-6 border-t-4 border-blue-600" onclick="showModule('checklist')">
                        <div class="text-4xl mb-3 module-icon"><i class="fas fa-clipboard-check text-blue-600"></i></div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Checklist de Inspecci√≥n</h3>
                        <p class="text-gray-600 text-sm">Inspecciones por zonas con fotos y plan de acci√≥n</p>
                    </div>

                    <!-- Module 2: Actions -->
                    <div class="module-card bg-white rounded-lg shadow-md p-6 border-t-4 border-orange-600" onclick="showModule('actions')">
                        <div class="text-4xl mb-3 module-icon"><i class="fas fa-tasks text-orange-600"></i></div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Gestor de Acciones</h3>
                        <p class="text-gray-600 text-sm">Seguimiento de hallazgos y tareas correctivas</p>
                    </div>

                    <!-- Module 3: Fire Load -->
                    <div class="module-card bg-white rounded-lg shadow-md p-6 border-t-4 border-red-600" onclick="showModule('fireload')">
                        <div class="text-4xl mb-3 module-icon"><i class="fas fa-fire text-red-600"></i></div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Carga de Fuego</h3>
                        <p class="text-gray-600 text-sm">Calculadora MJ/m¬≤ y clasificaci√≥n de riesgo</p>
                    </div>

                    <!-- Module 4: Extinguishers -->
                    <div class="module-card bg-white rounded-lg shadow-md p-6 border-t-4 border-red-700" onclick="showModule('extinguishers')">
                        <div class="text-4xl mb-3 module-icon"><i class="fas fa-fire-extinguisher text-red-700"></i></div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Gesti√≥n de Extintores</h3>
                        <p class="text-gray-600 text-sm">Inventario y planificaci√≥n de mantenimiento</p>
                    </div>

                    <!-- Module 5: Risk Matrix -->
                    <div class="module-card bg-white rounded-lg shadow-md p-6 border-t-4 border-yellow-600" onclick="showModule('riskmatrix')">
                        <div class="text-4xl mb-3 module-icon"><i class="fas fa-exclamation-triangle text-yellow-600"></i></div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Matriz de Riesgos</h3>
                        <p class="text-gray-600 text-sm">Evaluaci√≥n probabilidad √ó severidad</p>
                    </div>

                    <!-- Module 6: Training -->
                    <div class="module-card bg-white rounded-lg shadow-md p-6 border-t-4 border-green-600" onclick="showModule('training')">
                        <div class="text-4xl mb-3 module-icon"><i class="fas fa-graduation-cap text-green-600"></i></div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Capacitaciones</h3>
                        <p class="text-gray-600 text-sm">Registro y certificados de formaci√≥n</p>
                    </div>

                    <!-- Module 7: Incidents -->
                    <div class="module-card bg-white rounded-lg shadow-md p-6 border-t-4 border-purple-600" onclick="showModule('incidents')">
                        <div class="text-4xl mb-3 module-icon"><i class="fas fa-ambulance text-purple-600"></i></div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Incidentes</h3>
                        <p class="text-gray-600 text-sm">Registro e investigaci√≥n de eventos</p>
                    </div>

                    <!-- Module 8: PPE -->
                    <div class="module-card bg-white rounded-lg shadow-md p-6 border-t-4 border-indigo-600" onclick="showModule('ppe')">
                        <div class="text-4xl mb-3 module-icon"><i class="fas fa-hard-hat text-indigo-600"></i></div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">EPP</h3>
                        <p class="text-gray-600 text-sm">Inventario y entregas de equipos</p>
                    </div>

                    <!-- Module 9: KPI Dashboard -->
                    <div class="module-card bg-white rounded-lg shadow-md p-6 border-t-4 border-cyan-600" onclick="showModule('dashboard')">
                        <div class="text-4xl mb-3 module-icon"><i class="fas fa-chart-line text-cyan-600"></i></div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Dashboard KPI</h3>
                        <p class="text-gray-600 text-sm">Indicadores y reportes para direcci√≥n</p>
                    </div>

                    <!-- Module 10: Document Management -->
                    <div class="module-card bg-white rounded-lg shadow-md p-6 border-t-4 border-teal-600" onclick="showModule('documents')">
                        <div class="text-4xl mb-3 module-icon"><i class="fas fa-folder-open text-teal-600"></i></div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Gesti√≥n Documental</h3>
                        <p class="text-gray-600 text-sm">Control de documentaci√≥n obligatoria y habilitaciones</p>
                    </div>

                    <!-- Module 11: RGRL -->
                    <div class="module-card bg-white rounded-lg shadow-md p-6 border-t-4 border-indigo-600" onclick="showModule('rgrl')">
                        <div class="text-4xl mb-3 module-icon"><i class="fas fa-file-alt text-indigo-600"></i></div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">RGRL - Formulario A</h3>
                        <p class="text-gray-600 text-sm">Relevamiento General de Riesgos Laborales</p>
                    </div>

                    <!-- Module 12: RGRL Obras -->
                    <div class="module-card bg-white rounded-lg shadow-md p-6 border-t-4 border-yellow-700" onclick="showModule('rgrlObras')">
                        <div class="text-4xl mb-3 module-icon"><i class="fas fa-hard-hat text-yellow-700"></i></div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">RGRL - Formulario B (Obras)</h3>
                        <p class="text-gray-600 text-sm">Relevamiento para Obras de Construcci√≥n</p>
                    </div>
                </div>

                <!-- Additional Tools Section -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4"><i class="fas fa-toolbox text-gray-700"></i> Herramientas Adicionales</h2>
                    <div class="grid md:grid-cols-3 lg:grid-cols-4 gap-3">
                        <button onclick="showModule('jsa')" class="bg-gray-100 hover:bg-gray-200 p-3 rounded-lg text-left transition">
                            <div class="font-semibold"><i class="fas fa-file-signature text-blue-600"></i> JSA / Permisos</div>
                            <div class="text-xs text-gray-600">An√°lisis de trabajos</div>
                        </button>
                        <button onclick="showModule('sds')" class="bg-gray-100 hover:bg-gray-200 p-3 rounded-lg text-left transition">
                            <div class="font-semibold"><i class="fas fa-flask text-purple-600"></i> Qu√≠micos/SDS</div>
                            <div class="text-xs text-gray-600">Fichas de seguridad</div>
                        </button>
                        <button onclick="showModule('environmental')" class="bg-gray-100 hover:bg-gray-200 p-3 rounded-lg text-left transition">
                            <div class="font-semibold"><i class="fas fa-thermometer-half text-red-600"></i> Mediciones</div>
                            <div class="text-xs text-gray-600">Monitoreo ambiental</div>
                        </button>
                        <button onclick="showModule('evacuation')" class="bg-gray-100 hover:bg-gray-200 p-3 rounded-lg text-left transition">
                            <div class="font-semibold"><i class="fas fa-door-open text-green-600"></i> Evacuaci√≥n</div>
                            <div class="text-xs text-gray-600">Plan y simulacros</div>
                        </button>
                        <button onclick="showModule('contractors')" class="bg-gray-100 hover:bg-gray-200 p-3 rounded-lg text-left transition">
                            <div class="font-semibold"><i class="fas fa-user-tie text-indigo-600"></i> Contratistas</div>
                            <div class="text-xs text-gray-600">Permisos de ingreso</div>
                        </button>
                        <button onclick="showModule('maintenance')" class="bg-gray-100 hover:bg-gray-200 p-3 rounded-lg text-left transition">
                            <div class="font-semibold"><i class="fas fa-wrench text-orange-600"></i> Mantenimiento</div>
                            <div class="text-xs text-gray-600">Cronograma preventivo</div>
                        </button>
                        <button onclick="showModule('medical')" class="bg-gray-100 hover:bg-gray-200 p-3 rounded-lg text-left transition">
                            <div class="font-semibold"><i class="fas fa-heartbeat text-red-600"></i> Vigilancia Salud</div>
                            <div class="text-xs text-gray-600">Ex√°menes m√©dicos</div>
                        </button>
                        <button onclick="showModule('niosh')" class="bg-gray-100 hover:bg-gray-200 p-3 rounded-lg text-left transition">
                            <div class="font-semibold"><i class="fas fa-weight text-gray-700"></i> NIOSH</div>
                            <div class="text-xs text-gray-600">Levantamiento manual</div>
                        </button>
                        <button onclick="showModule('vehicles')" class="bg-gray-100 hover:bg-gray-200 p-3 rounded-lg text-left transition">
                            <div class="font-semibold"><i class="fas fa-truck text-blue-600"></i> Movilidades</div>
                            <div class="text-xs text-gray-600">Gesti√≥n de veh√≠culos</div>
                        </button>
                        <button onclick="showModule('machinery')" class="bg-gray-100 hover:bg-gray-200 p-3 rounded-lg text-left transition">
                            <div class="font-semibold"><i class="fas fa-cogs text-gray-700"></i> Maquinarias</div>
                            <div class="text-xs text-gray-600">Control de equipos</div>
                        </button>
                        <button onclick="showModule('datamanagement')" class="bg-gray-100 hover:bg-gray-200 p-3 rounded-lg text-left transition">
                            <div class="font-semibold"><i class="fas fa-database text-cyan-600"></i> Gesti√≥n de Datos</div>
                            <div class="text-xs text-gray-600">Exportar/Importar</div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- New Establishment Form -->
            <div id="newEstablishmentView" class="hidden">
                <div class="bg-white rounded-lg shadow-md p-6 max-w-3xl mx-auto">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6"><i class="fas fa-plus-circle text-blue-600"></i> Nuevo Establecimiento</h2>
                    <form id="establishmentForm" onsubmit="saveEstablishment(event)" class="space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">Nombre *</label>
                                <input type="text" name="nombre" required class="border border-gray-300 rounded-lg p-3 w-full">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">CUIT *</label>
                                <input type="text" name="cuit" required placeholder="XX-XXXXXXXX-X" class="border border-gray-300 rounded-lg p-3 w-full">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-semibold mb-2">Direcci√≥n *</label>
                                <input type="text" name="direccion" required class="border border-gray-300 rounded-lg p-3 w-full">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Actividad *</label>
                                <input type="text" name="actividad" required class="border border-gray-300 rounded-lg p-3 w-full">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Superficie (m¬≤) *</label>
                                <input type="number" name="superficie_m2" required min="1" class="border border-gray-300 rounded-lg p-3 w-full">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">N√∫mero de Empleados</label>
                                <input type="number" name="empleados" min="0" class="border border-gray-300 rounded-lg p-3 w-full">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Tel√©fono de Contacto</label>
                                <input type="tel" name="telefono" placeholder="Ej: +54 264 123-4567" class="border border-gray-300 rounded-lg p-3 w-full">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-semibold mb-2">Email de Contacto</label>
                                <input type="email" name="email" placeholder="contacto@empresa.com" class="border border-gray-300 rounded-lg p-3 w-full">
                            </div>
                            <div class="md:col-span-2">
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" name="obra_construccion" class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <span class="text-sm font-semibold text-gray-700"><i class="fas fa-hard-hat text-orange-600"></i> Este establecimiento es una obra en construcci√≥n</span>
                                </label>
                                <p class="text-xs text-gray-500 mt-1 ml-7">Marque esta opci√≥n si el establecimiento es una obra en construcci√≥n temporal (Res. SRT 51/97, 231/96)</p>
                            </div>
                        </div>
                        <div class="flex gap-3 pt-4">
                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold flex-1 transition">
                                <i class="fas fa-save"></i> Guardar Establecimiento
                            </button>
                            <button type="button" onclick="showHome()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-semibold transition">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Edit Establishment Form -->
            <div id="editEstablishmentView" class="hidden">
                <div class="bg-white rounded-lg shadow-md p-6 max-w-3xl mx-auto">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">‚úèÔ∏è Editar Establecimiento</h2>
                    <form id="editEstablishmentForm" onsubmit="updateEstablishment(event)" class="space-y-4">
                        <input type="hidden" name="establishment_index" id="editEstablishmentIndex">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">Nombre *</label>
                                <input type="text" name="nombre" id="editNombre" required class="border border-gray-300 rounded-lg p-3 w-full">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">CUIT *</label>
                                <input type="text" name="cuit" id="editCuit" required placeholder="XX-XXXXXXXX-X" class="border border-gray-300 rounded-lg p-3 w-full">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-semibold mb-2">Direcci√≥n *</label>
                                <input type="text" name="direccion" id="editDireccion" required class="border border-gray-300 rounded-lg p-3 w-full">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Actividad *</label>
                                <input type="text" name="actividad" id="editActividad" required class="border border-gray-300 rounded-lg p-3 w-full">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Superficie (m¬≤) *</label>
                                <input type="number" name="superficie_m2" id="editSuperficie" required min="1" class="border border-gray-300 rounded-lg p-3 w-full">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">N√∫mero de Empleados</label>
                                <input type="number" name="empleados" id="editEmpleados" min="0" class="border border-gray-300 rounded-lg p-3 w-full">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Tel√©fono de Contacto</label>
                                <input type="tel" name="telefono" id="editTelefono" placeholder="Ej: +54 264 123-4567" class="border border-gray-300 rounded-lg p-3 w-full">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-semibold mb-2">Email de Contacto</label>
                                <input type="email" name="email" id="editEmail" placeholder="contacto@empresa.com" class="border border-gray-300 rounded-lg p-3 w-full">
                            </div>
                            <div class="md:col-span-2">
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" name="obra_construccion" id="editObraConstruccion" class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <span class="text-sm font-semibold text-gray-700"><i class="fas fa-hard-hat text-orange-600"></i> Este establecimiento es una obra en construcci√≥n</span>
                                </label>
                                <p class="text-xs text-gray-500 mt-1 ml-7">Marque esta opci√≥n si el establecimiento es una obra en construcci√≥n temporal (Res. SRT 51/97, 231/96)</p>
                            </div>
                        </div>
                        <div class="flex gap-3 pt-4">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold flex-1 transition">
                                <i class="fas fa-save"></i> Actualizar Establecimiento
                            </button>
                            <button type="button" onclick="showHome()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-semibold transition">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Checklist Module -->
            <div id="checklistView" class="hidden">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-clipboard-check text-blue-600"></i> Checklist de Inspecci√≥n</h2>
                        <div class="flex gap-2">
                            <button onclick="toggleChecklistForm()" id="newChecklistBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                                <i class="fas fa-plus-circle"></i> Nuevo Relevamiento
                            </button>
                            <button onclick="generateChecklistPDF()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                                <i class="fas fa-file-pdf"></i> Generar PDF
                            </button>
                        </div>
                    </div>
                    
                    <form id="checklistForm" class="space-y-6 hidden">
                        <!-- Inspector Info -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-bold text-lg mb-3">Inspector</h3>
                            <div class="grid md:grid-cols-3 gap-4">
                                <input type="text" id="inspectorName" placeholder="Nombre completo *" required class="border border-gray-300 rounded-lg p-3">
                                <input type="text" id="inspectorMatricula" placeholder="Matr√≠cula" class="border border-gray-300 rounded-lg p-3">
                                <input type="date" id="inspectionDate" required class="border border-gray-300 rounded-lg p-3">
                            </div>
                        </div>

                        <!-- Sector Selection -->
                        <div>
                            <label class="block text-sm font-semibold mb-2">Sector/Zona *</label>
                            <input type="text" id="checklistSector" required placeholder="Ej: Dep√≥sito, Oficinas, Producci√≥n" class="border border-gray-300 rounded-lg p-3 w-full">
                        </div>

                        <!-- Checklist Categories -->
                        <div id="checklistCategories"></div>

                        <button type="button" onclick="saveChecklist()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold w-full transition">
                            <i class="fas fa-save"></i> Guardar Inspecci√≥n
                        </button>
                    </form>
                </div>

                <!-- Inspection History -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">üìö Historial de Inspecciones</h3>
                    <div id="inspectionHistory" class="space-y-3"></div>
                </div>
            </div>

            <!-- Actions Module -->
            <div id="actionsView" class="hidden">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-tasks text-orange-600"></i> Gestor de Acciones</h2>
                        <div class="flex gap-2">
                            <button onclick="exportActionsPDF()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                                <i class="fas fa-file-pdf"></i> Exportar PDF
                            </button>
                            <button onclick="showNewAction()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                                <i class="fas fa-plus-circle"></i> Nueva Acci√≥n
                            </button>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="grid md:grid-cols-4 gap-3 mb-6">
                        <select id="actionFilterStatus" onchange="filterActions()" class="border border-gray-300 rounded-lg p-2">
                            <option value="">Todos los estados</option>
                            <option value="pendiente">Pendiente</option>
                            <option value="en_progreso">En Progreso</option>
                            <option value="cerrado">Cerrado</option>
                        </select>
                        <select id="actionFilterPriority" onchange="filterActions()" class="border border-gray-300 rounded-lg p-2">
                            <option value="">Todas las prioridades</option>
                            <option value="Alta">Alta</option>
                            <option value="Media">Media</option>
                            <option value="Baja">Baja</option>
                        </select>
                        <input type="text" id="actionSearch" onkeyup="filterActions()" placeholder="Buscar..." class="border border-gray-300 rounded-lg p-2">
                        <button onclick="exportActionsCSV()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                            <i class="fas fa-file-export"></i> Exportar CSV
                        </button>
                    </div>

                    <!-- Actions List -->
                    <div id="actionsList" class="space-y-3"></div>
                </div>

                <!-- New Action Form -->
                <div id="newActionForm" class="hidden bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Nueva Acci√≥n Correctiva</h3>
                    <form onsubmit="saveAction(event)" class="space-y-4">
                        <input type="text" name="titulo" required placeholder="T√≠tulo *" class="border border-gray-300 rounded-lg p-3 w-full">
                        <textarea name="descripcion" required placeholder="Descripci√≥n *" rows="3" class="border border-gray-300 rounded-lg p-3 w-full"></textarea>
                        <div class="grid md:grid-cols-3 gap-4">
                            <select name="prioridad" required class="border border-gray-300 rounded-lg p-3">
                                <option value="">Prioridad *</option>
                                <option value="Alta">Alta</option>
                                <option value="Media">Media</option>
                                <option value="Baja">Baja</option>
                            </select>
                            <input type="text" name="sector" placeholder="Sector" class="border border-gray-300 rounded-lg p-3">
                            <input type="text" name="responsable" required placeholder="Responsable *" class="border border-gray-300 rounded-lg p-3">
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <input type="date" name="vencimiento" required class="border border-gray-300 rounded-lg p-3">
                            <select name="estado" class="border border-gray-300 rounded-lg p-3">
                                <option value="pendiente">Pendiente</option>
                                <option value="en_progreso">En Progreso</option>
                            </select>
                        </div>
                        <div class="flex gap-3">
                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold flex-1 transition">
                                <i class="fas fa-save"></i> Guardar Acci√≥n
                            </button>
                            <button type="button" onclick="cancelNewAction()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-semibold transition">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Fire Load Module -->
            <div id="fireloadView" class="hidden">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6"><i class="fas fa-fire text-red-600"></i> Calculadora de Carga de Fuego</h2>
                    
                    <div class="bg-blue-50 border-l-4 border-blue-600 p-4 mb-6">
                        <p class="text-sm"><strong>Nota:</strong> Los valores de PCI son aproximados. Confirmar con SDS y normativa IRAM correspondiente.</p>
                    </div>

                    <form id="fireLoadForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-semibold mb-2">√Årea del Sector (m¬≤) *</label>
                            <input type="number" id="fireLoadArea" required min="1" step="0.01" class="border border-gray-300 rounded-lg p-3 w-full md:w-64">
                        </div>

                        <div>
                            <h3 class="font-bold text-lg mb-3">Materiales Combustibles</h3>
                            <div id="fireLoadMaterials"></div>
                            <button type="button" onclick="addFireLoadMaterial()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold mt-3 transition">
                                <i class="fas fa-plus-circle"></i> Agregar Material
                            </button>
                        </div>

                        <button type="button" onclick="calculateFireLoad()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition">
                            <i class="fas fa-microscope"></i> Calcular Carga de Fuego
                        </button>
                    </form>

                    <div id="fireLoadResults" class="hidden mt-6 p-6 bg-gray-50 rounded-lg"></div>
                </div>
            </div>

            <!-- Extinguishers Module -->
            <div id="extinguishersView" class="hidden">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-fire-extinguisher text-red-700"></i> Gesti√≥n de Extintores</h2>
                        <div class="flex gap-2">
                            <button onclick="exportExtinguishersReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                                <i class="fas fa-file-pdf"></i> Exportar Informe
                            </button>
                            <button onclick="showNewExtinguisher()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                                <i class="fas fa-plus-circle"></i> Nuevo Extintor
                            </button>
                        </div>
                    </div>

                    <!-- Calendario de Vencimientos -->
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-6 mb-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">üìÖ Calendario de Vencimientos de Recarga</h3>
                        
                        <!-- Navegaci√≥n del Calendario -->
                        <div class="flex items-center justify-between mb-4">
                            <button onclick="changeCalendarMonth(-1)" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                                ‚Üê Anterior
                            </button>
                            <h4 id="calendarMonthYear" class="text-xl font-bold text-gray-800"></h4>
                            <button onclick="changeCalendarMonth(1)" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                                Siguiente ‚Üí
                            </button>
                        </div>

                        <!-- Grid del Calendario -->
                        <div class="grid grid-cols-7 gap-1">
                            <!-- Headers de d√≠as -->
                            <div class="text-center font-bold text-sm text-gray-700 bg-blue-100 p-2 rounded">Dom</div>
                            <div class="text-center font-bold text-sm text-gray-700 bg-blue-100 p-2 rounded">Lun</div>
                            <div class="text-center font-bold text-sm text-gray-700 bg-blue-100 p-2 rounded">Mar</div>
                            <div class="text-center font-bold text-sm text-gray-700 bg-blue-100 p-2 rounded">Mi√©</div>
                            <div class="text-center font-bold text-sm text-gray-700 bg-blue-100 p-2 rounded">Jue</div>
                            <div class="text-center font-bold text-sm text-gray-700 bg-blue-100 p-2 rounded">Vie</div>
                            <div class="text-center font-bold text-sm text-gray-700 bg-blue-100 p-2 rounded">S√°b</div>
                        </div>
                        <div id="calendarDays" class="grid grid-cols-7 gap-1 mt-1"></div>

                        <!-- Leyenda -->
                        <div class="mt-4 flex flex-wrap gap-4 text-sm">
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-red-500 rounded"></div>
                                <span>Vencido</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-yellow-400 rounded"></div>
                                <span>Por vencer (30 d√≠as)</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-green-400 rounded"></div>
                                <span>Pr√≥ximo vencimiento</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-blue-400 rounded"></div>
                                <span>D√≠a actual</span>
                            </div>
                        </div>
                    </div>

                    <div id="extinguishersList" class="space-y-3"></div>
                </div>

                <div id="newExtinguisherForm" class="hidden bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Nuevo Extintor</h3>
                    <form onsubmit="saveExtinguisher(event)" class="space-y-4">
                        <div class="grid md:grid-cols-3 gap-4">
                            <input type="text" name="codigo" required placeholder="C√≥digo *" class="border border-gray-300 rounded-lg p-3">
                            <select name="tipo" required class="border border-gray-300 rounded-lg p-3">
                                <option value="">Tipo *</option>
                                <option value="ABC">ABC (Polvo)</option>
                                <option value="BC">BC (CO2)</option>
                                <option value="K">Clase K (Cocina)</option>
                                <option value="Agua">Agua</option>
                            </select>
                            <input type="number" name="capacidad" required placeholder="Capacidad (kg) *" min="1" step="0.5" class="border border-gray-300 rounded-lg p-3">
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <input type="text" name="ubicacion" required placeholder="Ubicaci√≥n *" class="border border-gray-300 rounded-lg p-3">
                            <input type="date" name="ultima_recarga" required class="border border-gray-300 rounded-lg p-3">
                        </div>
                        <div class="flex gap-3">
                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold flex-1 transition">
                                <i class="fas fa-save"></i> Guardar Extintor
                            </button>
                            <button type="button" onclick="cancelNewExtinguisher()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-semibold transition">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Risk Matrix Module -->
            <div id="riskmatrixView" class="hidden">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">‚ö†Ô∏è Matriz de Riesgos</h2>
                        <div class="flex gap-2">
                            <button onclick="exportRiskMatrixReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                                <i class="fas fa-file-pdf"></i> Exportar Informe
                            </button>
                            <button onclick="showNewRisk()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                                <i class="fas fa-plus-circle"></i> Nuevo Riesgo
                            </button>
                        </div>
                    </div>

                    <!-- Risk Matrix Visual -->
                    <div class="mb-6">
                        <h3 class="font-bold text-lg mb-3">Matriz P√óS</h3>
                        <div class="risk-matrix mb-2">
                            <div class="risk-cell bg-gray-300 font-bold"></div>
                            <div class="risk-cell bg-gray-300 font-bold">1</div>
                            <div class="risk-cell bg-gray-300 font-bold">2</div>
                            <div class="risk-cell bg-gray-300 font-bold">3</div>
                            <div class="risk-cell bg-gray-300 font-bold">4</div>
                            <div class="risk-cell bg-gray-300 font-bold">5</div>
                            
                            <div class="risk-cell bg-gray-300 font-bold">5</div>
                            <div class="risk-cell bg-yellow-300">5</div>
                            <div class="risk-cell bg-orange-300">10</div>
                            <div class="risk-cell bg-orange-400">15</div>
                            <div class="risk-cell bg-red-400">20</div>
                            <div class="risk-cell bg-red-600 text-white">25</div>
                            
                            <div class="risk-cell bg-gray-300 font-bold">4</div>
                            <div class="risk-cell bg-green-300">4</div>
                            <div class="risk-cell bg-yellow-300">8</div>
                            <div class="risk-cell bg-orange-300">12</div>
                            <div class="risk-cell bg-orange-400">16</div>
                            <div class="risk-cell bg-red-400">20</div>
                            
                            <div class="risk-cell bg-gray-300 font-bold">3</div>
                            <div class="risk-cell bg-green-300">3</div>
                            <div class="risk-cell bg-green-400">6</div>
                            <div class="risk-cell bg-yellow-300">9</div>
                            <div class="risk-cell bg-orange-300">12</div>
                            <div class="risk-cell bg-orange-400">15</div>
                            
                            <div class="risk-cell bg-gray-300 font-bold">2</div>
                            <div class="risk-cell bg-green-200">2</div>
                            <div class="risk-cell bg-green-300">4</div>
                            <div class="risk-cell bg-green-400">6</div>
                            <div class="risk-cell bg-yellow-300">8</div>
                            <div class="risk-cell bg-orange-300">10</div>
                            
                            <div class="risk-cell bg-gray-300 font-bold">1</div>
                            <div class="risk-cell bg-green-200">1</div>
                            <div class="risk-cell bg-green-200">2</div>
                            <div class="risk-cell bg-green-300">3</div>
                            <div class="risk-cell bg-green-300">4</div>
                            <div class="risk-cell bg-yellow-300">5</div>
                        </div>
                        <div class="text-sm text-gray-600">
                            <p><strong>Probabilidad (1-5):</strong> 1=Muy improbable, 5=Muy probable</p>
                            <p><strong>Severidad (1-5):</strong> 1=Leve, 5=Catastr√≥fico</p>
                        </div>
                    </div>

                    <div id="risksList" class="space-y-3"></div>
                </div>

                <div id="newRiskForm" class="hidden bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Nuevo Riesgo</h3>
                    <form onsubmit="saveRisk(event)" class="space-y-4">
                        <input type="text" name="descripcion" required placeholder="Descripci√≥n del riesgo *" class="border border-gray-300 rounded-lg p-3 w-full">
                        <input type="text" name="sector" placeholder="Sector/√Årea" class="border border-gray-300 rounded-lg p-3 w-full">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">Probabilidad (1-5) *</label>
                                <select name="probabilidad" required class="border border-gray-300 rounded-lg p-3 w-full">
                                    <option value="1">1 - Muy improbable</option>
                                    <option value="2">2 - Improbable</option>
                                    <option value="3">3 - Posible</option>
                                    <option value="4">4 - Probable</option>
                                    <option value="5">5 - Muy probable</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Severidad (1-5) *</label>
                                <select name="severidad" required class="border border-gray-300 rounded-lg p-3 w-full">
                                    <option value="1">1 - Leve</option>
                                    <option value="2">2 - Menor</option>
                                    <option value="3">3 - Moderado</option>
                                    <option value="4">4 - Mayor</option>
                                    <option value="5">5 - Catastr√≥fico</option>
                                </select>
                            </div>
                        </div>
                        <textarea name="controles" placeholder="Controles existentes o propuestos" rows="3" class="border border-gray-300 rounded-lg p-3 w-full"></textarea>
                        <div class="flex gap-3">
                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold flex-1 transition">
                                <i class="fas fa-save"></i> Guardar Riesgo
                            </button>
                            <button type="button" onclick="cancelNewRisk()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-semibold transition">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Training Module -->
            <div id="trainingView" class="hidden">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-graduation-cap text-green-600"></i> Gesti√≥n de Capacitaciones</h2>
                        <div class="flex gap-2">
                            <button onclick="showAnnualPlan()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                                üìÖ Plan Anual
                            </button>
                            <button onclick="exportTrainingsReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                                <i class="fas fa-file-pdf"></i> Exportar PDF
                            </button>
                            <button onclick="showNewTraining()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                                <i class="fas fa-plus-circle"></i> Nueva Capacitaci√≥n
                            </button>
                        </div>
                    </div>

                    <div id="trainingsList" class="space-y-3"></div>
                </div>

                <div id="newTrainingForm" class="hidden bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Nueva Capacitaci√≥n</h3>
                    <form onsubmit="saveTraining(event)" class="space-y-4">
                        <input type="text" name="titulo" required placeholder="T√≠tulo de la capacitaci√≥n *" class="border border-gray-300 rounded-lg p-3 w-full">
                        <div class="grid md:grid-cols-3 gap-4">
                            <input type="date" name="fecha" required class="border border-gray-300 rounded-lg p-3">
                            <input type="number" name="duracion" required placeholder="Duraci√≥n (hs) *" min="0.5" step="0.5" class="border border-gray-300 rounded-lg p-3">
                            <input type="text" name="instructor" required placeholder="Instructor *" class="border border-gray-300 rounded-lg p-3">
                        </div>
                        <textarea name="participantes" required placeholder="Participantes (uno por l√≠nea) *" rows="4" class="border border-gray-300 rounded-lg p-3 w-full"></textarea>
                        <div class="flex gap-3">
                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold flex-1 transition">
                                <i class="fas fa-save"></i> Guardar Capacitaci√≥n
                            </button>
                            <button type="button" onclick="cancelNewTraining()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-semibold transition">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Annual Training Plan Modal -->
            <div id="annualPlanView" class="hidden">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">üìÖ Plan Anual de Capacitaciones</h2>
                        <div class="flex gap-2">
                            <button onclick="exportAnnualPlan()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                                <i class="fas fa-file-pdf"></i> Exportar Plan
                            </button>
                            <button onclick="showNewAnnualPlanItem()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                                <i class="fas fa-plus-circle"></i> Agregar Capacitaci√≥n
                            </button>
                            <button onclick="closeAnnualPlan()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                                ‚Üê Volver
                            </button>
                        </div>
                    </div>

                    <div class="mb-4 p-4 bg-purple-50 rounded-lg border-l-4 border-purple-600">
                        <p class="text-sm text-gray-700">
                            <strong><i class="fas fa-calendar-check text-green-600"></i> Plan Anual de Capacitaciones</strong><br>
                            Planifique las capacitaciones del a√±o organizadas por mes. Este plan le ayudar√° a cumplir con los requisitos de la SRT y mantener al personal capacitado.
                        </p>
                    </div>

                    <div id="annualPlanList" class="space-y-6"></div>
                </div>

                <!-- New Annual Plan Item Form -->
                <div id="newAnnualPlanForm" class="hidden bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Agregar Capacitaci√≥n al Plan Anual</h3>
                    <form onsubmit="saveAnnualPlanItem(event)" class="space-y-4">
                        <input type="text" name="titulo" required placeholder="T√≠tulo de la capacitaci√≥n *" class="border border-gray-300 rounded-lg p-3 w-full">
                        
                        <div class="grid md:grid-cols-2 gap-4">
                            <select name="mes" required class="border border-gray-300 rounded-lg p-3">
                                <option value="">Seleccionar mes *</option>
                                <option value="01">Enero</option>
                                <option value="02">Febrero</option>
                                <option value="03">Marzo</option>
                                <option value="04">Abril</option>
                                <option value="05">Mayo</option>
                                <option value="06">Junio</option>
                                <option value="07">Julio</option>
                                <option value="08">Agosto</option>
                                <option value="09">Septiembre</option>
                                <option value="10">Octubre</option>
                                <option value="11">Noviembre</option>
                                <option value="12">Diciembre</option>
                            </select>
                            
                            <input type="number" name="anio" required placeholder="A√±o *" min="2024" max="2030" value="2025" class="border border-gray-300 rounded-lg p-3">
                        </div>

                        <div class="grid md:grid-cols-2 gap-4">
                            <input type="number" name="duracion" required placeholder="Duraci√≥n estimada (hs) *" min="0.5" step="0.5" class="border border-gray-300 rounded-lg p-3">
                            <input type="text" name="instructor" placeholder="Instructor (opcional)" class="border border-gray-300 rounded-lg p-3">
                        </div>

                        <textarea name="objetivo" placeholder="Objetivo de la capacitaci√≥n" rows="2" class="border border-gray-300 rounded-lg p-3 w-full"></textarea>
                        
                        <textarea name="destinatarios" placeholder="Destinatarios / Sectores (uno por l√≠nea)" rows="3" class="border border-gray-300 rounded-lg p-3 w-full"></textarea>

                        <div class="flex gap-3">
                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold flex-1 transition">
                                <i class="fas fa-save"></i> Guardar en Plan Anual
                            </button>
                            <button type="button" onclick="cancelNewAnnualPlanItem()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-semibold transition">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Incidents Module -->
            <div id="incidentsView" class="hidden">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-ambulance text-purple-600"></i> Registro de Incidentes</h2>
                        <div class="flex gap-2">
                            <button onclick="exportIncidentsReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                                <i class="fas fa-file-pdf"></i> Exportar Informe
                            </button>
                            <button onclick="showNewIncident()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                                <i class="fas fa-plus-circle"></i> Nuevo Incidente
                            </button>
                        </div>
                    </div>

                    <div id="incidentsList" class="space-y-3"></div>
                </div>

                <div id="newIncidentForm" class="hidden bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Nuevo Incidente</h3>
                    <form onsubmit="saveIncident(event)" class="space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <select name="tipo" required class="border border-gray-300 rounded-lg p-3">
                                <option value="">Tipo de incidente *</option>
                                <option value="Accidente">Accidente</option>
                                <option value="Incidente">Incidente sin lesi√≥n</option>
                                <option value="Cuasi-accidente">Cuasi-accidente</option>
                            </select>
                            <select name="gravedad" required class="border border-gray-300 rounded-lg p-3">
                                <option value="">Gravedad *</option>
                                <option value="Leve">Leve</option>
                                <option value="Moderado">Moderado</option>
                                <option value="Grave">Grave</option>
                                <option value="Fatal">Fatal</option>
                            </select>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <input type="date" name="fecha" required class="border border-gray-300 rounded-lg p-3">
                            <input type="time" name="hora" required class="border border-gray-300 rounded-lg p-3">
                        </div>
                        <input type="text" name="lugar" required placeholder="Lugar del incidente *" class="border border-gray-300 rounded-lg p-3 w-full">
                        <input type="text" name="involucrado" placeholder="Persona involucrada" class="border border-gray-300 rounded-lg p-3 w-full">
                        <textarea name="descripcion" required placeholder="Descripci√≥n del incidente *" rows="4" class="border border-gray-300 rounded-lg p-3 w-full"></textarea>
                        <textarea name="causas" placeholder="Causas identificadas (5 porqu√©s)" rows="3" class="border border-gray-300 rounded-lg p-3 w-full"></textarea>
                        <textarea name="acciones" placeholder="Acciones correctivas" rows="3" class="border border-gray-300 rounded-lg p-3 w-full"></textarea>
                        <div class="flex gap-3">
                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold flex-1 transition">
                                <i class="fas fa-save"></i> Guardar Incidente
                            </button>
                            <button type="button" onclick="cancelNewIncident()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-semibold transition">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- PPE Module -->
            <div id="ppeView" class="hidden">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-hard-hat text-indigo-600"></i> Gesti√≥n de EPP</h2>
                        <div class="flex gap-2">
                            <button onclick="exportPPEReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                                <i class="fas fa-file-pdf"></i> Exportar PDF
                            </button>
                            <button onclick="showNewPPE()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                                ‚ûï Registrar Entrega
                            </button>
                        </div>
                    </div>

                    <div id="ppeList" class="space-y-3"></div>
                </div>

                <div id="newPPEForm" class="hidden bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Registrar Entrega de EPP</h3>
                    <form onsubmit="savePPE(event)" class="space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <input type="text" name="empleado" required placeholder="Nombre del empleado *" class="border border-gray-300 rounded-lg p-3">
                            <input type="text" name="articulo" required placeholder="Art√≠culo EPP *" class="border border-gray-300 rounded-lg p-3">
                        </div>
                        <div class="grid md:grid-cols-3 gap-4">
                            <input type="text" name="talla" placeholder="Talla" class="border border-gray-300 rounded-lg p-3">
                            <input type="number" name="cantidad" required placeholder="Cantidad *" min="1" class="border border-gray-300 rounded-lg p-3">
                            <input type="date" name="fecha_entrega" required class="border border-gray-300 rounded-lg p-3">
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <input type="text" name="lote" placeholder="Lote/Serie" class="border border-gray-300 rounded-lg p-3">
                            <input type="number" name="vida_util_meses" placeholder="Vida √∫til (meses)" min="1" class="border border-gray-300 rounded-lg p-3">
                        </div>
                        <textarea name="observaciones" placeholder="Observaciones" rows="2" class="border border-gray-300 rounded-lg p-3 w-full"></textarea>
                        <div>
                            <label class="block text-sm font-semibold mb-2">üì∑ Foto del EPP entregado (opcional)</label>
                            <input type="file" id="ppePhotoInput" accept="image/*" class="border border-gray-300 rounded-lg p-2 w-full" onchange="previewPPEPhoto(this, 'new')">
                            <div id="ppePhotoPreview" class="mt-2"></div>
                        </div>
                        <div class="flex gap-3">
                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold flex-1 transition">
                                <i class="fas fa-save"></i> Registrar Entrega
                            </button>
                            <button type="button" onclick="cancelNewPPE()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-semibold transition">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Edit PPE Form -->
                <div id="editPPEForm" class="hidden bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Editar Entrega de EPP</h3>
                    <form onsubmit="updatePPE(event)" class="space-y-4">
                        <input type="hidden" name="ppe_id" id="edit_ppe_id">
                        <div class="grid md:grid-cols-2 gap-4">
                            <input type="text" name="empleado" id="edit_empleado" required placeholder="Nombre del empleado *" class="border border-gray-300 rounded-lg p-3">
                            <input type="text" name="articulo" id="edit_articulo" required placeholder="Art√≠culo EPP *" class="border border-gray-300 rounded-lg p-3">
                        </div>
                        <div class="grid md:grid-cols-3 gap-4">
                            <input type="text" name="talla" id="edit_talla" placeholder="Talla" class="border border-gray-300 rounded-lg p-3">
                            <input type="number" name="cantidad" id="edit_cantidad" required placeholder="Cantidad *" min="1" class="border border-gray-300 rounded-lg p-3">
                            <input type="date" name="fecha_entrega" id="edit_fecha_entrega" required class="border border-gray-300 rounded-lg p-3">
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <input type="text" name="lote" id="edit_lote" placeholder="Lote/Serie" class="border border-gray-300 rounded-lg p-3">
                            <input type="number" name="vida_util_meses" id="edit_vida_util_meses" placeholder="Vida √∫til (meses)" min="1" class="border border-gray-300 rounded-lg p-3">
                        </div>
                        <textarea name="observaciones" id="edit_observaciones" placeholder="Observaciones" rows="2" class="border border-gray-300 rounded-lg p-3 w-full"></textarea>
                        <div>
                            <label class="block text-sm font-semibold mb-2">üì∑ Foto del EPP (opcional)</label>
                            <input type="file" id="editPpePhotoInput" accept="image/*" class="border border-gray-300 rounded-lg p-2 w-full" onchange="previewPPEPhoto(this, 'edit')">
                            <div id="editPpePhotoPreview" class="mt-2"></div>
                        </div>
                        <div class="flex gap-3">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold flex-1 transition">
                                <i class="fas fa-save"></i> Guardar Cambios
                            </button>
                            <button type="button" onclick="cancelEditPPE()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-semibold transition">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Return PPE Form -->
                <div id="returnPPEForm" class="hidden bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Registrar Devoluci√≥n de EPP</h3>
                    <div id="returnPPEInfo" class="bg-blue-50 p-4 rounded-lg mb-4"></div>
                    <form onsubmit="saveReturnPPE(event)" class="space-y-4">
                        <input type="hidden" name="ppe_id" id="return_ppe_id">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Fecha de Devoluci√≥n *</label>
                                <input type="date" name="fecha_devolucion" id="return_fecha_devolucion" required class="border border-gray-300 rounded-lg p-3 w-full">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Estado del EPP *</label>
                                <select name="estado_devolucion" id="return_estado" required class="border border-gray-300 rounded-lg p-3 w-full">
                                    <option value="">Seleccionar estado...</option>
                                    <option value="Excelente">Excelente - Como nuevo</option>
                                    <option value="Bueno">Bueno - Uso normal</option>
                                    <option value="Regular">Regular - Desgaste visible</option>
                                    <option value="Malo">Malo - Requiere reemplazo</option>
                                    <option value="Da√±ado">Da√±ado - No reutilizable</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Observaciones del Estado del EPP *</label>
                            <textarea name="observaciones_devolucion" id="return_observaciones" required placeholder="Describa el estado del EPP devuelto, da√±os, desgaste, etc..." rows="3" class="border border-gray-300 rounded-lg p-3 w-full"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">üì∑ Foto del EPP devuelto (opcional)</label>
                            <input type="file" id="returnPpePhotoInput" accept="image/*" class="border border-gray-300 rounded-lg p-2 w-full" onchange="previewPPEPhoto(this, 'return')">
                            <p class="text-xs text-gray-500 mt-1">Foto del estado del EPP al momento de la devoluci√≥n</p>
                            <div id="returnPpePhotoPreview" class="mt-2"></div>
                        </div>
                        <div class="flex gap-3">
                            <button type="submit" class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-3 rounded-lg font-semibold flex-1 transition">
                                <i class="fas fa-undo"></i> Registrar Devoluci√≥n
                            </button>
                            <button type="button" onclick="cancelReturnPPE()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-semibold transition">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Photo Viewer Modal -->
                <div id="ppePhotoModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-2xl font-bold text-gray-800" id="ppePhotoModalTitle">Fotos del EPP</h3>
                                <button onclick="closePPEPhotoModal()" class="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
                            </div>
                            
                            <div id="ppePhotoModalContent" class="space-y-6">
                                <!-- Content will be loaded dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Module -->
            <div id="dashboardView" class="hidden">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-chart-line text-cyan-600"></i> Dashboard de KPIs Completo</h2>
                        <div class="flex gap-2">
                            <button onclick="exportDashboardPDFReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                                <i class="fas fa-file-pdf"></i> Exportar PDF
                            </button>
                            <button onclick="refreshDashboard()" class="bg-cyan-600 hover:bg-cyan-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                                <i class="fas fa-sync"></i> Actualizar
                            </button>
                        </div>
                    </div>
                    
                    <!-- KPIs Proactivos -->
                    <div class="mb-8">
                        <h3 class="text-xl font-bold text-green-700 mb-4 flex items-center">
                            <span class="mr-2">üõ°Ô∏è</span> Indicadores Proactivos (Prevenci√≥n)
                        </h3>
                        <div class="grid md:grid-cols-5 gap-4">
                            <div class="bg-green-50 border-l-4 border-green-600 p-4 rounded hover:shadow-lg transition">
                                <div class="text-xs text-gray-600 mb-1">Inspecciones Realizadas</div>
                                <div class="text-3xl font-bold text-green-700" id="kpiInspections">0</div>
                                <div class="text-xs text-gray-500 mt-1" id="kpiInspectionsDetail">√öltimo mes</div>
                            </div>
                            <div class="bg-blue-50 border-l-4 border-blue-600 p-4 rounded hover:shadow-lg transition">
                                <div class="text-xs text-gray-600 mb-1">Capacitaciones</div>
                                <div class="text-3xl font-bold text-blue-700" id="kpiTrainings">0</div>
                                <div class="text-xs text-gray-500 mt-1" id="kpiTrainingsDetail">Total personal capacitado</div>
                            </div>
                            <div class="bg-purple-50 border-l-4 border-purple-600 p-4 rounded hover:shadow-lg transition">
                                <div class="text-xs text-gray-600 mb-1">Extintores Vigentes</div>
                                <div class="text-3xl font-bold text-purple-700" id="kpiExtinguishers">0</div>
                                <div class="text-xs text-gray-500 mt-1" id="kpiExtinguishersDetail">% de cumplimiento</div>
                            </div>
                            <div class="bg-cyan-50 border-l-4 border-cyan-600 p-4 rounded hover:shadow-lg transition">
                                <div class="text-xs text-gray-600 mb-1">Acciones Cerradas</div>
                                <div class="text-3xl font-bold text-cyan-700" id="kpiClosedActions">0</div>
                                <div class="text-xs text-gray-500 mt-1" id="kpiClosedActionsDetail">√öltimo mes</div>
                            </div>
                            <div class="bg-indigo-50 border-l-4 border-indigo-600 p-4 rounded hover:shadow-lg transition">
                                <div class="text-xs text-gray-600 mb-1">% Cumplimiento</div>
                                <div class="text-3xl font-bold text-indigo-700" id="kpiCompliance">0%</div>
                                <div class="text-xs text-gray-500 mt-1">Inspecciones</div>
                            </div>
                        </div>
                    </div>

                    <!-- KPIs Reactivos -->
                    <div class="mb-8">
                        <h3 class="text-xl font-bold text-red-700 mb-4 flex items-center">
                            <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i> Indicadores Reactivos (Incidentes y Correctivos)
                        </h3>
                        <div class="grid md:grid-cols-5 gap-4">
                            <div class="bg-red-50 border-l-4 border-red-600 p-4 rounded hover:shadow-lg transition">
                                <div class="text-xs text-gray-600 mb-1">Incidentes Totales</div>
                                <div class="text-3xl font-bold text-red-700" id="kpiIncidentsTotal">0</div>
                                <div class="text-xs text-gray-500 mt-1" id="kpiIncidentsTotalDetail">√öltimo mes</div>
                            </div>
                            <div class="bg-orange-50 border-l-4 border-orange-600 p-4 rounded hover:shadow-lg transition">
                                <div class="text-xs text-gray-600 mb-1">Accidentes con Lesi√≥n</div>
                                <div class="text-3xl font-bold text-orange-700" id="kpiAccidents">0</div>
                                <div class="text-xs text-gray-500 mt-1" id="kpiAccidentsDetail">Requieren investigaci√≥n</div>
                            </div>
                            <div class="bg-yellow-50 border-l-4 border-yellow-600 p-4 rounded hover:shadow-lg transition">
                                <div class="text-xs text-gray-600 mb-1">Acciones Pendientes</div>
                                <div class="text-3xl font-bold text-yellow-700" id="kpiPendingActions">0</div>
                                <div class="text-xs text-gray-500 mt-1" id="kpiPendingActionsDetail">Requieren atenci√≥n</div>
                            </div>
                            <div class="bg-pink-50 border-l-4 border-pink-600 p-4 rounded hover:shadow-lg transition">
                                <div class="text-xs text-gray-600 mb-1">Riesgos Cr√≠ticos</div>
                                <div class="text-3xl font-bold text-pink-700" id="kpiCriticalRisks">0</div>
                                <div class="text-xs text-gray-500 mt-1" id="kpiCriticalRisksDetail">Alto impacto</div>
                            </div>
                            <div class="bg-gray-50 border-l-4 border-gray-600 p-4 rounded hover:shadow-lg transition">
                                <div class="text-xs text-gray-600 mb-1">Tiempo Medio Cierre</div>
                                <div class="text-3xl font-bold text-gray-700" id="kpiAvgClosureTime">0</div>
                                <div class="text-xs text-gray-500 mt-1">d√≠as promedio</div>
                            </div>
                        </div>
                    </div>

                    <!-- Estad√≠sticas Adicionales -->
                    <div class="mb-8 bg-gray-50 p-4 rounded-lg">
                        <h3 class="text-lg font-bold text-gray-800 mb-3"><i class="fas fa-chart-line"></i> Estad√≠sticas del Per√≠odo</h3>
                        <div class="grid md:grid-cols-4 gap-4 text-sm">
                            <div>
                                <span class="font-semibold">Total Trabajadores:</span>
                                <span class="ml-2" id="statTotalWorkers">-</span>
                            </div>
                            <div>
                                <span class="font-semibold">Horas Capacitaci√≥n:</span>
                                <span class="ml-2" id="statTrainingHours">-</span>
                            </div>
                            <div>
                                <span class="font-semibold">Tasa de Incidentes:</span>
                                <span class="ml-2" id="statIncidentRate">-</span>
                            </div>
                            <div>
                                <span class="font-semibold">D√≠as sin Accidentes:</span>
                                <span class="ml-2" id="statDaysWithoutAccidents">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Gr√°ficos con Selectores -->
                    <div class="grid md:grid-cols-2 gap-6 mb-8">
                        <!-- Gr√°fico 1: Acciones por Estado -->
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="font-bold text-lg">Acciones por Estado</h3>
                                <select id="actionsChartType" onchange="updateChartType('actions', this.value)" class="chart-type-selector border border-gray-300 rounded px-2 py-1 text-sm">
                                    <option value="doughnut">üç© Torta</option>
                                    <option value="bar">üìä Barras</option>
                                    <option value="line"><i class="fas fa-chart-line"></i> L√≠nea</option>
                                </select>
                            </div>
                            <canvas id="actionsChart"></canvas>
                        </div>

                        <!-- Gr√°fico 2: Incidentes por Tipo -->
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="font-bold text-lg">Incidentes por Tipo</h3>
                                <select id="incidentsChartType" onchange="updateChartType('incidents', this.value)" class="chart-type-selector border border-gray-300 rounded px-2 py-1 text-sm">
                                    <option value="bar">üìä Barras</option>
                                    <option value="doughnut">üç© Torta</option>
                                    <option value="line"><i class="fas fa-chart-line"></i> L√≠nea</option>
                                </select>
                            </div>
                            <canvas id="incidentsChart"></canvas>
                        </div>

                        <!-- Gr√°fico 3: Riesgos por Nivel -->
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="font-bold text-lg">Riesgos por Nivel</h3>
                                <select id="risksChartType" onchange="updateChartType('risks', this.value)" class="chart-type-selector border border-gray-300 rounded px-2 py-1 text-sm">
                                    <option value="bar">üìä Barras</option>
                                    <option value="doughnut">üç© Torta</option>
                                    <option value="line"><i class="fas fa-chart-line"></i> L√≠nea</option>
                                </select>
                            </div>
                            <canvas id="risksChart"></canvas>
                        </div>

                        <!-- Gr√°fico 4: Capacitaciones Mensuales -->
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="font-bold text-lg">Capacitaciones (√öltimos 6 Meses)</h3>
                                <select id="trainingsChartType" onchange="updateChartType('trainings', this.value)" class="chart-type-selector border border-gray-300 rounded px-2 py-1 text-sm">
                                    <option value="line"><i class="fas fa-chart-line"></i> L√≠nea</option>
                                    <option value="bar">üìä Barras</option>
                                    <option value="doughnut">üç© Torta</option>
                                </select>
                            </div>
                            <canvas id="trainingsChart"></canvas>
                        </div>
                    </div>

                    <!-- Tendencias y An√°lisis -->
                    <div class="bg-blue-50 border-l-4 border-blue-600 p-4 rounded">
                        <h3 class="font-bold text-lg mb-2 flex items-center">
                            <i class="fas fa-lightbulb text-yellow-500 mr-2"></i> An√°lisis y Recomendaciones
                        </h3>
                        <div id="dashboardRecommendations" class="text-sm text-gray-700 space-y-1"></div>
                    </div>
                </div>
            </div>

            <!-- JSA / Permisos Module -->
            <div id="jsaView" class="hidden">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-edit"></i> JSA / Permisos de Trabajo</h2>
                        <div class="flex gap-2">
                            <button onclick="exportJSAReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                                <i class="fas fa-file-pdf"></i> Exportar PDF
                            </button>
                            <button onclick="showNewJSA()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                                <i class="fas fa-plus-circle"></i> Nuevo JSA
                            </button>
                        </div>
                    </div>

                    <div id="jsaList" class="space-y-3"></div>
                </div>

                <div id="newJSAForm" class="hidden bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Nuevo Job Safety Analysis</h3>
                    <form onsubmit="saveJSA(event)" class="space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <input type="text" name="tarea" required placeholder="Tarea a realizar *" class="border border-gray-300 rounded-lg p-3 w-full">
                            <input type="text" name="ubicacion" required placeholder="Ubicaci√≥n *" class="border border-gray-300 rounded-lg p-3 w-full">
                        </div>
                        <div class="grid md:grid-cols-3 gap-4">
                            <input type="date" name="fecha" required class="border border-gray-300 rounded-lg p-3">
                            <input type="text" name="supervisor" required placeholder="Supervisor *" class="border border-gray-300 rounded-lg p-3">
                            <select name="tipo_permiso" required class="border border-gray-300 rounded-lg p-3">
                                <option value="">Tipo de permiso *</option>
                                <option value="Trabajo en Altura">Trabajo en Altura</option>
                                <option value="Trabajo en Caliente">Trabajo en Caliente</option>
                                <option value="Espacio Confinado">Espacio Confinado</option>
                                <option value="Trabajo El√©ctrico">Trabajo El√©ctrico</option>
                                <option value="Excavaci√≥n">Excavaci√≥n</option>
                                <option value="General">General</option>
                            </select>
                        </div>
                        
                        <div class="border border-gray-300 rounded-lg p-4">
                            <h4 class="font-bold mb-3">An√°lisis de Pasos y Peligros</h4>
                            <div id="jsaSteps" class="space-y-3">
                                <div class="flex gap-2">
                                    <input type="text" placeholder="Paso de la tarea" class="jsa-step border border-gray-300 rounded p-2 flex-1">
                                    <input type="text" placeholder="Peligro identificado" class="jsa-hazard border border-gray-300 rounded p-2 flex-1">
                                    <input type="text" placeholder="Control / Medida preventiva" class="jsa-control border border-gray-300 rounded p-2 flex-1">
                                </div>
                            </div>
                            <button type="button" onclick="addJSAStep()" class="mt-3 bg-blue-600 text-white px-3 py-1 rounded text-sm">
                                + Agregar Paso
                            </button>
                        </div>

                        <div class="border border-gray-300 rounded-lg p-4">
                            <h4 class="font-bold mb-3">EPP Requerido</h4>
                            <div class="grid md:grid-cols-3 gap-2">
                                <label class="flex items-center"><input type="checkbox" name="epp" value="Casco" class="mr-2"> Casco</label>
                                <label class="flex items-center"><input type="checkbox" name="epp" value="Lentes" class="mr-2"> Lentes</label>
                                <label class="flex items-center"><input type="checkbox" name="epp" value="Guantes" class="mr-2"> Guantes</label>
                                <label class="flex items-center"><input type="checkbox" name="epp" value="Calzado" class="mr-2"> Calzado de seguridad</label>
                                <label class="flex items-center"><input type="checkbox" name="epp" value="Arn√©s" class="mr-2"> Arn√©s</label>
                                <label class="flex items-center"><input type="checkbox" name="epp" value="Respirador" class="mr-2"> Respirador</label>
                            </div>
                        </div>

                        <textarea name="observaciones" placeholder="Observaciones adicionales" rows="3" class="border border-gray-300 rounded-lg p-3 w-full"></textarea>

                        <div class="flex gap-3">
                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold flex-1 transition">
                                <i class="fas fa-save"></i> Guardar JSA
                            </button>
                            <button type="button" onclick="cancelNewJSA()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-semibold transition">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- SDS / Chemicals Module -->
            <div id="sdsView" class="hidden">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-flask"></i> Gesti√≥n de Qu√≠micos / SDS</h2>
                        <button onclick="showNewChemical()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                            <i class="fas fa-plus-circle"></i> Nuevo Producto Qu√≠mico
                        </button>
                    </div>

                    <div id="chemicalsList" class="space-y-3"></div>
                </div>

                <div id="newChemicalForm" class="hidden bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Nuevo Producto Qu√≠mico</h3>
                    <form onsubmit="saveChemical(event)" class="space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <input type="text" name="nombre" required placeholder="Nombre del producto *" class="border border-gray-300 rounded-lg p-3 w-full">
                            <input type="text" name="fabricante" placeholder="Fabricante" class="border border-gray-300 rounded-lg p-3 w-full">
                        </div>
                        
                        <div class="grid md:grid-cols-3 gap-4">
                            <input type="text" name="codigo" placeholder="C√≥digo/SKU" class="border border-gray-300 rounded-lg p-3">
                            <input type="text" name="numero_cas" placeholder="N√∫mero CAS" class="border border-gray-300 rounded-lg p-3">
                            <input type="text" name="numero_nu" placeholder="N√∫mero NU/ONU" class="border border-gray-300 rounded-lg p-3">
                        </div>

                        <div class="border border-gray-300 rounded-lg p-4">
                            <h4 class="font-bold mb-3">Pictogramas GHS</h4>
                            <div class="grid md:grid-cols-3 gap-2">
                                <label class="flex items-center text-sm"><input type="checkbox" name="pictograma" value="Explosivo" class="mr-2"> <i class="fas fa-exclamation-circle text-orange-500"></i> Explosivo</label>
                                <label class="flex items-center text-sm"><input type="checkbox" name="pictograma" value="Inflamable" class="mr-2"> <i class="fas fa-fire text-red-600"></i> Inflamable</label>
                                <label class="flex items-center text-sm"><input type="checkbox" name="pictograma" value="Comburente" class="mr-2"> üå°Ô∏è Comburente</label>
                                <label class="flex items-center text-sm"><input type="checkbox" name="pictograma" value="Gas a presi√≥n" class="mr-2"> <i class="fas fa-wind"></i> Gas a presi√≥n</label>
                                <label class="flex items-center text-sm"><input type="checkbox" name="pictograma" value="Corrosivo" class="mr-2"> <i class="fas fa-flask"></i> Corrosivo</label>
                                <label class="flex items-center text-sm"><input type="checkbox" name="pictograma" value="Toxicidad" class="mr-2"> ‚ò†Ô∏è Toxicidad aguda</label>
                                <label class="flex items-center text-sm"><input type="checkbox" name="pictograma" value="Peligro para salud" class="mr-2"> ‚ö†Ô∏è Peligro para salud</label>
                                <label class="flex items-center text-sm"><input type="checkbox" name="pictograma" value="Medio ambiente" class="mr-2"> üåç Medio ambiente</label>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">Almacenamiento</label>
                                <input type="text" name="almacenamiento" placeholder="Ubicaci√≥n f√≠sica" class="border border-gray-300 rounded-lg p-3 w-full">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Cantidad Actual (L o kg)</label>
                                <input type="number" name="cantidad" step="0.1" placeholder="0.0" class="border border-gray-300 rounded-lg p-3 w-full">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold mb-2">Frases H (Peligro)</label>
                            <textarea name="frases_h" placeholder="Ej: H225 - L√≠quido y vapores muy inflamables" rows="2" class="border border-gray-300 rounded-lg p-3 w-full"></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold mb-2">Frases P (Precauci√≥n)</label>
                            <textarea name="frases_p" placeholder="Ej: P210 - Mantener alejado del calor, chispas, llama" rows="2" class="border border-gray-300 rounded-lg p-3 w-full"></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold mb-2">Incompatibilidades</label>
                            <textarea name="incompatibilidades" placeholder="Productos con los que no debe almacenarse junto" rows="2" class="border border-gray-300 rounded-lg p-3 w-full"></textarea>
                        </div>

                        <div class="flex gap-3">
                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold flex-1 transition">
                                <i class="fas fa-save"></i> Guardar Producto
                            </button>
                            <button type="button" onclick="cancelNewChemical()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-semibold transition">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Environmental Monitoring Module -->
            <div id="environmentalView" class="hidden">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">üå°Ô∏è Monitoreo Ambiental</h2>
                        <button onclick="showNewMeasurement()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                            <i class="fas fa-plus-circle"></i> Nueva Medici√≥n
                        </button>
                    </div>

                    <div id="measurementsList" class="space-y-3"></div>
                </div>

                <div id="newMeasurementForm" class="hidden bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Nueva Medici√≥n Ambiental</h3>
                    <form onsubmit="saveMeasurement(event)" class="space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <select name="tipo" required class="border border-gray-300 rounded-lg p-3" onchange="updateLimits(this.value)">
                                <option value="">Tipo de medici√≥n *</option>
                                <option value="Ruido">Ruido (dB)</option>
                                <option value="Iluminaci√≥n">Iluminaci√≥n (lux)</option>
                                <option value="Temperatura">Temperatura (¬∞C)</option>
                                <option value="Humedad">Humedad (%)</option>
                                <option value="CO">Mon√≥xido de Carbono (ppm)</option>
                                <option value="CO2">Di√≥xido de Carbono (ppm)</option>
                                <option value="Polvo">Material Particulado (mg/m¬≥)</option>
                                <option value="Ventilaci√≥n">Ventilaci√≥n (m¬≥/h)</option>
                            </select>
                            <input type="text" name="ubicacion" required placeholder="Ubicaci√≥n/Puesto *" class="border border-gray-300 rounded-lg p-3">
                        </div>

                        <div class="grid md:grid-cols-3 gap-4">
                            <input type="date" name="fecha" required class="border border-gray-300 rounded-lg p-3">
                            <input type="time" name="hora" required class="border border-gray-300 rounded-lg p-3">
                            <input type="text" name="instrumento" placeholder="Instrumento usado" class="border border-gray-300 rounded-lg p-3">
                        </div>

                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">Valor Medido *</label>
                                <input type="number" name="valor" required step="0.01" placeholder="0.00" class="border border-gray-300 rounded-lg p-3 w-full">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">L√≠mite Permisible</label>
                                <input type="number" name="limite" step="0.01" placeholder="L√≠mite seg√∫n normativa" class="border border-gray-300 rounded-lg p-3 w-full" id="measurementLimit">
                            </div>
                        </div>

                        <div id="limitReference" class="text-xs text-gray-600 bg-blue-50 p-3 rounded hidden">
                            <!-- Se llenar√° din√°micamente con referencias normativas -->
                        </div>

                        <textarea name="observaciones" placeholder="Observaciones (condiciones clim√°ticas, actividad, etc.)" rows="3" class="border border-gray-300 rounded-lg p-3 w-full"></textarea>

                        <div class="flex gap-3">
                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold flex-1 transition">
                                <i class="fas fa-save"></i> Guardar Medici√≥n
                            </button>
                            <button type="button" onclick="cancelNewMeasurement()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-semibold transition">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Evacuation Plan Module -->
            <div id="evacuationView" class="hidden">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">üö™ Plan de Evacuaci√≥n</h2>
                        <button onclick="showNewDrill()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                            ‚ûï Registrar Simulacro
                        </button>
                    </div>

                    <!-- Calculadora de Salidas -->
                    <div class="bg-blue-50 border border-blue-300 rounded-lg p-4 mb-6">
                        <h3 class="font-bold mb-3">üìê Calculadora de Salidas de Emergencia</h3>
                        <div class="grid md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">Ocupaci√≥n M√°xima (personas)</label>
                                <input type="number" id="calcOcupacion" placeholder="0" class="border border-gray-300 rounded-lg p-2 w-full">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Tipo de Ocupaci√≥n</label>
                                <select id="calcTipo" class="border border-gray-300 rounded-lg p-2 w-full">
                                    <option value="oficina">Oficina</option>
                                    <option value="comercio">Comercio</option>
                                    <option value="industria">Industria</option>
                                    <option value="educacion">Educaci√≥n</option>
                                    <option value="salud">Salud</option>
                                </select>
                            </div>
                            <div>
                                <button onclick="calculateExits()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg mt-6 w-full">
                                    Calcular
                                </button>
                            </div>
                        </div>
                        <div id="exitResults" class="mt-4 text-sm hidden"></div>
                    </div>

                    <div id="drillsList" class="space-y-3"></div>
                </div>

                <div id="newDrillForm" class="hidden bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Registro de Simulacro</h3>
                    <form onsubmit="saveDrill(event)" class="space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <input type="date" name="fecha" required class="border border-gray-300 rounded-lg p-3">
                            <input type="time" name="hora" required class="border border-gray-300 rounded-lg p-3">
                        </div>

                        <div class="grid md:grid-cols-2 gap-4">
                            <select name="tipo_emergencia" required class="border border-gray-300 rounded-lg p-3">
                                <option value="">Tipo de emergencia simulada *</option>
                                <option value="Incendio">Incendio</option>
                                <option value="Sismo">Sismo</option>
                                <option value="Amenaza de bomba">Amenaza de bomba</option>
                                <option value="Fuga de gas">Fuga de gas</option>
                                <option value="Otro">Otro</option>
                            </select>
                            <select name="anunciado" required class="border border-gray-300 rounded-lg p-3">
                                <option value="">¬øSimulacro anunciado? *</option>
                                <option value="Si">S√≠ - Anunciado</option>
                                <option value="No">No - Sorpresa</option>
                            </select>
                        </div>

                        <div class="grid md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">Personas Presentes</label>
                                <input type="number" name="personas_presentes" required min="1" class="border border-gray-300 rounded-lg p-3 w-full">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Personas Evacuadas</label>
                                <input type="number" name="personas_evacuadas" required min="0" class="border border-gray-300 rounded-lg p-3 w-full">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Tiempo Total (minutos)</label>
                                <input type="number" name="tiempo_minutos" required step="0.1" min="0" class="border border-gray-300 rounded-lg p-3 w-full">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold mb-2">Coordinador del Simulacro</label>
                            <input type="text" name="coordinador" required placeholder="Nombre del coordinador" class="border border-gray-300 rounded-lg p-3 w-full">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold mb-2">Hallazgos y Observaciones</label>
                            <textarea name="hallazgos" required placeholder="Detallar comportamiento, problemas detectados, rutas usadas, etc." rows="4" class="border border-gray-300 rounded-lg p-3 w-full"></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold mb-2">Acciones de Mejora</label>
                            <textarea name="mejoras" placeholder="Acciones correctivas propuestas" rows="3" class="border border-gray-300 rounded-lg p-3 w-full"></textarea>
                        </div>

                        <div class="flex gap-3">
                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold flex-1 transition">
                                <i class="fas fa-save"></i> Guardar Simulacro
                            </button>
                            <button type="button" onclick="cancelNewDrill()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-semibold transition">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Contractors Module -->
            <div id="contractorsView" class="hidden">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-user-hard-hat"></i> Gesti√≥n de Contratistas</h2>
                        <div class="flex gap-3">
                            <button onclick="generateAllContractorsPDF()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                                <i class="fas fa-file-pdf"></i> Informe General PDF
                            </button>
                            <button onclick="showNewContractor()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                                <i class="fas fa-plus-circle"></i> Nuevo Contratista
                            </button>
                        </div>
                    </div>

                    <div id="contractorsList" class="space-y-3"></div>
                </div>

                <div id="newContractorForm" class="hidden bg-white rounded-lg shadow-md p-6">
                    <h3 id="contractorFormTitle" class="text-xl font-bold text-gray-800 mb-4">Nuevo Contratista</h3>
                    <form onsubmit="saveContractor(event)" class="space-y-4">
                        <input type="hidden" id="contractorEditId" name="edit_id">
                        <div class="grid md:grid-cols-2 gap-4">
                            <input type="text" name="razon_social" required placeholder="Raz√≥n Social *" class="border border-gray-300 rounded-lg p-3 w-full">
                            <input type="text" name="cuit" required placeholder="CUIT *" class="border border-gray-300 rounded-lg p-3 w-full">
                        </div>

                        <div class="grid md:grid-cols-2 gap-4">
                            <input type="text" name="responsable" placeholder="Responsable/Contacto" class="border border-gray-300 rounded-lg p-3 w-full">
                            <input type="tel" name="telefono" placeholder="Tel√©fono" class="border border-gray-300 rounded-lg p-3 w-full">
                        </div>

                        <input type="text" name="actividad" required placeholder="Actividad / Rubro *" class="border border-gray-300 rounded-lg p-3 w-full">

                        <div class="border border-gray-300 rounded-lg p-4">
                            <h4 class="font-bold mb-3">Seguro ART</h4>
                            <div class="grid md:grid-cols-2 gap-4">
                                <input type="text" name="art" placeholder="Aseguradora" class="border border-gray-300 rounded-lg p-3 w-full">
                                <input type="text" name="art_poliza" placeholder="N√∫mero de p√≥liza" class="border border-gray-300 rounded-lg p-3 w-full">
                            </div>
                            <div class="grid md:grid-cols-2 gap-4 mt-3">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Vigencia desde</label>
                                    <input type="date" name="art_desde" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Vigencia hasta</label>
                                    <input type="date" name="art_hasta" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                            </div>
                        </div>

                        <div class="border border-gray-300 rounded-lg p-4">
                            <h4 class="font-bold mb-3">Certificaciones y Habilitaciones</h4>
                            <div class="space-y-2">
                                <label class="flex items-center"><input type="checkbox" name="cert" value="Alta ART" class="mr-2"> Alta ART</label>
                                <label class="flex items-center"><input type="checkbox" name="cert" value="Certificado REPSAL" class="mr-2"> Certificado REPSAL</label>
                                <label class="flex items-center"><input type="checkbox" name="cert" value="Habilitaci√≥n municipal" class="mr-2"> Habilitaci√≥n municipal</label>
                                <label class="flex items-center"><input type="checkbox" name="cert" value="Certificado ISO 45001" class="mr-2"> Certificado ISO 45001</label>
                            </div>
                        </div>

                        <textarea name="observaciones" placeholder="Observaciones adicionales" rows="2" class="border border-gray-300 rounded-lg p-3 w-full"></textarea>

                        <div class="flex gap-3">
                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold flex-1 transition">
                                <i class="fas fa-save"></i> Guardar Contratista
                            </button>
                            <button type="button" onclick="cancelNewContractor()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-semibold transition">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="maintenanceView" class="hidden">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-wrench"></i> Mantenimiento Preventivo</h2>
                        <button onclick="showNewMaintenance()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                            <i class="fas fa-plus-circle"></i> Nueva Actividad de Mantenimiento
                        </button>
                    </div>

                    <!-- Filtros -->
                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <select id="maintenanceFilterType" onchange="loadMaintenances()" class="border border-gray-300 rounded-lg p-2">
                            <option value="">Todos los equipos</option>
                            <option value="Extintor">Extintores</option>
                            <option value="Detector de humo">Detectores de humo</option>
                            <option value="Luz de emergencia">Luces de emergencia</option>
                            <option value="Botiqu√≠n">Botiquines</option>
                            <option value="Sistema de alarma">Sistemas de alarma</option>
                            <option value="Camilla">Camillas</option>
                            <option value="Ducha de emergencia">Duchas de emergencia</option>
                            <option value="Otro">Otros</option>
                        </select>
                        <select id="maintenanceFilterStatus" onchange="loadMaintenances()" class="border border-gray-300 rounded-lg p-2">
                            <option value="">Todos los estados</option>
                            <option value="vigente">‚úÖ Vigente</option>
                            <option value="proximo"><i class="fas fa-exclamation-triangle"></i> Pr√≥ximo a vencer (30 d√≠as)</option>
                            <option value="vencido">‚ùå Vencido</option>
                        </select>
                    </div>

                    <div id="maintenancesList" class="space-y-3"></div>
                </div>

                <div id="newMaintenanceForm" class="hidden bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Nueva Actividad de Mantenimiento</h3>
                    <form onsubmit="saveMaintenance(event)" class="space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">Tipo de Equipo *</label>
                                <select name="tipo_equipo" required class="border border-gray-300 rounded-lg p-3 w-full">
                                    <option value="">Seleccionar...</option>
                                    <option value="Extintor">Extintor</option>
                                    <option value="Detector de humo">Detector de humo</option>
                                    <option value="Luz de emergencia">Luz de emergencia</option>
                                    <option value="Botiqu√≠n">Botiqu√≠n</option>
                                    <option value="Sistema de alarma">Sistema de alarma</option>
                                    <option value="Camilla">Camilla</option>
                                    <option value="Ducha de emergencia">Ducha de emergencia</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>
                            <input type="text" name="identificador" required placeholder="ID/C√≥digo del equipo *" class="border border-gray-300 rounded-lg p-3">
                        </div>

                        <div class="grid md:grid-cols-2 gap-4">
                            <input type="text" name="ubicacion" required placeholder="Ubicaci√≥n *" class="border border-gray-300 rounded-lg p-3">
                            <input type="text" name="marca_modelo" placeholder="Marca/Modelo" class="border border-gray-300 rounded-lg p-3">
                        </div>

                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">Tipo de Mantenimiento *</label>
                                <select name="tipo_mantenimiento" required class="border border-gray-300 rounded-lg p-3 w-full">
                                    <option value="Inspecci√≥n">Inspecci√≥n</option>
                                    <option value="Prueba funcional">Prueba funcional</option>
                                    <option value="Recarga">Recarga</option>
                                    <option value="Reemplazo">Reemplazo</option>
                                    <option value="Limpieza">Limpieza</option>
                                    <option value="Calibraci√≥n">Calibraci√≥n</option>
                                    <option value="Reparaci√≥n">Reparaci√≥n</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Frecuencia *</label>
                                <select name="frecuencia" required class="border border-gray-300 rounded-lg p-3 w-full">
                                    <option value="Mensual">Mensual</option>
                                    <option value="Trimestral">Trimestral</option>
                                    <option value="Semestral">Semestral</option>
                                    <option value="Anual">Anual</option>
                                    <option value="Cada 5 a√±os">Cada 5 a√±os</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">√öltimo Mantenimiento</label>
                                <input type="date" name="ultima_fecha" required class="border border-gray-300 rounded-lg p-3 w-full">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Pr√≥ximo Mantenimiento</label>
                                <input type="date" name="proxima_fecha" required class="border border-gray-300 rounded-lg p-3 w-full">
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-4">
                            <input type="text" name="tecnico" placeholder="T√©cnico responsable" class="border border-gray-300 rounded-lg p-3">
                            <input type="text" name="empresa" placeholder="Empresa de mantenimiento" class="border border-gray-300 rounded-lg p-3">
                        </div>

                        <textarea name="observaciones" placeholder="Observaciones" rows="2" class="border border-gray-300 rounded-lg p-3 w-full"></textarea>

                        <div class="flex gap-3">
                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold flex-1 transition">
                                <i class="fas fa-save"></i> Guardar Mantenimiento
                            </button>
                            <button type="button" onclick="cancelNewMaintenance()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-semibold transition">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="medicalView" class="hidden">
                <div class="bg-red-50 border-l-4 border-red-600 p-4 mb-4">
                    <p class="font-semibold text-red-800">‚ö†Ô∏è DATOS SENSIBLES - LEY 25.326</p>
                    <p class="text-sm mt-2">Este m√≥dulo contiene informaci√≥n de salud personal. Uso exclusivo para profesionales de Medicina Laboral y RRHH con autorizaci√≥n. Los datos se almacenan localmente en este dispositivo.</p>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">üè• Vigilancia de la Salud</h2>
                        <button onclick="showNewMedical()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                            <i class="fas fa-plus-circle"></i> Nuevo Examen M√©dico
                        </button>
                    </div>

                    <!-- Resumen de vencimientos -->
                    <div id="medicalSummary" class="grid md:grid-cols-3 gap-4 mb-6"></div>

                    <div id="medicalList" class="space-y-3"></div>
                </div>

                <div id="newMedicalForm" class="hidden bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Nuevo Examen M√©dico</h3>
                    <form onsubmit="saveMedical(event)" class="space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <input type="text" name="legajo" required placeholder="Legajo del trabajador *" class="border border-gray-300 rounded-lg p-3">
                            <input type="text" name="nombre_completo" required placeholder="Nombre completo *" class="border border-gray-300 rounded-lg p-3">
                        </div>

                        <div class="grid md:grid-cols-3 gap-4">
                            <input type="text" name="puesto" required placeholder="Puesto de trabajo *" class="border border-gray-300 rounded-lg p-3">
                            <input type="text" name="sector" placeholder="Sector/√Årea" class="border border-gray-300 rounded-lg p-3">
                            <input type="date" name="fecha_ingreso" placeholder="Fecha de ingreso" class="border border-gray-300 rounded-lg p-3">
                        </div>

                        <div class="border border-gray-300 rounded-lg p-4">
                            <h4 class="font-bold mb-3">Datos del Examen</h4>
                            <div class="grid md:grid-cols-2 gap-4">
                                <select name="tipo_examen" required class="border border-gray-300 rounded-lg p-3">
                                    <option value="">Tipo de examen *</option>
                                    <option value="Preocupacional">Preocupacional</option>
                                    <option value="Peri√≥dico">Peri√≥dico</option>
                                    <option value="Previo a transferencia">Previo a transferencia</option>
                                    <option value="Posterior a ausencia prolongada">Posterior a ausencia prolongada</option>
                                    <option value="Previo a terminaci√≥n de relaci√≥n laboral">Previo a terminaci√≥n de relaci√≥n laboral</option>
                                </select>
                                <input type="date" name="fecha_examen" required class="border border-gray-300 rounded-lg p-3">
                            </div>

                            <div class="grid md:grid-cols-2 gap-4 mt-3">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Resultado</label>
                                    <select name="resultado" required class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="Apto">Apto</option>
                                        <option value="Apto con observaciones">Apto con observaciones</option>
                                        <option value="No apto">No apto</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Pr√≥ximo Control</label>
                                    <input type="date" name="proximo_control" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-4">
                            <input type="text" name="medico" placeholder="M√©dico examinador" class="border border-gray-300 rounded-lg p-3">
                            <input type="text" name="matricula_medico" placeholder="Matr√≠cula" class="border border-gray-300 rounded-lg p-3">
                        </div>

                        <textarea name="observaciones" placeholder="Observaciones y recomendaciones" rows="3" class="border border-gray-300 rounded-lg p-3 w-full"></textarea>

                        <div class="bg-yellow-50 border border-yellow-300 rounded p-3 text-sm">
                            <p><strong>‚ö†Ô∏è Recordatorio:</strong> Los resultados detallados y datos cl√≠nicos deben mantenerse en la historia cl√≠nica del trabajador bajo custodia del servicio m√©dico. Este registro es solo para fines administrativos y de seguimiento.</p>
                        </div>

                        <div class="flex gap-3">
                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold flex-1 transition">
                                <i class="fas fa-save"></i> Guardar Examen
                            </button>
                            <button type="button" onclick="cancelNewMedical()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-semibold transition">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="nioshView" class="hidden">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">üí™ Calculadora NIOSH</h2>
                    <p class="text-sm text-gray-600 mb-6">C√°lculo de la ecuaci√≥n NIOSH para determinar el l√≠mite de peso recomendado (RWL) y el √≠ndice de levantamiento (LI) en tareas de manipulaci√≥n manual de cargas.</p>

                    <div class="grid md:grid-cols-2 gap-6">
                        <!-- Formulario de entrada -->
                        <div class="space-y-4">
                            <h3 class="font-bold text-lg text-blue-800">Par√°metros de la Tarea</h3>
                            
                            <div>
                                <label class="block text-sm font-semibold mb-2">Peso de la carga (kg) *</label>
                                <input type="number" id="niosh_peso" step="0.1" min="0" placeholder="Ej: 15" class="border border-gray-300 rounded-lg p-3 w-full">
                            </div>

                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Distancia horizontal (cm) *</label>
                                    <input type="number" id="niosh_h" step="1" min="0" placeholder="25-63" class="border border-gray-300 rounded-lg p-3 w-full">
                                    <p class="text-xs text-gray-500 mt-1">Desde el punto medio entre tobillos hasta el centro de agarre</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Altura inicial (cm) *</label>
                                    <input type="number" id="niosh_v" step="1" min="0" max="175" placeholder="0-175" class="border border-gray-300 rounded-lg p-3 w-full">
                                    <p class="text-xs text-gray-500 mt-1">Altura del agarre al inicio</p>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold mb-2">Desplazamiento vertical (cm) *</label>
                                <input type="number" id="niosh_d" step="1" min="0" placeholder="Ej: 50" class="border border-gray-300 rounded-lg p-3 w-full">
                                <p class="text-xs text-gray-500 mt-1">Diferencia entre altura inicial y final</p>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold mb-2">√Ångulo de asimetr√≠a (grados) *</label>
                                <input type="number" id="niosh_a" step="1" min="0" max="135" placeholder="0-135" class="border border-gray-300 rounded-lg p-3 w-full">
                                <p class="text-xs text-gray-500 mt-1">Giro del tronco respecto al plano sagital</p>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold mb-2">Frecuencia (levantamientos/minuto) *</label>
                                <input type="number" id="niosh_f" step="0.1" min="0" placeholder="Ej: 1" class="border border-gray-300 rounded-lg p-3 w-full">
                            </div>

                            <div>
                                <label class="block text-sm font-semibold mb-2">Duraci√≥n de la tarea *</label>
                                <select id="niosh_duracion" class="border border-gray-300 rounded-lg p-3 w-full">
                                    <option value="1">‚â§ 1 hora</option>
                                    <option value="2">1-2 horas</option>
                                    <option value="8">2-8 horas</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold mb-2">Calidad del agarre *</label>
                                <select id="niosh_agarre" class="border border-gray-300 rounded-lg p-3 w-full">
                                    <option value="bueno">Bueno</option>
                                    <option value="regular">Regular</option>
                                    <option value="malo">Malo</option>
                                </select>
                            </div>

                            <button onclick="calculateNIOSH()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold w-full transition">
                                üßÆ Calcular RWL y LI
                            </button>
                        </div>

                        <!-- Resultados -->
                        <div>
                            <h3 class="font-bold text-lg text-green-800 mb-4">Resultados</h3>
                            <div id="nioshResults" class="space-y-4">
                                <div class="bg-gray-50 p-4 rounded text-center text-gray-500">
                                    Complete los par√°metros y presione "Calcular"
                                </div>
                            </div>

                            <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm">
                                <h4 class="font-bold mb-2">Interpretaci√≥n del √çndice de Levantamiento (LI)</h4>
                                <ul class="space-y-1">
                                    <li><strong class="text-green-600">LI ‚â§ 1.0:</strong> Riesgo limitado, mayor√≠a de trabajadores puede realizar la tarea</li>
                                    <li><strong class="text-yellow-600">1.0 &lt; LI ‚â§ 3.0:</strong> Riesgo incrementado para algunos trabajadores</li>
                                    <li><strong class="text-red-600">LI &gt; 3.0:</strong> Riesgo elevado, se requieren cambios ergon√≥micos</li>
                                </ul>
                            </div>

                            <div class="mt-4 text-xs text-gray-600">
                                <p><strong>Ecuaci√≥n NIOSH:</strong></p>
                                <p class="mt-1">RWL = LC √ó HM √ó VM √ó DM √ó AM √ó FM √ó CM</p>
                                <p class="mt-1"><strong>√çndice de Levantamiento:</strong></p>
                                <p>LI = Peso de la carga / RWL</p>
                                <p class="mt-2"><strong>Constante de carga (LC):</strong> 23 kg</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Management Module -->
            <div id="datamanagementView" class="hidden">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6"><i class="fas fa-save"></i> Gesti√≥n de Datos</h2>
                    
                    <!-- Export Section -->
                    <div class="mb-8 p-6 bg-blue-50 border border-blue-200 rounded-lg">
                        <h3 class="text-xl font-bold text-blue-800 mb-3">üì§ Exportar Datos</h3>
                        <p class="text-sm text-gray-700 mb-4">Descarga todos tus datos (incluyendo fotos) en un archivo JSON que podr√°s importar m√°s tarde.</p>
                        <button onclick="exportAllData()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition">
                            üì• Descargar Datos Completos
                        </button>
                    </div>

                    <!-- Import Section -->
                    <div class="mb-8 p-6 bg-green-50 border border-green-200 rounded-lg">
                        <h3 class="text-xl font-bold text-green-800 mb-3">üì• Importar Datos</h3>
                        <p class="text-sm text-gray-700 mb-4">Carga un archivo JSON previamente exportado para restaurar tus datos.</p>
                        <input type="file" id="importFileInput" accept=".json" class="hidden" onchange="importAllData(event)">
                        <button onclick="document.getElementById('importFileInput').click()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition">
                            üì§ Cargar Archivo de Datos
                        </button>
                    </div>

                    <!-- Reset Section -->
                    <div class="p-6 bg-red-50 border border-red-200 rounded-lg">
                        <h3 class="text-xl font-bold text-red-800 mb-3">üóëÔ∏è Restablecer Datos</h3>
                        <p class="text-sm text-gray-700 mb-4">‚ö†Ô∏è <strong>ATENCI√ìN:</strong> Esta acci√≥n eliminar√° TODOS los datos de forma permanente. Se recomienda exportar antes de restablecer.</p>
                        <button onclick="resetAllData()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-semibold transition">
                            üóëÔ∏è Eliminar Todos los Datos
                        </button>
                    </div>

                    <!-- Info Section -->
                    <div class="mt-6 p-4 bg-gray-100 rounded-lg text-sm text-gray-700">
                        <p class="font-bold mb-2">‚ÑπÔ∏è Informaci√≥n sobre el backup:</p>
                        <ul class="list-disc list-inside space-y-1">
                            <li>El archivo exportado incluye todas las fotos en formato base64</li>
                            <li>Guarda el archivo en un lugar seguro (nube, disco externo)</li>
                            <li>El archivo es compatible solo con esta versi√≥n de la aplicaci√≥n</li>
                            <li>Los datos se almacenan localmente en tu navegador</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- About View -->
            <div id="aboutView" class="hidden">
                <div class="bg-white rounded-lg shadow-md p-8">
                    <div class="text-center mb-8">
                        <div class="inline-flex items-center justify-center w-24 h-24 bg-gradient-to-br from-blue-500 to-blue-700 rounded-full mb-6 shadow-lg">
                            <i class="fas fa-shield-alt text-white text-5xl"></i>
                        </div>
                        <h2 class="text-3xl font-bold text-gray-800 mb-2">
                            Sistema de Seguridad e Higiene
                        </h2>
                        <p class="text-lg text-gray-600">
                            Versi√≥n 1.0 - Argentina
                        </p>
                    </div>

                    <div class="max-w-2xl mx-auto space-y-6">
                        <!-- Desarrollador -->
                        <div class="p-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border-l-4 border-blue-600">
                            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-user-tie text-blue-600 mr-3"></i>
                                Desarrollador
                            </h3>
                            <div class="space-y-2 text-gray-700">
                                <p class="text-lg font-semibold">Maximiliano Pechieu</p>
                                <p class="flex items-center">
                                    <i class="fas fa-graduation-cap text-blue-600 mr-2"></i>
                                    T√©cnico en Seguridad y Salud Ocupacional
                                </p>
                                <p class="flex items-center">
                                    <i class="fas fa-calendar-alt text-blue-600 mr-2"></i>
                                    A√±o 2025
                                </p>
                            </div>
                        </div>

                        <!-- Contacto -->
                        <div class="p-6 bg-gradient-to-r from-green-50 to-teal-50 rounded-lg border-l-4 border-green-600">
                            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-envelope text-green-600 mr-3"></i>
                                Contacto
                            </h3>
                            <div class="space-y-2">
                                <p class="text-gray-700 flex items-center">
                                    <i class="fas fa-at text-green-600 mr-2"></i>
                                    <a href="mailto:maxipechieu@gmail.com" class="text-green-700 hover:text-green-800 font-semibold hover:underline transition">
                                        maxipechieu@gmail.com
                                    </a>
                                </p>
                                <p class="text-gray-700 flex items-center">
                                    <i class="fas fa-phone text-green-600 mr-2"></i>
                                    <a href="tel:+5492644432242" class="text-green-700 hover:text-green-800 font-semibold hover:underline transition">
                                        +54 9 2644432242
                                    </a>
                                </p>
                            </div>
                        </div>

                        <!-- Descripci√≥n del Sistema -->
                        <div class="p-6 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg border-l-4 border-purple-600">
                            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-info-circle text-purple-600 mr-3"></i>
                                Acerca del Sistema
                            </h3>
                            <div class="text-gray-700 space-y-3">
                                <p>
                                    Sistema integral de gesti√≥n de Seguridad e Higiene en el Trabajo desarrollado espec√≠ficamente para cumplir con la normativa argentina vigente.
                                </p>
                                <div class="mt-4">
                                    <p class="font-semibold mb-2">Normativas incluidas:</p>
                                    <ul class="list-disc list-inside space-y-1 text-sm ml-4">
                                        <li>Ley 19.587 - Higiene y Seguridad en el Trabajo</li>
                                        <li>Decreto 351/79 - Reglamentaci√≥n</li>
                                        <li>Ley 24.557 - Riesgos del Trabajo</li>
                                        <li>Resoluciones SRT (295/03, 905/15, 960/15, entre otras)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Caracter√≠sticas -->
                        <div class="p-6 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg border-l-4 border-yellow-600">
                            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-star text-yellow-600 mr-3"></i>
                                Caracter√≠sticas Principales
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-gray-700">
                                <div class="flex items-start">
                                    <i class="fas fa-check-circle text-green-600 mr-2 mt-1"></i>
                                    <span>Gesti√≥n de inspecciones y checklists</span>
                                </div>
                                <div class="flex items-start">
                                    <i class="fas fa-check-circle text-green-600 mr-2 mt-1"></i>
                                    <span>Control de extintores y carga de fuego</span>
                                </div>
                                <div class="flex items-start">
                                    <i class="fas fa-check-circle text-green-600 mr-2 mt-1"></i>
                                    <span>Matriz de riesgos y acciones correctivas</span>
                                </div>
                                <div class="flex items-start">
                                    <i class="fas fa-check-circle text-green-600 mr-2 mt-1"></i>
                                    <span>Registro de capacitaciones y EPP</span>
                                </div>
                                <div class="flex items-start">
                                    <i class="fas fa-check-circle text-green-600 mr-2 mt-1"></i>
                                    <span>Formularios RGRL (A y B)</span>
                                </div>
                                <div class="flex items-start">
                                    <i class="fas fa-check-circle text-green-600 mr-2 mt-1"></i>
                                    <span>Gesti√≥n documental completa</span>
                                </div>
                                <div class="flex items-start">
                                    <i class="fas fa-check-circle text-green-600 mr-2 mt-1"></i>
                                    <span>Dashboard con KPIs</span>
                                </div>
                                <div class="flex items-start">
                                    <i class="fas fa-check-circle text-green-600 mr-2 mt-1"></i>
                                    <span>Exportaci√≥n e importaci√≥n de datos</span>
                                </div>
                            </div>
                        </div>

                        <!-- Tecnolog√≠a -->
                        <div class="p-6 bg-gradient-to-r from-gray-50 to-slate-50 rounded-lg border-l-4 border-gray-600">
                            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-code text-gray-600 mr-3"></i>
                                Tecnolog√≠a
                            </h3>
                            <div class="text-sm text-gray-700">
                                <p>
                                    Aplicaci√≥n web progresiva (PWA) que funciona completamente offline. Los datos se almacenan localmente en el navegador utilizando localStorage.
                                </p>
                                <div class="mt-3 flex flex-wrap gap-2">
                                    <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-semibold">HTML5</span>
                                    <span class="px-3 py-1 bg-cyan-100 text-cyan-800 rounded-full text-xs font-semibold">TailwindCSS</span>
                                    <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-semibold">JavaScript</span>
                                    <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">Chart.js</span>
                                    <span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-xs font-semibold">jsPDF</span>
                                </div>
                            </div>
                        </div>

                        <!-- Nota Final -->
                        <div class="text-center p-6 bg-gray-100 rounded-lg">
                            <p class="text-sm text-gray-600">
                                <i class="fas fa-heart text-red-500"></i> Desarrollado con dedicaci√≥n para mejorar la seguridad laboral en Argentina
                            </p>
                            <p class="text-xs text-gray-500 mt-2">
                                ¬© 2025 - Todos los derechos reservados
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Documents Management View -->
            <div id="documentsView" class="hidden space-y-6">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-folder-open text-teal-600"></i> Gesti√≥n Documental</h2>
                        <button onclick="exportDocumentsSummary()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                            üì• Exportar Resumen
                        </button>
                    </div>

                    <div class="mb-6 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-600">
                        <p class="text-sm text-gray-700">
                            <strong><i class="fas fa-clipboard-list"></i> Control de Documentaci√≥n Obligatoria para San Juan, Argentina</strong><br>
                            Gestione el estado de toda la documentaci√≥n requerida por SRT, Municipalidad, Bomberos, OSSE y organismos ambientales seg√∫n normativa provincial y nacional.
                        </p>
                    </div>

                    <!-- Category Tabs -->
                    <div class="flex flex-wrap gap-2 mb-6 border-b border-gray-200 pb-2">
                        <button onclick="showDocCategory('laboralSeguridad')" id="tab-laboralSeguridad" class="px-4 py-2 font-semibold text-sm rounded-t transition bg-teal-600 text-white">
                            <i class="fas fa-building"></i> Laboral y S&H
                        </button>
                        <button onclick="showDocCategory('habilitacion')" id="tab-habilitacion" class="px-3 py-2 font-semibold text-sm rounded-t transition text-gray-600 hover:bg-gray-100">
                            <i class="fas fa-building text-blue-600"></i> Habilitaciones
                        </button>
                        <button onclick="showDocCategory('incendios')" id="tab-incendios" class="px-3 py-2 font-semibold text-sm rounded-t transition text-gray-600 hover:bg-gray-100">
                            <i class="fas fa-fire text-red-600"></i> Incendios
                        </button>
                        <button onclick="showDocCategory('ambiental')" id="tab-ambiental" class="px-3 py-2 font-semibold text-sm rounded-t transition text-gray-600 hover:bg-gray-100">
                            üåø Ambiental
                        </button>
                        <button onclick="showDocCategory('sanitario')" id="tab-sanitario" class="px-3 py-2 font-semibold text-sm rounded-t transition text-gray-600 hover:bg-gray-100">
                            üíß Sanitario
                        </button>
                        <button onclick="showDocCategory('salud')" id="tab-salud" class="px-3 py-2 font-semibold text-sm rounded-t transition text-gray-600 hover:bg-gray-100">
                            ‚öïÔ∏è Salud
                        </button>
                        <button onclick="showDocCategory('complementaria')" id="tab-complementaria" class="px-3 py-2 font-semibold text-sm rounded-t transition text-gray-600 hover:bg-gray-100">
                            üìë Complementaria
                        </button>
                    </div>

                    <!-- Document Categories Content -->
                    <div id="docContent-laboralSeguridad" class="doc-category-content">
                        <h3 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-clipboard-list"></i> Documentaci√≥n Laboral y de Seguridad e Higiene</h3>
                        <p class="text-sm text-gray-600 mb-4">Responsabilidad directa del Lic. en Seguridad e Higiene (SRT, Ministerio de Trabajo, ART)</p>
                        <div id="laboralSeguridadList" class="space-y-3"></div>
                        <button onclick="showAddDocument('laboralSeguridad')" class="mt-4 bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                            <i class="fas fa-plus-circle"></i> Agregar Documento
                        </button>
                    </div>

                    <div id="docContent-habilitacion" class="doc-category-content hidden">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">  <i class="fas fa-building text-blue-600"></i> Habilitaci√≥n Comercial y Edilicia</h3>
                        <p class="text-sm text-gray-600 mb-4">Responsabilidad compartida (verificaci√≥n de seguridad por el higienista)</p>
                        <div id="habilitacionList" class="space-y-3"></div>
                        <button onclick="showAddDocument('habilitacion')" class="mt-4 bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                            <i class="fas fa-plus-circle"></i> Agregar Documento
                        </button>
                    </div>

                    <div id="docContent-incendios" class="doc-category-content hidden">
                        <h3 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-fire text-red-600"></i> Prevenci√≥n de Incendios</h3>
                        <p class="text-sm text-gray-600 mb-4">Responsabilidad compartida (Bomberos ‚Äì Polic√≠a de San Juan)</p>
                        <div id="incendiosList" class="space-y-3"></div>
                        <button onclick="showAddDocument('incendios')" class="mt-4 bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                            <i class="fas fa-plus-circle"></i> Agregar Documento
                        </button>
                    </div>

                    <div id="docContent-ambiental" class="doc-category-content hidden">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">üåø Cuestiones Ambientales</h3>
                        <p class="text-sm text-gray-600 mb-4">Responsabilidad de coordinaci√≥n y control</p>
                        <div id="ambientalList" class="space-y-3"></div>
                        <button onclick="showAddDocument('ambiental')" class="mt-4 bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                            <i class="fas fa-plus-circle"></i> Agregar Documento
                        </button>
                    </div>

                    <div id="docContent-sanitario" class="doc-category-content hidden">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">üíß Aspectos Sanitarios y de OSSE</h3>
                        <p class="text-sm text-gray-600 mb-4">Responsabilidad de verificaci√≥n</p>
                        <div id="sanitarioList" class="space-y-3"></div>
                        <button onclick="showAddDocument('sanitario')" class="mt-4 bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                            <i class="fas fa-plus-circle"></i> Agregar Documento
                        </button>
                    </div>

                    <div id="docContent-salud" class="doc-category-content hidden">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">‚öïÔ∏è Salud Laboral</h3>
                        <p class="text-sm text-gray-600 mb-4">Responsabilidad compartida con el Servicio M√©dico Laboral y la ART</p>
                        <div id="saludList" class="space-y-3"></div>
                        <button onclick="showAddDocument('salud')" class="mt-4 bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                            <i class="fas fa-plus-circle"></i> Agregar Documento
                        </button>
                    </div>

                    <div id="docContent-complementaria" class="doc-category-content hidden">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">üìë Documentaci√≥n Complementaria Obligatoria</h3>
                        <p class="text-sm text-gray-600 mb-4">Debe mantenerse disponible en todo momento</p>
                        <div id="complementariaList" class="space-y-3"></div>
                        <button onclick="showAddDocument('complementaria')" class="mt-4 bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                            <i class="fas fa-plus-circle"></i> Agregar Documento
                        </button>
                    </div>

                    <!-- Summary Section -->
                    <div class="mt-8 grid md:grid-cols-3 gap-4">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="text-2xl font-bold text-green-700" id="docCompleteCount">0</div>
                            <div class="text-sm text-green-600">Documentos al d√≠a</div>
                        </div>
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <div class="text-2xl font-bold text-yellow-700" id="docPendingCount">0</div>
                            <div class="text-sm text-yellow-600">Por vencer (30 d√≠as)</div>
                        </div>
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="text-2xl font-bold text-red-700" id="docExpiredCount">0</div>
                            <div class="text-sm text-red-600">Vencidos o faltantes</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RGRL View -->
            <div id="rgrlView" class="hidden">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-gray-800"><i class="fas fa-clipboard-list"></i> RGRL - Relevamiento General de Riesgos Laborales</h2>
                        <div class="flex gap-2">
                            <button onclick="showNewRGRLForm()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-semibold transition">
                                <i class="fas fa-plus-circle"></i> Nuevo Formulario
                            </button>
                        </div>
                    </div>

                    <!-- Lista de Formularios Guardados -->
                    <div id="rgrlListContainer" class="mb-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Formularios Guardados</h3>
                        <div id="rgrlFormsList" class="space-y-3">
                            <!-- Los formularios se cargar√°n aqu√≠ din√°micamente -->
                        </div>
                    </div>

                    <!-- Formulario RGRL (oculto inicialmente) -->
                    <div id="rgrlFormContainer" class="hidden">
                        <div class="flex items-center justify-between mb-6 bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-xl font-bold text-gray-800">Formulario RGRL</h3>
                            <div class="flex gap-2">
                                <button onclick="saveRGRLForm()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold transition">
                                    <i class="fas fa-save"></i> Guardar
                                </button>
                                <button onclick="exportRGRLToPDF()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-semibold transition">
                                    <i class="fas fa-file-pdf"></i> Exportar PDF
                                </button>
                                <button onclick="cancelRGRLForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-semibold transition">
                                    ‚úï Cancelar
                                </button>
                            </div>
                        </div>

                        <!-- Datos Generales del Establecimiento -->
                        <div class="border border-gray-300 rounded-lg p-6 mb-6 bg-yellow-50">
                            <h3 class="font-bold text-xl mb-4 text-gray-800">DATOS GENERALES DEL ESTABLECIMIENTO</h3>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Nombre de la Empresa *</label>
                                    <input type="text" id="rgrlEmpresaNombre" class="border border-gray-300 rounded-lg p-3 w-full" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">CUIT / CUIP *</label>
                                    <input type="text" id="rgrlCuit" placeholder="XX-XXXXXXXX-X" class="border border-gray-300 rounded-lg p-3 w-full" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">N¬∫ de Establecimiento</label>
                                    <input type="text" id="rgrlNumEstablecimiento" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">CIIU (Actividad Econ√≥mica - Revisi√≥n 3) *</label>
                                    <input type="text" id="rgrlCiiu" class="border border-gray-300 rounded-lg p-3 w-full" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Superficie del Establecimiento (m¬≤)</label>
                                    <input type="number" id="rgrlSuperficie" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">C√≥digo de Actividad (Form. AFIP N¬∫150)</label>
                                    <input type="text" id="rgrlCodigoActividad" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Cantidad de Trabajadores</label>
                                    <input type="number" id="rgrlCantTrabajadores" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Breve Descripci√≥n de la Actividad *</label>
                                    <textarea id="rgrlDescActividad" rows="2" class="border border-gray-300 rounded-lg p-3 w-full" required></textarea>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Domicilio *</label>
                                    <input type="text" id="rgrlDomicilio" class="border border-gray-300 rounded-lg p-3 w-full" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Provincia</label>
                                    <input type="text" id="rgrlProvincia" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">C√≥digo Postal</label>
                                    <input type="text" id="rgrlCodigoPostal" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Localidad</label>
                                    <input type="text" id="rgrlLocalidad" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Tel√©fono</label>
                                    <input type="tel" id="rgrlTelefono" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                            </div>
                        </div>

                        <!-- Formulario Completo (sin pesta√±as) -->
                        <div id="rgrlFormulario" class="space-y-6">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                                <h3 class="font-bold text-lg mb-2">Instrucciones</h3>
                                <p class="text-sm text-gray-700">Complete el formulario marcando S√ç, NO o NO APLICA seg√∫n corresponda. Para las fechas de regularizaci√≥n, utilice el selector de fecha. Este relevamiento debe actualizarse anualmente.</p>
                            </div>

                            <!-- Tablas din√°micas se cargar√°n aqu√≠ con JavaScript -->
                            <div id="rgrlTablesContainer"></div>

                            <!-- Planillas Adicionales integradas -->
                            <div class="mt-8 space-y-6">
                                <!-- Planilla A: Sustancias Cancer√≠genas -->
                                <div class="border border-gray-300 rounded-lg p-4">
                                    <h3 class="font-bold text-lg mb-4 bg-purple-100 p-2 rounded">PLANILLA A | LISTADO DE SUSTANCIAS Y AGENTES CANCER√çGENOS</h3>
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm border-collapse">
                                            <thead>
                                                <tr class="bg-gray-200">
                                                    <th class="border border-gray-300 p-2 text-left">Descripci√≥n</th>
                                                    <th class="border border-gray-300 p-2 text-center w-20">S√ç</th>
                                                    <th class="border border-gray-300 p-2 text-center w-20">NO</th>
                                                </tr>
                                            </thead>
                                            <tbody id="planillaATable"></tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Planilla B: Difenilos Policlorados (PCBs) -->
                                <div class="border border-gray-300 rounded-lg p-4">
                                    <h3 class="font-bold text-lg mb-4 bg-purple-100 p-2 rounded">PLANILLA B | DIFENILOS POLICLORADOS</h3>
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm border-collapse">
                                            <thead>
                                                <tr class="bg-gray-200">
                                                    <th class="border border-gray-300 p-2 text-left">Descripci√≥n</th>
                                                    <th class="border border-gray-300 p-2 text-center w-20">S√ç</th>
                                                    <th class="border border-gray-300 p-2 text-center w-20">NO</th>
                                                </tr>
                                            </thead>
                                            <tbody id="planillaBTable"></tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Planilla C: Sustancias Qu√≠micas -->
                                <div class="border border-gray-300 rounded-lg p-4">
                                    <h3 class="font-bold text-lg mb-4 bg-purple-100 p-2 rounded">PLANILLA C | SUSTANCIAS QU√çMICAS A DECLARAR</h3>
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm border-collapse">
                                            <thead>
                                                <tr class="bg-gray-200">
                                                    <th class="border border-gray-300 p-2 text-left">Descripci√≥n</th>
                                                    <th class="border border-gray-300 p-2 text-center w-32">Cantidad Umbral (TN)</th>
                                                    <th class="border border-gray-300 p-2 text-center w-20">S√ç</th>
                                                    <th class="border border-gray-300 p-2 text-center w-20">NO</th>
                                                </tr>
                                            </thead>
                                            <tbody id="planillaCTable"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RGRL OBRAS View -->
            <div id="rgrlObrasView" class="hidden">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-gray-800"><i class="fas fa-hard-hat text-yellow-700"></i> RGRL - Formulario B (Obras de Construcci√≥n)</h2>
                        <div class="flex gap-2">
                            <button onclick="showNewRGRLObrasForm()" class="bg-yellow-700 hover:bg-yellow-800 text-white px-6 py-2 rounded-lg font-semibold transition">
                                <i class="fas fa-plus-circle"></i> Nuevo Formulario
                            </button>
                        </div>
                    </div>

                    <!-- Lista de Formularios Guardados -->
                    <div id="rgrlObrasListContainer" class="mb-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Formularios Guardados</h3>
                        <div id="rgrlObrasFormsList" class="space-y-3">
                            <!-- Los formularios se cargar√°n aqu√≠ din√°micamente -->
                        </div>
                    </div>

                    <!-- Formulario RGRL Obras (oculto inicialmente) -->
                    <div id="rgrlObrasFormContainer" class="hidden">
                        <div class="flex items-center justify-between mb-6 bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-xl font-bold text-gray-800">Formulario RGRL - Obras</h3>
                            <div class="flex gap-2">
                                <button onclick="saveRGRLObrasForm()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold transition">
                                    <i class="fas fa-save"></i> Guardar
                                </button>
                                <button onclick="exportRGRLObrasToPDF()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-semibold transition">
                                    <i class="fas fa-file-pdf"></i> Exportar PDF
                                </button>
                                <button onclick="cancelRGRLObrasForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-semibold transition">
                                    ‚úï Cancelar
                                </button>
                            </div>
                        </div>

                        <!-- Datos Generales del Establecimiento -->
                        <div class="border border-gray-300 rounded-lg p-6 mb-6 bg-yellow-50">
                            <h3 class="font-bold text-xl mb-4 text-gray-800">DATOS GENERALES DEL ESTABLECIMIENTO (OBRA)</h3>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Nombre de la Empresa *</label>
                                    <input type="text" id="rgrlObrasEmpresaNombre" class="border border-gray-300 rounded-lg p-3 w-full" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">CUIT / CUIP *</label>
                                    <input type="text" id="rgrlObrasCuit" placeholder="XX-XXXXXXXX-X" class="border border-gray-300 rounded-lg p-3 w-full" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">N¬∫ de Establecimiento</label>
                                    <input type="text" id="rgrlObrasNumEstablecimiento" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">CIIU (Actividad Econ√≥mica - Revisi√≥n 3) *</label>
                                    <input type="text" id="rgrlObrasCiiu" class="border border-gray-300 rounded-lg p-3 w-full" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Superficie del Establecimiento (m¬≤)</label>
                                    <input type="number" id="rgrlObrasSuperficie" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">C√≥digo de Actividad (Form. AFIP N¬∫150)</label>
                                    <input type="text" id="rgrlObrasCodigoActividad" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Cantidad de Trabajadores</label>
                                    <input type="number" id="rgrlObrasCantTrabajadores" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Breve Descripci√≥n de la Actividad *</label>
                                    <textarea id="rgrlObrasDescActividad" rows="2" class="border border-gray-300 rounded-lg p-3 w-full" required></textarea>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Domicilio de la Obra *</label>
                                    <input type="text" id="rgrlObrasDomicilio" class="border border-gray-300 rounded-lg p-3 w-full" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Provincia</label>
                                    <input type="text" id="rgrlObrasProvincia" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">C√≥digo Postal</label>
                                    <input type="text" id="rgrlObrasCodigoPostal" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Localidad</label>
                                    <input type="text" id="rgrlObrasLocalidad" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Tel√©fono</label>
                                    <input type="tel" id="rgrlObrasTelefono" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                            </div>
                        </div>

                        <!-- Formulario Completo -->
                        <div id="rgrlObrasFormulario" class="space-y-6">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                                <h3 class="font-bold text-lg mb-2">Instrucciones</h3>
                                <p class="text-sm text-gray-700">Complete el formulario marcando S√ç, NO o NO APLICA seg√∫n corresponda para cada condici√≥n de seguridad en obra. Para las fechas de regularizaci√≥n, utilice el selector de fecha. Este relevamiento debe actualizarse anualmente y presentarse ante la ART.</p>
                            </div>

                            <!-- Tablas din√°micas se cargar√°n aqu√≠ con JavaScript -->
                            <div id="rgrlObrasTablesContainer"></div>

                            <!-- Planillas Adicionales integradas -->
                            <div class="mt-8 space-y-6">
                                <!-- Planilla A: Sustancias Cancer√≠genas -->
                                <div class="border border-gray-300 rounded-lg p-4">
                                    <h3 class="font-bold text-lg mb-4 bg-purple-100 p-2 rounded">PLANILLA A | LISTADO DE SUSTANCIAS Y AGENTES CANCER√çGENOS</h3>
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm border-collapse">
                                            <thead>
                                                <tr class="bg-gray-200">
                                                    <th class="border border-gray-300 p-2 text-left">Descripci√≥n</th>
                                                    <th class="border border-gray-300 p-2 text-center w-20">S√ç</th>
                                                    <th class="border border-gray-300 p-2 text-center w-20">NO</th>
                                                </tr>
                                            </thead>
                                            <tbody id="planillaObrasATable"></tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Planilla B: Difenilos Policlorados (PCBs) -->
                                <div class="border border-gray-300 rounded-lg p-4">
                                    <h3 class="font-bold text-lg mb-4 bg-purple-100 p-2 rounded">PLANILLA B | DIFENILOS POLICLORADOS</h3>
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm border-collapse">
                                            <thead>
                                                <tr class="bg-gray-200">
                                                    <th class="border border-gray-300 p-2 text-left">Descripci√≥n</th>
                                                    <th class="border border-gray-300 p-2 text-center w-20">S√ç</th>
                                                    <th class="border border-gray-300 p-2 text-center w-20">NO</th>
                                                </tr>
                                            </thead>
                                            <tbody id="planillaObrasBTable"></tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Planilla C: Sustancias Qu√≠micas -->
                                <div class="border border-gray-300 rounded-lg p-4">
                                    <h3 class="font-bold text-lg mb-4 bg-purple-100 p-2 rounded">PLANILLA C | SUSTANCIAS QU√çMICAS A DECLARAR</h3>
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm border-collapse">
                                            <thead>
                                                <tr class="bg-gray-200">
                                                    <th class="border border-gray-300 p-2 text-left">Descripci√≥n</th>
                                                    <th class="border border-gray-300 p-2 text-center w-32">Cantidad Umbral (TN)</th>
                                                    <th class="border border-gray-300 p-2 text-center w-20">S√ç</th>
                                                    <th class="border border-gray-300 p-2 text-center w-20">NO</th>
                                                </tr>
                                            </thead>
                                            <tbody id="planillaObrasCTable"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Add/Edit Document Modal -->
            <div id="documentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-2 sm:p-4 z-50">
                <div class="bg-white rounded-lg max-w-2xl w-full max-h-[85vh] flex flex-col m-2">
                    <!-- Header fijo -->
                    <div class="p-3 sm:p-6 flex-shrink-0 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg sm:text-2xl font-bold text-gray-800" id="documentModalTitle">Agregar Documento</h3>
                            <button onclick="closeDocumentModal()" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">‚úï</button>
                        </div>
                    </div>
                    
                    <!-- Contenido con scroll -->
                    <div class="p-3 sm:p-6 overflow-y-auto flex-1">
                        <form id="documentForm" onsubmit="saveDocument(event)" class="space-y-4">
                            <input type="hidden" id="documentId" name="id">
                            <input type="hidden" id="documentCategory" name="category">

                            <div class="grid md:grid-cols-2 gap-4">
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Tipo de Documento *</label>
                                    <select id="documentType" name="tipo" required class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="">Seleccionar...</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Estado *</label>
                                    <select name="estado" required class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="vigente">‚úÖ Vigente</option>
                                        <option value="por_vencer"><i class="fas fa-exclamation-triangle"></i> Por vencer</option>
                                        <option value="vencido">‚ùå Vencido</option>
                                        <option value="faltante"><i class="fas fa-inbox"></i> Faltante</option>
                                        <option value="en_tramite"><i class="fas fa-sync"></i> En tr√°mite</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Fecha de Emisi√≥n</label>
                                    <input type="date" name="fecha_emision" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>

                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Fecha de Vencimiento</label>
                                    <input type="date" name="fecha_vencimiento" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>

                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Responsable</label>
                                    <input type="text" name="responsable" placeholder="Nombre del responsable" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>

                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">N√∫mero de Expediente</label>
                                    <input type="text" name="numero_expediente" placeholder="Ej: EXP-2025-123" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>

                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Organismo Emisor</label>
                                    <input type="text" name="organismo" placeholder="Ej: SRT, Municipalidad, Bomberos" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>

                                <div class="md:col-span-2">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Observaciones</label>
                                    <textarea name="observaciones" rows="3" placeholder="Notas adicionales, requisitos pendientes, etc." class="border border-gray-300 rounded-lg p-3 w-full"></textarea>
                                </div>

                                <div class="md:col-span-2">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Archivo Adjunto</label>
                                    <input type="file" id="documentFileInput" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" class="border border-gray-300 rounded-lg p-2 w-full text-sm">
                                    <p class="text-xs text-gray-500 mt-1">PDF, im√°genes o documentos. M√°x. 5MB</p>
                                    <div id="documentFilePreview" class="mt-2"></div>
                                </div>
                            </div>

                            <div class="flex gap-3 pt-4">
                                <button type="submit" class="flex-1 bg-teal-600 hover:bg-teal-700 text-white px-6 py-3 rounded-lg font-semibold transition">
                                    <i class="fas fa-save"></i> Guardar Documento
                                </button>
                                <button type="button" onclick="closeDocumentModal()" class="px-6 py-3 border border-gray-300 rounded-lg font-semibold hover:bg-gray-50 transition">
                                    Cancelar
                                </button>
                            </div>
                        </form>
                    </div><!-- Cierre del contenido con scroll -->
                </div><!-- Cierre del modal blanco -->
            </div><!-- Cierre de documentModal -->

            <!-- Vehicles Management View -->
            <div id="vehiclesView" class="hidden">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-car"></i> Gesti√≥n de Movilidades</h2>
                        <div class="flex gap-2">
                            <button onclick="exportVehiclesPDF()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                                <i class="fas fa-file-pdf"></i> Exportar PDF
                            </button>
                            <button onclick="showNewVehicle()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                                ‚ûï Registrar Veh√≠culo
                            </button>
                        </div>
                    </div>

                    <!-- Info Panel -->
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <div class="ml-3 text-sm">
                                <p class="font-semibold text-blue-800">Registro seg√∫n normativa vigente</p>
                                <p class="text-blue-700 mt-1">Control de documentaci√≥n, elementos de seguridad, inspecciones peri√≥dicas y mantenimiento de veh√≠culos de la empresa.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="grid md:grid-cols-3 gap-3 mb-6">
                        <select id="vehicleFilterStatus" onchange="filterVehicles()" class="border border-gray-300 rounded-lg p-2">
                            <option value="">Todos los estados</option>
                            <option value="activo">Activo</option>
                            <option value="mantenimiento">En Mantenimiento</option>
                            <option value="inactivo">Inactivo</option>
                        </select>
                        <select id="vehicleFilterType" onchange="filterVehicles()" class="border border-gray-300 rounded-lg p-2">
                            <option value="">Todos los tipos</option>
                            <option value="automovil">Autom√≥vil</option>
                            <option value="camioneta">Camioneta</option>
                            <option value="camion">Cami√≥n</option>
                            <option value="furgon">Furg√≥n</option>
                            <option value="moto">Motocicleta</option>
                            <option value="otro">Otro</option>
                        </select>
                        <input type="text" id="vehicleSearch" onkeyup="filterVehicles()" placeholder="Buscar por patente, marca o modelo..." class="border border-gray-300 rounded-lg p-2">
                    </div>

                    <!-- Vehicles List -->
                    <div id="vehiclesList" class="space-y-3"></div>
                </div>

                <!-- New Vehicle Form -->
                <div id="newVehicleForm" class="hidden bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Nuevo Veh√≠culo</h3>
                    <form onsubmit="saveVehicle(event)" class="space-y-6">
                        <!-- Datos del Veh√≠culo -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-bold text-lg mb-3">Datos del Veh√≠culo</h4>
                            <div class="grid md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Patente *</label>
                                    <input type="text" name="patente" required placeholder="Ej: AA123BB" class="border border-gray-300 rounded-lg p-3 w-full uppercase">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Tipo de Veh√≠culo *</label>
                                    <select name="tipo" required class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="">Seleccionar...</option>
                                        <option value="automovil">Autom√≥vil</option>
                                        <option value="camioneta">Camioneta</option>
                                        <option value="camion">Cami√≥n</option>
                                        <option value="furgon">Furg√≥n</option>
                                        <option value="moto">Motocicleta</option>
                                        <option value="otro">Otro</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Estado *</label>
                                    <select name="estado" required class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="activo">Activo</option>
                                        <option value="mantenimiento">En Mantenimiento</option>
                                        <option value="inactivo">Inactivo</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Marca *</label>
                                    <input type="text" name="marca" required placeholder="Ej: Ford" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Modelo *</label>
                                    <input type="text" name="modelo" required placeholder="Ej: Ranger" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">A√±o</label>
                                    <input type="number" name="anio" min="1900" max="2030" placeholder="Ej: 2020" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Kilometraje Actual</label>
                                    <input type="number" name="kilometraje" min="0" placeholder="Ej: 45000" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Combustible</label>
                                    <select name="combustible" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="">Seleccionar...</option>
                                        <option value="nafta">Nafta</option>
                                        <option value="diesel">Diesel</option>
                                        <option value="gnc">GNC</option>
                                        <option value="electrico">El√©ctrico</option>
                                        <option value="hibrido">H√≠brido</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">N√∫mero de Chasis</label>
                                    <input type="text" name="chasis" placeholder="N√∫mero de chasis" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">N√∫mero de Motor</label>
                                    <input type="text" name="motor" placeholder="N√∫mero de motor" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                            </div>
                        </div>

                        <!-- Documentaci√≥n -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-bold text-lg mb-3">Documentaci√≥n</h4>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">C√©dula Verde/Azul</label>
                                    <select name="cedula" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="vigente">Vigente</option>
                                        <option value="vencida">Vencida</option>
                                        <option value="no_tiene">No Tiene</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Vencimiento C√©dula</label>
                                    <input type="date" name="cedula_vencimiento" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Seguro</label>
                                    <select name="seguro" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="vigente">Vigente</option>
                                        <option value="vencido">Vencido</option>
                                        <option value="no_tiene">No Tiene</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Vencimiento Seguro</label>
                                    <input type="date" name="seguro_vencimiento" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Compa√±√≠a de Seguro</label>
                                    <input type="text" name="seguro_compania" placeholder="Nombre de la compa√±√≠a" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">N√∫mero de P√≥liza</label>
                                    <input type="text" name="seguro_poliza" placeholder="N√∫mero de p√≥liza" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">VTV / RTO</label>
                                    <select name="vtv" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="vigente">Vigente</option>
                                        <option value="vencida">Vencida</option>
                                        <option value="no_tiene">No Tiene</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Vencimiento VTV</label>
                                    <input type="date" name="vtv_vencimiento" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                            </div>
                        </div>

                        <!-- Responsable y Observaciones -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-bold text-lg mb-3">Responsable y Observaciones</h4>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Conductor Habitual</label>
                                    <input type="text" name="conductor" placeholder="Nombre del conductor" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Sector Asignado</label>
                                    <input type="text" name="sector" placeholder="Ej: Operaciones, Mantenimiento" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-semibold mb-2">Observaciones</label>
                                    <textarea name="observaciones" rows="3" placeholder="Observaciones generales del veh√≠culo..." class="border border-gray-300 rounded-lg p-3 w-full"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Foto del Veh√≠culo -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-bold text-lg mb-3">Fotograf√≠a del Veh√≠culo</h4>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Adjuntar Foto</label>
                                <input type="file" id="vehiclePhotoInput" accept="image/*" class="border border-gray-300 rounded-lg p-2 w-full" onchange="previewVehiclePhoto(this, 'new')">
                                <p class="text-xs text-gray-500 mt-1">La imagen se comprimir√° autom√°ticamente para optimizar el almacenamiento</p>
                                <div id="vehiclePhotoPreview" class="mt-2"></div>
                            </div>
                        </div>

                        <div class="flex gap-3">
                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold flex-1 transition">
                                <i class="fas fa-save"></i> Guardar Veh√≠culo
                            </button>
                            <button type="button" onclick="cancelNewVehicle()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-semibold transition">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Vehicle Inspection Form -->
                <div id="vehicleInspectionForm" class="hidden bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Inspecci√≥n de Veh√≠culo</h3>
                    <form onsubmit="saveVehicleInspection(event)" class="space-y-6">
                        <input type="hidden" name="vehicle_id" id="inspectionVehicleId">
                        
                        <!-- Datos de la Inspecci√≥n -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-bold text-lg mb-3">Datos de la Inspecci√≥n</h4>
                            <div class="grid md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Fecha *</label>
                                    <input type="date" name="fecha" required class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Inspector *</label>
                                    <input type="text" name="inspector" required placeholder="Nombre del inspector" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Kilometraje</label>
                                    <input type="number" name="kilometraje" min="0" placeholder="Km actuales" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                            </div>
                        </div>

                        <!-- Elementos de Seguridad -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-bold text-lg mb-3">Elementos de Seguridad</h4>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div class="flex items-center gap-3">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" name="matafuegos" value="OK" class="w-5 h-5">
                                        <span class="font-semibold">Matafuegos</span>
                                    </label>
                                </div>
                                <div class="flex items-center gap-3">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" name="balizas" value="OK" class="w-5 h-5">
                                        <span class="font-semibold">Balizas Port√°tiles</span>
                                    </label>
                                </div>
                                <div class="flex items-center gap-3">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" name="botiquin" value="OK" class="w-5 h-5">
                                        <span class="font-semibold">Botiqu√≠n de Primeros Auxilios</span>
                                    </label>
                                </div>
                                <div class="flex items-center gap-3">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" name="rueda_auxilio" value="OK" class="w-5 h-5">
                                        <span class="font-semibold">Rueda de Auxilio</span>
                                    </label>
                                </div>
                                <div class="flex items-center gap-3">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" name="herramientas" value="OK" class="w-5 h-5">
                                        <span class="font-semibold">Herramientas (Crique, Llave)</span>
                                    </label>
                                </div>
                                <div class="flex items-center gap-3">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" name="chaleco" value="OK" class="w-5 h-5">
                                        <span class="font-semibold">Chaleco Reflectivo</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Estado del Veh√≠culo -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-bold text-lg mb-3">Estado del Veh√≠culo</h4>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Luces Delanteras</label>
                                    <select name="luces_delanteras" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="OK">OK</option>
                                        <option value="NOK">NOK</option>
                                        <option value="NA">N/A</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Luces Traseras</label>
                                    <select name="luces_traseras" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="OK">OK</option>
                                        <option value="NOK">NOK</option>
                                        <option value="NA">N/A</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Luces de Giro</label>
                                    <select name="luces_giro" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="OK">OK</option>
                                        <option value="NOK">NOK</option>
                                        <option value="NA">N/A</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Frenos</label>
                                    <select name="frenos" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="OK">OK</option>
                                        <option value="NOK">NOK</option>
                                        <option value="NA">N/A</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Neum√°ticos</label>
                                    <select name="neumaticos" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="OK">OK</option>
                                        <option value="NOK">NOK</option>
                                        <option value="NA">N/A</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Cinturones de Seguridad</label>
                                    <select name="cinturones" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="OK">OK</option>
                                        <option value="NOK">NOK</option>
                                        <option value="NA">N/A</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Espejos Retrovisores</label>
                                    <select name="espejos" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="OK">OK</option>
                                        <option value="NOK">NOK</option>
                                        <option value="NA">N/A</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Limpiaparabrisas</label>
                                    <select name="limpiaparabrisas" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="OK">OK</option>
                                        <option value="NOK">NOK</option>
                                        <option value="NA">N/A</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Bocina</label>
                                    <select name="bocina" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="OK">OK</option>
                                        <option value="NOK">NOK</option>
                                        <option value="NA">N/A</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Carrocer√≠a</label>
                                    <select name="carroceria" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="OK">OK</option>
                                        <option value="NOK">NOK</option>
                                        <option value="NA">N/A</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Niveles de Fluidos -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-bold text-lg mb-3">Niveles de Fluidos</h4>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Aceite de Motor</label>
                                    <select name="aceite_motor" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="OK">OK</option>
                                        <option value="NOK">NOK</option>
                                        <option value="NA">N/A</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">L√≠quido de Frenos</label>
                                    <select name="liquido_frenos" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="OK">OK</option>
                                        <option value="NOK">NOK</option>
                                        <option value="NA">N/A</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Refrigerante</label>
                                    <select name="refrigerante" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="OK">OK</option>
                                        <option value="NOK">NOK</option>
                                        <option value="NA">N/A</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">L√≠quido Limpiaparabrisas</label>
                                    <select name="liquido_limpia" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="OK">OK</option>
                                        <option value="NOK">NOK</option>
                                        <option value="NA">N/A</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Observaciones y Estado General -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-bold text-lg mb-3">Estado General</h4>
                            <div class="grid gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Estado General del Veh√≠culo</label>
                                    <select name="estado_general" required class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="apto">Apto para Circular</option>
                                        <option value="apto_con_observaciones">Apto con Observaciones</option>
                                        <option value="no_apto">No Apto para Circular</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Observaciones y Hallazgos</label>
                                    <textarea name="observaciones" rows="4" placeholder="Detallar cualquier deficiencia, anomal√≠a o recomendaci√≥n..." class="border border-gray-300 rounded-lg p-3 w-full"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Fotos de la Inspecci√≥n -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-bold text-lg mb-3">Fotograf√≠as de la Inspecci√≥n</h4>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Adjuntar Fotos</label>
                                <input type="file" id="inspectionPhotoInput" accept="image/*" multiple class="border border-gray-300 rounded-lg p-2 w-full" onchange="previewInspectionPhotos(this)">
                                <p class="text-xs text-gray-500 mt-1">Puede seleccionar m√∫ltiples fotos. Las im√°genes se comprimir√°n autom√°ticamente.</p>
                                <div id="inspectionPhotosPreview" class="mt-2 grid grid-cols-2 md:grid-cols-4 gap-2"></div>
                            </div>
                        </div>

                        <div class="flex gap-3">
                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold flex-1 transition">
                                <i class="fas fa-save"></i> Guardar Inspecci√≥n
                            </button>
                            <button type="button" onclick="cancelVehicleInspection()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-semibold transition">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Machinery Management View -->
            <div id="machineryView" class="hidden">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-cog"></i> Gesti√≥n de Maquinarias</h2>
                        <div class="flex gap-2">
                            <button onclick="exportMachineryPDF()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                                <i class="fas fa-file-pdf"></i> Exportar PDF
                            </button>
                            <button onclick="showNewMachinery()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition">
                                ‚ûï Registrar Maquinaria
                            </button>
                        </div>
                    </div>

                    <!-- Info Panel -->
                    <div class="bg-orange-50 border-l-4 border-orange-500 p-4 mb-6">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-orange-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <div class="ml-3 text-sm">
                                <p class="font-semibold text-orange-800">Control seg√∫n Dec. 351/79 Anexo V - Res. SRT 896/99</p>
                                <p class="text-orange-700 mt-1">Registro de protecciones, dispositivos de seguridad, habilitaciones, certificaciones y mantenimiento de maquinarias industriales.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="grid md:grid-cols-3 gap-3 mb-6">
                        <select id="machineryFilterStatus" onchange="filterMachinery()" class="border border-gray-300 rounded-lg p-2">
                            <option value="">Todos los estados</option>
                            <option value="operativo">Operativo</option>
                            <option value="mantenimiento">En Mantenimiento</option>
                            <option value="fuera_servicio">Fuera de Servicio</option>
                            <option value="baja">Dado de Baja</option>
                        </select>
                        <select id="machineryFilterType" onchange="filterMachinery()" class="border border-gray-300 rounded-lg p-2">
                            <option value="">Todos los tipos</option>
                            <option value="torno">Torno</option>
                            <option value="fresadora">Fresadora</option>
                            <option value="prensa">Prensa</option>
                            <option value="soldadora">Soldadora</option>
                            <option value="compresor">Compresor</option>
                            <option value="montacarga">Montacargas/Autoelevador</option>
                            <option value="puente_grua">Puente Gr√∫a</option>
                            <option value="cortadora">Cortadora</option>
                            <option value="cizalla">Cizalla</option>
                            <option value="taladro">Taladro</option>
                            <option value="otro">Otro</option>
                        </select>
                        <input type="text" id="machinerySearch" onkeyup="filterMachinery()" placeholder="Buscar por c√≥digo, marca o modelo..." class="border border-gray-300 rounded-lg p-2">
                    </div>

                    <!-- Machinery List -->
                    <div id="machineryList" class="space-y-3"></div>
                </div>

                <!-- New Machinery Form -->
                <div id="newMachineryForm" class="hidden bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Nueva Maquinaria</h3>
                    <form onsubmit="saveMachinery(event)" class="space-y-6">
                        <!-- Datos de la Maquinaria -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-bold text-lg mb-3">Datos de la Maquinaria</h4>
                            <div class="grid md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">C√≥digo/ID *</label>
                                    <input type="text" name="codigo" required placeholder="Ej: MAQ-001" class="border border-gray-300 rounded-lg p-3 w-full uppercase">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Tipo de Maquinaria *</label>
                                    <select name="tipo" required class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="">Seleccionar...</option>
                                        <option value="torno">Torno</option>
                                        <option value="fresadora">Fresadora</option>
                                        <option value="prensa">Prensa</option>
                                        <option value="soldadora">Soldadora</option>
                                        <option value="compresor">Compresor</option>
                                        <option value="montacarga">Montacargas/Autoelevador</option>
                                        <option value="puente_grua">Puente Gr√∫a</option>
                                        <option value="cortadora">Cortadora</option>
                                        <option value="cizalla">Cizalla</option>
                                        <option value="taladro">Taladro</option>
                                        <option value="otro">Otro</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Estado *</label>
                                    <select name="estado" required class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="operativo">Operativo</option>
                                        <option value="mantenimiento">En Mantenimiento</option>
                                        <option value="fuera_servicio">Fuera de Servicio</option>
                                        <option value="baja">Dado de Baja</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Marca *</label>
                                    <input type="text" name="marca" required placeholder="Ej: Bosch" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Modelo *</label>
                                    <input type="text" name="modelo" required placeholder="Ej: GWS 2000" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">A√±o de Fabricaci√≥n</label>
                                    <input type="number" name="anio" min="1900" max="2030" placeholder="Ej: 2018" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">N√∫mero de Serie</label>
                                    <input type="text" name="numero_serie" placeholder="N¬∞ de serie del fabricante" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Potencia/Capacidad</label>
                                    <input type="text" name="potencia" placeholder="Ej: 2000W, 5 Ton" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Tensi√≥n El√©ctrica</label>
                                    <select name="tension" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="">Seleccionar...</option>
                                        <option value="220V">220V Monof√°sico</option>
                                        <option value="380V">380V Trif√°sico</option>
                                        <option value="440V">440V Trif√°sico</option>
                                        <option value="no_electrica">No El√©ctrica</option>
                                        <option value="otra">Otra</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Ubicaci√≥n y Uso -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-bold text-lg mb-3">Ubicaci√≥n y Uso</h4>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Sector/√Årea *</label>
                                    <input type="text" name="sector" required placeholder="Ej: Taller Mec√°nico, Producci√≥n" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Ubicaci√≥n Espec√≠fica</label>
                                    <input type="text" name="ubicacion" placeholder="Ej: Nave 2, L√≠nea A" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Operador Habitual</label>
                                    <input type="text" name="operador" placeholder="Nombre del operador" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Turno de Operaci√≥n</label>
                                    <select name="turno" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="">Seleccionar...</option>
                                        <option value="ma√±ana">Ma√±ana</option>
                                        <option value="tarde">Tarde</option>
                                        <option value="noche">Noche</option>
                                        <option value="rotativo">Rotativo</option>
                                        <option value="continuo">Continuo 24hs</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Documentaci√≥n y Habilitaciones -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-bold text-lg mb-3">Documentaci√≥n y Habilitaciones</h4>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Manual de Operaci√≥n</label>
                                    <select name="manual" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="disponible">Disponible</option>
                                        <option value="no_disponible">No Disponible</option>
                                        <option value="solicitado">Solicitado al Fabricante</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Certificaci√≥n de Carga</label>
                                    <select name="certificacion_carga" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="no_aplica">No Aplica</option>
                                        <option value="vigente">Vigente</option>
                                        <option value="vencida">Vencida</option>
                                        <option value="pendiente">Pendiente</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Vencimiento Certificaci√≥n</label>
                                    <input type="date" name="cert_vencimiento" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Habilitaci√≥n de Operador</label>
                                    <select name="habilitacion_operador" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="no_requerida">No Requerida</option>
                                        <option value="vigente">Vigente</option>
                                        <option value="vencida">Vencida</option>
                                        <option value="pendiente">Pendiente</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Vencimiento Habilitaci√≥n</label>
                                    <input type="date" name="hab_vencimiento" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Puesta a Tierra</label>
                                    <select name="puesta_tierra" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="no_aplica">No Aplica</option>
                                        <option value="verificada">Verificada</option>
                                        <option value="pendiente">Pendiente Verificaci√≥n</option>
                                        <option value="deficiente">Deficiente</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Mantenimiento -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-bold text-lg mb-3">Mantenimiento Preventivo</h4>
                            <div class="grid md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Frecuencia de Mantenimiento</label>
                                    <select name="frecuencia_mant" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="">Seleccionar...</option>
                                        <option value="diario">Diario</option>
                                        <option value="semanal">Semanal</option>
                                        <option value="mensual">Mensual</option>
                                        <option value="trimestral">Trimestral</option>
                                        <option value="semestral">Semestral</option>
                                        <option value="anual">Anual</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">√öltimo Mantenimiento</label>
                                    <input type="date" name="ultimo_mantenimiento" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Pr√≥ximo Mantenimiento</label>
                                    <input type="date" name="proximo_mantenimiento" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                            </div>
                        </div>

                        <!-- Observaciones -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-bold text-lg mb-3">Informaci√≥n Adicional</h4>
                            <div class="grid gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Riesgos Principales</label>
                                    <textarea name="riesgos" rows="2" placeholder="Principales riesgos asociados a la operaci√≥n..." class="border border-gray-300 rounded-lg p-3 w-full"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Observaciones Generales</label>
                                    <textarea name="observaciones" rows="3" placeholder="Observaciones, historial de fallas, modificaciones, etc." class="border border-gray-300 rounded-lg p-3 w-full"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Foto de la Maquinaria -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-bold text-lg mb-3">Fotograf√≠a de la Maquinaria</h4>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Adjuntar Foto</label>
                                <input type="file" id="machineryPhotoInput" accept="image/*" class="border border-gray-300 rounded-lg p-2 w-full" onchange="previewMachineryPhoto(this, 'new')">
                                <p class="text-xs text-gray-500 mt-1">La imagen se comprimir√° autom√°ticamente para optimizar el almacenamiento</p>
                                <div id="machineryPhotoPreview" class="mt-2"></div>
                            </div>
                        </div>

                        <div class="flex gap-3">
                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold flex-1 transition">
                                <i class="fas fa-save"></i> Guardar Maquinaria
                            </button>
                            <button type="button" onclick="cancelNewMachinery()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-semibold transition">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Machinery Inspection Form -->
                <div id="machineryInspectionForm" class="hidden bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Inspecci√≥n de Maquinaria</h3>
                    <form onsubmit="saveMachineryInspection(event)" class="space-y-6">
                        <input type="hidden" name="machinery_id" id="inspectionMachineryId">
                        
                        <!-- Datos de la Inspecci√≥n -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-bold text-lg mb-3">Datos de la Inspecci√≥n</h4>
                            <div class="grid md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Fecha *</label>
                                    <input type="date" name="fecha" required class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Inspector *</label>
                                    <input type="text" name="inspector" required placeholder="Nombre del inspector" class="border border-gray-300 rounded-lg p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Tipo de Inspecci√≥n *</label>
                                    <select name="tipo_inspeccion" required class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="rutinaria">Rutinaria</option>
                                        <option value="preventiva">Preventiva</option>
                                        <option value="correctiva">Correctiva</option>
                                        <option value="auditoria">Auditor√≠a</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Protecciones de Seguridad (Dec. 351/79 Anexo V) -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-bold text-lg mb-3">Protecciones de Seguridad (Dec. 351/79 Anexo V)</h4>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Protecciones Mec√°nicas</label>
                                    <select name="protecciones_mecanicas" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="OK">OK - Presentes y Funcionando</option>
                                        <option value="NOK">NOK - Deficientes o Faltantes</option>
                                        <option value="NA">N/A - No Aplica</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Resguardos Fijos</label>
                                    <select name="resguardos_fijos" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="OK">OK</option>
                                        <option value="NOK">NOK</option>
                                        <option value="NA">N/A</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Resguardos M√≥viles</label>
                                    <select name="resguardos_moviles" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="OK">OK</option>
                                        <option value="NOK">NOK</option>
                                        <option value="NA">N/A</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Dispositivos de Parada de Emergencia</label>
                                    <select name="parada_emergencia" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="OK">OK</option>
                                        <option value="NOK">NOK</option>
                                        <option value="NA">N/A</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Se√±alizaci√≥n de Seguridad</label>
                                    <select name="senalizacion" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="OK">OK</option>
                                        <option value="NOK">NOK</option>
                                        <option value="NA">N/A</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Enclavamientos de Seguridad</label>
                                    <select name="enclavamientos" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="OK">OK</option>
                                        <option value="NOK">NOK</option>
                                        <option value="NA">N/A</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Seguridad El√©ctrica -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-bold text-lg mb-3">Seguridad El√©ctrica</h4>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Conexi√≥n a Tierra</label>
                                    <select name="conexion_tierra" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="OK">OK</option>
                                        <option value="NOK">NOK</option>
                                        <option value="NA">N/A</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Disyuntor Diferencial</label>
                                    <select name="disyuntor" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="OK">OK</option>
                                        <option value="NOK">NOK</option>
                                        <option value="NA">N/A</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Estado de Cables y Conexiones</label>
                                    <select name="cables" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="OK">OK</option>
                                        <option value="NOK">NOK</option>
                                        <option value="NA">N/A</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Tablero El√©ctrico</label>
                                    <select name="tablero_electrico" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="OK">OK</option>
                                        <option value="NOK">NOK</option>
                                        <option value="NA">N/A</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Estado Mec√°nico -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-bold text-lg mb-3">Estado Mec√°nico y Funcional</h4>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Estructura General</label>
                                    <select name="estructura" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="OK">OK</option>
                                        <option value="NOK">NOK</option>
                                        <option value="NA">N/A</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Componentes M√≥viles</label>
                                    <select name="componentes_moviles" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="OK">OK</option>
                                        <option value="NOK">NOK</option>
                                        <option value="NA">N/A</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Lubricaci√≥n</label>
                                    <select name="lubricacion" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="OK">OK</option>
                                        <option value="NOK">NOK</option>
                                        <option value="NA">N/A</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Sistema Hidr√°ulico/Neum√°tico</label>
                                    <select name="sistema_hidraulico" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="OK">OK</option>
                                        <option value="NOK">NOK</option>
                                        <option value="NA">N/A</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Niveles de Fluidos</label>
                                    <select name="niveles_fluidos" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="OK">OK</option>
                                        <option value="NOK">NOK</option>
                                        <option value="NA">N/A</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Ruidos/Vibraciones Anormales</label>
                                    <select name="ruidos_vibraciones" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="OK">OK - Sin Anomal√≠as</option>
                                        <option value="NOK">NOK - Detectadas</option>
                                        <option value="NA">N/A</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Controles y Comandos -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-bold text-lg mb-3">Controles y Comandos</h4>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Botoneras/Pulsadores</label>
                                    <select name="botoneras" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="OK">OK</option>
                                        <option value="NOK">NOK</option>
                                        <option value="NA">N/A</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Palancas/Manijas</label>
                                    <select name="palancas" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="OK">OK</option>
                                        <option value="NOK">NOK</option>
                                        <option value="NA">N/A</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Indicadores/Instrumentos</label>
                                    <select name="indicadores" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="OK">OK</option>
                                        <option value="NOK">NOK</option>
                                        <option value="NA">N/A</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Sistema de Control</label>
                                    <select name="sistema_control" class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="OK">OK</option>
                                        <option value="NOK">NOK</option>
                                        <option value="NA">N/A</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Conclusi√≥n -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-bold text-lg mb-3">Conclusi√≥n de la Inspecci√≥n</h4>
                            <div class="grid gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Estado General de la Maquinaria *</label>
                                    <select name="estado_general" required class="border border-gray-300 rounded-lg p-3 w-full">
                                        <option value="apto">Apto para Operar</option>
                                        <option value="apto_con_observaciones">Apto con Observaciones</option>
                                        <option value="no_apto">No Apto - Requiere Intervenci√≥n</option>
                                        <option value="fuera_servicio">Fuera de Servicio</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Hallazgos, Deficiencias y Recomendaciones</label>
                                    <textarea name="observaciones" rows="4" placeholder="Detallar deficiencias encontradas, acciones correctivas recomendadas, fechas l√≠mite..." class="border border-gray-300 rounded-lg p-3 w-full"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Acciones Correctivas Realizadas</label>
                                    <textarea name="acciones_correctivas" rows="3" placeholder="Acciones inmediatas tomadas durante la inspecci√≥n..." class="border border-gray-300 rounded-lg p-3 w-full"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Fotos de la Inspecci√≥n -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-bold text-lg mb-3">Fotograf√≠as de la Inspecci√≥n</h4>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Adjuntar Fotos</label>
                                <input type="file" id="machineryInspectionPhotoInput" accept="image/*" multiple class="border border-gray-300 rounded-lg p-2 w-full" onchange="previewMachineryInspectionPhotos(this)">
                                <p class="text-xs text-gray-500 mt-1">Puede seleccionar m√∫ltiples fotos. Las im√°genes se comprimir√°n autom√°ticamente.</p>
                                <div id="machineryInspectionPhotosPreview" class="mt-2 grid grid-cols-2 md:grid-cols-4 gap-2"></div>
                            </div>
                        </div>

                        <div class="flex gap-3">
                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold flex-1 transition">
                                <i class="fas fa-save"></i> Guardar Inspecci√≥n
                            </button>
                            <button type="button" onclick="cancelMachineryInspection()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-semibold transition">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </main>

        <!-- Inspection Details Modal -->
        <div id="inspectionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-2 sm:p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-[85vh] flex flex-col m-2">
                <!-- Header fijo siempre visible -->
                <div class="bg-white border-b border-gray-200 p-3 sm:p-6 flex justify-between items-center flex-shrink-0 rounded-t-lg">
                    <h2 class="text-lg sm:text-2xl font-bold text-gray-800"><i class="fas fa-clipboard-list"></i> Detalles de Inspecci√≥n</h2>
                    <div class="flex gap-1 sm:gap-2">
                        <button onclick="exportInspectionDetailPDF()" class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 sm:px-4 sm:py-2 rounded-lg font-semibold transition text-xs sm:text-sm">
                            <i class="fas fa-file-pdf"></i> <span class="hidden sm:inline">Exportar </span>PDF
                        </button>
                        <button onclick="closeInspectionModal()" class="text-gray-500 hover:text-gray-700 text-2xl sm:text-3xl font-bold leading-none">
                            √ó
                        </button>
                    </div>
                </div>
                <!-- Contenido con scroll -->
                <div id="inspectionModalContent" class="p-3 sm:p-6 overflow-y-auto flex-1">
                    <!-- Content will be dynamically loaded -->
                </div>
            </div>
        </div>

        <!-- Image Viewer Modal -->
        <div id="imageModal" class="hidden fixed inset-0 bg-black bg-opacity-90 z-[60] flex items-center justify-center p-4" onclick="closeImageModal()">
            <div class="relative max-w-7xl max-h-[95vh] w-full h-full flex items-center justify-center">
                <button onclick="closeImageModal()" class="absolute top-4 right-4 text-white text-4xl font-bold hover:text-gray-300 z-10">
                    √ó
                </button>
                <img id="imageModalImg" src="" class="max-w-full max-h-full object-contain rounded shadow-2xl" onclick="event.stopPropagation()" alt="Vista completa">
            </div>
        </div>

        <!-- Calendar Events Modal -->
        <div id="calendarEventsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-2 sm:p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[85vh] flex flex-col m-2">
                <!-- Header fijo siempre visible -->
                <div class="bg-white border-b border-gray-200 p-3 sm:p-6 flex justify-between items-center flex-shrink-0 rounded-t-lg">
                    <h2 id="calendarModalTitle" class="text-lg sm:text-2xl font-bold text-gray-800">üìÖ Eventos del d√≠a</h2>
                    <button onclick="closeCalendarModal()" class="text-gray-500 hover:text-gray-700 text-2xl sm:text-3xl font-bold leading-none">
                        √ó
                    </button>
                </div>
                <!-- Contenido con scroll -->
                <div id="calendarEventsContent" class="p-3 sm:p-6 overflow-y-auto flex-1">
                    <!-- Content will be dynamically loaded -->
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white py-6 mt-12 no-print">
            <div class="container mx-auto px-4 text-center">
                <p class="text-sm">
                    <i class="fas fa-clipboard-list"></i> Sistema de Seguridad e Higiene | Ley 19.587 - Decreto 351/79 - Resoluci√≥n SRT 905/2015 - Normas IRAM
                </p>
                <p class="text-xs text-gray-400 mt-2">
                    ‚ö†Ô∏è Herramienta de apoyo t√©cnico. No reemplaza el dictamen profesional oficial.
                </p>
            </div>
        </footer>
    </div>

    <script>
        // ============= SIDEBAR TOGGLE =============
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            const mainContent = document.getElementById('mainContent');
            
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
            
            if (window.innerWidth > 1024) {
                sidebar.classList.toggle('closed');
                mainContent.classList.toggle('expanded');
            }
        }
        
        // Responsive handling
        window.addEventListener('resize', () => {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            
            if (window.innerWidth > 1024) {
                overlay.classList.remove('active');
                sidebar.classList.remove('open');
            }
        });
        
        // Ajustar sidebar en load
        window.addEventListener('load', () => {
            if (window.innerWidth <= 1024) {
                document.getElementById('sidebar').classList.add('closed');
            }
        });
        
        // ============= DATA STRUCTURES =============
        const CHECKLIST_CATEGORIES = {
            'Incendio': [
                '¬øExtintores con carga vigente?',
                '¬øSe√±alizaci√≥n de equipos contra incendio visible?',
                '¬øDetectores de humo funcionales?',
                '¬øSalidas de emergencia despejadas?',
                '¬øPlano de evacuaci√≥n actualizado?'
            ],
            'Electricidad': [
                '¬øTableros el√©ctricos identificados y cerrados?',
                '¬øCables y conexiones en buen estado?',
                '¬øDisyuntores diferenciales funcionando?',
                '¬øPuesta a tierra verificada?'
            ],
            'EPP': [
                '¬øPersonal usa EPP adecuado?',
                '¬øEPP en buen estado de conservaci√≥n?',
                '¬øStock de EPP suficiente?',
                '¬øRegistros de entrega actualizados?'
            ],
            'Orden y Limpieza': [
                '¬ø√Åreas de trabajo ordenadas?',
                '¬øPasillos libres de obst√°culos?',
                '¬øResiduos clasificados correctamente?',
                '¬øSuperficies limpias y secas?'
            ],
            'Ergonom√≠a': [
                '¬øMobiliario ergon√≥mico adecuado?',
                '¬øIluminaci√≥n suficiente?',
                '¬øCargas manuales dentro de l√≠mites?'
            ],
            'Maquinaria': [
                '¬øProtecciones de m√°quinas instaladas?',
                '¬øBotoneras de emergencia accesibles?',
                '¬øMantenimiento preventivo al d√≠a?'
            ],
            'Se√±alizaci√≥n': [
                '¬øSe√±al√©tica completa y visible?',
                '¬øColores seg√∫n norma IRAM?',
                '¬øSe√±alizaci√≥n fotoluminiscente donde corresponde?'
            ]
        };

        const CHECKLIST_INFO = {
            'Incendio': {
                '¬øExtintores con carga vigente?': 'Los extintores deben recargarse anualmente y someterse a prueba hidr√°ulica cada 5 a√±os. La fecha de vencimiento debe estar visible en la etiqueta. Dec. 351/79 Cap. 18 - IRAM 3517.',
                '¬øSe√±alizaci√≥n de equipos contra incendio visible?': 'Se√±alizaci√≥n fotoluminiscente seg√∫n IRAM 10005. Debe ser visible desde 10m de distancia. Cartel con texto "EXTINTOR" y flecha indicadora. Altura recomendada: 2m desde el piso.',
                '¬øDetectores de humo funcionales?': 'Los detectores deben probarse mensualmente. Reemplazo cada 10 a√±os o seg√∫n especificaci√≥n del fabricante. Instalaci√≥n seg√∫n IRAM 3546. Uno cada 60-80 m¬≤ en techos de hasta 3m de altura.',
                '¬øSalidas de emergencia despejadas?': 'Las salidas deben estar libres de obst√°culos en todo momento. Ancho m√≠nimo 1.20m (2 unidades de salida). Puertas con apertura en sentido de evacuaci√≥n. Dec. 351/79 Art. 172-182.',
                '¬øPlano de evacuaci√≥n actualizado?': 'Debe estar visible en cada sector. Incluir: Usted est√° aqu√≠, rutas de evacuaci√≥n, punto de encuentro, extintores, alarmas. Actualizaci√≥n anual o ante cambios edilicios.'
            },
            'Electricidad': {
                '¬øTableros el√©ctricos identificados y cerrados?': 'Tableros con tapa y puerta con llave o herramienta. Identificaci√≥n clara de circuitos. Espacio libre m√≠nimo de 1m frente al tablero. Dec. 351/79 Cap. 14 - AEA 90364.',
                '¬øCables y conexiones en buen estado?': 'Cables sin deterioro visible, empalmes con cinta aisladora o bornera. Evitar cables sueltos o colgantes. Protecci√≥n mec√°nica donde haya tr√°nsito. Reemplazo ante signos de envejecimiento.',
                '¬øDisyuntores diferenciales funcionando?': 'Prueba con bot√≥n TEST mensualmente. Sensibilidad: 30mA para protecci√≥n de personas, 300mA para protecci√≥n contra incendios. Tiempo de actuaci√≥n < 30ms. AEA 90364-4-41.',
                '¬øPuesta a tierra verificada?': 'Resistencia < 10 Ohm para instalaciones en general, < 5 Ohm para √°reas peligrosas. Medici√≥n anual con telur√≥metro. Visual inspecci√≥n de jabalinas y conexiones. AEA 90364-5-54.'
            },
            'EPP': {
                '¬øPersonal usa EPP adecuado?': 'EPP seg√∫n evaluaci√≥n de riesgos del puesto. Uso obligatorio en zonas se√±alizadas. Capacitaci√≥n en uso correcto. Res. SRT 299/11 sobre EPP. Provisi√≥n gratuita por el empleador.',
                '¬øEPP en buen estado de conservaci√≥n?': 'Inspecci√≥n visual diaria por usuario. Reemplazo inmediato si hay deterioro. Arneses: inspecci√≥n trimestral por persona competente. Cascos: reemplazo cada 3-5 a√±os o tras impacto.',
                '¬øStock de EPP suficiente?': 'Stock m√≠nimo: 20% sobre dotaci√≥n actual. Considerar tiempo de reposici√≥n del proveedor. Variedad de tallas disponibles. Control de vencimientos (filtros, arneses).',
                '¬øRegistros de entrega actualizados?': 'Registro con firma del trabajador. Incluir: art√≠culo, talla, cantidad, fecha. Conservar 2 a√±os m√≠nimo. Facilita auditor√≠as de ART y reposici√≥n programada.'
            },
            'Orden y Limpieza': {
                '¬ø√Åreas de trabajo ordenadas?': 'Metodolog√≠a 5S: Clasificar, Ordenar, Limpiar, Estandarizar, Disciplina. Herramientas en su lugar. Materiales identificados. Reduce riesgos de tropiezos y aumenta productividad.',
                '¬øPasillos libres de obst√°culos?': 'Ancho m√≠nimo pasillos: 1.20m con tr√°nsito en un sentido, 1.50m con tr√°nsito en ambos sentidos. Demarcaci√≥n con pintura amarilla. Sin almacenamiento transitorio. Dec. 351/79 Art. 43.',
                '¬øResiduos clasificados correctamente?': 'Cestos diferenciados por tipo. Colores: Verde (org√°nicos), Amarillo (pl√°sticos/metales), Azul (papel/cart√≥n), Rojo (peligrosos). Vaciado frecuente. Evita focos de incendio.',
                '¬øSuperficies limpias y secas?': 'Limpieza diaria de pisos. Inmediata ante derrames. Se√±alizaci√≥n de piso mojado. Pisos antideslizantes en zonas h√∫medas. Prevenci√≥n de ca√≠das (principal causa de accidentes).'
            },
            'Ergonom√≠a': {
                '¬øMobiliario ergon√≥mico adecuado?': 'Sillas con regulaci√≥n de altura, respaldo lumbar, apoyabrazos. Monitor a altura de ojos, distancia 50-70cm. Teclado y mouse a altura de codos. Res. SRT 295/03 sobre ergonom√≠a.',
                '¬øIluminaci√≥n suficiente?': 'M√≠nimos: Dep√≥sitos 100 lux, Oficinas 300 lux, Trabajo fino 500 lux. Medici√≥n con lux√≥metro anual. Evitar deslumbramientos y sombras. Combinaci√≥n de luz natural y artificial. Dec. 351/79 Cap. 12.',
                '¬øCargas manuales dentro de l√≠mites?': 'L√≠mite general: 25 kg. NIOSH recomienda evaluar cada tarea. Considerar: peso, frecuencia, distancia, altura, agarre. Rotaci√≥n de personal. Ayudas mec√°nicas para > 25 kg. Res. SRT 295/03.'
            },
            'Maquinaria': {
                '¬øProtecciones de m√°quinas instaladas?': 'Protecci√≥n de partes m√≥viles, transmisiones, puntos de atrapamiento. Fijas con tornillos o m√≥viles con enclavamiento. Evitar acceso a zonas peligrosas. Dec. 351/79 Cap. 15 - IRAM 3622.',
                '¬øBotoneras de emergencia accesibles?': 'Pulsadores tipo hongo, color rojo sobre fondo amarillo. Acci√≥n mec√°nica positiva (queda enclavado). Accesible desde posici√≥n de operaci√≥n. Una cada 10m en l√≠neas de producci√≥n.',
                '¬øMantenimiento preventivo al d√≠a?': 'Plan escrito de mantenimiento. Frecuencia seg√∫n fabricante. Registro de intervenciones. Bloqueo (LOTO) durante mantenimiento. Capacitaci√≥n del personal de mantenimiento.'
            },
            'Se√±alizaci√≥n': {
                '¬øSe√±al√©tica completa y visible?': 'Se√±ales de: Obligaci√≥n (azul), Prohibici√≥n (rojo), Advertencia (amarillo), Emergencia (verde). Tama√±o seg√∫n distancia de visualizaci√≥n. IRAM 10005. Material fotoluminiscente donde corresponda.',
                '¬øColores seg√∫n norma IRAM?': 'IRAM 10005: Rojo (prohibici√≥n/incendio), Amarillo (precauci√≥n), Azul (obligaci√≥n), Verde (seguridad/emergencia). Contraste adecuado con fondo. Pictogramas universales.',
                '¬øSe√±alizaci√≥n fotoluminiscente donde corresponde?': 'Obligatoria en v√≠as de escape, salidas de emergencia, equipos contra incendio. Carga con luz natural/artificial. Luminiscencia m√≠nima 2 horas. Certificaci√≥n seg√∫n normas.'
            }
        };

        const FIRE_MATERIALS = {
            'Papel/Cart√≥n': { pci: 16, unit: 'MJ/kg' },
            'Madera': { pci: 18, unit: 'MJ/kg' },
            'Pl√°sticos (general)': { pci: 40, unit: 'MJ/kg' },
            'Textiles': { pci: 20, unit: 'MJ/kg' },
            'L√≠quidos combustibles': { pci: 42, unit: 'MJ/L' },
            'Otro': { pci: 0, unit: 'MJ/kg' }
        };

        // ============= STATE MANAGEMENT =============
        let currentEstablishment = null;
        let appData = {
            establishments: [],
            inspections: [],
            actions: [],
            fireloads: [],
            extinguishers: [],
            risks: [],
            trainings: [],
            incidents: [],
            ppe: [],
            jsas: [],
            chemicals: [],
            measurements: [],
            drills: [],
            contractors: [],
            maintenances: [],
            medicals: [],
            documents: [],
            annualTrainingPlan: [],
            vehicles: [],
            machinery: []
        };

        // ============= INITIALIZATION =============
        function initApp() {
            // Mostrar splash screen durante 3 segundos
            setTimeout(() => {
                const splashScreen = document.getElementById('splashScreen');
                splashScreen.classList.add('fade-out');
                
                // Remover el splash screen del DOM y permitir interacci√≥n despu√©s de la animaci√≥n
                setTimeout(() => {
                    splashScreen.style.display = 'none';
                    document.body.classList.remove('splash-active');
                }, 1000);
            }, 3000);
            
            loadData();
            populateEstablishments();
            updateOfflineIndicator();
            renderMainCalendar(); // Render calendar on load
            // initChecklistForm(); // Se inicializa solo al presionar "Nuevo Relevamiento"
            
            // Check online status
            window.addEventListener('online', updateOfflineIndicator);
            window.addEventListener('offline', updateOfflineIndicator);
        }

        function loadData() {
            const stored = localStorage.getItem('higieneApp');
            if (stored) {
                const loadedData = JSON.parse(stored);
                // Merge con la estructura base para asegurar que todas las propiedades existan
                appData = {
                    establishments: loadedData.establishments || [],
                    inspections: loadedData.inspections || [],
                    actions: loadedData.actions || [],
                    fireloads: loadedData.fireloads || [],
                    extinguishers: loadedData.extinguishers || [],
                    risks: loadedData.risks || [],
                    trainings: loadedData.trainings || [],
                    incidents: loadedData.incidents || [],
                    ppe: loadedData.ppe || [],
                    jsas: loadedData.jsas || [],
                    chemicals: loadedData.chemicals || [],
                    measurements: loadedData.measurements || [],
                    drills: loadedData.drills || [],
                    contractors: loadedData.contractors || [],
                    maintenances: loadedData.maintenances || [],
                    medicals: loadedData.medicals || [],
                    documents: loadedData.documents || [],
                    annualTrainingPlan: loadedData.annualTrainingPlan || [],
                    vehicles: loadedData.vehicles || [],
                    machinery: loadedData.machinery || []
                };
            }
        }

        function saveData() {
            localStorage.setItem('higieneApp', JSON.stringify(appData));
        }

        function updateOfflineIndicator() {
            const indicator = document.getElementById('offlineIndicator');
            if (navigator.onLine) {
                indicator.className = 'offline-indicator bg-green-500 text-white';
                indicator.textContent = '';
                indicator.innerHTML = '<i class="fas fa-bolt"></i> Modo Online';
            } else {
                indicator.className = 'offline-indicator bg-orange-500 text-white';
                indicator.textContent = 'üì¥ Modo Offline';
            }
        }

        // ============= NAVIGATION =============
        function showHome() {
            hideAllViews();
            document.getElementById('homeView').classList.remove('hidden');
            renderMainCalendar(); // Update calendar when returning home
            updateDashboardIfVisible();
        }

        function showModule(moduleName) {
            // Scroll hacia arriba al abrir cualquier m√≥dulo
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Los m√≥dulos de gesti√≥n de datos y acerca de no requieren establecimiento seleccionado
            if (!currentEstablishment && moduleName !== 'datamanagement' && moduleName !== 'about') {
                alert('Por favor, seleccione un establecimiento primero.');
                return;
            }
            
            hideAllViews();
            const viewId = moduleName + 'View';
            const view = document.getElementById(viewId);
            if (view) {
                view.classList.remove('hidden');
                
                // Load module-specific data
                switch(moduleName) {
                    case 'checklist':
                        loadInspectionHistory();
                        break;
                    case 'actions':
                        loadActions();
                        break;
                    case 'extinguishers':
                        loadExtinguishers();
                        break;
                    case 'riskmatrix':
                        loadRisks();
                        break;
                    case 'training':
                        loadTrainings();
                        break;
                    case 'incidents':
                        loadIncidents();
                        break;
                    case 'ppe':
                        loadPPE();
                        break;
                    case 'dashboard':
                        updateDashboard();
                        break;
                    case 'jsa':
                        loadJSAs();
                        break;
                    case 'sds':
                        loadChemicals();
                        break;
                    case 'environmental':
                        loadMeasurements();
                        break;
                    case 'evacuation':
                        loadDrills();
                        break;
                    case 'contractors':
                        loadContractors();
                        break;
                    case 'maintenance':
                        loadMaintenances();
                        break;
                    case 'medical':
                        loadMedicals();
                        break;
                    case 'documents':
                        loadDocuments();
                        break;
                    case 'rgrl':
                        initRGRL();
                        break;
                    case 'rgrlObras':
                        initRGRLObras();
                        break;
                    case 'niosh':
                        // No hay datos que cargar, es una calculadora
                        break;
                    case 'datamanagement':
                        // No requiere cargar datos espec√≠ficos
                        break;
                    case 'about':
                        // No requiere cargar datos espec√≠ficos
                        break;
                    case 'vehicles':
                        loadVehicles();
                        break;
                    case 'machinery':
                        loadMachinery();
                        break;
                }
            }
        }

        function hideAllViews() {
            const views = ['homeView', 'newEstablishmentView', 'editEstablishmentView', 'checklistView', 'actionsView', 
                          'fireloadView', 'extinguishersView', 'riskmatrixView', 'trainingView',
                          'incidentsView', 'ppeView', 'dashboardView', 'jsaView', 'sdsView',
                          'environmentalView', 'evacuationView', 'contractorsView', 'maintenanceView',
                          'medicalView', 'nioshView', 'datamanagementView', 'aboutView', 'documentsView', 'annualPlanView', 'rgrlView', 'rgrlObrasView', 'vehiclesView', 'machineryView'];
            views.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
        }

        // ============= ESTABLISHMENTS =============
        function populateEstablishments() {
            const select = document.getElementById('establishmentSelect');
            select.innerHTML = '<option value="">Seleccionar establecimiento...</option>';
            appData.establishments.forEach((est, idx) => {
                const option = document.createElement('option');
                option.value = idx;
                option.textContent = est.nombre;
                select.appendChild(option);
            });
        }

        function loadEstablishment() {
            const idx = document.getElementById('establishmentSelect').value;
            if (idx === '') {
                currentEstablishment = null;
                document.getElementById('currentEstablishment').classList.add('hidden');
                return;
            }
            
            currentEstablishment = appData.establishments[idx];
            const details = document.getElementById('establishmentDetails');
            
            // Crear enlace de Google Maps con la direcci√≥n
            const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(currentEstablishment.direccion)}`;
            
            details.innerHTML = `
                <div><strong>Nombre:</strong> ${currentEstablishment.nombre}</div>
                <div><strong>CUIT:</strong> ${currentEstablishment.cuit}</div>
                <div class="flex items-center gap-2">
                    <span><strong>Direcci√≥n:</strong> ${currentEstablishment.direccion}</span>
                    <a href="${mapsUrl}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 text-lg" title="Ver en Google Maps">
                        <i class="fas fa-map-marker-alt"></i>
                    </a>
                </div>
                <div><strong>Actividad:</strong> ${currentEstablishment.actividad}</div>
                <div><strong>Superficie:</strong> ${currentEstablishment.superficie_m2} m¬≤</div>
                <div><strong>Empleados:</strong> ${currentEstablishment.empleados || 'N/A'}</div>
                ${currentEstablishment.telefono ? `<div><strong><i class="fas fa-phone text-blue-600"></i> Tel√©fono:</strong> <a href="tel:${currentEstablishment.telefono}" class="text-blue-600 hover:text-blue-800">${currentEstablishment.telefono}</a></div>` : ''}
                ${currentEstablishment.email ? `<div><strong><i class="fas fa-envelope text-blue-600"></i> Email:</strong> <a href="mailto:${currentEstablishment.email}" class="text-blue-600 hover:text-blue-800">${currentEstablishment.email}</a></div>` : ''}
                ${currentEstablishment.obra_construccion ? `<div class="md:col-span-2"><span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-orange-100 text-orange-800"><i class="fas fa-hard-hat mr-1"></i> Obra en Construcci√≥n</span></div>` : ''}
            `;
            document.getElementById('currentEstablishment').classList.remove('hidden');
        }

        function showNewEstablishment() {
            hideAllViews();
            document.getElementById('newEstablishmentView').classList.remove('hidden');
        }

        function saveEstablishment(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const establishment = {
                id: 'est-' + Date.now(),
                nombre: formData.get('nombre'),
                cuit: formData.get('cuit'),
                direccion: formData.get('direccion'),
                actividad: formData.get('actividad'),
                superficie_m2: parseFloat(formData.get('superficie_m2')),
                empleados: formData.get('empleados') ? parseInt(formData.get('empleados')) : null,
                telefono: formData.get('telefono'),
                email: formData.get('email'),
                obra_construccion: formData.get('obra_construccion') === 'on',
                creado: new Date().toISOString()
            };
            
            appData.establishments.push(establishment);
            saveData();
            populateEstablishments();
            form.reset();
            showHome();
            alert('‚úÖ Establecimiento guardado correctamente');
        }

        function editEstablishment() {
            if (!currentEstablishment) {
                alert('No hay establecimiento seleccionado');
                return;
            }
            
            // Encontrar el √≠ndice del establecimiento actual
            const index = appData.establishments.findIndex(e => e.id === currentEstablishment.id);
            if (index === -1) {
                alert('Error: No se pudo encontrar el establecimiento');
                return;
            }
            
            // Cargar datos en el formulario de edici√≥n
            document.getElementById('editEstablishmentIndex').value = index;
            document.getElementById('editNombre').value = currentEstablishment.nombre;
            document.getElementById('editCuit').value = currentEstablishment.cuit;
            document.getElementById('editDireccion').value = currentEstablishment.direccion;
            document.getElementById('editActividad').value = currentEstablishment.actividad;
            document.getElementById('editSuperficie').value = currentEstablishment.superficie_m2;
            document.getElementById('editEmpleados').value = currentEstablishment.empleados || '';
            document.getElementById('editTelefono').value = currentEstablishment.telefono || '';
            document.getElementById('editEmail').value = currentEstablishment.email || '';
            document.getElementById('editObraConstruccion').checked = currentEstablishment.obra_construccion || false;
            
            // Mostrar vista de edici√≥n
            hideAllViews();
            document.getElementById('editEstablishmentView').classList.remove('hidden');
        }

        function updateEstablishment(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const index = parseInt(formData.get('establishment_index'));
            
            if (index < 0 || index >= appData.establishments.length) {
                alert('Error: √çndice de establecimiento inv√°lido');
                return;
            }
            
            // Actualizar el establecimiento manteniendo el ID y fecha de creaci√≥n originales
            const updatedEstablishment = {
                ...appData.establishments[index],
                nombre: formData.get('nombre'),
                cuit: formData.get('cuit'),
                direccion: formData.get('direccion'),
                actividad: formData.get('actividad'),
                superficie_m2: parseFloat(formData.get('superficie_m2')),
                empleados: formData.get('empleados') ? parseInt(formData.get('empleados')) : null,
                telefono: formData.get('telefono'),
                email: formData.get('email'),
                obra_construccion: formData.get('obra_construccion') === 'on',
                modificado: new Date().toISOString()
            };
            
            appData.establishments[index] = updatedEstablishment;
            currentEstablishment = updatedEstablishment;
            saveData();
            populateEstablishments();
            
            // Actualizar el selector para reflejar el cambio
            document.getElementById('establishmentSelect').value = index;
            loadEstablishment();
            
            form.reset();
            showHome();
            alert('‚úÖ Establecimiento actualizado correctamente');
        }

        function deleteEstablishment() {
            if (!currentEstablishment) {
                alert('‚ö†Ô∏è No hay establecimiento seleccionado');
                return;
            }
            
            const establishmentName = currentEstablishment.nombre;
            const establishmentId = currentEstablishment.id;
            
            // Pedir confirmaci√≥n doble porque es una acci√≥n destructiva
            if (!confirm(`‚ö†Ô∏è ¬øEst√° seguro de que desea eliminar el establecimiento "${establishmentName}"?\n\nEsta acci√≥n eliminar√° TODOS los datos asociados:\n- Inspecciones\n- Documentos\n- Formularios RGRL\n- Planes de evacuaci√≥n\n- Y todos los dem√°s datos relacionados\n\n‚ö†Ô∏è ESTA ACCI√ìN NO SE PUEDE DESHACER <i class="fas fa-exclamation-triangle text-yellow-600"></i>`)) {
                return;
            }
            
            // Segunda confirmaci√≥n
            if (!confirm(`‚ö†Ô∏è √öLTIMA CONFIRMACI√ìN <i class="fas fa-exclamation-triangle text-yellow-600"></i>\n\n¬øEst√° COMPLETAMENTE SEGURO de eliminar "${establishmentName}"?\n\nTodos los datos se perder√°n permanentemente.`)) {
                return;
            }
            
            // Encontrar el √≠ndice del establecimiento actual
            const index = appData.establishments.findIndex(est => est.id === establishmentId);
            
            if (index === -1) {
                alert('‚ùå Error: No se pudo encontrar el establecimiento');
                return;
            }
            
            // Eliminar todos los datos asociados en localStorage
            const keysToDelete = [];
            
            // Recorrer todas las keys de localStorage para encontrar las relacionadas con este establecimiento
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.includes(establishmentId)) {
                    keysToDelete.push(key);
                }
            }
            
            // Eliminar todas las keys relacionadas
            keysToDelete.forEach(key => {
                localStorage.removeItem(key);
            });
            
            // Eliminar el establecimiento del array
            appData.establishments.splice(index, 1);
            
            // Guardar los cambios
            saveData();
            
            // Actualizar la lista de establecimientos
            populateEstablishments();
            
            // Limpiar la selecci√≥n actual
            currentEstablishment = null;
            document.getElementById('currentEstablishment').classList.add('hidden');
            
            // Si hay establecimientos restantes, seleccionar el primero
            if (appData.establishments.length > 0) {
                document.getElementById('establishmentSelect').value = 0;
                loadEstablishment();
            } else {
                // No hay m√°s establecimientos
                document.getElementById('establishmentSelect').value = '';
            }
            
            alert(`‚úÖ Establecimiento "${establishmentName}" eliminado correctamente\n\nTodos los datos asociados han sido eliminados.`);
        }

        // ============= CHECKLIST MODULE =============
        function toggleChecklistForm() {
            const form = document.getElementById('checklistForm');
            const btn = document.getElementById('newChecklistBtn');
            
            if (form.classList.contains('hidden')) {
                form.classList.remove('hidden');
                btn.textContent = '‚úï Cancelar';
                btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                btn.classList.add('bg-gray-600', 'hover:bg-gray-700');
                // Inicializar el formulario si a√∫n no est√° cargado
                if (document.getElementById('checklistCategories').children.length === 0) {
                    initChecklistForm();
                }
            } else {
                form.classList.add('hidden');
                btn.textContent = '<i class="fas fa-plus-circle"></i> Nuevo Relevamiento';
                btn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                btn.classList.add('bg-green-600', 'hover:bg-green-700');
                // Limpiar el formulario
                document.getElementById('checklistForm').reset();
            }
        }

        function initChecklistForm() {
            const container = document.getElementById('checklistCategories');
            container.innerHTML = '';
            
            Object.entries(CHECKLIST_CATEGORIES).forEach(([category, questions]) => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'border border-gray-300 rounded-lg p-4 space-y-3';
                categoryDiv.innerHTML = `
                    <h3 class="font-bold text-lg text-blue-800">${category}</h3>
                    <div class="space-y-4" id="category-${category.replace(/\s+/g, '')}"></div>
                `;
                container.appendChild(categoryDiv);
                
                const questionsContainer = categoryDiv.querySelector(`#category-${category.replace(/\s+/g, '')}`);
                questions.forEach((question, idx) => {
                    const infoText = CHECKLIST_INFO[category]?.[question] || 'Informaci√≥n no disponible';
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'bg-gray-50 p-3 rounded';
                    questionDiv.innerHTML = `
                        <div class="font-semibold text-sm mb-2">
                            ${question}
                            <span class="info-icon">
                                i
                                <div class="info-bubble">${infoText}</div>
                            </span>
                        </div>
                        <div class="grid md:grid-cols-3 gap-2">
                            <div class="flex items-center space-x-2">
                                <input type="radio" name="q-${category}-${idx}" value="si" id="q-${category}-${idx}-si" class="w-4 h-4">
                                <label for="q-${category}-${idx}-si" class="text-sm">‚úÖ S√≠</label>
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="radio" name="q-${category}-${idx}" value="no" id="q-${category}-${idx}-no" class="w-4 h-4">
                                <label for="q-${category}-${idx}-no" class="text-sm">‚ùå No</label>
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="radio" name="q-${category}-${idx}" value="na" id="q-${category}-${idx}-na" class="w-4 h-4">
                                <label for="q-${category}-${idx}-na" class="text-sm">‚ûñ N/A</label>
                            </div>
                        </div>
                        <div class="mt-2">
                            <select name="priority-${category}-${idx}" class="border border-gray-300 rounded p-1 text-sm w-full md:w-auto">
                                <option value="">Sin prioridad</option>
                                <option value="Alta"><i class="fas fa-circle text-red-500"></i> Alta</option>
                                <option value="Media"><i class="fas fa-circle text-yellow-500"></i> Media</option>
                                <option value="Baja"><i class="fas fa-circle text-green-500"></i> Baja</option>
                            </select>
                        </div>
                        <textarea name="comment-${category}-${idx}" placeholder="Comentarios..." rows="2" class="border border-gray-300 rounded p-2 text-sm w-full mt-2"></textarea>
                        <div class="mt-2">
                            <label class="text-xs text-gray-600 cursor-pointer hover:text-blue-600">
                                üì∑ Adjuntar foto
                                <input type="file" name="photo-${category}-${idx}" accept="image/*" class="hidden" onchange="previewChecklistPhoto(this, '${category}', ${idx})">
                            </label>
                            <div id="preview-${category}-${idx}" class="mt-2"></div>
                        </div>
                    `;
                    questionsContainer.appendChild(questionDiv);
                });
            });
            
            document.getElementById('inspectionDate').valueAsDate = new Date();
        }

        function saveChecklist() {
            if (!currentEstablishment) {
                alert('Seleccione un establecimiento primero');
                return;
            }
            
            const inspectorName = document.getElementById('inspectorName').value;
            const inspectorMatricula = document.getElementById('inspectorMatricula').value;
            const inspectionDate = document.getElementById('inspectionDate').value;
            const sector = document.getElementById('checklistSector').value;
            
            if (!inspectorName || !inspectionDate || !sector) {
                alert('Complete los campos obligatorios');
                return;
            }
            
            const items = [];
            let okCount = 0, nokCount = 0, naCount = 0;
            
            Object.entries(CHECKLIST_CATEGORIES).forEach(([category, questions]) => {
                questions.forEach((question, idx) => {
                    const respuesta = document.querySelector(`input[name="q-${category}-${idx}"]:checked`)?.value || '';
                    const prioridad = document.querySelector(`select[name="priority-${category}-${idx}"]`).value;
                    const comentario = document.querySelector(`textarea[name="comment-${category}-${idx}"]`).value;
                    const photoInput = document.querySelector(`input[name="photo-${category}-${idx}"]`);
                    let photoData = null;
                    
                    // Capturar foto si existe
                    if (photoInput && photoInput.files && photoInput.files[0]) {
                        const previewDiv = document.getElementById(`preview-${category}-${idx}`);
                        if (previewDiv) {
                            const img = previewDiv.querySelector('img');
                            if (img && img.src) {
                                photoData = img.src; // base64 data URL
                            }
                        }
                    }
                    
                    if (respuesta) {
                        if (respuesta === 'si') okCount++;
                        else if (respuesta === 'no') nokCount++;
                        else naCount++;
                        
                        items.push({
                            id: `item-${Date.now()}-${idx}`,
                            categoria: category,
                            pregunta: question,
                            respuesta: respuesta,
                            prioridad: prioridad,
                            comentario: comentario,
                            foto: photoData
                        });
                    }
                });
            });
            
            const inspection = {
                id: 'insp-' + Date.now(),
                establecimiento_id: currentEstablishment.id,
                establecimiento_nombre: currentEstablishment.nombre,
                sector: sector,
                inspector: {
                    nombre: inspectorName,
                    matricula: inspectorMatricula
                },
                fecha: inspectionDate,
                fecha_creacion: new Date().toISOString(),
                items: items,
                resumen: {
                    ok: okCount,
                    nok: nokCount,
                    na: naCount,
                    total: items.length
                }
            };
            
            appData.inspections.push(inspection);
            saveData();
            
            // Auto-generate actions for NOK items with priority
            items.forEach(item => {
                if (item.respuesta === 'no' && item.prioridad) {
                    const action = {
                        id: 'act-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                        titulo: `[${item.categoria}] ${item.pregunta}`,
                        descripcion: item.comentario || 'Hallazgo de inspecci√≥n',
                        prioridad: item.prioridad,
                        sector: sector,
                        responsable: 'Por asignar',
                        estado: 'pendiente',
                        vencimiento: new Date(Date.now() + 30*24*60*60*1000).toISOString().split('T')[0],
                        establecimiento_id: currentEstablishment.id,
                        origen: `Inspecci√≥n ${inspection.id}`,
                        fecha_creacion: new Date().toISOString()
                    };
                    appData.actions.push(action);
                }
            });
            
            saveData();
            alert(`‚úÖ Inspecci√≥n guardada\n\nüìä Resumen:\n‚úÖ OK: ${okCount}\n‚ùå NOK: ${nokCount}\n‚ûñ N/A: ${naCount}`);
            
            // Reset form and hide it
            document.getElementById('checklistForm').reset();
            document.getElementById('inspectionDate').valueAsDate = new Date();
            
            // Ocultar el formulario y restaurar el bot√≥n
            const form = document.getElementById('checklistForm');
            const btn = document.getElementById('newChecklistBtn');
            form.classList.add('hidden');
            btn.textContent = '<i class="fas fa-plus-circle"></i> Nuevo Relevamiento';
            btn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
            btn.classList.add('bg-green-600', 'hover:bg-green-700');
            
            loadInspectionHistory();
        }

        function loadInspectionHistory() {
            if (!currentEstablishment) return;
            
            const container = document.getElementById('inspectionHistory');
            const inspections = appData.inspections
                .filter(i => i.establecimiento_id === currentEstablishment.id)
                .sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            if (inspections.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay inspecciones registradas</p>';
                return;
            }
            
            container.innerHTML = inspections.map(insp => `
                <div class="border border-gray-300 rounded-lg p-4 hover:shadow-md transition">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold">${insp.sector}</h4>
                            <p class="text-sm text-gray-600">${insp.inspector.nombre} - ${insp.fecha}</p>
                        </div>
                        <div class="text-right">
                            <div class="text-xs space-y-1">
                                <div>‚úÖ ${insp.resumen.ok} | ‚ùå ${insp.resumen.nok} | ‚ûñ ${insp.resumen.na}</div>
                                <div class="font-semibold">${insp.resumen.total} items</div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-2 flex gap-2">
                        <button onclick="viewInspectionDetails('${insp.id}')" class="text-xs bg-blue-100 text-blue-800 px-3 py-1 rounded hover:bg-blue-200 transition">
                            üëÅÔ∏è Ver detalles
                        </button>
                        <button onclick="editInspection('${insp.id}')" class="text-xs bg-green-100 text-green-800 px-3 py-1 rounded hover:bg-green-200 transition">
                            ‚úèÔ∏è Editar
                        </button>
                        <button onclick="deleteInspection('${insp.id}')" class="text-xs bg-red-100 text-red-800 px-3 py-1 rounded hover:bg-red-200 transition">
                            üóëÔ∏è Eliminar
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function viewInspectionDetails(inspId) {
            const insp = appData.inspections.find(i => i.id === inspId);
            if (!insp) return;
            
            // Construir el contenido HTML de la modal
            let html = `
                <div class="space-y-6">
                    <!-- Header Info -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="grid md:grid-cols-3 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">Sector</p>
                                <p class="font-bold text-lg">${insp.sector}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Inspector</p>
                                <p class="font-bold">${insp.inspector.nombre}</p>
                                ${insp.inspector.matricula ? `<p class="text-xs text-gray-600">Mat. ${insp.inspector.matricula}</p>` : ''}
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Fecha</p>
                                <p class="font-bold">${insp.fecha}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Resumen -->
                    <div class="grid grid-cols-4 gap-3">
                        <div class="bg-green-50 border border-green-300 rounded-lg p-3 text-center">
                            <p class="text-2xl font-bold text-green-700">‚úÖ ${insp.resumen.ok}</p>
                            <p class="text-xs text-gray-600">Conformes</p>
                        </div>
                        <div class="bg-red-50 border border-red-300 rounded-lg p-3 text-center">
                            <p class="text-2xl font-bold text-red-700">‚ùå ${insp.resumen.nok}</p>
                            <p class="text-xs text-gray-600">No Conformes</p>
                        </div>
                        <div class="bg-gray-50 border border-gray-300 rounded-lg p-3 text-center">
                            <p class="text-2xl font-bold text-gray-700">‚ûñ ${insp.resumen.na}</p>
                            <p class="text-xs text-gray-600">No Aplica</p>
                        </div>
                        <div class="bg-blue-50 border border-blue-300 rounded-lg p-3 text-center">
                            <p class="text-2xl font-bold text-blue-700">${insp.resumen.total}</p>
                            <p class="text-xs text-gray-600">Total Items</p>
                        </div>
                    </div>

                    <!-- Items por categor√≠a -->
                    <div class="space-y-4">
            `;

            // Agrupar items por categor√≠a
            const itemsByCategory = {};
            insp.items.forEach(item => {
                if (!itemsByCategory[item.categoria]) {
                    itemsByCategory[item.categoria] = [];
                }
                itemsByCategory[item.categoria].push(item);
            });

            // Mostrar cada categor√≠a
            Object.entries(itemsByCategory).forEach(([categoria, items]) => {
                html += `
                    <div class="border border-gray-300 rounded-lg overflow-hidden">
                        <div class="bg-gray-100 px-4 py-3 font-bold text-gray-800">
                            ${categoria} (${items.length} items)
                        </div>
                        <div class="divide-y divide-gray-200">
                `;

                items.forEach(item => {
                    const statusIcon = item.respuesta === 'si' ? '<i class="fas fa-check-circle text-green-600"></i>' : (item.respuesta === 'no' ? '<i class="fas fa-times-circle text-red-600"></i>' : '‚ûñ');
                    const statusColor = item.respuesta === 'si' ? 'bg-green-50' : (item.respuesta === 'no' ? 'bg-red-50' : 'bg-gray-50');
                    const priorityBadge = item.prioridad ? `<span class="px-2 py-1 rounded text-xs font-semibold ${
                        item.prioridad === 'Alta' ? 'bg-red-100 text-red-800' :
                        item.prioridad === 'Media' ? 'bg-yellow-100 text-yellow-800' :
                        'bg-blue-100 text-blue-800'
                    }">Prioridad: ${item.prioridad}</span>` : '';

                    html += `
                        <div class="${statusColor} p-4">
                            <div class="flex items-start gap-3">
                                <span class="text-2xl">${statusIcon}</span>
                                <div class="flex-1">
                                    <p class="font-semibold text-gray-800">${item.pregunta}</p>
                                    ${priorityBadge}
                                    ${item.comentario ? `<p class="text-sm text-gray-700 mt-2"><strong>Comentario:</strong> ${item.comentario}</p>` : ''}
                                    ${item.foto ? `
                                        <div class="mt-3">
                                            <p class="text-xs text-gray-600 mb-2">üì∑ Foto adjunta:</p>
                                            <img src="${item.foto}" class="max-w-md rounded border border-gray-300 shadow-sm cursor-pointer hover:shadow-lg transition" onclick="openImageModal('${item.foto}')" alt="Foto del hallazgo">
                                            <p class="text-xs text-gray-500 mt-1 italic">Click en la imagen para ver en tama√±o completo</p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
            `;

            // Guardar la inspecci√≥n actual
            currentInspectionId = inspId;

            // Mostrar la modal
            document.getElementById('inspectionModalContent').innerHTML = html;
            document.getElementById('inspectionModal').classList.remove('hidden');
        }

        function closeInspectionModal() {
            document.getElementById('inspectionModal').classList.add('hidden');
            currentInspectionId = null;
        }

        // Variable para guardar la inspecci√≥n actual
        let currentInspectionId = null;

        // Funciones para la modal de imagen
        function openImageModal(imageSrc) {
            event.stopPropagation();
            const modal = document.getElementById('imageModal');
            const img = document.getElementById('imageModalImg');
            img.src = imageSrc;
            modal.classList.remove('hidden');
            // Prevenir scroll del body
            document.body.style.overflow = 'hidden';
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.add('hidden');
            // Restaurar scroll del body
            document.body.style.overflow = 'auto';
        }

        // Exportar detalle de inspecci√≥n como PDF
        async function exportInspectionDetailPDF() {
            if (!currentInspectionId) {
                alert('Error: No se pudo identificar la inspecci√≥n');
                return;
            }

            const insp = appData.inspections.find(i => i.id === currentInspectionId);
            if (!insp) {
                alert('Error: Inspecci√≥n no encontrada');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header
            doc.setFillColor(30, 64, 175);
            doc.rect(0, 0, 210, 35, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('DETALLE DE INSPECCI√ìN', 15, 15);
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text('Sistema de Seguridad e Higiene', 15, 23);
            doc.text(`Generado: ${new Date().toLocaleDateString('es-AR')}`, 15, 29);

            let yPos = 45;

            // Informaci√≥n general
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('INFORMACI√ìN GENERAL', 15, yPos);
            yPos += 8;

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Sector: ${insp.sector}`, 15, yPos);
            yPos += 6;
            doc.text(`Inspector: ${insp.inspector.nombre}`, 15, yPos);
            if (insp.inspector.matricula) {
                doc.text(`Mat. ${insp.inspector.matricula}`, 80, yPos);
            }
            yPos += 6;
            doc.text(`Fecha: ${insp.fecha}`, 15, yPos);
            yPos += 10;

            // Resumen
            doc.setFillColor(240, 240, 240);
            doc.rect(15, yPos, 180, 20, 'F');
            doc.setFont(undefined, 'bold');
            yPos += 7;
            doc.text('RESUMEN DE INSPECCI√ìN', 20, yPos);
            yPos += 7;
            doc.setFont(undefined, 'normal');
            doc.text(`Conformes: ${insp.resumen.ok}  |  No Conformes: ${insp.resumen.nok}  |  N/A: ${insp.resumen.na}  |  Total: ${insp.resumen.total}`, 20, yPos);
            yPos += 12;

            // Items por categor√≠a
            const itemsByCategory = {};
            insp.items.forEach(item => {
                if (!itemsByCategory[item.categoria]) {
                    itemsByCategory[item.categoria] = [];
                }
                itemsByCategory[item.categoria].push(item);
            });

            // Mostrar cada categor√≠a
            for (const [categoria, items] of Object.entries(itemsByCategory)) {
                // Verificar si necesitamos nueva p√°gina
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }

                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setFillColor(59, 130, 246);
                doc.rect(15, yPos, 180, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.text(`${categoria} (${items.length} items)`, 20, yPos + 6);
                doc.setTextColor(0, 0, 0);
                yPos += 12;

                // Items de la categor√≠a
                for (const item of items) {
                    if (yPos > 260) {
                        doc.addPage();
                        yPos = 20;
                    }

                    // Determinar el texto de la respuesta
                    let statusText = '';
                    let statusColor = [0, 0, 0]; // Negro por defecto
                    
                    if (item.respuesta === 'si') {
                        statusText = '[CONFORME]';
                        statusColor = [22, 163, 74]; // Verde
                    } else if (item.respuesta === 'no') {
                        statusText = '[NO CONFORME]';
                        statusColor = [220, 38, 38]; // Rojo
                    } else {
                        statusText = '[N/A]';
                        statusColor = [107, 114, 128]; // Gris
                    }
                    
                    doc.setFont(undefined, 'bold');
                    doc.setFontSize(10);
                    
                    // Mostrar el status con color
                    doc.setTextColor(statusColor[0], statusColor[1], statusColor[2]);
                    doc.text(statusText, 20, yPos);
                    
                    // Mostrar la pregunta en negro
                    doc.setTextColor(0, 0, 0);
                    const preguntaLines = doc.splitTextToSize(item.pregunta, 155);
                    doc.text(preguntaLines, 52, yPos);
                    yPos += Math.max(5, preguntaLines.length * 5);

                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(9);

                    if (item.prioridad) {
                        doc.setTextColor(
                            item.prioridad === 'Alta' ? 220 : (item.prioridad === 'Media' ? 180 : 100),
                            item.prioridad === 'Alta' ? 38 : (item.prioridad === 'Media' ? 83 : 100),
                            item.prioridad === 'Alta' ? 38 : (item.prioridad === 'Media' ? 14 : 100)
                        );
                        doc.text(`Prioridad: ${item.prioridad}`, 25, yPos);
                        doc.setTextColor(0, 0, 0);
                        yPos += 5;
                    }

                    if (item.comentario) {
                        const comentarioLines = doc.splitTextToSize(`Comentario: ${item.comentario}`, 170);
                        doc.text(comentarioLines, 25, yPos);
                        yPos += (comentarioLines.length * 5);
                    }

                    if (item.foto) {
                        yPos += 3;
                        doc.setFontSize(8);
                        doc.setTextColor(100, 100, 100);
                        doc.text('[FOTO] Foto adjunta (ver en version digital)', 25, yPos);
                        doc.setTextColor(0, 0, 0);
                        yPos += 5;

                        // Intentar agregar la foto con proporciones originales
                        try {
                            // Crear una imagen para obtener las dimensiones originales
                            const img = new Image();
                            img.src = item.foto;
                            
                            await new Promise((resolve) => {
                                img.onload = resolve;
                                img.onerror = resolve;
                            });
                            
                            if (img.width && img.height) {
                                // Calcular dimensiones manteniendo proporci√≥n
                                const maxWidth = 160; // Ancho m√°ximo en mm
                                const maxHeight = 100; // Alto m√°ximo en mm
                                
                                let imgWidth = img.width * 0.264583; // Convertir p√≠xeles a mm (1px = 0.264583mm a 96dpi)
                                let imgHeight = img.height * 0.264583;
                                
                                // Escalar si excede el ancho m√°ximo
                                if (imgWidth > maxWidth) {
                                    const ratio = maxWidth / imgWidth;
                                    imgWidth = maxWidth;
                                    imgHeight = imgHeight * ratio;
                                }
                                
                                // Escalar si excede el alto m√°ximo
                                if (imgHeight > maxHeight) {
                                    const ratio = maxHeight / imgHeight;
                                    imgHeight = maxHeight;
                                    imgWidth = imgWidth * ratio;
                                }
                                
                                // Verificar si hay espacio suficiente en la p√°gina
                                if (yPos + imgHeight > 270) {
                                    doc.addPage();
                                    yPos = 20;
                                }
                                
                                doc.addImage(item.foto, 'JPEG', 25, yPos, imgWidth, imgHeight);
                                yPos += imgHeight + 5;
                            }
                        } catch (e) {
                            console.log('No se pudo agregar imagen al PDF:', e);
                        }
                    }

                    yPos += 8;
                }
            }

            // Footer
            const totalPages = doc.internal.pages.length - 1;
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                doc.text(`P√°gina ${i} de ${totalPages}`, 15, 285);
                doc.text(`Establecimiento: ${currentEstablishment.nombre}`, 105, 285, { align: 'center' });
                doc.text('Ley 19.587 - Dec. 351/79', 195, 285, { align: 'right' });
            }

            doc.save(`Inspeccion_Detalle_${insp.sector.replace(/\s+/g, '_')}_${insp.fecha}.pdf`);
        }

        // Cerrar modal al hacer click fuera de ella
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('inspectionModal');
            if (modal && event.target === modal) {
                closeInspectionModal();
            }
        });

        // Cerrar modals con tecla ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const imageModal = document.getElementById('imageModal');
                const inspectionModal = document.getElementById('inspectionModal');
                
                if (imageModal && !imageModal.classList.contains('hidden')) {
                    closeImageModal();
                } else if (inspectionModal && !inspectionModal.classList.contains('hidden')) {
                    closeInspectionModal();
                }
            }
        });

        function editInspection(inspId) {
            const insp = appData.inspections.find(i => i.id === inspId);
            if (!insp) return;
            
            if (!confirm(`¬øDesea editar la inspecci√≥n del sector "${insp.sector}" realizada el ${insp.fecha}?\n\nNOTA: Se cargar√° el formulario con los datos actuales.`)) {
                return;
            }
            
            // Cerrar modal si est√° abierta
            closeInspectionModal();
            
            // Mostrar el formulario de checklist
            showModule('checklist');
            
            // Cargar los datos en el formulario
            setTimeout(() => {
                // Usar los IDs correctos
                document.getElementById('checklistSector').value = insp.sector;
                document.getElementById('inspectorName').value = insp.inspector.nombre;
                document.getElementById('inspectorMatricula').value = insp.inspector.matricula || '';
                document.getElementById('inspectionDate').value = insp.fecha;
                
                // Inicializar el formulario con las categor√≠as
                initChecklistForm();
                
                // Cargar respuestas despu√©s de que se generen las preguntas
                setTimeout(() => {
                    Object.entries(CHECKLIST_CATEGORIES).forEach(([category, questions]) => {
                        questions.forEach((question, idx) => {
                            // Buscar el item correspondiente en la inspecci√≥n
                            const item = insp.items.find(i => i.categoria === category && i.pregunta === question);
                            
                            if (item) {
                                // Marcar la respuesta
                                const radioName = `q-${category}-${idx}`;
                                const radio = document.querySelector(`input[name="${radioName}"][value="${item.respuesta}"]`);
                                if (radio) radio.checked = true;
                                
                                // Llenar prioridad
                                const prioritySelect = document.querySelector(`select[name="priority-${category}-${idx}"]`);
                                if (prioritySelect && item.prioridad) {
                                    prioritySelect.value = item.prioridad;
                                }
                                
                                // Llenar comentario
                                const commentTextarea = document.querySelector(`textarea[name="comment-${category}-${idx}"]`);
                                if (commentTextarea && item.comentario) {
                                    commentTextarea.value = item.comentario;
                                }
                                
                                // Cargar foto si existe
                                if (item.foto) {
                                    const previewDiv = document.getElementById(`preview-${category}-${idx}`);
                                    if (previewDiv) {
                                        previewDiv.innerHTML = `
                                            <img src="${item.foto}" class="max-w-xs rounded border mt-2" alt="Foto existente">
                                            <button type="button" onclick="removeChecklistPhoto('${category}', ${idx})" class="text-xs text-red-600 hover:text-red-800 mt-1">
                                                üóëÔ∏è Eliminar foto
                                            </button>
                                        `;
                                    }
                                }
                            }
                        });
                    });
                }, 300);
                
                // Eliminar la inspecci√≥n anterior cuando se guarde la nueva
                const originalSaveChecklist = window.saveChecklist;
                window.saveChecklist = function() {
                    const index = appData.inspections.findIndex(i => i.id === inspId);
                    if (index > -1) {
                        appData.inspections.splice(index, 1);
                    }
                    originalSaveChecklist();
                    window.saveChecklist = originalSaveChecklist; // Restaurar la funci√≥n original
                };
            }, 300);
        }

        function deleteInspection(inspId) {
            const insp = appData.inspections.find(i => i.id === inspId);
            if (!insp) return;
            
            if (!confirm(`¬øEst√° seguro de eliminar la inspecci√≥n del sector "${insp.sector}" realizada el ${insp.fecha}?\n\nEsta acci√≥n no se puede deshacer.`)) {
                return;
            }
            
            const index = appData.inspections.findIndex(i => i.id === inspId);
            if (index > -1) {
                appData.inspections.splice(index, 1);
                saveData();
                loadInspectionHistory();
                alert('‚úÖ Inspecci√≥n eliminada correctamente');
            }
        }

        async function generateChecklistPDF() {
            if (!currentEstablishment) {
                alert('Por favor, seleccione un establecimiento primero.');
                return;
            }
            
            const inspections = appData.inspections.filter(i => i.establecimiento_id === currentEstablishment.id);
            
            if (inspections.length === 0) {
                alert('No hay inspecciones registradas para generar el expediente.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let yPos = 20;
            const pageHeight = doc.internal.pageSize.height;
            const pageWidth = doc.internal.pageSize.width;
            const margin = 15;
            const contentWidth = pageWidth - 2 * margin;
            
            // Funci√≥n auxiliar para agregar nueva p√°gina si es necesario
            function checkPageBreak(needed = 20) {
                if (yPos + needed > pageHeight - 20) {
                    doc.addPage();
                    yPos = 20;
                    return true;
                }
                return false;
            }
            
            // PORTADA
            doc.setFillColor(30, 58, 138); // bg-blue-900
            doc.rect(0, 0, pageWidth, 60, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text('EXPEDIENTE DE SEGURIDAD E HIGIENE', margin, 25);
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text('Sistema de Gesti√≥n SRT - Ley 19.587 / Dec. 351/79', margin, 35);
            doc.text(`Generado: ${new Date().toLocaleDateString('es-AR')}`, margin, 42);
            
            yPos = 80;
            doc.setTextColor(0, 0, 0);
            
            // DATOS DEL ESTABLECIMIENTO
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('ESTABLECIMIENTO', margin, yPos);
            yPos += 10;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Nombre: ${currentEstablishment.nombre}`, margin, yPos);
            yPos += 6;
            doc.text(`CUIT: ${currentEstablishment.cuit}`, margin, yPos);
            yPos += 6;
            doc.text(`Direcci√≥n: ${currentEstablishment.direccion}`, margin, yPos);
            yPos += 6;
            doc.text(`Actividad: ${currentEstablishment.actividad}`, margin, yPos);
            yPos += 6;
            doc.text(`Superficie: ${currentEstablishment.superficie_m2} m¬≤`, margin, yPos);
            yPos += 6;
            doc.text(`Empleados: ${currentEstablishment.empleados || 'No especificado'}`, margin, yPos);
            yPos += 15;
            
            // RESUMEN EJECUTIVO
            checkPageBreak(30);
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('RESUMEN EJECUTIVO', margin, yPos);
            yPos += 10;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            
            const totalInspecciones = inspections.length;
            const totalHallazgos = inspections.reduce((sum, i) => sum + i.resumen.total, 0);
            const totalOK = inspections.reduce((sum, i) => sum + i.resumen.ok, 0);
            const totalNOK = inspections.reduce((sum, i) => sum + i.resumen.nok, 0);
            const totalNA = inspections.reduce((sum, i) => sum + i.resumen.na, 0);
            const porcentajeCumplimiento = totalHallazgos > 0 ? Math.round((totalOK / (totalOK + totalNOK)) * 100) : 0;
            
            doc.text(`Total de Inspecciones: ${totalInspecciones}`, margin, yPos);
            yPos += 6;
            doc.text(`Items Evaluados: ${totalHallazgos}`, margin, yPos);
            yPos += 6;
            doc.text(`Conformes (OK): ${totalOK}`, margin, yPos);
            yPos += 6;
            doc.text(`No Conformes (NOK): ${totalNOK}`, margin, yPos);
            yPos += 6;
            doc.text(`No Aplicables (N/A): ${totalNA}`, margin, yPos);
            yPos += 6;
            doc.setFont(undefined, 'bold');
            doc.text(`Nivel de Cumplimiento: ${porcentajeCumplimiento}%`, margin, yPos);
            yPos += 15;
            
            // DETALLE DE INSPECCIONES
            doc.addPage();
            yPos = 20;
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('DETALLE DE INSPECCIONES', margin, yPos);
            yPos += 12;
            
            inspections.sort((a, b) => new Date(b.fecha) - new Date(a.fecha)).forEach((insp, idx) => {
                checkPageBreak(40);
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text(`${idx + 1}. Inspecci√≥n - ${insp.sector}`, margin, yPos);
                yPos += 7;
                
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                doc.text(`Fecha: ${insp.fecha}`, margin + 5, yPos);
                yPos += 5;
                doc.text(`Inspector: ${insp.inspector.nombre}${insp.inspector.matricula ? ' (Mat: ' + insp.inspector.matricula + ')' : ''}`, margin + 5, yPos);
                yPos += 5;
                doc.text(`Resumen: OK: ${insp.resumen.ok} | NOK: ${insp.resumen.nok} | N/A: ${insp.resumen.na}`, margin + 5, yPos);
                yPos += 8;
                
                // Hallazgos NOK
                const nokItems = insp.items.filter(i => i.respuesta === 'no');
                if (nokItems.length > 0) {
                    doc.setFont(undefined, 'bold');
                    doc.text('Hallazgos No Conformes:', margin + 5, yPos);
                    yPos += 6;
                    
                    nokItems.forEach(item => {
                        checkPageBreak(15);
                        doc.setFont(undefined, 'normal');
                        const text = `‚Ä¢ [${item.categoria}] ${item.pregunta}`;
                        const lines = doc.splitTextToSize(text, contentWidth - 10);
                        doc.text(lines, margin + 10, yPos);
                        yPos += lines.length * 5;
                        
                        if (item.prioridad) {
                            doc.setFont(undefined, 'bold');
                            doc.text(`  Prioridad: ${item.prioridad}`, margin + 10, yPos);
                            yPos += 5;
                            doc.setFont(undefined, 'normal');
                        }
                        
                        if (item.comentario) {
                            const commentLines = doc.splitTextToSize(`  ${item.comentario}`, contentWidth - 15);
                            doc.text(commentLines, margin + 10, yPos);
                            yPos += commentLines.length * 5;
                        }
                        yPos += 3;
                    });
                }
                
                yPos += 10;
            });
            
            // ACCIONES GENERADAS
            const actions = appData.actions.filter(a => a.establecimiento_id === currentEstablishment.id);
            if (actions.length > 0) {
                checkPageBreak(30);
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('PLAN DE ACCIONES', margin, yPos);
                yPos += 12;
                
                const pendientes = actions.filter(a => a.estado === 'pendiente');
                const cerradas = actions.filter(a => a.estado === 'cerrado');
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Acciones Pendientes: ${pendientes.length}`, margin, yPos);
                yPos += 6;
                doc.text(`Acciones Cerradas: ${cerradas.length}`, margin, yPos);
                yPos += 10;
                
                if (pendientes.length > 0) {
                    doc.setFont(undefined, 'bold');
                    doc.text('Acciones Prioritarias Pendientes:', margin, yPos);
                    yPos += 8;
                    
                    pendientes
                        .sort((a, b) => {
                            const order = { 'Alta': 3, 'Media': 2, 'Baja': 1 };
                            return (order[b.prioridad] || 0) - (order[a.prioridad] || 0);
                        })
                        .slice(0, 20)
                        .forEach((action, idx) => {
                            checkPageBreak(20);
                            
                            doc.setFontSize(9);
                            doc.setFont(undefined, 'bold');
                            const title = `${idx + 1}. [${action.prioridad}] ${action.titulo}`;
                            const titleLines = doc.splitTextToSize(title, contentWidth - 5);
                            doc.text(titleLines, margin + 5, yPos);
                            yPos += titleLines.length * 5;
                            
                            doc.setFont(undefined, 'normal');
                            doc.text(`   Responsable: ${action.responsable} | Vencimiento: ${action.vencimiento}`, margin + 5, yPos);
                            yPos += 5;
                            
                            if (action.descripcion) {
                                const descLines = doc.splitTextToSize(`   ${action.descripcion}`, contentWidth - 10);
                                doc.text(descLines, margin + 5, yPos);
                                yPos += descLines.length * 5;
                            }
                            yPos += 5;
                        });
                }
            }
            
            // PIE DE P√ÅGINA
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text(`P√°gina ${i} de ${totalPages}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
                doc.text('Sistema de Seguridad e Higiene - Ley 19.587', margin, pageHeight - 10);
            }
            
            // Descargar
            doc.save(`Expediente_${currentEstablishment.nombre.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
            alert('‚úÖ Expediente PDF generado correctamente');
        }

        // ============= ACTIONS MODULE =============
        function loadActions() {
            if (!currentEstablishment) return;
            filterActions();
        }

        function filterActions() {
            if (!currentEstablishment) return;
            
            const statusFilter = document.getElementById('actionFilterStatus').value;
            const priorityFilter = document.getElementById('actionFilterPriority').value;
            const searchText = document.getElementById('actionSearch').value.toLowerCase();
            
            let filtered = appData.actions.filter(a => a.establecimiento_id === currentEstablishment.id);
            
            if (statusFilter) filtered = filtered.filter(a => a.estado === statusFilter);
            if (priorityFilter) filtered = filtered.filter(a => a.prioridad === priorityFilter);
            if (searchText) filtered = filtered.filter(a => 
                a.titulo.toLowerCase().includes(searchText) || 
                a.descripcion.toLowerCase().includes(searchText)
            );
            
            const container = document.getElementById('actionsList');
            
            if (filtered.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay acciones registradas</p>';
                return;
            }
            
            filtered.sort((a, b) => {
                const priorityOrder = {'Alta': 3, 'Media': 2, 'Baja': 1};
                return (priorityOrder[b.prioridad] || 0) - (priorityOrder[a.prioridad] || 0);
            });
            
            container.innerHTML = filtered.map(action => {
                const isOverdue = new Date(action.vencimiento) < new Date() && action.estado !== 'cerrado';
                const priorityColor = {
                    'Alta': 'border-red-500 bg-red-50',
                    'Media': 'border-yellow-500 bg-yellow-50',
                    'Baja': 'border-green-500 bg-green-50'
                }[action.prioridad] || 'border-gray-300';
                
                return `
                    <div class="border-l-4 ${priorityColor} rounded-lg p-4 hover:shadow-md transition">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="font-bold">${action.titulo}</h4>
                                <p class="text-sm text-gray-600 mt-1">${action.descripcion}</p>
                                <div class="flex gap-3 mt-2 text-xs text-gray-500">
                                    <span><i class="fas fa-user"></i> ${action.responsable}</span>
                                    <span><i class="fas fa-map-marker-alt"></i> ${action.sector || 'N/A'}</span>
                                    <span class="${isOverdue ? 'text-red-600 font-bold' : ''}">üìÖ ${action.vencimiento}</span>
                                </div>
                            </div>
                            <div class="ml-4 flex flex-col gap-2">
                                <select onchange="updateActionStatus('${action.id}', this.value)" 
                                        class="text-sm border border-gray-300 rounded p-1">
                                    <option value="pendiente" ${action.estado === 'pendiente' ? 'selected' : ''}>Pendiente</option>
                                    <option value="en_progreso" ${action.estado === 'en_progreso' ? 'selected' : ''}>En Progreso</option>
                                    <option value="cerrado" ${action.estado === 'cerrado' ? 'selected' : ''}>Cerrado</option>
                                </select>
                                <div class="flex gap-1">
                                    <button onclick="editAction('${action.id}')" class="text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600 transition" title="Editar acci√≥n">
                                        ‚úèÔ∏è
                                    </button>
                                    <button onclick="deleteAction('${action.id}')" class="text-xs bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600 transition" title="Eliminar acci√≥n">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                        </div>
                        ${action.origen ? `<p class="text-xs text-blue-600 mt-2">üîó Origen: ${action.origen}</p>` : ''}
                    </div>
                `;
            }).join('');
        }

        function showNewAction() {
            document.getElementById('newActionForm').classList.remove('hidden');
            document.getElementById('actionsList').classList.add('hidden');
        }

        function cancelNewAction() {
            document.getElementById('newActionForm').classList.add('hidden');
            document.getElementById('actionsList').classList.remove('hidden');
            document.querySelector('#newActionForm form').reset();
        }

        function saveAction(event) {
            event.preventDefault();
            if (!currentEstablishment) return;
            
            const formData = new FormData(event.target);
            const action = {
                id: 'act-' + Date.now(),
                titulo: formData.get('titulo'),
                descripcion: formData.get('descripcion'),
                prioridad: formData.get('prioridad'),
                sector: formData.get('sector'),
                responsable: formData.get('responsable'),
                vencimiento: formData.get('vencimiento'),
                estado: formData.get('estado'),
                establecimiento_id: currentEstablishment.id,
                fecha_creacion: new Date().toISOString()
            };
            
            appData.actions.push(action);
            saveData();
            cancelNewAction();
            loadActions();
            alert('‚úÖ Acci√≥n guardada correctamente');
        }

        function updateActionStatus(actionId, newStatus) {
            const action = appData.actions.find(a => a.id === actionId);
            if (action) {
                action.estado = newStatus;
                if (newStatus === 'cerrado') {
                    action.fecha_cierre = new Date().toISOString();
                }
                saveData();
                filterActions();
            }
        }

        function editAction(actionId) {
            const action = appData.actions.find(a => a.id === actionId);
            if (!action) return;
            
            // Mostrar formulario de nueva acci√≥n
            showNewAction();
            
            // Cargar datos en el formulario
            setTimeout(() => {
                document.querySelector('#newActionForm input[name="titulo"]').value = action.titulo;
                document.querySelector('#newActionForm textarea[name="descripcion"]').value = action.descripcion;
                document.querySelector('#newActionForm select[name="prioridad"]').value = action.prioridad;
                document.querySelector('#newActionForm input[name="sector"]').value = action.sector || '';
                document.querySelector('#newActionForm input[name="responsable"]').value = action.responsable;
                document.querySelector('#newActionForm input[name="vencimiento"]').value = action.vencimiento;
                
                // Cambiar el comportamiento del bot√≥n de guardar
                const form = document.querySelector('#newActionForm form');
                const originalOnSubmit = form.onsubmit;
                
                form.onsubmit = function(e) {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    
                    // Actualizar la acci√≥n existente
                    action.titulo = formData.get('titulo');
                    action.descripcion = formData.get('descripcion');
                    action.prioridad = formData.get('prioridad');
                    action.sector = formData.get('sector');
                    action.responsable = formData.get('responsable');
                    action.vencimiento = formData.get('vencimiento');
                    action.fecha_modificacion = new Date().toISOString();
                    
                    saveData();
                    cancelNewAction();
                    filterActions();
                    alert('‚úÖ Acci√≥n actualizada correctamente');
                    
                    // Restaurar el comportamiento original
                    form.onsubmit = originalOnSubmit;
                };
            }, 100);
        }

        function deleteAction(actionId) {
            const action = appData.actions.find(a => a.id === actionId);
            if (!action) return;
            
            if (!confirm(`¬øEst√° seguro de eliminar la acci√≥n "${action.titulo}"?\n\nEsta acci√≥n no se puede deshacer.`)) {
                return;
            }
            
            const index = appData.actions.findIndex(a => a.id === actionId);
            if (index > -1) {
                appData.actions.splice(index, 1);
                saveData();
                filterActions();
                alert('‚úÖ Acci√≥n eliminada correctamente');
            }
        }

        function exportActionsCSV() {
            if (!currentEstablishment) return;
            
            const actions = appData.actions.filter(a => a.establecimiento_id === currentEstablishment.id);
            if (actions.length === 0) {
                alert('No hay acciones para exportar');
                return;
            }
            
            let csv = 'ID,T√≠tulo,Descripci√≥n,Prioridad,Sector,Responsable,Vencimiento,Estado,Fecha Creaci√≥n\n';
            actions.forEach(a => {
                csv += `"${a.id}","${a.titulo}","${a.descripcion}","${a.prioridad}","${a.sector}","${a.responsable}","${a.vencimiento}","${a.estado}","${a.fecha_creacion}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `acciones_${currentEstablishment.nombre}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // ============= FIRE LOAD MODULE =============
        function addFireLoadMaterial() {
            const container = document.getElementById('fireLoadMaterials');
            const id = Date.now();
            const div = document.createElement('div');
            div.className = 'grid md:grid-cols-5 gap-2 items-center p-3 bg-gray-50 rounded';
            div.innerHTML = `
                <select class="border border-gray-300 rounded p-2" onchange="updatePCI(${id})">
                    ${Object.keys(FIRE_MATERIALS).map(m => `<option value="${m}">${m}</option>`).join('')}
                </select>
                <input type="number" id="mass-${id}" placeholder="Cantidad" step="0.01" min="0" class="border border-gray-300 rounded p-2">
                <input type="number" id="pci-${id}" placeholder="PCI" step="0.01" value="${FIRE_MATERIALS['Papel/Cart√≥n'].pci}" class="border border-gray-300 rounded p-2">
                <span class="text-sm text-gray-600">${FIRE_MATERIALS['Papel/Cart√≥n'].unit}</span>
                <button type="button" onclick="this.parentElement.remove()" class="bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600 transition"><i class="fas fa-times-circle text-red-600"></i></button>
            `;
            container.appendChild(div);
        }

        function updatePCI(id) {
            const select = event.target;
            const material = FIRE_MATERIALS[select.value];
            if (material) {
                document.getElementById(`pci-${id}`).value = material.pci;
            }
        }

        function calculateFireLoad() {
            const area = parseFloat(document.getElementById('fireLoadArea').value);
            if (!area || area <= 0) {
                alert('Ingrese un √°rea v√°lida');
                return;
            }
            
            const materials = [];
            let totalMJ = 0;
            
            document.querySelectorAll('#fireLoadMaterials > div').forEach(div => {
                const select = div.querySelector('select');
                const massInput = div.querySelectorAll('input')[0];
                const pciInput = div.querySelectorAll('input')[1];
                
                const mass = parseFloat(massInput.value) || 0;
                const pci = parseFloat(pciInput.value) || 0;
                
                if (mass > 0 && pci > 0) {
                    const mj = mass * pci;
                    totalMJ += mj;
                    materials.push({
                        material: select.value,
                        cantidad: mass,
                        pci: pci,
                        energia: mj
                    });
                }
            });
            
            if (materials.length === 0) {
                alert('Agregue al menos un material con cantidad');
                return;
            }
            
            const cargaFuego = totalMJ / area;
            let clasificacion, color, recomendaciones;
            
            if (cargaFuego < 15) {
                clasificacion = 'BAJO';
                color = 'green';
                recomendaciones = 'Riesgo bajo. Mantener medidas preventivas b√°sicas.';
            } else if (cargaFuego < 30) {
                clasificacion = 'MODERADO';
                color = 'yellow';
                recomendaciones = 'Riesgo moderado. Verificar cantidad y tipo de extintores.';
            } else if (cargaFuego < 60) {
                clasificacion = 'ALTO';
                color = 'orange';
                recomendaciones = 'Riesgo alto. Considerar compartimentaci√≥n y rociadores autom√°ticos.';
            } else {
                clasificacion = 'MUY ALTO';
                color = 'red';
                recomendaciones = 'Riesgo muy alto. Implementar compartimentaci√≥n, rociadores autom√°ticos y extintores adicionales.';
            }
            
            const results = document.getElementById('fireLoadResults');
            results.classList.remove('hidden');
            results.innerHTML = `
                <h3 class="font-bold text-xl mb-4">üìä Resultados del C√°lculo</h3>
                <div class="grid md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded">
                        <div class="text-sm text-gray-600">Energ√≠a Total</div>
                        <div class="text-3xl font-bold text-blue-600">${totalMJ.toFixed(2)} MJ</div>
                    </div>
                    <div class="bg-${color}-50 p-4 rounded">
                        <div class="text-sm text-gray-600">Carga de Fuego</div>
                        <div class="text-3xl font-bold text-${color}-600">${cargaFuego.toFixed(2)} MJ/m¬≤</div>
                        <div class="text-sm font-semibold mt-1">Clasificaci√≥n: ${clasificacion}</div>
                    </div>
                </div>
                
                <div class="bg-gray-100 p-4 rounded mb-4">
                    <h4 class="font-bold mb-2">Desglose por Material:</h4>
                    <div class="space-y-2">
                        ${materials.map(m => `
                            <div class="text-sm">
                                <strong>${m.material}:</strong> ${m.cantidad} √ó ${m.pci} = ${m.energia.toFixed(2)} MJ
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="bg-blue-50 border-l-4 border-blue-600 p-4">
                    <p class="font-semibold mb-2"><i class="fas fa-clipboard-list"></i> Recomendaciones:</p>
                    <p class="text-sm">${recomendaciones}</p>
                    <p class="text-xs text-gray-600 mt-2">
                        <strong>Nota:</strong> Valores aproximados. Verificar con normativa IRAM 3620 y consultar profesional.
                    </p>
                </div>
                
                <button onclick="saveFireLoad(${cargaFuego}, '${clasificacion}')" class="mt-4 bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold w-full transition">
                    <i class="fas fa-save"></i> Guardar C√°lculo
                </button>
            `;
        }

        function saveFireLoad(cargaFuego, clasificacion) {
            if (!currentEstablishment) return;
            
            const record = {
                id: 'fl-' + Date.now(),
                establecimiento_id: currentEstablishment.id,
                fecha: new Date().toISOString(),
                area: parseFloat(document.getElementById('fireLoadArea').value),
                carga_fuego: cargaFuego,
                clasificacion: clasificacion
            };
            
            appData.fireloads.push(record);
            saveData();
            alert('‚úÖ C√°lculo de carga de fuego guardado');
        }

        // ============= EXTINGUISHERS MODULE =============
        function loadExtinguishers() {
            if (!currentEstablishment) return;
            
            const container = document.getElementById('extinguishersList');
            const extinguishers = appData.extinguishers.filter(e => e.establecimiento_id === currentEstablishment.id);
            
            if (extinguishers.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay extintores registrados</p>';
                return;
            }
            
            container.innerHTML = extinguishers.map(ext => {
                // Calcular fecha de vencimiento si no existe
                if (!ext.fecha_vencimiento && ext.ultima_recarga) {
                    const fechaRecarga = new Date(ext.ultima_recarga);
                    const proxVenc = new Date(fechaRecarga);
                    proxVenc.setFullYear(proxVenc.getFullYear() + 1);
                    ext.fecha_vencimiento = proxVenc.toISOString().split('T')[0];
                }
                
                const fechaVenc = new Date(ext.fecha_vencimiento);
                const diasHastaVenc = Math.floor((fechaVenc - new Date()) / (1000*60*60*24));
                const isVencido = diasHastaVenc < 0;
                const isPorVencer = diasHastaVenc >= 0 && diasHastaVenc <= 30;
                
                return `
                    <div class="border border-gray-300 rounded-lg p-4 hover:shadow-md transition ${isVencido ? 'bg-red-50 border-red-500' : isPorVencer ? 'bg-yellow-50 border-yellow-500' : ''}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="font-bold text-lg">üßØ ${ext.codigo}</h4>
                                <p class="text-sm text-gray-600">${ext.tipo} - ${ext.capacidad} kg</p>
                                <p class="text-sm text-gray-600"><i class="fas fa-map-marker-alt"></i> ${ext.ubicacion}</p>
                                <p class="text-sm text-gray-600">
                                    <i class="fas fa-sync"></i> √öltima recarga: ${ext.ultima_recarga}
                                </p>
                                <p class="text-sm font-semibold ${isVencido ? 'text-red-600' : isPorVencer ? 'text-yellow-600' : 'text-green-600'}">
                                    ‚è∞ Vence: ${ext.fecha_vencimiento}
                                    ${isVencido ? ' ‚ö†Ô∏è VENCIDO' : isPorVencer ? ` (en ${diasHastaVenc} d√≠as)` : ''}
                                </p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editExtinguisher('${ext.id}')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm font-semibold transition">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button onclick="deleteExtinguisher('${ext.id}')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm font-semibold transition">
                                    üóëÔ∏è Eliminar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Renderizar calendario
            renderExtinguishersCalendar();
        }

        function showNewExtinguisher() {
            document.getElementById('newExtinguisherForm').classList.remove('hidden');
            document.getElementById('extinguishersList').classList.add('hidden');
        }

        function cancelNewExtinguisher() {
            document.getElementById('newExtinguisherForm').classList.add('hidden');
            document.getElementById('extinguishersList').classList.remove('hidden');
            
            const form = document.querySelector('#newExtinguisherForm form');
            form.reset();
            delete form.dataset.editingId;
            
            // Restaurar el t√≠tulo original
            document.querySelector('#newExtinguisherForm h3').textContent = 'Nuevo Extintor';
        }

        function saveExtinguisher(event) {
            event.preventDefault();
            if (!currentEstablishment) return;
            
            const formData = new FormData(event.target);
            const extinguisherId = event.target.dataset.editingId;
            
            // Calcular fecha de vencimiento (1 a√±o despu√©s de la recarga)
            const fechaRecarga = new Date(formData.get('ultima_recarga'));
            const fechaVencimiento = new Date(fechaRecarga);
            fechaVencimiento.setFullYear(fechaVencimiento.getFullYear() + 1);
            
            if (extinguisherId) {
                // Editar extintor existente
                const index = appData.extinguishers.findIndex(e => e.id === extinguisherId);
                if (index !== -1) {
                    appData.extinguishers[index] = {
                        ...appData.extinguishers[index],
                        codigo: formData.get('codigo'),
                        tipo: formData.get('tipo'),
                        capacidad: parseFloat(formData.get('capacidad')),
                        ubicacion: formData.get('ubicacion'),
                        ultima_recarga: formData.get('ultima_recarga'),
                        fecha_vencimiento: fechaVencimiento.toISOString().split('T')[0]
                    };
                    alert('‚úÖ Extintor actualizado correctamente');
                }
            } else {
                // Crear nuevo extintor
                const extinguisher = {
                    id: 'ext-' + Date.now(),
                    codigo: formData.get('codigo'),
                    tipo: formData.get('tipo'),
                    capacidad: parseFloat(formData.get('capacidad')),
                    ubicacion: formData.get('ubicacion'),
                    ultima_recarga: formData.get('ultima_recarga'),
                    fecha_vencimiento: fechaVencimiento.toISOString().split('T')[0],
                    establecimiento_id: currentEstablishment.id,
                    fecha_registro: new Date().toISOString()
                };
                appData.extinguishers.push(extinguisher);
                alert('‚úÖ Extintor registrado correctamente');
            }
            
            saveData();
            cancelNewExtinguisher();
            loadExtinguishers();
            renderExtinguishersCalendar(); // Actualizar calendario de extintores
            renderMainCalendar(); // Actualizar calendario principal
        }

        function editExtinguisher(id) {
            const extinguisher = appData.extinguishers.find(e => e.id === id);
            if (!extinguisher) return;
            
            // Mostrar el formulario
            document.getElementById('newExtinguisherForm').classList.remove('hidden');
            document.getElementById('extinguishersList').classList.add('hidden');
            
            // Cambiar el t√≠tulo del formulario
            document.querySelector('#newExtinguisherForm h3').textContent = 'Editar Extintor';
            
            // Llenar el formulario con los datos existentes
            const form = document.querySelector('#newExtinguisherForm form');
            form.querySelector('[name="codigo"]').value = extinguisher.codigo;
            form.querySelector('[name="tipo"]').value = extinguisher.tipo;
            form.querySelector('[name="capacidad"]').value = extinguisher.capacidad;
            form.querySelector('[name="ubicacion"]').value = extinguisher.ubicacion;
            form.querySelector('[name="ultima_recarga"]').value = extinguisher.ultima_recarga;
            
            // Marcar el formulario como en modo edici√≥n
            form.dataset.editingId = id;
        }

        function deleteExtinguisher(id) {
            const extinguisher = appData.extinguishers.find(e => e.id === id);
            if (!extinguisher) return;
            
            if (confirm(`¬øEst√° seguro de eliminar el extintor ${extinguisher.codigo}?\nEsta acci√≥n no se puede deshacer.`)) {
                appData.extinguishers = appData.extinguishers.filter(e => e.id !== id);
                saveData();
                loadExtinguishers();
                renderExtinguishersCalendar(); // Actualizar calendario de extintores
                renderMainCalendar(); // Actualizar calendario principal
                alert('‚úÖ Extintor eliminado correctamente');
            }
        }

        // ============= CALENDARIO DE EXTINTORES =============
        let currentCalendarMonth = new Date().getMonth();
        let currentCalendarYear = new Date().getFullYear();

        function renderExtinguishersCalendar() {
            if (!currentEstablishment) return;
            
            const extinguishers = appData.extinguishers.filter(e => e.establecimiento_id === currentEstablishment.id);
            
            // Actualizar t√≠tulo del mes
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                              'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            document.getElementById('calendarMonthYear').textContent = 
                `${monthNames[currentCalendarMonth]} ${currentCalendarYear}`;
            
            // Obtener primer y √∫ltimo d√≠a del mes
            const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1);
            const lastDay = new Date(currentCalendarYear, currentCalendarMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDayOfWeek = firstDay.getDay();
            
            // Crear mapa de vencimientos por d√≠a
            const vencimientosPorDia = {};
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            
            extinguishers.forEach(ext => {
                if (!ext.fecha_vencimiento) return;
                
                const fechaVenc = new Date(ext.fecha_vencimiento);
                if (fechaVenc.getMonth() === currentCalendarMonth && 
                    fechaVenc.getFullYear() === currentCalendarYear) {
                    const dia = fechaVenc.getDate();
                    if (!vencimientosPorDia[dia]) {
                        vencimientosPorDia[dia] = [];
                    }
                    
                    // Determinar estado del extintor
                    const diasHastaVenc = Math.floor((fechaVenc - hoy) / (1000*60*60*24));
                    const isVencido = diasHastaVenc < 0;
                    const isPorVencer = diasHastaVenc >= 0 && diasHastaVenc <= 30;
                    
                    vencimientosPorDia[dia].push({
                        codigo: ext.codigo,
                        isVencido: isVencido,
                        isPorVencer: isPorVencer,
                        diasHastaVenc: diasHastaVenc
                    });
                }
            });
            
            // Generar d√≠as del calendario
            const calendarDays = document.getElementById('calendarDays');
            calendarDays.innerHTML = '';
            
            // Celdas vac√≠as antes del primer d√≠a
            for (let i = 0; i < startDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'p-2 bg-gray-50 rounded';
                calendarDays.appendChild(emptyCell);
            }
            
            // D√≠as del mes
            for (let dia = 1; dia <= daysInMonth; dia++) {
                const dayCell = document.createElement('div');
                const fechaDia = new Date(currentCalendarYear, currentCalendarMonth, dia);
                const esHoy = fechaDia.toDateString() === hoy.toDateString();
                
                let bgColor = 'bg-white';
                let textColor = 'text-gray-800';
                let borderColor = 'border-gray-200';
                
                // Verificar si hay vencimientos
                if (vencimientosPorDia[dia]) {
                    const extintores = vencimientosPorDia[dia];
                    const hayVencidos = extintores.some(e => e.isVencido);
                    const hayPorVencer = extintores.some(e => e.isPorVencer);
                    
                    if (hayVencidos) {
                        bgColor = 'bg-red-500';
                        textColor = 'text-white';
                    } else if (hayPorVencer) {
                        bgColor = 'bg-yellow-400';
                        textColor = 'text-gray-900';
                    } else {
                        bgColor = 'bg-green-400';
                        textColor = 'text-white';
                    }
                    
                    dayCell.title = extintores.map(e => 
                        `${e.codigo}: ${e.isVencido ? 'VENCIDO' : e.isPorVencer ? `Vence en ${e.diasHastaVenc} d√≠as` : 'Vence'}`
                    ).join('\n');
                    dayCell.className = `p-2 border ${borderColor} rounded cursor-pointer hover:shadow-lg transition ${bgColor} ${textColor}`;
                    
                    dayCell.innerHTML = `
                        <div class="font-bold text-center">${dia}</div>
                        <div class="text-xs text-center mt-1">${extintores.length} <i class="fas fa-fire-extinguisher"></i></div>
                    `;
                    
                    dayCell.onclick = () => showVencimientoDetails(dia, currentCalendarMonth, currentCalendarYear);
                } else {
                    if (esHoy) {
                        bgColor = 'bg-blue-400';
                        textColor = 'text-white';
                    }
                    dayCell.className = `p-3 border ${borderColor} rounded ${bgColor} ${textColor} text-center`;
                    dayCell.innerHTML = `<div class="font-semibold">${dia}</div>`;
                }
                
                calendarDays.appendChild(dayCell);
            }
        }

        function changeCalendarMonth(delta) {
            currentCalendarMonth += delta;
            
            if (currentCalendarMonth > 11) {
                currentCalendarMonth = 0;
                currentCalendarYear++;
            } else if (currentCalendarMonth < 0) {
                currentCalendarMonth = 11;
                currentCalendarYear--;
            }
            
            renderExtinguishersCalendar();
        }

        function showVencimientoDetails(dia, mes, a√±o) {
            if (!currentEstablishment) return;
            
            const extinguishers = appData.extinguishers.filter(e => {
                if (!e.fecha_vencimiento || e.establecimiento_id !== currentEstablishment.id) return false;
                const fechaVenc = new Date(e.fecha_vencimiento);
                return fechaVenc.getDate() === dia && 
                       fechaVenc.getMonth() === mes && 
                       fechaVenc.getFullYear() === a√±o;
            });
            
            if (extinguishers.length === 0) return;
            
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                              'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            const detalles = extinguishers.map(ext => {
                const fechaVenc = new Date(ext.fecha_vencimiento);
                const diasHastaVenc = Math.floor((fechaVenc - hoy) / (1000*60*60*24));
                const isVencido = diasHastaVenc < 0;
                const isPorVencer = diasHastaVenc >= 0 && diasHastaVenc <= 30;
                
                return `
                    <div class="p-3 border ${isVencido ? 'border-red-500 bg-red-50' : isPorVencer ? 'border-yellow-500 bg-yellow-50' : 'border-green-500 bg-green-50'} rounded mb-2">
                        <div class="font-bold">üßØ ${ext.codigo}</div>
                        <div class="text-sm">${ext.tipo} - ${ext.capacidad} kg</div>
                        <div class="text-sm"><i class="fas fa-map-marker-alt"></i> ${ext.ubicacion}</div>
                        <div class="text-sm font-semibold ${isVencido ? 'text-red-600' : isPorVencer ? 'text-yellow-600' : 'text-green-600'}">
                            ${isVencido ? `‚ö†Ô∏è VENCIDO hace ${Math.abs(diasHastaVenc)} d√≠as` : 
                              isPorVencer ? `‚ö†Ô∏è Vence en ${diasHastaVenc} d√≠as` : 
                              `‚úÖ Vence en ${diasHastaVenc} d√≠as`}
                        </div>
                    </div>
                `;
            }).join('');
            
            alert(`üìÖ Vencimientos del ${dia} de ${monthNames[mes]} ${a√±o}\n\n${extinguishers.map(e => `üßØ ${e.codigo} - ${e.ubicacion}`).join('\n')}`);
        }

        // ============= RISK MATRIX MODULE =============
        function loadRisks() {
            if (!currentEstablishment) return;
            
            const container = document.getElementById('risksList');
            const risks = appData.risks.filter(r => r.establecimiento_id === currentEstablishment.id);
            
            if (risks.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay riesgos registrados</p>';
                return;
            }
            
            risks.sort((a, b) => b.score - a.score);
            
            container.innerHTML = risks.map(risk => {
                const colors = {
                    'Cr√≠tico': 'border-red-600 bg-red-50',
                    'Alto': 'border-orange-500 bg-orange-50',
                    'Moderado': 'border-yellow-500 bg-yellow-50',
                    'Bajo': 'border-green-500 bg-green-50'
                };
                
                return `
                    <div class="border-l-4 ${colors[risk.nivel]} rounded-lg p-4 hover:shadow-md transition">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="font-bold text-2xl">${risk.score}</span>
                                    <span class="px-3 py-1 rounded-full text-xs font-semibold ${colors[risk.nivel].replace('border-', 'bg-').replace('bg-', 'bg-').replace('-50', '-200')}">${risk.nivel}</span>
                                </div>
                                <h4 class="font-bold">${risk.descripcion}</h4>
                                <p class="text-sm text-gray-600 mt-1"><i class="fas fa-map-marker-alt"></i> ${risk.sector || 'General'}</p>
                                <div class="flex gap-4 mt-2 text-xs text-gray-500">
                                    <span>P: ${risk.probabilidad}</span>
                                    <span>S: ${risk.severidad}</span>
                                </div>
                                ${risk.controles ? `<p class="text-sm text-gray-700 mt-2 bg-white p-2 rounded">${risk.controles}</p>` : ''}
                            </div>
                            <div class="flex flex-col gap-2 ml-4">
                                <button onclick="editRisk('${risk.id}')" class="text-xs bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition" title="Editar riesgo">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button onclick="deleteRisk('${risk.id}')" class="text-xs bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition" title="Eliminar riesgo">
                                    üóëÔ∏è Eliminar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showNewRisk() {
            document.getElementById('newRiskForm').classList.remove('hidden');
            document.getElementById('risksList').classList.add('hidden');
        }

        function cancelNewRisk() {
            document.getElementById('newRiskForm').classList.add('hidden');
            document.getElementById('risksList').classList.remove('hidden');
            document.querySelector('#newRiskForm form').reset();
        }

        function saveRisk(event) {
            event.preventDefault();
            if (!currentEstablishment) return;
            
            const formData = new FormData(event.target);
            const prob = parseInt(formData.get('probabilidad'));
            const sev = parseInt(formData.get('severidad'));
            const score = prob * sev;
            
            let nivel;
            if (score >= 16) nivel = 'Cr√≠tico';
            else if (score >= 10) nivel = 'Alto';
            else if (score >= 5) nivel = 'Moderado';
            else nivel = 'Bajo';
            
            const risk = {
                id: 'risk-' + Date.now(),
                descripcion: formData.get('descripcion'),
                sector: formData.get('sector'),
                probabilidad: prob,
                severidad: sev,
                score: score,
                nivel: nivel,
                controles: formData.get('controles'),
                establecimiento_id: currentEstablishment.id,
                fecha_evaluacion: new Date().toISOString()
            };
            
            appData.risks.push(risk);
            saveData();
            cancelNewRisk();
            loadRisks();
            
            if (nivel === 'Cr√≠tico') {
                alert('‚ö†Ô∏è RIESGO CR√çTICO IDENTIFICADO\n\nScore: ' + score + '\nSe requiere acci√≥n inmediata.');
            } else {
                alert('‚úÖ Riesgo registrado correctamente\n\nNivel: ' + nivel + ' (Score: ' + score + ')');
            }
        }

        function editRisk(riskId) {
            const risk = appData.risks.find(r => r.id === riskId);
            if (!risk) return;
            
            // Mostrar formulario
            showNewRisk();
            
            // Cargar datos
            setTimeout(() => {
                document.querySelector('#newRiskForm input[name="descripcion"]').value = risk.descripcion;
                document.querySelector('#newRiskForm input[name="sector"]').value = risk.sector || '';
                document.querySelector('#newRiskForm select[name="probabilidad"]').value = risk.probabilidad;
                document.querySelector('#newRiskForm select[name="severidad"]').value = risk.severidad;
                document.querySelector('#newRiskForm textarea[name="controles"]').value = risk.controles || '';
                
                // Cambiar comportamiento del formulario
                const form = document.querySelector('#newRiskForm form');
                const originalOnSubmit = form.onsubmit;
                
                form.onsubmit = function(e) {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const prob = parseInt(formData.get('probabilidad'));
                    const sev = parseInt(formData.get('severidad'));
                    const score = prob * sev;
                    
                    let nivel;
                    if (score >= 16) nivel = 'Cr√≠tico';
                    else if (score >= 10) nivel = 'Alto';
                    else if (score >= 5) nivel = 'Moderado';
                    else nivel = 'Bajo';
                    
                    // Actualizar el riesgo
                    risk.descripcion = formData.get('descripcion');
                    risk.sector = formData.get('sector');
                    risk.probabilidad = prob;
                    risk.severidad = sev;
                    risk.score = score;
                    risk.nivel = nivel;
                    risk.controles = formData.get('controles');
                    risk.fecha_modificacion = new Date().toISOString();
                    
                    saveData();
                    cancelNewRisk();
                    loadRisks();
                    alert('‚úÖ Riesgo actualizado correctamente\n\nNivel: ' + nivel + ' (Score: ' + score + ')');
                    
                    // Restaurar comportamiento original
                    form.onsubmit = originalOnSubmit;
                };
            }, 100);
        }

        function deleteRisk(riskId) {
            const risk = appData.risks.find(r => r.id === riskId);
            if (!risk) return;
            
            if (!confirm(`¬øEst√° seguro de eliminar el riesgo "${risk.descripcion}"?\n\nEsta acci√≥n no se puede deshacer.`)) {
                return;
            }
            
            const index = appData.risks.findIndex(r => r.id === riskId);
            if (index > -1) {
                appData.risks.splice(index, 1);
                saveData();
                loadRisks();
                alert('‚úÖ Riesgo eliminado correctamente');
            }
        }

        // ============= TRAINING MODULE =============
        function loadTrainings() {
            if (!currentEstablishment) return;
            
            const container = document.getElementById('trainingsList');
            const trainings = appData.trainings
                .filter(t => t.establecimiento_id === currentEstablishment.id)
                .sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            if (trainings.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay capacitaciones registradas</p>';
                return;
            }
            
            container.innerHTML = trainings.map(training => `
                <div class="border border-gray-300 rounded-lg p-4 hover:shadow-md transition">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-bold"><i class="fas fa-user"></i>‚Äçüè´ ${training.titulo}</h4>
                            <p class="text-sm text-gray-600 mt-1">üìÖ ${training.fecha} | ‚è±Ô∏è ${training.duracion} hs</p>
                            <p class="text-sm text-gray-600">Instructor: ${training.instructor}</p>
                            <p class="text-sm text-gray-600">Participantes: ${training.participantes.length}</p>
                        </div>
                        <div class="flex flex-col gap-2 ml-4">
                            <button onclick="generateCertificate('${training.id}')" class="text-sm bg-blue-100 text-blue-800 px-3 py-1 rounded hover:bg-blue-200 transition">
                                üìú Certificado
                            </button>
                            <button onclick="editTraining('${training.id}')" class="text-sm bg-green-100 text-green-800 px-3 py-1 rounded hover:bg-green-200 transition">
                                ‚úèÔ∏è Editar
                            </button>
                            <button onclick="deleteTraining('${training.id}')" class="text-sm bg-red-100 text-red-800 px-3 py-1 rounded hover:bg-red-200 transition">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showNewTraining() {
            document.getElementById('newTrainingForm').classList.remove('hidden');
            document.getElementById('trainingsList').classList.add('hidden');
        }

        function cancelNewTraining() {
            document.getElementById('newTrainingForm').classList.add('hidden');
            document.getElementById('trainingsList').classList.remove('hidden');
            document.querySelector('#newTrainingForm form').reset();
        }

        function saveTraining(event) {
            event.preventDefault();
            if (!currentEstablishment) return;
            
            const formData = new FormData(event.target);
            const participantesText = formData.get('participantes');
            const participantes = participantesText.split('\n').filter(p => p.trim());
            
            const training = {
                id: 'train-' + Date.now(),
                titulo: formData.get('titulo'),
                fecha: formData.get('fecha'),
                duracion: parseFloat(formData.get('duracion')),
                instructor: formData.get('instructor'),
                participantes: participantes,
                establecimiento_id: currentEstablishment.id,
                fecha_registro: new Date().toISOString()
            };
            
            appData.trainings.push(training);
            saveData();
            cancelNewTraining();
            loadTrainings();
            alert(`‚úÖ Capacitaci√≥n registrada\n\nParticipantes: ${participantes.length}`);
        }

        function generateCertificate(trainingId) {
            alert('üìú Generaci√≥n de certificados en desarrollo.\n\nPr√≥ximamente: Certificados PDF personalizados con logo y firma digital.');
        }

        function editTraining(trainingId) {
            const training = appData.trainings.find(t => t.id === trainingId);
            if (!training) return;
            
            // Mostrar formulario
            showNewTraining();
            
            // Cargar datos
            setTimeout(() => {
                document.querySelector('#newTrainingForm input[name="titulo"]').value = training.titulo;
                document.querySelector('#newTrainingForm input[name="fecha"]').value = training.fecha;
                document.querySelector('#newTrainingForm input[name="duracion"]').value = training.duracion;
                document.querySelector('#newTrainingForm input[name="instructor"]').value = training.instructor;
                document.querySelector('#newTrainingForm textarea[name="participantes"]').value = training.participantes.join('\n');
                
                // Cambiar comportamiento del formulario
                const form = document.querySelector('#newTrainingForm form');
                const originalOnSubmit = form.onsubmit;
                
                form.onsubmit = function(e) {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const participantesText = formData.get('participantes');
                    const participantes = participantesText.split('\n').filter(p => p.trim());
                    
                    // Actualizar la capacitaci√≥n
                    training.titulo = formData.get('titulo');
                    training.fecha = formData.get('fecha');
                    training.duracion = parseFloat(formData.get('duracion'));
                    training.instructor = formData.get('instructor');
                    training.participantes = participantes;
                    training.fecha_modificacion = new Date().toISOString();
                    
                    saveData();
                    cancelNewTraining();
                    loadTrainings();
                    alert(`‚úÖ Capacitaci√≥n actualizada\n\nParticipantes: ${participantes.length}`);
                    
                    // Restaurar comportamiento original
                    form.onsubmit = originalOnSubmit;
                };
            }, 100);
        }

        function deleteTraining(trainingId) {
            const training = appData.trainings.find(t => t.id === trainingId);
            if (!training) return;
            
            if (!confirm(`¬øEst√° seguro de eliminar la capacitaci√≥n "${training.titulo}"?\n\nSe perder√°n los registros de ${training.participantes.length} participantes.\n\nEsta acci√≥n no se puede deshacer.`)) {
                return;
            }
            
            const index = appData.trainings.findIndex(t => t.id === trainingId);
            if (index > -1) {
                appData.trainings.splice(index, 1);
                saveData();
                loadTrainings();
                alert('‚úÖ Capacitaci√≥n eliminada correctamente');
            }
        }

        // ============= ANNUAL TRAINING PLAN MODULE =============
        function showAnnualPlan() {
            if (!currentEstablishment) {
                alert('‚ö†Ô∏è Seleccione un establecimiento primero');
                return;
            }
            
            hideAllViews();
            document.getElementById('annualPlanView').classList.remove('hidden');
            loadAnnualPlan();
        }

        function closeAnnualPlan() {
            document.getElementById('annualPlanView').classList.add('hidden');
            document.getElementById('newAnnualPlanForm').classList.add('hidden');
            showModule('training');
        }

        function loadAnnualPlan() {
            if (!currentEstablishment) return;
            
            const container = document.getElementById('annualPlanList');
            const planItems = appData.annualTrainingPlan
                .filter(item => item.establecimiento_id === currentEstablishment.id)
                .sort((a, b) => {
                    if (a.anio !== b.anio) return a.anio - b.anio;
                    return a.mes.localeCompare(b.mes);
                });
            
            if (planItems.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay capacitaciones planificadas</p>';
                return;
            }
            
            // Agrupar por a√±o y mes
            const groupedByYear = {};
            planItems.forEach(item => {
                if (!groupedByYear[item.anio]) {
                    groupedByYear[item.anio] = {};
                }
                if (!groupedByYear[item.anio][item.mes]) {
                    groupedByYear[item.anio][item.mes] = [];
                }
                groupedByYear[item.anio][item.mes].push(item);
            });
            
            const monthNames = {
                '01': 'Enero', '02': 'Febrero', '03': 'Marzo', '04': 'Abril',
                '05': 'Mayo', '06': 'Junio', '07': 'Julio', '08': 'Agosto',
                '09': 'Septiembre', '10': 'Octubre', '11': 'Noviembre', '12': 'Diciembre'
            };
            
            let html = '';
            
            Object.keys(groupedByYear).sort().forEach(year => {
                html += `<div class="mb-6">
                    <h3 class="text-xl font-bold text-purple-800 mb-4 pb-2 border-b-2 border-purple-300">üìÖ A√±o ${year}</h3>`;
                
                Object.keys(groupedByYear[year]).sort().forEach(month => {
                    html += `<div class="mb-4">
                        <h4 class="text-lg font-semibold text-purple-700 mb-2">${monthNames[month]}</h4>
                        <div class="space-y-2">`;
                    
                    groupedByYear[year][month].forEach(item => {
                        const destinatarios = item.destinatarios && item.destinatarios.length > 0 
                            ? item.destinatarios.join(', ') 
                            : 'No especificado';
                        
                        html += `
                            <div class="border border-purple-200 bg-purple-50 rounded-lg p-4 hover:shadow-md transition">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <h5 class="font-bold text-gray-800"><i class="fas fa-user"></i>‚Äçüè´ ${item.titulo}</h5>
                                        <p class="text-sm text-gray-600 mt-1">‚è±Ô∏è Duraci√≥n: ${item.duracion} hs</p>
                                        ${item.instructor ? `<p class="text-sm text-gray-600">Instructor: ${item.instructor}</p>` : ''}
                                        ${item.objetivo ? `<p class="text-sm text-gray-700 mt-1"><strong>Objetivo:</strong> ${item.objetivo}</p>` : ''}
                                        <p class="text-sm text-gray-600 mt-1"><strong>Destinatarios:</strong> ${destinatarios}</p>
                                    </div>
                                    <div class="flex flex-col gap-2 ml-4">
                                        <button onclick="editAnnualPlanItem('${item.id}')" class="text-sm bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition">
                                            ‚úèÔ∏è Editar
                                        </button>
                                        <button onclick="deleteAnnualPlanItem('${item.id}')" class="text-sm bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition">
                                            üóëÔ∏è Eliminar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `</div></div>`;
                });
                
                html += `</div>`;
            });
            
            container.innerHTML = html;
        }

        function showNewAnnualPlanItem() {
            document.getElementById('newAnnualPlanForm').classList.remove('hidden');
            document.getElementById('annualPlanList').classList.add('hidden');
        }

        function cancelNewAnnualPlanItem() {
            document.getElementById('newAnnualPlanForm').classList.add('hidden');
            document.getElementById('annualPlanList').classList.remove('hidden');
            document.querySelector('#newAnnualPlanForm form').reset();
        }

        function saveAnnualPlanItem(event) {
            event.preventDefault();
            if (!currentEstablishment) return;
            
            const formData = new FormData(event.target);
            const destinatariosText = formData.get('destinatarios');
            const destinatarios = destinatariosText ? destinatariosText.split('\n').filter(d => d.trim()) : [];
            
            const planItem = {
                id: 'plan-' + Date.now(),
                titulo: formData.get('titulo'),
                mes: formData.get('mes'),
                anio: parseInt(formData.get('anio')),
                duracion: parseFloat(formData.get('duracion')),
                instructor: formData.get('instructor') || '',
                objetivo: formData.get('objetivo') || '',
                destinatarios: destinatarios,
                establecimiento_id: currentEstablishment.id,
                fecha_registro: new Date().toISOString()
            };
            
            appData.annualTrainingPlan.push(planItem);
            saveData();
            cancelNewAnnualPlanItem();
            loadAnnualPlan();
            alert('‚úÖ Capacitaci√≥n agregada al plan anual');
        }

        function editAnnualPlanItem(itemId) {
            const item = appData.annualTrainingPlan.find(i => i.id === itemId);
            if (!item) return;
            
            // Mostrar formulario
            showNewAnnualPlanItem();
            
            // Cargar datos
            setTimeout(() => {
                document.querySelector('#newAnnualPlanForm input[name="titulo"]').value = item.titulo;
                document.querySelector('#newAnnualPlanForm select[name="mes"]').value = item.mes;
                document.querySelector('#newAnnualPlanForm input[name="anio"]').value = item.anio;
                document.querySelector('#newAnnualPlanForm input[name="duracion"]').value = item.duracion;
                document.querySelector('#newAnnualPlanForm input[name="instructor"]').value = item.instructor || '';
                document.querySelector('#newAnnualPlanForm textarea[name="objetivo"]').value = item.objetivo || '';
                document.querySelector('#newAnnualPlanForm textarea[name="destinatarios"]').value = item.destinatarios.join('\n');
                
                // Cambiar comportamiento del formulario
                const form = document.querySelector('#newAnnualPlanForm form');
                const originalOnSubmit = form.onsubmit;
                
                form.onsubmit = function(e) {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const destinatariosText = formData.get('destinatarios');
                    const destinatarios = destinatariosText ? destinatariosText.split('\n').filter(d => d.trim()) : [];
                    
                    // Actualizar el item
                    item.titulo = formData.get('titulo');
                    item.mes = formData.get('mes');
                    item.anio = parseInt(formData.get('anio'));
                    item.duracion = parseFloat(formData.get('duracion'));
                    item.instructor = formData.get('instructor') || '';
                    item.objetivo = formData.get('objetivo') || '';
                    item.destinatarios = destinatarios;
                    item.fecha_modificacion = new Date().toISOString();
                    
                    saveData();
                    cancelNewAnnualPlanItem();
                    loadAnnualPlan();
                    alert('‚úÖ Capacitaci√≥n del plan anual actualizada');
                    
                    // Restaurar comportamiento original
                    form.onsubmit = originalOnSubmit;
                };
            }, 100);
        }

        function deleteAnnualPlanItem(itemId) {
            const item = appData.annualTrainingPlan.find(i => i.id === itemId);
            if (!item) return;
            
            if (!confirm(`¬øEst√° seguro de eliminar "${item.titulo}" del plan anual?\n\nEsta acci√≥n no se puede deshacer.`)) {
                return;
            }
            
            const index = appData.annualTrainingPlan.findIndex(i => i.id === itemId);
            if (index > -1) {
                appData.annualTrainingPlan.splice(index, 1);
                saveData();
                loadAnnualPlan();
                alert('‚úÖ Capacitaci√≥n eliminada del plan anual');
            }
        }

        function exportAnnualPlan() {
            if (!currentEstablishment) {
                alert('Seleccione un establecimiento primero');
                return;
            }
            
            const establishment = currentEstablishment;
            const planItems = appData.annualTrainingPlan
                .filter(item => item.establecimiento_id === currentEstablishment.id)
                .sort((a, b) => {
                    if (a.anio !== b.anio) return a.anio - b.anio;
                    return a.mes.localeCompare(b.mes);
                });
            
            if (planItems.length === 0) {
                alert('No hay capacitaciones en el plan anual para exportar');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // T√≠tulo
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('PLAN ANUAL DE CAPACITACIONES', 105, 20, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Establecimiento: ${establishment.nombre}`, 20, 30);
            doc.text(`Generado: ${new Date().toLocaleDateString('es-AR')}`, 20, 36);
            
            let y = 45;
            
            // Agrupar por a√±o
            const groupedByYear = {};
            planItems.forEach(item => {
                if (!groupedByYear[item.anio]) {
                    groupedByYear[item.anio] = [];
                }
                groupedByYear[item.anio].push(item);
            });
            
            const monthNames = {
                '01': 'Enero', '02': 'Febrero', '03': 'Marzo', '04': 'Abril',
                '05': 'Mayo', '06': 'Junio', '07': 'Julio', '08': 'Agosto',
                '09': 'Septiembre', '10': 'Octubre', '11': 'Noviembre', '12': 'Diciembre'
            };
            
            Object.keys(groupedByYear).sort().forEach(year => {
                if (y > 250) {
                    doc.addPage();
                    y = 20;
                }
                
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text(`A√ëO ${year}`, 20, y);
                y += 10;
                
                groupedByYear[year].forEach(item => {
                    if (y > 260) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.text(`${monthNames[item.mes]} - ${item.titulo}`, 20, y);
                    y += 6;
                    
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'normal');
                    doc.text(`Duracion: ${item.duracion} hs`, 25, y);
                    y += 5;
                    
                    if (item.instructor) {
                        doc.text(`Instructor: ${item.instructor}`, 25, y);
                        y += 5;
                    }
                    
                    if (item.objetivo) {
                        const objetivoLines = doc.splitTextToSize(`Objetivo: ${item.objetivo}`, 160);
                        doc.text(objetivoLines, 25, y);
                        y += objetivoLines.length * 5;
                    }
                    
                    if (item.destinatarios && item.destinatarios.length > 0) {
                        doc.text(`Destinatarios: ${item.destinatarios.join(', ')}`, 25, y);
                        y += 5;
                    }
                    
                    y += 3;
                });
                
                y += 5;
            });
            
            // Pie de p√°gina
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.text(`P√°gina ${i} de ${pageCount}`, 105, 285, { align: 'center' });
                doc.text('Sistema de Seguridad e Higiene - Plan Anual de Capacitaciones', 105, 290, { align: 'center' });
            }
            
            doc.save(`plan-anual-capacitaciones-${establishment.nombre.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.pdf`);
        }

        // ============= INCIDENTS MODULE =============
        function loadIncidents() {
            if (!currentEstablishment) return;
            
            const container = document.getElementById('incidentsList');
            const incidents = appData.incidents
                .filter(i => i.establecimiento_id === currentEstablishment.id)
                .sort((a, b) => new Date(b.fecha + 'T' + b.hora) - new Date(a.fecha + 'T' + a.hora));
            
            if (incidents.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay incidentes registrados</p>';
                return;
            }
            
            container.innerHTML = incidents.map(incident => {
                const colors = {
                    'Leve': 'border-green-500 bg-green-50',
                    'Moderado': 'border-yellow-500 bg-yellow-50',
                    'Grave': 'border-orange-500 bg-orange-50',
                    'Fatal': 'border-red-600 bg-red-50'
                };
                
                return `
                    <div class="border-l-4 ${colors[incident.gravedad]} rounded-lg p-4 hover:shadow-md transition">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="px-2 py-1 rounded text-xs font-semibold ${colors[incident.gravedad].replace('border-', 'bg-').replace('-50', '-200')}">${incident.tipo}</span>
                                    <span class="px-2 py-1 rounded text-xs font-semibold ${colors[incident.gravedad].replace('border-', 'bg-').replace('-50', '-300')}">${incident.gravedad}</span>
                                </div>
                                <h4 class="font-bold">${incident.lugar}</h4>
                                <p class="text-sm text-gray-600">üìÖ ${incident.fecha} ‚è∞ ${incident.hora}</p>
                                ${incident.involucrado ? `<p class="text-sm text-gray-600"><i class="fas fa-user"></i> ${incident.involucrado}</p>` : ''}
                                <p class="text-sm text-gray-700 mt-2">${incident.descripcion}</p>
                            </div>
                            <div class="flex flex-col gap-2 ml-4">
                                <button onclick="editIncident('${incident.id}')" class="text-xs bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition" title="Editar incidente">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button onclick="deleteIncident('${incident.id}')" class="text-xs bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition" title="Eliminar incidente">
                                    üóëÔ∏è Eliminar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showNewIncident() {
            document.getElementById('newIncidentForm').classList.remove('hidden');
            document.getElementById('incidentsList').classList.add('hidden');
        }

        function cancelNewIncident() {
            document.getElementById('newIncidentForm').classList.add('hidden');
            document.getElementById('incidentsList').classList.remove('hidden');
            document.querySelector('#newIncidentForm form').reset();
        }

        function saveIncident(event) {
            event.preventDefault();
            if (!currentEstablishment) return;
            
            const formData = new FormData(event.target);
            const incident = {
                id: 'inc-' + Date.now(),
                tipo: formData.get('tipo'),
                gravedad: formData.get('gravedad'),
                fecha: formData.get('fecha'),
                hora: formData.get('hora'),
                lugar: formData.get('lugar'),
                involucrado: formData.get('involucrado'),
                descripcion: formData.get('descripcion'),
                causas: formData.get('causas'),
                acciones: formData.get('acciones'),
                establecimiento_id: currentEstablishment.id,
                fecha_registro: new Date().toISOString()
            };
            
            appData.incidents.push(incident);
            saveData();
            cancelNewIncident();
            loadIncidents();
            
            if (incident.gravedad === 'Grave' || incident.gravedad === 'Fatal') {
                alert('‚ö†Ô∏è INCIDENTE GRAVE REGISTRADO\n\nSe recomienda investigaci√≥n inmediata y reporte a autoridades competentes.');
            } else {
                alert('‚úÖ Incidente registrado correctamente');
            }
        }

        function editIncident(incidentId) {
            const incident = appData.incidents.find(i => i.id === incidentId);
            if (!incident) return;
            
            // Mostrar formulario
            showNewIncident();
            
            // Cargar datos
            setTimeout(() => {
                document.querySelector('#newIncidentForm select[name="tipo"]').value = incident.tipo;
                document.querySelector('#newIncidentForm select[name="gravedad"]').value = incident.gravedad;
                document.querySelector('#newIncidentForm input[name="fecha"]').value = incident.fecha;
                document.querySelector('#newIncidentForm input[name="hora"]').value = incident.hora;
                document.querySelector('#newIncidentForm input[name="lugar"]').value = incident.lugar;
                document.querySelector('#newIncidentForm input[name="involucrado"]').value = incident.involucrado || '';
                document.querySelector('#newIncidentForm textarea[name="descripcion"]').value = incident.descripcion;
                document.querySelector('#newIncidentForm textarea[name="causas"]').value = incident.causas || '';
                document.querySelector('#newIncidentForm textarea[name="acciones"]').value = incident.acciones || '';
                
                // Cambiar comportamiento del formulario
                const form = document.querySelector('#newIncidentForm form');
                const originalOnSubmit = form.onsubmit;
                
                form.onsubmit = function(e) {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    
                    // Actualizar el incidente
                    incident.tipo = formData.get('tipo');
                    incident.gravedad = formData.get('gravedad');
                    incident.fecha = formData.get('fecha');
                    incident.hora = formData.get('hora');
                    incident.lugar = formData.get('lugar');
                    incident.involucrado = formData.get('involucrado');
                    incident.descripcion = formData.get('descripcion');
                    incident.causas = formData.get('causas');
                    incident.acciones = formData.get('acciones');
                    incident.fecha_modificacion = new Date().toISOString();
                    
                    saveData();
                    cancelNewIncident();
                    loadIncidents();
                    alert('‚úÖ Incidente actualizado correctamente');
                    
                    // Restaurar comportamiento original
                    form.onsubmit = originalOnSubmit;
                };
            }, 100);
        }

        function deleteIncident(incidentId) {
            const incident = appData.incidents.find(i => i.id === incidentId);
            if (!incident) return;
            
            if (!confirm(`¬øEst√° seguro de eliminar el incidente registrado en "${incident.lugar}" el ${incident.fecha}?\n\nEsta acci√≥n no se puede deshacer.`)) {
                return;
            }
            
            const index = appData.incidents.findIndex(i => i.id === incidentId);
            if (index > -1) {
                appData.incidents.splice(index, 1);
                saveData();
                loadIncidents();
                alert('‚úÖ Incidente eliminado correctamente');
            }
        }

        // ============= PPE MODULE =============
        function loadPPE() {
            if (!currentEstablishment) return;
            
            const container = document.getElementById('ppeList');
            const ppe = appData.ppe
                .filter(p => p.establecimiento_id === currentEstablishment.id)
                .sort((a, b) => new Date(b.fecha_entrega) - new Date(a.fecha_entrega));
            
            if (ppe.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay entregas de EPP registradas</p>';
                return;
            }
            
            container.innerHTML = ppe.map(item => `
                <div class="border border-gray-300 rounded-lg p-4 hover:shadow-md transition ${item.fecha_devolucion ? 'bg-gray-50' : ''}">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <h4 class="font-bold"><i class="fas fa-vest"></i> ${item.articulo}</h4>
                                ${item.fecha_devolucion ? '<span class="text-xs bg-gray-500 text-white px-2 py-1 rounded">Devuelto</span>' : '<span class="text-xs bg-green-500 text-white px-2 py-1 rounded">En uso</span>'}
                                ${item.foto || item.foto_devolucion ? `
                                    <button onclick="viewPPEPhotos('${item.id}')" class="text-blue-600 hover:text-blue-800 text-sm flex items-center gap-1" title="Ver fotos">
                                        üì∑ ${item.foto && item.foto_devolucion ? '2 fotos' : '1 foto'}
                                    </button>
                                ` : ''}
                            </div>
                            <p class="text-sm text-gray-600"><i class="fas fa-user"></i> ${item.empleado}</p>
                            <p class="text-sm text-gray-600">üìÖ Entregado: ${item.fecha_entrega}</p>
                            ${item.fecha_devolucion ? `<p class="text-sm text-gray-600"><i class="fas fa-undo"></i> Devuelto: ${item.fecha_devolucion}</p>` : ''}
                            <div class="flex gap-3 mt-1 text-xs text-gray-500">
                                ${item.talla ? `<span>Talla: ${item.talla}</span>` : ''}
                                <span>Cantidad: ${item.cantidad}</span>
                                ${item.lote ? `<span>Lote: ${item.lote}</span>` : ''}
                            </div>
                            ${item.observaciones ? `<p class="text-xs text-gray-600 mt-2"><strong>Observaciones entrega:</strong> ${item.observaciones}</p>` : ''}
                            ${item.observaciones_devolucion ? `<p class="text-xs text-gray-600 mt-1"><strong>Estado en devoluci√≥n:</strong> ${item.observaciones_devolucion}</p>` : ''}
                        </div>
                        <div class="flex gap-2 ml-4">
                            ${!item.fecha_devolucion ? `
                                <button onclick="editPPE('${item.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs font-semibold transition" title="Editar entrega">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button onclick="showReturnPPE('${item.id}')" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded text-xs font-semibold transition" title="Registrar devoluci√≥n">
                                    <i class="fas fa-undo"></i> Devoluci√≥n
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showNewPPE() {
            document.getElementById('newPPEForm').classList.remove('hidden');
            document.getElementById('ppeList').classList.add('hidden');
        }

        function cancelNewPPE() {
            document.getElementById('newPPEForm').classList.add('hidden');
            document.getElementById('ppeList').classList.remove('hidden');
            document.querySelector('#newPPEForm form').reset();
        }

        function savePPE(event) {
            event.preventDefault();
            if (!currentEstablishment) return;
            
            const formData = new FormData(event.target);
            
            // Capturar foto si existe
            let photoData = null;
            const previewDiv = document.getElementById('ppePhotoPreview');
            if (previewDiv) {
                const img = previewDiv.querySelector('img');
                if (img && img.src) {
                    photoData = img.src; // base64 data URL
                }
            }
            
            const ppe = {
                id: 'ppe-' + Date.now(),
                empleado: formData.get('empleado'),
                articulo: formData.get('articulo'),
                talla: formData.get('talla'),
                cantidad: parseInt(formData.get('cantidad')),
                fecha_entrega: formData.get('fecha_entrega'),
                lote: formData.get('lote'),
                vida_util_meses: formData.get('vida_util_meses') ? parseInt(formData.get('vida_util_meses')) : null,
                observaciones: formData.get('observaciones'),
                foto: photoData,
                establecimiento_id: currentEstablishment.id,
                fecha_registro: new Date().toISOString()
            };
            
            appData.ppe.push(ppe);
            saveData();
            cancelNewPPE();
            loadPPE();
            alert('‚úÖ Entrega de EPP registrada correctamente');
        }

        function editPPE(id) {
            const ppe = appData.ppe.find(p => p.id === id);
            if (!ppe) return;

            // Ocultar listado y otros formularios
            document.getElementById('ppeList').classList.add('hidden');
            document.getElementById('newPPEForm').classList.add('hidden');
            document.getElementById('returnPPEForm').classList.add('hidden');
            
            // Mostrar formulario de edici√≥n
            document.getElementById('editPPEForm').classList.remove('hidden');
            
            // Llenar el formulario con los datos actuales
            document.getElementById('edit_ppe_id').value = ppe.id;
            document.getElementById('edit_empleado').value = ppe.empleado;
            document.getElementById('edit_articulo').value = ppe.articulo;
            document.getElementById('edit_talla').value = ppe.talla || '';
            document.getElementById('edit_cantidad').value = ppe.cantidad;
            document.getElementById('edit_fecha_entrega').value = ppe.fecha_entrega;
            document.getElementById('edit_lote').value = ppe.lote || '';
            document.getElementById('edit_vida_util_meses').value = ppe.vida_util_meses || '';
            document.getElementById('edit_observaciones').value = ppe.observaciones || '';
            
            // Mostrar foto existente si la hay
            const previewDiv = document.getElementById('editPpePhotoPreview');
            if (ppe.foto && previewDiv) {
                previewDiv.innerHTML = `<img src="${ppe.foto}" class="max-w-xs rounded border" alt="Foto EPP"><p class="text-xs text-gray-600 mt-1">Foto actual (seleccione una nueva para reemplazar)</p>`;
            } else if (previewDiv) {
                previewDiv.innerHTML = '';
            }
        }

        function cancelEditPPE() {
            document.getElementById('editPPEForm').classList.add('hidden');
            document.getElementById('ppeList').classList.remove('hidden');
            document.querySelector('#editPPEForm form').reset();
        }

        function updatePPE(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const ppeId = formData.get('ppe_id');
            const ppeIndex = appData.ppe.findIndex(p => p.id === ppeId);
            
            if (ppeIndex === -1) {
                alert('‚ùå Error: EPP no encontrado');
                return;
            }
            
            // Capturar nueva foto si se seleccion√≥ una
            let photoData = appData.ppe[ppeIndex].foto; // Mantener foto existente por defecto
            const previewDiv = document.getElementById('editPpePhotoPreview');
            if (previewDiv) {
                const img = previewDiv.querySelector('img');
                if (img && img.src && !img.src.includes('data:image')) {
                    // No hay nueva foto, mantener la existente
                } else if (img && img.src.includes('data:image')) {
                    // Hay una nueva foto
                    photoData = img.src;
                }
            }
            
            // Actualizar datos manteniendo los campos originales no modificables
            appData.ppe[ppeIndex] = {
                ...appData.ppe[ppeIndex],
                empleado: formData.get('empleado'),
                articulo: formData.get('articulo'),
                talla: formData.get('talla'),
                cantidad: parseInt(formData.get('cantidad')),
                fecha_entrega: formData.get('fecha_entrega'),
                lote: formData.get('lote'),
                vida_util_meses: formData.get('vida_util_meses') ? parseInt(formData.get('vida_util_meses')) : null,
                observaciones: formData.get('observaciones'),
                foto: photoData,
                fecha_modificacion: new Date().toISOString()
            };
            
            saveData();
            cancelEditPPE();
            loadPPE();
            alert('‚úÖ Entrega de EPP actualizada correctamente');
        }

        function showReturnPPE(id) {
            const ppe = appData.ppe.find(p => p.id === id);
            if (!ppe) return;

            // Ocultar otros formularios y listado
            document.getElementById('ppeList').classList.add('hidden');
            document.getElementById('newPPEForm').classList.add('hidden');
            document.getElementById('editPPEForm').classList.add('hidden');
            
            // Mostrar formulario de devoluci√≥n
            document.getElementById('returnPPEForm').classList.remove('hidden');
            
            // Mostrar informaci√≥n del EPP a devolver
            const infoDiv = document.getElementById('returnPPEInfo');
            infoDiv.innerHTML = `
                <h4 class="font-bold text-lg mb-2">Informaci√≥n del EPP a devolver</h4>
                <div class="grid md:grid-cols-2 gap-2 text-sm">
                    <p><strong>Art√≠culo:</strong> ${ppe.articulo}</p>
                    <p><strong>Empleado:</strong> ${ppe.empleado}</p>
                    <p><strong>Fecha de entrega:</strong> ${ppe.fecha_entrega}</p>
                    <p><strong>Cantidad:</strong> ${ppe.cantidad}</p>
                    ${ppe.talla ? `<p><strong>Talla:</strong> ${ppe.talla}</p>` : ''}
                    ${ppe.lote ? `<p><strong>Lote:</strong> ${ppe.lote}</p>` : ''}
                </div>
            `;
            
            // Guardar ID en el campo hidden
            document.getElementById('return_ppe_id').value = ppe.id;
            
            // Establecer fecha de hoy por defecto
            document.getElementById('return_fecha_devolucion').value = new Date().toISOString().split('T')[0];
        }

        function cancelReturnPPE() {
            document.getElementById('returnPPEForm').classList.add('hidden');
            document.getElementById('ppeList').classList.remove('hidden');
            document.querySelector('#returnPPEForm form').reset();
            // Limpiar preview de foto
            const previewDiv = document.getElementById('returnPpePhotoPreview');
            if (previewDiv) previewDiv.innerHTML = '';
        }

        function saveReturnPPE(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const ppeId = formData.get('ppe_id');
            const ppeIndex = appData.ppe.findIndex(p => p.id === ppeId);
            
            if (ppeIndex === -1) {
                alert('‚ùå Error: EPP no encontrado');
                return;
            }
            
            // Capturar foto de devoluci√≥n si existe
            let photoData = null;
            const previewDiv = document.getElementById('returnPpePhotoPreview');
            if (previewDiv) {
                const img = previewDiv.querySelector('img');
                if (img && img.src) {
                    photoData = img.src; // base64 data URL
                }
            }
            
            // Actualizar datos de devoluci√≥n
            appData.ppe[ppeIndex].fecha_devolucion = formData.get('fecha_devolucion');
            appData.ppe[ppeIndex].estado_devolucion = formData.get('estado_devolucion');
            appData.ppe[ppeIndex].observaciones_devolucion = formData.get('observaciones_devolucion');
            appData.ppe[ppeIndex].foto_devolucion = photoData;
            appData.ppe[ppeIndex].fecha_registro_devolucion = new Date().toISOString();
            
            saveData();
            cancelReturnPPE();
            loadPPE();
            alert('‚úÖ Devoluci√≥n de EPP registrada correctamente');
        }

        function viewPPEPhotos(id) {
            const ppe = appData.ppe.find(p => p.id === id);
            if (!ppe) return;
            
            const modal = document.getElementById('ppePhotoModal');
            const title = document.getElementById('ppePhotoModalTitle');
            const content = document.getElementById('ppePhotoModalContent');
            
            title.textContent = `Fotos del EPP: ${ppe.articulo}`;
            
            let htmlContent = `
                <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                    <h4 class="font-bold mb-2">Informaci√≥n del EPP</h4>
                    <div class="grid md:grid-cols-2 gap-2 text-sm">
                        <p><strong>Art√≠culo:</strong> ${ppe.articulo}</p>
                        <p><strong>Empleado:</strong> ${ppe.empleado}</p>
                        <p><strong>Fecha de entrega:</strong> ${ppe.fecha_entrega}</p>
                        ${ppe.fecha_devolucion ? `<p><strong>Fecha de devoluci√≥n:</strong> ${ppe.fecha_devolucion}</p>` : ''}
                    </div>
                </div>
            `;
            
            if (ppe.foto) {
                htmlContent += `
                    <div class="border border-gray-300 rounded-lg p-4">
                        <h4 class="font-bold mb-3 text-green-700">üì∑ Foto de Entrega</h4>
                        <div class="flex justify-center">
                            <img src="${ppe.foto}" class="max-w-full rounded border shadow-lg" alt="Foto del EPP al momento de la entrega" onclick="this.requestFullscreen();" style="cursor: zoom-in;">
                        </div>
                        <p class="text-xs text-gray-500 mt-2 text-center">üìÖ Fecha de entrega: ${ppe.fecha_entrega}</p>
                        ${ppe.observaciones ? `<p class="text-sm text-gray-600 mt-2"><strong>Observaciones:</strong> ${ppe.observaciones}</p>` : ''}
                        <p class="text-xs text-gray-400 mt-2 text-center italic">Haz clic en la imagen para verla en pantalla completa</p>
                    </div>
                `;
            }
            
            if (ppe.foto_devolucion) {
                htmlContent += `
                    <div class="border border-gray-300 rounded-lg p-4">
                        <h4 class="font-bold mb-3 text-orange-700">üì∑ Foto de Devoluci√≥n</h4>
                        <div class="flex justify-center">
                            <img src="${ppe.foto_devolucion}" class="max-w-full rounded border shadow-lg" alt="Foto del EPP al momento de la devoluci√≥n" onclick="this.requestFullscreen();" style="cursor: zoom-in;">
                        </div>
                        <p class="text-xs text-gray-500 mt-2 text-center"><i class="fas fa-undo"></i> Fecha de devoluci√≥n: ${ppe.fecha_devolucion}</p>
                        ${ppe.estado_devolucion ? `<p class="text-sm text-gray-600 mt-2"><strong>Estado:</strong> ${ppe.estado_devolucion}</p>` : ''}
                        ${ppe.observaciones_devolucion ? `<p class="text-sm text-gray-600 mt-1"><strong>Observaciones:</strong> ${ppe.observaciones_devolucion}</p>` : ''}
                        <p class="text-xs text-gray-400 mt-2 text-center italic">Haz clic en la imagen para verla en pantalla completa</p>
                    </div>
                `;
            }
            
            if (!ppe.foto && !ppe.foto_devolucion) {
                htmlContent += '<p class="text-gray-500 text-center py-4">No hay fotos disponibles para este EPP</p>';
            }
            
            content.innerHTML = htmlContent;
            modal.classList.remove('hidden');
        }

        function closePPEPhotoModal() {
            const modal = document.getElementById('ppePhotoModal');
            modal.classList.add('hidden');
        }

        // ============= DASHBOARD MODULE =============
        // Variables globales para los gr√°ficos
        let dashboardCharts = {
            actions: null,
            incidents: null,
            risks: null,
            trainings: null
        };

        function updateDashboard() {
            if (!currentEstablishment) return;
            
            const inspections = appData.inspections.filter(i => i.establecimiento_id === currentEstablishment.id);
            const actions = appData.actions.filter(a => a.establecimiento_id === currentEstablishment.id);
            const risks = appData.risks.filter(r => r.establecimiento_id === currentEstablishment.id);
            const trainings = appData.trainings.filter(t => t.establecimiento_id === currentEstablishment.id);
            const incidents = appData.incidents.filter(i => i.establecimiento_id === currentEstablishment.id);
            const extinguishers = appData.extinguishers.filter(e => e.establecimiento_id === currentEstablishment.id);
            
            // Calcular fechas del √∫ltimo mes
            const hoy = new Date();
            const haceUnMes = new Date();
            haceUnMes.setMonth(haceUnMes.getMonth() - 1);
            
            // === KPIs PROACTIVOS ===
            
            // Inspecciones realizadas (√∫ltimo mes)
            const inspectionsLastMonth = inspections.filter(i => new Date(i.fecha) >= haceUnMes).length;
            document.getElementById('kpiInspections').textContent = inspections.length;
            document.getElementById('kpiInspectionsDetail').textContent = `${inspectionsLastMonth} √∫ltimo mes`;
            
            // Capacitaciones
            let totalCapacitados = 0;
            trainings.forEach(t => totalCapacitados += (t.participantes?.length || 0));
            document.getElementById('kpiTrainings').textContent = trainings.length;
            document.getElementById('kpiTrainingsDetail').textContent = `${totalCapacitados} personas`;
            
            // Extintores vigentes
            const extintoresVigentes = extinguishers.filter(e => {
                if (!e.proxima_recarga) return false;
                const fechaRecarga = new Date(e.proxima_recarga);
                return fechaRecarga >= hoy;
            }).length;
            const porcentajeExtintores = extinguishers.length > 0 ? 
                Math.round((extintoresVigentes / extinguishers.length) * 100) : 0;
            document.getElementById('kpiExtinguishers').textContent = extintoresVigentes;
            document.getElementById('kpiExtinguishersDetail').textContent = `${porcentajeExtintores}% vigentes`;
            
            // Acciones cerradas (√∫ltimo mes)
            const accionesCerradasMes = actions.filter(a => {
                if (!a.fecha_cierre || a.estado !== 'cerrado') return false;
                return new Date(a.fecha_cierre) >= haceUnMes;
            }).length;
            const accionesCerradasTotal = actions.filter(a => a.estado === 'cerrado').length;
            document.getElementById('kpiClosedActions').textContent = accionesCerradasTotal;
            document.getElementById('kpiClosedActionsDetail').textContent = `${accionesCerradasMes} √∫ltimo mes`;
            
            // % de Cumplimiento en inspecciones
            let totalHallazgos = 0;
            let hallazgosOK = 0;
            inspections.forEach(insp => {
                if (insp.resumen) {
                    totalHallazgos += insp.resumen.total || 0;
                    hallazgosOK += insp.resumen.ok || 0;
                }
            });
            const porcentajeCumplimiento = totalHallazgos > 0 ? 
                Math.round((hallazgosOK / totalHallazgos) * 100) : 0;
            document.getElementById('kpiCompliance').textContent = porcentajeCumplimiento + '%';
            
            // === KPIs REACTIVOS ===
            
            // Incidentes totales (√∫ltimo mes)
            const incidentesLastMonth = incidents.filter(i => new Date(i.fecha) >= haceUnMes).length;
            document.getElementById('kpiIncidentsTotal').textContent = incidents.length;
            document.getElementById('kpiIncidentsTotalDetail').textContent = `${incidentesLastMonth} √∫ltimo mes`;
            
            // Accidentes con lesi√≥n
            const accidentes = incidents.filter(i => i.tipo === 'Accidente').length;
            document.getElementById('kpiAccidents').textContent = accidentes;
            document.getElementById('kpiAccidentsDetail').textContent = accidentes > 0 ? 'Requieren acci√≥n' : 'Sin accidentes';
            
            // Acciones pendientes
            const pendingActions = actions.filter(a => a.estado === 'pendiente');
            const accionesCriticas = pendingActions.filter(a => a.prioridad === 'Alta').length;
            document.getElementById('kpiPendingActions').textContent = pendingActions.length;
            document.getElementById('kpiPendingActionsDetail').textContent = `${accionesCriticas} cr√≠ticas`;
            
            // Riesgos cr√≠ticos
            const criticalRisks = risks.filter(r => r.nivel === 'Cr√≠tico');
            document.getElementById('kpiCriticalRisks').textContent = criticalRisks.length;
            document.getElementById('kpiCriticalRisksDetail').textContent = criticalRisks.length > 0 ? 'Atenci√≥n urgente' : 'Controlados';
            
            // Tiempo medio de cierre
            const accionesCerradas = actions.filter(a => a.estado === 'cerrado' && a.fecha_cierre);
            let tiempoMedioCierre = 0;
            if (accionesCerradas.length > 0) {
                const tiempos = accionesCerradas.map(a => {
                    const creacion = new Date(a.fecha_creacion);
                    const cierre = new Date(a.fecha_cierre);
                    return Math.floor((cierre - creacion) / (1000*60*60*24));
                });
                tiempoMedioCierre = Math.round(tiempos.reduce((a, b) => a + b, 0) / tiempos.length);
            }
            document.getElementById('kpiAvgClosureTime').textContent = tiempoMedioCierre;
            
            // === ESTAD√çSTICAS ADICIONALES ===
            
            // Total trabajadores (estimado desde capacitaciones)
            const trabajadoresUnicos = new Set();
            trainings.forEach(t => {
                if (t.participantes) {
                    t.participantes.forEach(p => trabajadoresUnicos.add(p.nombre));
                }
            });
            document.getElementById('statTotalWorkers').textContent = trabajadoresUnicos.size || currentEstablishment.cantidadTrabajadores || '-';
            
            // Horas de capacitaci√≥n
            let horasTotales = 0;
            trainings.forEach(t => horasTotales += (t.duracion || 2));
            document.getElementById('statTrainingHours').textContent = horasTotales + ' hrs';
            
            // Tasa de incidentes (por cada 100 trabajadores)
            const numTrabajadores = trabajadoresUnicos.size || currentEstablishment.cantidadTrabajadores || 100;
            const tasaIncidentes = ((incidents.length / numTrabajadores) * 100).toFixed(2);
            document.getElementById('statIncidentRate').textContent = tasaIncidentes + '%';
            
            // D√≠as sin accidentes
            let diasSinAccidentes = 0;
            const accidentesConLesion = incidents.filter(i => i.tipo === 'Accidente' && i.gravedad !== 'Leve').sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            if (accidentesConLesion.length > 0) {
                const ultimoAccidente = new Date(accidentesConLesion[0].fecha);
                diasSinAccidentes = Math.floor((hoy - ultimoAccidente) / (1000*60*60*24));
            } else {
                diasSinAccidentes = 365; // M√°s de un a√±o
            }
            document.getElementById('statDaysWithoutAccidents').textContent = diasSinAccidentes > 365 ? '+365' : diasSinAccidentes;
            
            // === GR√ÅFICOS ===
            
            // Destruir gr√°ficos existentes
            Object.keys(dashboardCharts).forEach(key => {
                if (dashboardCharts[key]) {
                    dashboardCharts[key].destroy();
                    dashboardCharts[key] = null;
                }
            });
            
            // 1. Acciones por Estado
            const actionsByStatus = {
                pendiente: actions.filter(a => a.estado === 'pendiente').length,
                en_progreso: actions.filter(a => a.estado === 'en_progreso').length,
                cerrado: actions.filter(a => a.estado === 'cerrado').length
            };
            
            const actionsCtx = document.getElementById('actionsChart');
            const actionsChartType = document.getElementById('actionsChartType')?.value || 'doughnut';
            if (actionsCtx) {
                dashboardCharts.actions = new Chart(actionsCtx, {
                    type: actionsChartType,
                    data: {
                        labels: ['Pendiente', 'En Progreso', 'Cerrado'],
                        datasets: [{
                            label: 'Cantidad',
                            data: [actionsByStatus.pendiente, actionsByStatus.en_progreso, actionsByStatus.cerrado],
                            backgroundColor: ['#f59e0b', '#3b82f6', '#10b981']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        },
                        scales: actionsChartType === 'bar' || actionsChartType === 'line' ? {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1 }
                            }
                        } : {}
                    }
                });
            }
            
            // 2. Incidentes por Tipo
            const incidentsByType = {
                'Accidente': incidents.filter(i => i.tipo === 'Accidente').length,
                'Incidente': incidents.filter(i => i.tipo === 'Incidente').length,
                'Cuasi-accidente': incidents.filter(i => i.tipo === 'Cuasi-accidente').length
            };
            
            const incidentsCtx = document.getElementById('incidentsChart');
            const incidentsChartType = document.getElementById('incidentsChartType')?.value || 'bar';
            if (incidentsCtx) {
                dashboardCharts.incidents = new Chart(incidentsCtx, {
                    type: incidentsChartType,
                    data: {
                        labels: Object.keys(incidentsByType),
                        datasets: [{
                            label: 'Cantidad',
                            data: Object.values(incidentsByType),
                            backgroundColor: ['#ef4444', '#f59e0b', '#fbbf24']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                display: incidentsChartType === 'doughnut'
                            }
                        },
                        scales: incidentsChartType === 'bar' || incidentsChartType === 'line' ? {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1 }
                            }
                        } : {}
                    }
                });
            }
            
            // 3. Riesgos por Nivel
            const risksByLevel = {
                'Bajo': risks.filter(r => r.nivel === 'Bajo').length,
                'Medio': risks.filter(r => r.nivel === 'Medio').length,
                'Alto': risks.filter(r => r.nivel === 'Alto').length,
                'Cr√≠tico': risks.filter(r => r.nivel === 'Cr√≠tico').length
            };
            
            const risksCtx = document.getElementById('risksChart');
            const risksChartType = document.getElementById('risksChartType')?.value || 'bar';
            if (risksCtx) {
                dashboardCharts.risks = new Chart(risksCtx, {
                    type: risksChartType,
                    data: {
                        labels: Object.keys(risksByLevel),
                        datasets: [{
                            label: 'Cantidad',
                            data: Object.values(risksByLevel),
                            backgroundColor: ['#10b981', '#fbbf24', '#f59e0b', '#ef4444']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                display: risksChartType === 'doughnut'
                            }
                        },
                        scales: risksChartType === 'bar' || risksChartType === 'line' ? {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1 }
                            }
                        } : {}
                    }
                });
            }
            
            // 4. Capacitaciones Mensuales (√∫ltimos 6 meses)
            const mesesLabels = [];
            const capacitacionesPorMes = [];
            for (let i = 5; i >= 0; i--) {
                const fecha = new Date();
                fecha.setMonth(fecha.getMonth() - i);
                const mesAnio = fecha.toLocaleDateString('es-AR', { month: 'short', year: 'numeric' });
                mesesLabels.push(mesAnio);
                
                const capacitacionesMes = trainings.filter(t => {
                    const fechaCapac = new Date(t.fecha);
                    return fechaCapac.getMonth() === fecha.getMonth() && 
                           fechaCapac.getFullYear() === fecha.getFullYear();
                }).length;
                capacitacionesPorMes.push(capacitacionesMes);
            }
            
            const trainingsCtx = document.getElementById('trainingsChart');
            const trainingsChartType = document.getElementById('trainingsChartType')?.value || 'line';
            if (trainingsCtx) {
                dashboardCharts.trainings = new Chart(trainingsCtx, {
                    type: trainingsChartType,
                    data: {
                        labels: mesesLabels,
                        datasets: [{
                            label: 'Capacitaciones',
                            data: capacitacionesPorMes,
                            backgroundColor: trainingsChartType === 'line' ? 'rgba(59, 130, 246, 0.1)' : '#3b82f6',
                            borderColor: '#3b82f6',
                            borderWidth: 2,
                            fill: trainingsChartType === 'line'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                display: trainingsChartType === 'doughnut'
                            }
                        },
                        scales: trainingsChartType === 'bar' || trainingsChartType === 'line' ? {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1 }
                            }
                        } : {}
                    }
                });
            }
            
            // === RECOMENDACIONES ===
            generateDashboardRecommendations(pendingActions, criticalRisks, incidents, trainings, porcentajeCumplimiento, extintoresVigentes, extinguishers);
        }
        
        function generateDashboardRecommendations(pendingActions, criticalRisks, incidents, trainings, cumplimiento, extVigentes, extTotal) {
            const recommendations = [];
            
            if (criticalRisks.length > 0) {
                recommendations.push(`<i class="fas fa-circle text-red-500"></i> <strong>CR√çTICO:</strong> Hay ${criticalRisks.length} riesgo(s) cr√≠tico(s) que requieren atenci√≥n inmediata.`);
            }
            
            if (pendingActions.length > 10) {
                recommendations.push(`‚ö†Ô∏è <strong>ALERTA:</strong> M√°s de 10 acciones pendientes (${pendingActions.length}). Priorizar cierre de acciones.`);
            }
            
            const accidentesGraves = incidents.filter(i => i.gravedad === 'Grave' || i.gravedad === 'Fatal').length;
            if (accidentesGraves > 0) {
                recommendations.push(`‚ö†Ô∏è <strong>IMPORTANTE:</strong> Hay ${accidentesGraves} incidente(s) grave(s) registrado(s). Verificar implementaci√≥n de acciones correctivas.`);
            }
            
            if (trainings.length === 0) {
                recommendations.push(`üìö <strong>RECOMENDACI√ìN:</strong> No hay capacitaciones registradas. Implementar programa de formaci√≥n seg√∫n Res. SRT 905/2015.`);
            }
            
            if (cumplimiento < 70) {
                recommendations.push(`üìâ <strong>ATENCI√ìN:</strong> El cumplimiento en inspecciones es del ${cumplimiento}%. Se recomienda implementar acciones correctivas.`);
            } else if (cumplimiento >= 90) {
                recommendations.push(`‚úÖ <strong>EXCELENTE:</strong> Cumplimiento del ${cumplimiento}% en inspecciones. Mantener est√°ndares.`);
            }
            
            const porcentajeExtVigentes = extTotal > 0 ? Math.round((extVigentes / extTotal) * 100) : 0;
            if (porcentajeExtVigentes < 100 && extTotal > 0) {
                recommendations.push(`üßØ <strong>IMPORTANTE:</strong> ${extTotal - extVigentes} extintor(es) requiere(n) recarga. Gestionar mantenimiento.`);
            }
            
            if (recommendations.length === 0) {
                recommendations.push(`‚úÖ <strong>BIEN:</strong> Los indicadores se encuentran en niveles aceptables. Continuar con el monitoreo preventivo.`);
            }
            
            document.getElementById('dashboardRecommendations').innerHTML = recommendations.join('<br>');
        }
        
        function updateChartType(chartName, chartType) {
            // Actualizar el gr√°fico espec√≠fico con el nuevo tipo
            updateDashboard();
        }
        
        function refreshDashboard() {
            updateDashboard();
        }

        function updateDashboardIfVisible() {
            const dashboardView = document.getElementById('dashboardView');
            if (dashboardView && !dashboardView.classList.contains('hidden')) {
                updateDashboard();
            }
        }

        // ============= EXPORT FUNCTIONS =============
        function exportDashboardReport() {
            if (!currentEstablishment) {
                alert('Seleccione un establecimiento primero');
                return;
            }
            
            const inspections = appData.inspections.filter(i => i.establecimiento_id === currentEstablishment.id);
            const actions = appData.actions.filter(a => a.establecimiento_id === currentEstablishment.id);
            const risks = appData.risks.filter(r => r.establecimiento_id === currentEstablishment.id);
            const trainings = appData.trainings.filter(t => t.establecimiento_id === currentEstablishment.id);
            const incidents = appData.incidents.filter(i => i.establecimiento_id === currentEstablishment.id);
            
            const pendingActions = actions.filter(a => a.estado === 'pendiente');
            const criticalRisks = risks.filter(r => r.nivel === 'Cr√≠tico');
            
            // C√°lculo de KPIs
            const accionesCerradas = actions.filter(a => a.estado === 'cerrado' && a.fecha_cierre);
            let tiempoMedioCierre = 0;
            if (accionesCerradas.length > 0) {
                const tiempos = accionesCerradas.map(a => {
                    const creacion = new Date(a.fecha_creacion);
                    const cierre = new Date(a.fecha_cierre);
                    return Math.floor((cierre - creacion) / (1000*60*60*24));
                });
                tiempoMedioCierre = (tiempos.reduce((a, b) => a + b, 0) / tiempos.length).toFixed(1);
            }
            
            const report = `REPORTE EJECUTIVO DE SEGURIDAD E HIGIENE
=============================================

ESTABLECIMIENTO: ${currentEstablishment.nombre}
CUIT: ${currentEstablishment.cuit}
Fecha de Reporte: ${new Date().toLocaleDateString('es-AR')}

=============================================
INDICADORES CLAVE (KPIs)
=============================================

<i class="fas fa-clipboard-list"></i> Inspecciones Realizadas: ${inspections.length}
‚ö†Ô∏è Acciones Pendientes: ${pendingActions.length}
<i class="fas fa-circle text-red-500"></i> Riesgos Cr√≠ticos Activos: ${criticalRisks.length}
<i class="fas fa-user"></i>‚Äçüè´ Capacitaciones Realizadas: ${trainings.length}
‚ö†Ô∏è Incidentes Registrados: ${incidents.length}

‚è±Ô∏è Tiempo Medio de Cierre de Acciones: ${tiempoMedioCierre} d√≠as
üìä Total de Acciones: ${actions.length}
   - Pendientes: ${actions.filter(a => a.estado === 'pendiente').length}
   - En Progreso: ${actions.filter(a => a.estado === 'en_progreso').length}
   - Cerradas: ${actions.filter(a => a.estado === 'cerrado').length}

=============================================
INSPECCIONES - √öLTIMOS 30 D√çAS
=============================================

${inspections.slice(-5).reverse().map(insp => `
Fecha: ${insp.fecha}
Sector: ${insp.sector}
Inspector: ${insp.inspector.nombre}
Resultados: ‚úÖ ${insp.resumen.ok} OK | ‚ùå ${insp.resumen.nok} NOK | ‚ûñ ${insp.resumen.na} N/A
---`).join('\n')}

=============================================
ACCIONES PENDIENTES DE ALTA PRIORIDAD
=============================================

${pendingActions.filter(a => a.prioridad === 'Alta').map(action => `
‚Ä¢ ${action.titulo}
  Responsable: ${action.responsable}
  Vencimiento: ${action.vencimiento}
  Sector: ${action.sector || 'N/A'}
`).join('\n') || 'No hay acciones de alta prioridad pendientes'}

=============================================
RIESGOS CR√çTICOS
=============================================

${criticalRisks.map(risk => `
‚Ä¢ ${risk.descripcion}
  Sector: ${risk.sector || 'General'}
  Score: ${risk.score} (P:${risk.probabilidad} √ó S:${risk.severidad})
  Controles: ${risk.controles || 'Sin especificar'}
`).join('\n') || 'No hay riesgos cr√≠ticos identificados'}

=============================================
INCIDENTES - RESUMEN
=============================================

Total de Incidentes: ${incidents.length}

Por Tipo:
- Accidentes: ${incidents.filter(i => i.tipo === 'Accidente').length}
- Incidentes sin lesi√≥n: ${incidents.filter(i => i.tipo === 'Incidente').length}
- Cuasi-accidentes: ${incidents.filter(i => i.tipo === 'Cuasi-accidente').length}

Por Gravedad:
- Leves: ${incidents.filter(i => i.gravedad === 'Leve').length}
- Moderados: ${incidents.filter(i => i.gravedad === 'Moderado').length}
- Graves: ${incidents.filter(i => i.gravedad === 'Grave').length}
- Fatales: ${incidents.filter(i => i.gravedad === 'Fatal').length}

=============================================
CAPACITACIONES REALIZADAS
=============================================

${trainings.slice(-10).reverse().map(training => `
‚Ä¢ ${training.titulo}
  Fecha: ${training.fecha}
  Instructor: ${training.instructor}
  Participantes: ${training.participantes.length}
`).join('\n') || 'No hay capacitaciones registradas'}

=============================================
OBSERVACIONES Y RECOMENDACIONES
=============================================

${pendingActions.length > 10 ? '‚ö†Ô∏è ALERTA: M√°s de 10 acciones pendientes. Priorizar cierre de acciones.' : ''}
${criticalRisks.length > 0 ? '<i class="fas fa-circle text-red-500"></i> CR√çTICO: Hay riesgos cr√≠ticos que requieren atenci√≥n inmediata.' : ''}
${incidents.filter(i => i.gravedad === 'Grave' || i.gravedad === 'Fatal').length > 0 ? '‚ö†Ô∏è IMPORTANTE: Hay incidentes graves registrados. Verificar implementaci√≥n de acciones correctivas.' : ''}
${trainings.length === 0 ? 'üìö RECOMENDACI√ìN: No hay capacitaciones registradas. Implementar programa de formaci√≥n seg√∫n Res. SRT 905/2015.' : ''}

=============================================
MARCO NORMATIVO
=============================================

Este reporte se basa en:
- Ley 19.587: Higiene y Seguridad en el Trabajo
- Decreto 351/79: Reglamentaci√≥n Ley 19.587
- Resoluci√≥n SRT 905/2015: Relevamiento General de Riesgos Laborales
- Normas IRAM: 3517, 3620, 10005

=============================================
NOTA LEGAL
=============================================

Este reporte es generado autom√°ticamente por el Sistema de Seguridad 
e Higiene como herramienta de apoyo t√©cnico. No reemplaza el dictamen 
profesional oficial de un Licenciado en Seguridad e Higiene matriculado.

Generado el: ${new Date().toLocaleString('es-AR')}
`;
            
            // Crear y descargar archivo
            const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Reporte_${currentEstablishment.nombre.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        function exportEstablishmentSummary() {
            if (!currentEstablishment) {
                alert('Seleccione un establecimiento primero');
                return;
            }
            
            const inspections = appData.inspections.filter(i => i.establecimiento_id === currentEstablishment.id);
            const actions = appData.actions.filter(a => a.establecimiento_id === currentEstablishment.id);
            const risks = appData.risks.filter(r => r.establecimiento_id === currentEstablishment.id);
            const trainings = appData.trainings.filter(t => t.establecimiento_id === currentEstablishment.id);
            const incidents = appData.incidents.filter(i => i.establecimiento_id === currentEstablishment.id);
            const extinguishers = appData.extinguishers.filter(e => e.establecimiento_id === currentEstablishment.id);
            const fireloads = appData.fireloads.filter(f => f.establecimiento_id === currentEstablishment.id);
            const ppe = appData.ppe.filter(p => p.establecimiento_id === currentEstablishment.id);
            
            // C√°lculo de cumplimiento
            let totalHallazgos = 0;
            let hallazgosOK = 0;
            inspections.forEach(insp => {
                totalHallazgos += insp.resumen.total;
                hallazgosOK += insp.resumen.ok;
            });
            const porcentajeCumplimiento = totalHallazgos > 0 ? ((hallazgosOK / totalHallazgos) * 100).toFixed(1) : 0;
            
            // Extintores vencidos
            const hoy = new Date();
            const extintoresVencidos = extinguishers.filter(ext => {
                const ultimaRecarga = new Date(ext.ultima_recarga);
                const proxRecarga = new Date(ultimaRecarga);
                proxRecarga.setFullYear(proxRecarga.getFullYear() + 1);
                return proxRecarga < hoy;
            }).length;
            
            // √öltima carga de fuego
            const ultimaCargaFuego = fireloads.length > 0 ? fireloads[fireloads.length - 1] : null;
            
            // Crear PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 15;
            const maxWidth = pageWidth - 2 * margin;
            let yPosition = 20;
            
            // Funci√≥n para agregar nueva p√°gina si es necesario
            const checkPageBreak = (neededSpace = 10) => {
                if (yPosition + neededSpace > pageHeight - 20) {
                    doc.addPage();
                    yPosition = 20;
                    return true;
                }
                return false;
            };
            
            // Funci√≥n para agregar texto con word wrap
            const addText = (text, fontSize = 10, isBold = false) => {
                doc.setFontSize(fontSize);
                doc.setFont(undefined, isBold ? 'bold' : 'normal');
                const lines = doc.splitTextToSize(text, maxWidth);
                lines.forEach(line => {
                    checkPageBreak();
                    doc.text(line, margin, yPosition);
                    yPosition += fontSize * 0.5;
                });
            };
            
            // Funci√≥n para agregar separador
            const addSeparator = () => {
                checkPageBreak();
                doc.setDrawColor(0, 0, 0);
                doc.line(margin, yPosition, pageWidth - margin, yPosition);
                yPosition += 5;
            };
            
            // T√çTULO
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('RESUMEN EJECUTIVO DEL ESTABLECIMIENTO', margin, yPosition);
            yPosition += 10;
            addSeparator();
            
            // DATOS DEL ESTABLECIMIENTO
            yPosition += 3;
            addText('DATOS DEL ESTABLECIMIENTO', 14, true);
            yPosition += 5;
            addSeparator();
            yPosition += 3;
            
            addText(`Nombre: ${currentEstablishment.nombre}`);
            addText(`CUIT: ${currentEstablishment.cuit}`);
            addText(`Direccion: ${currentEstablishment.direccion}`);
            addText(`Actividad: ${currentEstablishment.actividad}`);
            addText(`Superficie: ${currentEstablishment.superficie_m2} m2`);
            addText(`Empleados: ${currentEstablishment.empleados || 'No especificado'}`);
            addText(`Telefono: ${currentEstablishment.telefono || 'No especificado'}`);
            yPosition += 3;
            addText(`Fecha del Resumen: ${new Date().toLocaleDateString('es-AR')}`);
            addText(`Estado del Establecimiento: ${actions.filter(a => a.estado === 'pendiente' && a.prioridad === 'Alta').length > 0 ? 'REQUIERE ATENCION' : 'OPERATIVO'}`);
            yPosition += 5;
            
            // ESTADO GENERAL
            addSeparator();
            yPosition += 3;
            addText('ESTADO GENERAL', 14, true);
            yPosition += 5;
            addSeparator();
            yPosition += 3;
            
            addText(`Nivel de Cumplimiento: ${porcentajeCumplimiento}%`);
            addText(`   Basado en ${totalHallazgos} items evaluados en inspecciones`);
            yPosition += 2;
            addText(`Riesgo de Incendio: ${ultimaCargaFuego ? ultimaCargaFuego.clasificacion : 'No evaluado'}`);
            if (ultimaCargaFuego) {
                addText(`   Carga de fuego: ${ultimaCargaFuego.carga_fuego} MJ/m2`);
            }
            yPosition += 2;
            addText(`Extintores: ${extinguishers.length} unidades registradas`);
            addText(`   ${extintoresVencidos > 0 ? `ALERTA: ${extintoresVencidos} vencidos` : 'Todos vigentes'}`);
            yPosition += 2;
            addText(`Riesgos Criticos Activos: ${risks.filter(r => r.nivel === 'Cr√≠tico').length}`);
            yPosition += 5;
            
            // ACTIVIDAD REGISTRADA
            addSeparator();
            yPosition += 3;
            addText('ACTIVIDAD REGISTRADA', 14, true);
            yPosition += 5;
            addSeparator();
            yPosition += 3;
            
            addText(`Inspecciones: ${inspections.length} realizadas`);
            addText(`Acciones Generadas: ${actions.length}`);
            addText(`   - Pendientes: ${actions.filter(a => a.estado === 'pendiente').length}`);
            addText(`   - Cerradas: ${actions.filter(a => a.estado === 'cerrado').length}`);
            yPosition += 2;
            addText(`Incidentes: ${incidents.length} registrados`);
            addText(`   - Accidentes: ${incidents.filter(i => i.tipo === 'Accidente').length}`);
            addText(`   - Cuasi-accidentes: ${incidents.filter(i => i.tipo === 'Cuasi-accidente').length}`);
            yPosition += 2;
            addText(`Capacitaciones: ${trainings.length} realizadas`);
            addText(`   Total de participantes: ${trainings.reduce((sum, t) => sum + t.participantes.length, 0)}`);
            yPosition += 2;
            addText(`Entregas de EPP: ${ppe.length} registros`);
            yPosition += 5;
            
            // MATRIZ DE RIESGOS
            addSeparator();
            yPosition += 3;
            addText('MATRIZ DE RIESGOS', 14, true);
            yPosition += 5;
            addSeparator();
            yPosition += 3;
            
            addText(`Total de Riesgos Evaluados: ${risks.length}`);
            yPosition += 2;
            addText('Por Nivel:');
            addText(`- Criticos (16-25): ${risks.filter(r => r.nivel === 'Cr√≠tico').length}`);
            addText(`- Altos (10-15): ${risks.filter(r => r.nivel === 'Alto').length}`);
            addText(`- Moderados (5-9): ${risks.filter(r => r.nivel === 'Moderado').length}`);
            addText(`- Bajos (1-4): ${risks.filter(r => r.nivel === 'Bajo').length}`);
            yPosition += 3;
            
            const riesgosCriticos = risks.filter(r => r.nivel === 'Cr√≠tico');
            if (riesgosCriticos.length > 0) {
                addText('RIESGOS CRITICOS IDENTIFICADOS:', 10, true);
                riesgosCriticos.forEach(r => {
                    addText(`- ${r.descripcion} (Score: ${r.score})`);
                });
            } else {
                addText('No hay riesgos criticos activos');
            }
            yPosition += 5;
            
            // √öLTIMAS INSPECCIONES
            checkPageBreak(40);
            addSeparator();
            yPosition += 3;
            addText('ULTIMAS INSPECCIONES', 14, true);
            yPosition += 5;
            addSeparator();
            yPosition += 3;
            
            const ultimas3 = inspections.slice(-3).reverse();
            if (ultimas3.length > 0) {
                ultimas3.forEach(insp => {
                    addText(`Fecha: ${insp.fecha}`);
                    addText(`Sector: ${insp.sector}`);
                    addText(`Hallazgos: ${insp.resumen.ok} OK, ${insp.resumen.nok} NOK, ${insp.resumen.na} N/A`);
                    addText(`Inspector: ${insp.inspector.nombre}`);
                    yPosition += 3;
                });
            } else {
                addText('No hay inspecciones registradas');
            }
            yPosition += 5;
            
            // ACCIONES PRIORITARIAS PENDIENTES
            checkPageBreak(40);
            addSeparator();
            yPosition += 3;
            addText('ACCIONES PRIORITARIAS PENDIENTES', 14, true);
            yPosition += 5;
            addSeparator();
            yPosition += 3;
            
            const accionesPrioritarias = actions.filter(a => a.estado === 'pendiente' && a.prioridad === 'Alta').slice(0, 5);
            if (accionesPrioritarias.length > 0) {
                accionesPrioritarias.forEach(action => {
                    addText(`ALTA: ${action.titulo}`, 10, true);
                    addText(`   Responsable: ${action.responsable}`);
                    addText(`   Vencimiento: ${action.vencimiento}`);
                    addText(`   Origen: ${action.origen || 'Manual'}`);
                    yPosition += 2;
                });
            } else {
                addText('No hay acciones de alta prioridad pendientes');
            }
            yPosition += 5;
            
            // √öLTIMAS CAPACITACIONES
            checkPageBreak(40);
            addSeparator();
            yPosition += 3;
            addText('ULTIMAS CAPACITACIONES', 14, true);
            yPosition += 5;
            addSeparator();
            yPosition += 3;
            
            const ultimas5Capacitaciones = trainings.slice(-5).reverse();
            if (ultimas5Capacitaciones.length > 0) {
                ultimas5Capacitaciones.forEach(training => {
                    addText(`- ${training.titulo}`);
                    addText(`  Fecha: ${training.fecha} | Duracion: ${training.duracion}hs`);
                    addText(`  Participantes: ${training.participantes.length}`);
                    yPosition += 2;
                });
            } else {
                addText('No hay capacitaciones registradas');
            }
            yPosition += 5;
            
            // INDICADORES DE GESTI√ìN
            checkPageBreak(30);
            addSeparator();
            yPosition += 3;
            addText('INDICADORES DE GESTION', 14, true);
            yPosition += 5;
            addSeparator();
            yPosition += 3;
            
            addText(`Tasa de Cierre de Acciones: ${actions.length > 0 ? ((actions.filter(a => a.estado === 'cerrado').length / actions.length) * 100).toFixed(1) : 0}%`);
            yPosition += 2;
            const accionesVencidas = actions.filter(a => {
                const venc = new Date(a.vencimiento);
                return venc < hoy && a.estado !== 'cerrado';
            }).length;
            addText(`Acciones Vencidas: ${accionesVencidas}`);
            yPosition += 2;
            addText(`Cobertura de Capacitacion: ${currentEstablishment.empleados && trainings.length > 0 ? 'Revisar participantes vs total de empleados' : 'Datos insuficientes'}`);
            yPosition += 5;
            
            // RECOMENDACIONES
            checkPageBreak(40);
            addSeparator();
            yPosition += 3;
            addText('RECOMENDACIONES', 14, true);
            yPosition += 5;
            addSeparator();
            yPosition += 3;
            
            let hayRecomendaciones = false;
            if (actions.filter(a => a.estado === 'pendiente').length > 5) {
                addText('ATENCION: Priorizar el cierre de acciones pendientes');
                hayRecomendaciones = true;
            }
            if (risks.filter(r => r.nivel === 'Cr√≠tico').length > 0) {
                addText('CRITICO: Atender riesgos criticos de forma inmediata');
                hayRecomendaciones = true;
            }
            if (extintoresVencidos > 0) {
                addText(`ATENCION: Programar recarga de ${extintoresVencidos} extintor(es)`);
                hayRecomendaciones = true;
            }
            if (trainings.length === 0) {
                addText('Implementar programa de capacitaciones');
                hayRecomendaciones = true;
            }
            if (incidents.filter(i => i.gravedad === 'Grave').length > 0) {
                addText('ATENCION: Revisar acciones correctivas de incidentes graves');
                hayRecomendaciones = true;
            }
            if (inspections.length === 0) {
                addText('Realizar primera inspeccion del establecimiento');
                hayRecomendaciones = true;
            }
            
            if (!hayRecomendaciones && actions.filter(a => a.estado === 'pendiente').length === 0 && 
                risks.filter(r => r.nivel === 'Cr√≠tico').length === 0 && extintoresVencidos === 0) {
                addText('El establecimiento presenta un buen nivel de gestion de SSyH');
            }
            yPosition += 5;
            
            // PR√ìXIMAS ACCIONES SUGERIDAS
            checkPageBreak(30);
            addSeparator();
            yPosition += 3;
            addText('PROXIMAS ACCIONES SUGERIDAS', 14, true);
            yPosition += 5;
            addSeparator();
            yPosition += 3;
            
            addText(`1. ${actions.filter(a => a.estado === 'pendiente' && a.prioridad === 'Alta').length > 0 ? 'Resolver acciones de alta prioridad pendientes' : 'Realizar inspeccion programada'}`);
            addText(`2. ${extintoresVencidos > 0 ? `Coordinar recarga de ${extintoresVencidos} extintor(es)` : 'Mantener calendario de mantenimiento preventivo'}`);
            addText(`3. ${trainings.length < 2 ? 'Programar capacitacion obligatoria anual' : 'Continuar con programa de formacion continua'}`);
            yPosition += 5;
            
            // NORMATIVA APLICABLE
            checkPageBreak(40);
            addSeparator();
            yPosition += 3;
            addText('NORMATIVA APLICABLE', 14, true);
            yPosition += 5;
            addSeparator();
            yPosition += 3;
            
            addText('- Ley 19.587: Higiene y Seguridad en el Trabajo');
            addText('- Decreto 351/79: Reglamentacion completa');
            addText('- Resolucion SRT 905/2015: Relevamiento de Riesgos');
            addText('- Resolucion SRT 299/11: EPP y elementos de proteccion');
            addText('- IRAM 3517: Extintores portatiles');
            addText('- IRAM 3620: Carga de fuego');
            addText('- IRAM 10005: Senalizacion de seguridad');
            yPosition += 5;
            
            // DECLARACI√ìN
            checkPageBreak(50);
            addSeparator();
            yPosition += 3;
            addText('DECLARACION', 14, true);
            yPosition += 5;
            addSeparator();
            yPosition += 3;
            
            addText('Este resumen es generado automaticamente por el Sistema de Seguridad e Higiene como herramienta de apoyo a la gestion.');
            yPosition += 3;
            addText('No constituye dictamen tecnico oficial ni reemplaza la responsabilidad del Licenciado en Seguridad e Higiene matriculado a cargo del establecimiento.');
            yPosition += 3;
            addText('Para validez legal, este documento debe ser revisado y firmado por profesional habilitado.');
            yPosition += 5;
            addSeparator();
            yPosition += 3;
            
            addText(`Generado el: ${new Date().toLocaleString('es-AR')}`, 8);
            addText('Version del Sistema: 1.0.0', 8);
            
            // Guardar PDF
            const fileName = `Resumen_${currentEstablishment.nombre.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
            
            alert('Resumen del establecimiento exportado correctamente en PDF');
        }

        // ============= JSA MODULE =============
        function showNewJSA() {
            document.getElementById('newJSAForm').classList.remove('hidden');
            document.querySelector('#newJSAForm input[name="fecha"]').valueAsDate = new Date();
        }

        function cancelNewJSA() {
            document.getElementById('newJSAForm').classList.add('hidden');
            document.getElementById('newJSAForm').querySelector('form').reset();
        }

        function addJSAStep() {
            const container = document.getElementById('jsaSteps');
            const newStep = document.createElement('div');
            newStep.className = 'flex gap-2';
            newStep.innerHTML = `
                <input type="text" placeholder="Paso de la tarea" class="jsa-step border border-gray-300 rounded p-2 flex-1">
                <input type="text" placeholder="Peligro identificado" class="jsa-hazard border border-gray-300 rounded p-2 flex-1">
                <input type="text" placeholder="Control / Medida preventiva" class="jsa-control border border-gray-300 rounded p-2 flex-1">
                <button type="button" onclick="this.parentElement.remove()" class="bg-red-500 text-white px-2 rounded">‚úï</button>
            `;
            container.appendChild(newStep);
        }

        function saveJSA(event) {
            event.preventDefault();
            if (!currentEstablishment) {
                alert('Seleccione un establecimiento primero');
                return;
            }

            const form = event.target;
            const formData = new FormData(form);
            
            // Recopilar pasos del an√°lisis
            const steps = [];
            const stepInputs = document.querySelectorAll('.jsa-step');
            const hazardInputs = document.querySelectorAll('.jsa-hazard');
            const controlInputs = document.querySelectorAll('.jsa-control');
            
            for (let i = 0; i < stepInputs.length; i++) {
                if (stepInputs[i].value.trim()) {
                    steps.push({
                        paso: stepInputs[i].value,
                        peligro: hazardInputs[i].value,
                        control: controlInputs[i].value
                    });
                }
            }

            // Recopilar EPP
            const eppList = [];
            form.querySelectorAll('input[name="epp"]:checked').forEach(cb => {
                eppList.push(cb.value);
            });

            const jsa = {
                id: 'jsa-' + Date.now(),
                establecimiento_id: currentEstablishment.id,
                tarea: formData.get('tarea'),
                ubicacion: formData.get('ubicacion'),
                fecha: formData.get('fecha'),
                supervisor: formData.get('supervisor'),
                tipo_permiso: formData.get('tipo_permiso'),
                steps: steps,
                epp: eppList,
                observaciones: formData.get('observaciones'),
                creado: new Date().toISOString()
            };

            if (!appData.jsas) appData.jsas = [];
            appData.jsas.push(jsa);
            saveData();
            
            form.reset();
            cancelNewJSA();
            loadJSAs();
            alert('‚úÖ JSA guardado correctamente');
        }

        function loadJSAs() {
            if (!currentEstablishment) return;
            if (!appData.jsas) appData.jsas = [];
            
            const jsas = appData.jsas.filter(j => j.establecimiento_id === currentEstablishment.id);
            const container = document.getElementById('jsaList');
            
            if (jsas.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay JSAs registrados</p>';
                return;
            }

            container.innerHTML = jsas.map(jsa => `
                <div class="border border-gray-300 rounded-lg p-4 hover:shadow-md transition">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-bold text-lg">${jsa.tarea}</h4>
                            <p class="text-sm text-gray-600">${jsa.tipo_permiso} | ${jsa.ubicacion}</p>
                            <p class="text-xs text-gray-500">Fecha: ${jsa.fecha} | Supervisor: ${jsa.supervisor}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editJSA('${jsa.id}')" class="text-xs bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition">‚úèÔ∏è Editar</button>
                            <button onclick="deleteJSA('${jsa.id}')" class="text-xs bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition">üóëÔ∏è Eliminar</button>
                        </div>
                    </div>
                    <div class="mt-2 text-sm">
                        <div class="font-semibold">Pasos analizados: ${jsa.steps.length}</div>
                        ${jsa.epp.length > 0 ? `<div class="text-xs mt-1"><strong>EPP:</strong> ${jsa.epp.join(', ')}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function deleteJSA(id) {
            const jsa = appData.jsas.find(j => j.id === id);
            if (!jsa) return;
            
            if (!confirm(`¬øEst√° seguro de eliminar el JSA de "${jsa.tarea}"?\n\nEsta acci√≥n no se puede deshacer.`)) return;
            appData.jsas = appData.jsas.filter(j => j.id !== id);
            saveData();
            loadJSAs();
            alert('‚úÖ JSA eliminado correctamente');
        }

        function editJSA(jsaId) {
            const jsa = appData.jsas.find(j => j.id === jsaId);
            if (!jsa) return;
            
            // Mostrar formulario
            document.getElementById('newJSAForm').classList.remove('hidden');
            
            // Cargar datos b√°sicos
            setTimeout(() => {
                document.querySelector('#newJSAForm input[name="tarea"]').value = jsa.tarea;
                document.querySelector('#newJSAForm input[name="ubicacion"]').value = jsa.ubicacion;
                document.querySelector('#newJSAForm input[name="fecha"]').value = jsa.fecha;
                document.querySelector('#newJSAForm input[name="supervisor"]').value = jsa.supervisor;
                document.querySelector('#newJSAForm select[name="tipo_permiso"]').value = jsa.tipo_permiso;
                document.querySelector('#newJSAForm textarea[name="observaciones"]').value = jsa.observaciones || '';
                
                // Cargar EPP
                document.querySelectorAll('#newJSAForm input[name="epp"]').forEach(cb => {
                    cb.checked = jsa.epp.includes(cb.value);
                });
                
                // Limpiar y cargar pasos
                const stepsContainer = document.getElementById('jsaSteps');
                stepsContainer.innerHTML = '';
                jsa.steps.forEach(step => {
                    const newStep = document.createElement('div');
                    newStep.className = 'flex gap-2';
                    newStep.innerHTML = `
                        <input type="text" value="${step.paso}" placeholder="Paso de la tarea" class="jsa-step border border-gray-300 rounded p-2 flex-1">
                        <input type="text" value="${step.peligro}" placeholder="Peligro identificado" class="jsa-hazard border border-gray-300 rounded p-2 flex-1">
                        <input type="text" value="${step.control}" placeholder="Control / Medida preventiva" class="jsa-control border border-gray-300 rounded p-2 flex-1">
                        <button type="button" onclick="this.parentElement.remove()" class="bg-red-500 text-white px-2 rounded">‚úï</button>
                    `;
                    stepsContainer.appendChild(newStep);
                });
                
                // Cambiar comportamiento del formulario
                const form = document.querySelector('#newJSAForm form');
                const originalOnSubmit = form.onsubmit;
                
                form.onsubmit = function(e) {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    
                    // Recopilar pasos
                    const steps = [];
                    const stepInputs = document.querySelectorAll('.jsa-step');
                    const hazardInputs = document.querySelectorAll('.jsa-hazard');
                    const controlInputs = document.querySelectorAll('.jsa-control');
                    
                    for (let i = 0; i < stepInputs.length; i++) {
                        if (stepInputs[i].value.trim()) {
                            steps.push({
                                paso: stepInputs[i].value,
                                peligro: hazardInputs[i].value,
                                control: controlInputs[i].value
                            });
                        }
                    }
                    
                    // Recopilar EPP
                    const eppList = [];
                    form.querySelectorAll('input[name="epp"]:checked').forEach(cb => {
                        eppList.push(cb.value);
                    });
                    
                    // Actualizar JSA
                    jsa.tarea = formData.get('tarea');
                    jsa.ubicacion = formData.get('ubicacion');
                    jsa.fecha = formData.get('fecha');
                    jsa.supervisor = formData.get('supervisor');
                    jsa.tipo_permiso = formData.get('tipo_permiso');
                    jsa.steps = steps;
                    jsa.epp = eppList;
                    jsa.observaciones = formData.get('observaciones');
                    jsa.modificado = new Date().toISOString();
                    
                    saveData();
                    form.reset();
                    cancelNewJSA();
                    loadJSAs();
                    alert('‚úÖ JSA actualizado correctamente');
                    
                    // Restaurar comportamiento original
                    form.onsubmit = originalOnSubmit;
                };
            }, 100);
        }

        // ============= CHEMICALS / SDS MODULE =============
        function showNewChemical() {
            document.getElementById('newChemicalForm').classList.remove('hidden');
        }

        function cancelNewChemical() {
            document.getElementById('newChemicalForm').classList.add('hidden');
            document.getElementById('newChemicalForm').querySelector('form').reset();
        }

        function saveChemical(event) {
            event.preventDefault();
            if (!currentEstablishment) {
                alert('Seleccione un establecimiento primero');
                return;
            }

            const form = event.target;
            const formData = new FormData(form);

            const pictogramas = [];
            form.querySelectorAll('input[name="pictograma"]:checked').forEach(cb => {
                pictogramas.push(cb.value);
            });

            const indicaciones = [];
            form.querySelectorAll('input[name="indicacion"]:checked').forEach(cb => {
                indicaciones.push(cb.value);
            });

            const chemical = {
                id: 'chem-' + Date.now(),
                establecimiento_id: currentEstablishment.id,
                nombre: formData.get('nombre'),
                fabricante: formData.get('fabricante'),
                codigo: formData.get('codigo'),
                numero_cas: formData.get('numero_cas'),
                numero_nu: formData.get('numero_nu'),
                pictogramas: pictogramas,
                indicaciones_peligro: indicaciones,
                cantidad: formData.get('cantidad'),
                unidad: formData.get('unidad'),
                ubicacion: formData.get('ubicacion'),
                uso: formData.get('uso'),
                fecha_sds: formData.get('fecha_sds'),
                creado: new Date().toISOString()
            };

            if (!appData.chemicals) appData.chemicals = [];
            appData.chemicals.push(chemical);
            saveData();
            
            form.reset();
            cancelNewChemical();
            loadChemicals();
            alert('‚úÖ Producto qu√≠mico guardado correctamente');
        }

        function loadChemicals() {
            if (!currentEstablishment) return;
            if (!appData.chemicals) appData.chemicals = [];
            
            const chemicals = appData.chemicals.filter(c => c.establecimiento_id === currentEstablishment.id);
            const container = document.getElementById('chemicalsList');
            
            if (chemicals.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay productos qu√≠micos registrados</p>';
                return;
            }

            container.innerHTML = chemicals.map(chem => `
                <div class="border border-gray-300 rounded-lg p-4 hover:shadow-md transition">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-bold text-lg">${chem.nombre}</h4>
                            <p class="text-sm text-gray-600">${chem.fabricante || 'Fabricante no especificado'}</p>
                            <p class="text-xs text-gray-500 mt-1">
                                ${chem.numero_cas ? 'CAS: ' + chem.numero_cas : ''} 
                                ${chem.numero_nu ? ' | NU: ' + chem.numero_nu : ''}
                            </p>
                            ${chem.pictogramas.length > 0 ? `<div class="mt-2 text-sm"><strong>GHS:</strong> ${chem.pictogramas.join(', ')}</div>` : ''}
                            <div class="text-xs mt-1">
                                ${chem.cantidad ? `Cantidad: ${chem.cantidad} ${chem.unidad || ''}` : ''} 
                                ${chem.ubicacion ? ` | Ubicaci√≥n: ${chem.ubicacion}` : ''}
                            </div>
                        </div>
                        <button onclick="deleteChemical('${chem.id}')" class="text-red-600 hover:text-red-800">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function deleteChemical(id) {
            if (!confirm('¬øEliminar este producto qu√≠mico?')) return;
            appData.chemicals = appData.chemicals.filter(c => c.id !== id);
            saveData();
            loadChemicals();
        }

        // ============= ENVIRONMENTAL MONITORING MODULE =============
        function showNewMeasurement() {
            document.getElementById('newMeasurementForm').classList.remove('hidden');
            document.querySelector('#newMeasurementForm input[name="fecha"]').valueAsDate = new Date();
        }

        function cancelNewMeasurement() {
            document.getElementById('newMeasurementForm').classList.add('hidden');
            document.getElementById('newMeasurementForm').querySelector('form').reset();
        }

        function saveMeasurement(event) {
            event.preventDefault();
            if (!currentEstablishment) {
                alert('Seleccione un establecimiento primero');
                return;
            }

            const form = event.target;
            const formData = new FormData(form);

            const valorMedido = parseFloat(formData.get('valor'));
            const limitePermitido = parseFloat(formData.get('limite')) || 0;

            const measurement = {
                id: 'meas-' + Date.now(),
                establecimiento_id: currentEstablishment.id,
                tipo: formData.get('tipo'),
                fecha: formData.get('fecha'),
                hora: formData.get('hora'),
                ubicacion: formData.get('ubicacion'),
                instrumento: formData.get('instrumento'),
                valor_medido: valorMedido,
                limite_permitido: limitePermitido,
                observaciones: formData.get('observaciones'),
                conforme: limitePermitido > 0 ? valorMedido <= limitePermitido : true,
                creado: new Date().toISOString()
            };

            if (!appData.measurements) appData.measurements = [];
            appData.measurements.push(measurement);
            saveData();
            
            form.reset();
            cancelNewMeasurement();
            loadMeasurements();
            alert('‚úÖ Medici√≥n guardada correctamente');
        }

        function loadMeasurements() {
            if (!currentEstablishment) return;
            if (!appData.measurements) appData.measurements = [];
            
            const measurements = appData.measurements.filter(m => m.establecimiento_id === currentEstablishment.id);
            const container = document.getElementById('measurementsList');
            
            if (measurements.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay mediciones registradas</p>';
                return;
            }

            container.innerHTML = measurements.map(meas => {
                const statusColor = meas.conforme ? 'bg-green-50 border-green-500' : 'bg-red-50 border-red-500';
                const statusIcon = meas.conforme ? '<i class="fas fa-check-circle text-green-600"></i>' : '<i class="fas fa-exclamation-triangle text-yellow-600"></i>';
                const unidad = meas.tipo.includes('Ruido') ? 'dB' : 
                              meas.tipo.includes('Iluminaci√≥n') ? 'lux' : 
                              meas.tipo.includes('Temperatura') ? '¬∞C' :
                              meas.tipo.includes('Humedad') ? '%' :
                              meas.tipo.includes('CO') ? 'ppm' :
                              meas.tipo.includes('Polvo') ? 'mg/m¬≥' : '';
                
                return `
                    <div class="border-l-4 ${statusColor} rounded-lg p-4 hover:shadow-md transition">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="font-bold">${statusIcon} ${meas.tipo}</h4>
                                <p class="text-sm text-gray-600">${meas.ubicacion} | ${meas.fecha}${meas.hora ? ' ' + meas.hora : ''}</p>
                                <div class="mt-2 text-sm">
                                    <strong>Valor:</strong> ${meas.valor_medido} ${unidad}
                                    ${meas.limite_permitido > 0 ? ` (L√≠mite: ${meas.limite_permitido} ${unidad})` : ''}
                                </div>
                                ${meas.instrumento ? `<p class="text-xs text-gray-500 mt-1">Instrumento: ${meas.instrumento}</p>` : ''}
                            </div>
                            <button onclick="deleteMeasurement('${meas.id}')" class="text-red-600 hover:text-red-800">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function deleteMeasurement(id) {
            if (!confirm('¬øEliminar esta medici√≥n?')) return;
            appData.measurements = appData.measurements.filter(m => m.id !== id);
            saveData();
            loadMeasurements();
        }

        // ============= EVACUATION MODULE =============
        function showNewDrill() {
            document.getElementById('newDrillForm').classList.remove('hidden');
            document.querySelector('#newDrillForm input[name="fecha"]').valueAsDate = new Date();
        }

        function cancelNewDrill() {
            document.getElementById('newDrillForm').classList.add('hidden');
            document.getElementById('newDrillForm').querySelector('form').reset();
        }

        function saveDrill(event) {
            event.preventDefault();
            if (!currentEstablishment) {
                alert('Seleccione un establecimiento primero');
                return;
            }

            const form = event.target;
            const formData = new FormData(form);

            const drill = {
                id: 'drill-' + Date.now(),
                establecimiento_id: currentEstablishment.id,
                fecha: formData.get('fecha'),
                hora: formData.get('hora'),
                tipo_emergencia: formData.get('tipo_emergencia'),
                anunciado: formData.get('anunciado'),
                personas_presentes: parseInt(formData.get('personas_presentes')),
                personas_evacuadas: parseInt(formData.get('personas_evacuadas')),
                tiempo_minutos: parseFloat(formData.get('tiempo_minutos')),
                coordinador: formData.get('coordinador'),
                hallazgos: formData.get('hallazgos'),
                mejoras: formData.get('mejoras'),
                creado: new Date().toISOString()
            };

            if (!appData.drills) appData.drills = [];
            appData.drills.push(drill);
            saveData();
            
            form.reset();
            cancelNewDrill();
            loadDrills();
            alert('‚úÖ Simulacro de evacuaci√≥n registrado correctamente');
        }

        function loadDrills() {
            if (!currentEstablishment) return;
            if (!appData.drills) appData.drills = [];
            
            const drills = appData.drills.filter(d => d.establecimiento_id === currentEstablishment.id);
            const container = document.getElementById('drillsList');
            
            if (drills.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay simulacros registrados</p>';
                return;
            }

            container.innerHTML = drills.map(drill => {
                const eficiencia = drill.personas_presentes > 0 ? 
                    Math.round((drill.personas_evacuadas / drill.personas_presentes) * 100) : 0;
                const statusColor = eficiencia >= 95 ? 'border-green-500' : eficiencia >= 80 ? 'border-yellow-500' : 'border-red-500';
                
                return `
                    <div class="border-l-4 ${statusColor} rounded-lg p-4 hover:shadow-md transition bg-white">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="font-bold text-lg">${drill.tipo_emergencia} ${drill.anunciado === 'No' ? '(Sorpresa)' : ''}</h4>
                                <p class="text-sm text-gray-600">${drill.fecha} | ${drill.hora}</p>
                                <div class="mt-2 grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
                                    <div><strong>Presentes:</strong> ${drill.personas_presentes}</div>
                                    <div><strong>Evacuadas:</strong> ${drill.personas_evacuadas}</div>
                                    <div><strong>Tiempo:</strong> ${drill.tiempo_minutos} min</div>
                                    <div><strong>Eficiencia:</strong> ${eficiencia}%</div>
                                </div>
                                <p class="text-xs text-gray-500 mt-2"><strong>Coordinador:</strong> ${drill.coordinador}</p>
                                ${drill.hallazgos ? `<p class="text-xs text-gray-700 mt-2"><strong>Hallazgos:</strong> ${drill.hallazgos.substring(0, 150)}${drill.hallazgos.length > 150 ? '...' : ''}</p>` : ''}
                            </div>
                            <button onclick="deleteDrill('${drill.id}')" class="text-red-600 hover:text-red-800">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function deleteDrill(id) {
            if (!confirm('¬øEliminar este simulacro?')) return;
            appData.drills = appData.drills.filter(d => d.id !== id);
            saveData();
            loadDrills();
        }

        function calculateExits() {
            const ocupacion = parseInt(document.getElementById('calcOcupacion').value);
            const tipo = document.getElementById('calcTipo').value;
            const resultsDiv = document.getElementById('exitResults');
            
            if (!ocupacion || ocupacion <= 0) {
                resultsDiv.classList.add('hidden');
                alert('Ingrese una ocupaci√≥n v√°lida');
                return;
            }

            // Factores seg√∫n Dec. 351/79 y normas de edificaci√≥n
            const factoresSalida = {
                'oficina': 150,      // 1.5 personas/cm seg√∫n Decreto 351/79
                'comercio': 200,     // 2 personas/cm
                'industria': 150,    // 1.5 personas/cm
                'educacion': 200,    // 2 personas/cm
                'salud': 100         // 1 persona/cm
            };

            const factor = factoresSalida[tipo] || 150;
            const anchoMinimoCm = Math.ceil(ocupacion / factor * 100); // En cm
            const anchoMinimoM = (anchoMinimoCm / 100).toFixed(2); // En metros
            
            // Cantidad m√≠nima de salidas
            let cantidadSalidas = 1;
            if (ocupacion > 300) cantidadSalidas = 3;
            else if (ocupacion > 100) cantidadSalidas = 2;

            // Ancho m√≠nimo por salida (m√≠nimo 1.20m = 2 unidades de salida)
            const anchoMinimoPorSalida = Math.max(1.20, anchoMinimoM / cantidadSalidas).toFixed(2);

            resultsDiv.classList.remove('hidden');
            resultsDiv.innerHTML = `
                <div class="bg-white p-4 rounded border border-blue-200">
                    <h4 class="font-bold text-blue-800 mb-2">üìä Resultados del C√°lculo</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="font-semibold">Ocupaci√≥n:</span>
                            <span>${ocupacion} personas</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-semibold">Ancho total m√≠nimo requerido:</span>
                            <span class="text-lg font-bold text-blue-600">${anchoMinimoM} m (${anchoMinimoCm} cm)</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-semibold">Cantidad m√≠nima de salidas:</span>
                            <span class="text-lg font-bold text-blue-600">${cantidadSalidas}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-semibold">Ancho m√≠nimo por salida:</span>
                            <span class="text-lg font-bold text-blue-600">${anchoMinimoPorSalida} m</span>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-blue-200 text-xs text-gray-600">
                        <p><strong>Normativa aplicable:</strong> Decreto 351/79 Art. 172-182</p>
                        <p class="mt-1"><strong>Criterio:</strong> Factor de ocupaci√≥n ${factor/100} persona(s) por cm de ancho de salida</p>
                        <p class="mt-1"><strong>Nota:</strong> Se debe verificar tambi√©n el ancho de pasillos, escaleras y puertas en el recorrido de evacuaci√≥n. Ancho m√≠nimo absoluto: 1.20m (2 unidades de salida de 0.55m cada una).</p>
                    </div>
                </div>
            `;
        }

        // ============= CONTRACTORS MODULE =============
        function showNewContractor() {
            document.getElementById('newContractorForm').classList.remove('hidden');
        }

        function cancelNewContractor() {
            document.getElementById('newContractorForm').classList.add('hidden');
            document.getElementById('newContractorForm').querySelector('form').reset();
            document.getElementById('contractorEditId').value = '';
            document.getElementById('contractorFormTitle').textContent = 'Nuevo Contratista';
        }

        function saveContractor(event) {
            event.preventDefault();
            if (!currentEstablishment) {
                alert('Seleccione un establecimiento primero');
                return;
            }

            const form = event.target;
            const formData = new FormData(form);
            const editId = formData.get('edit_id');

            const certificaciones = [];
            form.querySelectorAll('input[name="cert"]:checked').forEach(cb => {
                certificaciones.push(cb.value);
            });

            const contractorData = {
                razon_social: formData.get('razon_social'),
                cuit: formData.get('cuit'),
                responsable: formData.get('responsable'),
                telefono: formData.get('telefono'),
                actividad: formData.get('actividad'),
                art: formData.get('art'),
                art_poliza: formData.get('art_poliza'),
                art_desde: formData.get('art_desde'),
                art_hasta: formData.get('art_hasta'),
                certificaciones: certificaciones,
                observaciones: formData.get('observaciones')
            };

            if (!appData.contractors) appData.contractors = [];

            if (editId) {
                // Editar contratista existente
                const index = appData.contractors.findIndex(c => c.id === editId);
                if (index !== -1) {
                    appData.contractors[index] = {
                        ...appData.contractors[index],
                        ...contractorData,
                        modificado: new Date().toISOString()
                    };
                    alert('‚úÖ Contratista actualizado correctamente');
                }
            } else {
                // Crear nuevo contratista
                const contractor = {
                    ...contractorData,
                    id: 'cont-' + Date.now(),
                    establecimiento_id: currentEstablishment.id,
                    creado: new Date().toISOString()
                };
                appData.contractors.push(contractor);
                alert('‚úÖ Contratista guardado correctamente');
            }

            saveData();
            form.reset();
            document.getElementById('contractorEditId').value = '';
            cancelNewContractor();
            loadContractors();
        }

        function loadContractors() {
            if (!currentEstablishment) return;
            if (!appData.contractors) appData.contractors = [];
            
            const contractors = appData.contractors.filter(c => c.establecimiento_id === currentEstablishment.id);
            const container = document.getElementById('contractorsList');
            
            if (contractors.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay contratistas registrados</p>';
                return;
            }

            container.innerHTML = contractors.map(cont => {
                const hoy = new Date();
                const vencimiento = cont.art_hasta ? new Date(cont.art_hasta) : null;
                const artVencida = vencimiento && vencimiento < hoy;
                const statusColor = artVencida ? 'border-red-500 bg-red-50' : 'border-green-500 bg-green-50';
                
                return `
                    <div class="border-l-4 ${statusColor} rounded-lg p-4 hover:shadow-md transition">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="font-bold text-lg">${cont.razon_social}</h4>
                                <p class="text-sm text-gray-600">CUIT: ${cont.cuit} | ${cont.actividad}</p>
                                ${cont.responsable ? `<p class="text-xs text-gray-500">Contacto: ${cont.responsable}${cont.telefono ? ' | ' + cont.telefono : ''}</p>` : ''}
                                <div class="mt-2 text-sm">
                                    <div><strong>ART:</strong> ${cont.art || 'No especificada'} ${cont.art_poliza ? '(P√≥liza: ' + cont.art_poliza + ')' : ''}</div>
                                    ${cont.art_hasta ? `<div class="${artVencida ? 'text-red-600 font-semibold' : ''}">
                                        Vigencia: ${cont.art_desde || '?'} a ${cont.art_hasta} ${artVencida ? '‚ö†Ô∏è VENCIDA' : '<i class="fas fa-check-circle text-green-600"></i>'}
                                    </div>` : ''}
                                    ${cont.certificaciones.length > 0 ? `<div class="text-xs mt-1"><strong>Certificaciones:</strong> ${cont.certificaciones.join(', ')}</div>` : ''}
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="generateContractorPDF('${cont.id}')" class="text-purple-600 hover:text-purple-800" title="Generar Informe PDF">
                                    <i class="fas fa-file-pdf"></i>
                                </button>
                                <button onclick="editContractor('${cont.id}')" class="text-blue-600 hover:text-blue-800" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteContractor('${cont.id}')" class="text-red-600 hover:text-red-800" title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function deleteContractor(id) {
            if (!confirm('¬øEliminar este contratista?')) return;
            appData.contractors = appData.contractors.filter(c => c.id !== id);
            saveData();
            loadContractors();
        }

        function editContractor(id) {
            const contractor = appData.contractors.find(c => c.id === id);
            if (!contractor) return;

            // Mostrar el formulario
            document.getElementById('newContractorForm').classList.remove('hidden');
            document.getElementById('contractorFormTitle').textContent = 'Editar Contratista';

            // Llenar el formulario con los datos
            const form = document.querySelector('#newContractorForm form');
            document.getElementById('contractorEditId').value = contractor.id;
            form.querySelector('input[name="razon_social"]').value = contractor.razon_social || '';
            form.querySelector('input[name="cuit"]').value = contractor.cuit || '';
            form.querySelector('input[name="responsable"]').value = contractor.responsable || '';
            form.querySelector('input[name="telefono"]').value = contractor.telefono || '';
            form.querySelector('input[name="actividad"]').value = contractor.actividad || '';
            form.querySelector('input[name="art"]').value = contractor.art || '';
            form.querySelector('input[name="art_poliza"]').value = contractor.art_poliza || '';
            form.querySelector('input[name="art_desde"]').value = contractor.art_desde || '';
            form.querySelector('input[name="art_hasta"]').value = contractor.art_hasta || '';
            form.querySelector('textarea[name="observaciones"]').value = contractor.observaciones || '';

            // Marcar las certificaciones
            form.querySelectorAll('input[name="cert"]').forEach(cb => {
                cb.checked = contractor.certificaciones && contractor.certificaciones.includes(cb.value);
            });

            // Scroll al formulario
            document.getElementById('newContractorForm').scrollIntoView({ behavior: 'smooth' });
        }

        function generateContractorPDF(id) {
            const contractor = appData.contractors.find(c => c.id === id);
            if (!contractor) return;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Membrete azul - mismo formato que otros m√≥dulos
            doc.setFillColor(30, 64, 175); // Color azul del membrete
            doc.rect(0, 0, 210, 35, 'F');
            
            // T√≠tulo en blanco sobre el membrete
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text('INFORME DE CONTRATISTA', 105, 15, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text('Sistema de Seguridad e Higiene', 105, 25, { align: 'center' });
            
            // Fecha del informe
            const fechaInforme = new Date().toLocaleDateString('es-AR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            doc.setFontSize(10);
            doc.text(`Fecha: ${fechaInforme}`, 105, 32, { align: 'center' });
            
            // Restaurar color de texto a negro para el contenido
            doc.setTextColor(0, 0, 0);
            
            let yPos = 50;
            
            // Secci√≥n: Datos del Contratista
            doc.setFillColor(240, 240, 250);
            doc.rect(15, yPos - 5, 180, 8, 'F');
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(30, 64, 175);
            doc.text('DATOS DEL CONTRATISTA', 20, yPos);
            doc.setTextColor(0, 0, 0);
            yPos += 12;
            
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('Raz√≥n Social:', 20, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(contractor.razon_social || 'N/A', 60, yPos);
            yPos += 8;
            
            doc.setFont(undefined, 'bold');
            doc.text('CUIT:', 20, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(contractor.cuit || 'N/A', 60, yPos);
            yPos += 8;
            
            doc.setFont(undefined, 'bold');
            doc.text('Actividad:', 20, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(contractor.actividad || 'N/A', 60, yPos);
            yPos += 8;
            
            doc.setFont(undefined, 'bold');
            doc.text('Responsable:', 20, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(contractor.responsable || 'N/A', 60, yPos);
            yPos += 8;
            
            doc.setFont(undefined, 'bold');
            doc.text('Tel√©fono:', 20, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(contractor.telefono || 'N/A', 60, yPos);
            yPos += 15;
            
            // Secci√≥n: ART y Seguros
            doc.setFillColor(240, 240, 250);
            doc.rect(15, yPos - 5, 180, 8, 'F');
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(30, 64, 175);
            doc.text('ASEGURADORA DE RIESGOS DEL TRABAJO (ART)', 20, yPos);
            doc.setTextColor(0, 0, 0);
            yPos += 12;
            
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('ART:', 20, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(contractor.art || 'No especificada', 60, yPos);
            yPos += 8;
            
            doc.setFont(undefined, 'bold');
            doc.text('P√≥liza:', 20, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(contractor.art_poliza || 'No especificada', 60, yPos);
            yPos += 8;
            
            doc.setFont(undefined, 'bold');
            doc.text('Vigencia:', 20, yPos);
            doc.setFont(undefined, 'normal');
            const vigencia = contractor.art_desde && contractor.art_hasta ? 
                `${contractor.art_desde} a ${contractor.art_hasta}` : 'No especificada';
            doc.text(vigencia, 60, yPos);
            yPos += 8;
            
            // Verificar si est√° vencida
            if (contractor.art_hasta) {
                const hoy = new Date();
                const vencimiento = new Date(contractor.art_hasta);
                const artVencida = vencimiento < hoy;
                
                doc.setFont(undefined, 'bold');
                doc.text('Estado:', 20, yPos);
                doc.setFont(undefined, 'normal');
                if (artVencida) {
                    doc.setTextColor(220, 38, 38);
                    doc.text('VENCIDA', 60, yPos);
                } else {
                    doc.setTextColor(22, 163, 74);
                    doc.text('VIGENTE', 60, yPos);
                }
                doc.setTextColor(0, 0, 0);
                yPos += 8;
            }
            yPos += 7;
            
            // Secci√≥n: Certificaciones
            if (contractor.certificaciones && contractor.certificaciones.length > 0) {
                doc.setFillColor(240, 240, 250);
                doc.rect(15, yPos - 5, 180, 8, 'F');
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(30, 64, 175);
                doc.text('CERTIFICACIONES', 20, yPos);
                doc.setTextColor(0, 0, 0);
                yPos += 12;
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                contractor.certificaciones.forEach(cert => {
                    doc.text(`‚Ä¢ ${cert}`, 25, yPos);
                    yPos += 7;
                });
                yPos += 8;
            }
            
            // Secci√≥n: Observaciones
            if (contractor.observaciones) {
                if (yPos > 240) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFillColor(240, 240, 250);
                doc.rect(15, yPos - 5, 180, 8, 'F');
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(30, 64, 175);
                doc.text('OBSERVACIONES', 20, yPos);
                doc.setTextColor(0, 0, 0);
                yPos += 12;
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                const splitText = doc.splitTextToSize(contractor.observaciones, 170);
                doc.text(splitText, 20, yPos);
                yPos += (splitText.length * 7) + 10;
            }
            
            // Pie de p√°gina
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(9);
                doc.setTextColor(128, 128, 128);
                doc.setFont(undefined, 'normal');
                doc.text(
                    `P√°gina ${i} de ${pageCount}`,
                    105,
                    285,
                    { align: 'center' }
                );
                doc.text(
                    'Sistema de Seguridad e Higiene - Informe Generado Autom√°ticamente',
                    105,
                    290,
                    { align: 'center' }
                );
            }
            
            // Guardar el PDF
            const fileName = `Informe_Contratista_${contractor.razon_social.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
        }

        function generateAllContractorsPDF() {
            if (!currentEstablishment) {
                alert('Seleccione un establecimiento primero');
                return;
            }

            if (!appData.contractors) appData.contractors = [];
            const contractors = appData.contractors.filter(c => c.establecimiento_id === currentEstablishment.id);
            
            if (contractors.length === 0) {
                alert('No hay contratistas registrados para generar el informe');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Membrete azul
            doc.setFillColor(30, 64, 175);
            doc.rect(0, 0, 210, 35, 'F');
            
            // T√≠tulo en blanco sobre el membrete
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text('INFORME GENERAL DE CONTRATISTAS', 105, 15, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text('Sistema de Seguridad e Higiene', 105, 25, { align: 'center' });
            
            // Fecha del informe
            const fechaInforme = new Date().toLocaleDateString('es-AR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            doc.setFontSize(10);
            doc.text(`Fecha: ${fechaInforme}`, 105, 32, { align: 'center' });
            
            // Restaurar color de texto a negro
            doc.setTextColor(0, 0, 0);
            
            let yPos = 50;
            
            // Informaci√≥n del establecimiento
            doc.setFillColor(240, 240, 250);
            doc.rect(15, yPos - 5, 180, 8, 'F');
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(30, 64, 175);
            doc.text('ESTABLECIMIENTO', 20, yPos);
            doc.setTextColor(0, 0, 0);
            yPos += 12;
            
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            doc.text(currentEstablishment.nombre, 20, yPos);
            yPos += 20;
            
            // Resumen general
            doc.setFillColor(240, 240, 250);
            doc.rect(15, yPos - 5, 180, 8, 'F');
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(30, 64, 175);
            doc.text('RESUMEN GENERAL', 20, yPos);
            doc.setTextColor(0, 0, 0);
            yPos += 12;
            
            // Calcular estad√≠sticas
            let totalContratistas = contractors.length;
            let artVigentes = 0;
            let artVencidas = 0;
            let artSinEspecificar = 0;
            
            const hoy = new Date();
            contractors.forEach(cont => {
                if (cont.art_hasta) {
                    const vencimiento = new Date(cont.art_hasta);
                    if (vencimiento < hoy) {
                        artVencidas++;
                    } else {
                        artVigentes++;
                    }
                } else {
                    artSinEspecificar++;
                }
            });
            
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            doc.text(`Total de contratistas: ${totalContratistas}`, 20, yPos);
            yPos += 8;
            
            doc.setTextColor(22, 163, 74);
            doc.text(`ART Vigentes: ${artVigentes}`, 20, yPos);
            yPos += 8;
            
            doc.setTextColor(220, 38, 38);
            doc.text(`ART Vencidas: ${artVencidas}`, 20, yPos);
            yPos += 8;
            
            doc.setTextColor(100, 100, 100);
            doc.text(`Sin especificar: ${artSinEspecificar}`, 20, yPos);
            yPos += 15;
            
            // Lista de contratistas
            doc.setTextColor(0, 0, 0);
            doc.setFillColor(240, 240, 250);
            doc.rect(15, yPos - 5, 180, 8, 'F');
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(30, 64, 175);
            doc.text('LISTADO DE CONTRATISTAS', 20, yPos);
            doc.setTextColor(0, 0, 0);
            yPos += 12;
            
            // Tabla de contratistas
            const tableData = contractors.map(cont => {
                let estadoART = 'Sin especificar';
                let estadoColor = [100, 100, 100];
                
                if (cont.art_hasta) {
                    const vencimiento = new Date(cont.art_hasta);
                    if (vencimiento < hoy) {
                        estadoART = 'VENCIDA';
                        estadoColor = [220, 38, 38];
                    } else {
                        estadoART = 'VIGENTE';
                        estadoColor = [22, 163, 74];
                    }
                }
                
                return [
                    cont.razon_social || 'N/A',
                    cont.cuit || 'N/A',
                    cont.actividad || 'N/A',
                    cont.art || 'No especificada',
                    cont.art_hasta || 'N/A',
                    { content: estadoART, styles: { textColor: estadoColor, fontStyle: 'bold' } }
                ];
            });
            
            doc.autoTable({
                startY: yPos,
                head: [['Raz√≥n Social', 'CUIT', 'Actividad', 'ART', 'Vencimiento', 'Estado']],
                body: tableData,
                theme: 'striped',
                headStyles: {
                    fillColor: [30, 64, 175],
                    textColor: [255, 255, 255],
                    fontSize: 10,
                    fontStyle: 'bold',
                    halign: 'center'
                },
                bodyStyles: {
                    fontSize: 9,
                    cellPadding: 3
                },
                columnStyles: {
                    0: { cellWidth: 40 },
                    1: { cellWidth: 28 },
                    2: { cellWidth: 35 },
                    3: { cellWidth: 30 },
                    4: { cellWidth: 25, halign: 'center' },
                    5: { cellWidth: 22, halign: 'center' }
                },
                margin: { left: 15, right: 15 }
            });
            
            yPos = doc.lastAutoTable.finalY + 15;
            
            // Detalle de cada contratista
            if (yPos > 240) {
                doc.addPage();
                yPos = 20;
            }
            
            doc.setFillColor(240, 240, 250);
            doc.rect(15, yPos - 5, 180, 8, 'F');
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(30, 64, 175);
            doc.text('DETALLE DE CONTRATISTAS', 20, yPos);
            doc.setTextColor(0, 0, 0);
            yPos += 15;
            
            contractors.forEach((cont, index) => {
                // Verificar si necesitamos una nueva p√°gina
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }
                
                // Nombre del contratista
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text(`${index + 1}. ${cont.razon_social}`, 20, yPos);
                yPos += 8;
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                
                // CUIT y Actividad
                doc.text(`CUIT: ${cont.cuit || 'N/A'}`, 25, yPos);
                yPos += 6;
                doc.text(`Actividad: ${cont.actividad || 'N/A'}`, 25, yPos);
                yPos += 6;
                
                // Contacto
                if (cont.responsable) {
                    doc.text(`Responsable: ${cont.responsable}${cont.telefono ? ' | Tel: ' + cont.telefono : ''}`, 25, yPos);
                    yPos += 6;
                }
                
                // ART
                doc.text(`ART: ${cont.art || 'No especificada'}${cont.art_poliza ? ' (P√≥liza: ' + cont.art_poliza + ')' : ''}`, 25, yPos);
                yPos += 6;
                
                if (cont.art_hasta) {
                    const vencimiento = new Date(cont.art_hasta);
                    const artVencida = vencimiento < hoy;
                    const vigencia = `${cont.art_desde || 'N/A'} a ${cont.art_hasta}`;
                    
                    doc.setFont(undefined, 'bold');
                    if (artVencida) {
                        doc.setTextColor(220, 38, 38);
                        doc.text(`Vigencia: ${vigencia} - VENCIDA`, 25, yPos);
                    } else {
                        doc.setTextColor(22, 163, 74);
                        doc.text(`Vigencia: ${vigencia} - VIGENTE`, 25, yPos);
                    }
                    doc.setTextColor(0, 0, 0);
                    doc.setFont(undefined, 'normal');
                    yPos += 6;
                }
                
                // Certificaciones
                if (cont.certificaciones && cont.certificaciones.length > 0) {
                    doc.text(`Certificaciones: ${cont.certificaciones.join(', ')}`, 25, yPos);
                    yPos += 6;
                }
                
                // Observaciones
                if (cont.observaciones) {
                    doc.setFontSize(9);
                    const splitObs = doc.splitTextToSize(`Obs: ${cont.observaciones}`, 170);
                    doc.text(splitObs, 25, yPos);
                    yPos += (splitObs.length * 5);
                }
                
                yPos += 8; // Espacio entre contratistas
            });
            
            // Pie de p√°gina
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(9);
                doc.setTextColor(128, 128, 128);
                doc.setFont(undefined, 'normal');
                doc.text(
                    `P√°gina ${i} de ${pageCount}`,
                    105,
                    285,
                    { align: 'center' }
                );
                doc.text(
                    'Sistema de Seguridad e Higiene - Informe Generado Autom√°ticamente',
                    105,
                    290,
                    { align: 'center' }
                );
            }
            
            // Guardar el PDF
            const fileName = `Informe_General_Contratistas_${currentEstablishment.nombre.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
        }

        // ============= MAINTENANCE MODULE =============
        function showNewMaintenance() {
            document.getElementById('newMaintenanceForm').classList.remove('hidden');
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('#newMaintenanceForm input[name="ultima_fecha"]').value = today;
        }

        function cancelNewMaintenance() {
            document.getElementById('newMaintenanceForm').classList.add('hidden');
            document.getElementById('newMaintenanceForm').querySelector('form').reset();
        }

        function saveMaintenance(event) {
            event.preventDefault();
            if (!currentEstablishment) {
                alert('Seleccione un establecimiento primero');
                return;
            }

            const form = event.target;
            const formData = new FormData(form);

            const maintenance = {
                id: 'maint-' + Date.now(),
                establecimiento_id: currentEstablishment.id,
                tipo_equipo: formData.get('tipo_equipo'),
                identificador: formData.get('identificador'),
                ubicacion: formData.get('ubicacion'),
                marca_modelo: formData.get('marca_modelo'),
                tipo_mantenimiento: formData.get('tipo_mantenimiento'),
                frecuencia: formData.get('frecuencia'),
                ultima_fecha: formData.get('ultima_fecha'),
                proxima_fecha: formData.get('proxima_fecha'),
                tecnico: formData.get('tecnico'),
                empresa: formData.get('empresa'),
                observaciones: formData.get('observaciones'),
                creado: new Date().toISOString()
            };

            if (!appData.maintenances) appData.maintenances = [];
            appData.maintenances.push(maintenance);
            saveData();
            
            form.reset();
            cancelNewMaintenance();
            loadMaintenances();
            alert('‚úÖ Mantenimiento registrado correctamente');
        }

        function loadMaintenances() {
            if (!currentEstablishment) return;
            if (!appData.maintenances) appData.maintenances = [];
            
            let maintenances = appData.maintenances.filter(m => m.establecimiento_id === currentEstablishment.id);
            const container = document.getElementById('maintenancesList');
            
            // Aplicar filtros
            const typeFilter = document.getElementById('maintenanceFilterType')?.value;
            const statusFilter = document.getElementById('maintenanceFilterStatus')?.value;
            
            if (typeFilter) {
                maintenances = maintenances.filter(m => m.tipo_equipo === typeFilter);
            }
            
            const hoy = new Date();
            const en30dias = new Date();
            en30dias.setDate(hoy.getDate() + 30);
            
            if (statusFilter === 'vigente') {
                maintenances = maintenances.filter(m => new Date(m.proxima_fecha) > en30dias);
            } else if (statusFilter === 'proximo') {
                maintenances = maintenances.filter(m => {
                    const fecha = new Date(m.proxima_fecha);
                    return fecha > hoy && fecha <= en30dias;
                });
            } else if (statusFilter === 'vencido') {
                maintenances = maintenances.filter(m => new Date(m.proxima_fecha) < hoy);
            }
            
            if (maintenances.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay mantenimientos registrados</p>';
                return;
            }

            // Ordenar por fecha pr√≥xima
            maintenances.sort((a, b) => new Date(a.proxima_fecha) - new Date(b.proxima_fecha));

            container.innerHTML = maintenances.map(maint => {
                const proximaFecha = new Date(maint.proxima_fecha);
                const diasRestantes = Math.ceil((proximaFecha - hoy) / (1000 * 60 * 60 * 24));
                
                let statusColor, statusText, statusIcon;
                if (diasRestantes < 0) {
                    statusColor = 'border-red-500 bg-red-50';
                    statusText = `Vencido hace ${Math.abs(diasRestantes)} d√≠as`;
                    statusIcon = '<i class="fas fa-times-circle text-red-600"></i>';
                } else if (diasRestantes <= 30) {
                    statusColor = 'border-yellow-500 bg-yellow-50';
                    statusText = `Vence en ${diasRestantes} d√≠as`;
                    statusIcon = '<i class="fas fa-exclamation-triangle text-yellow-600"></i>';
                } else {
                    statusColor = 'border-green-500 bg-green-50';
                    statusText = `Vigente (${diasRestantes} d√≠as)`;
                    statusIcon = '<i class="fas fa-check-circle text-green-600"></i>';
                }
                
                return `
                    <div class="border-l-4 ${statusColor} rounded-lg p-4 hover:shadow-md transition">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="font-bold text-lg">${statusIcon} ${maint.tipo_equipo} - ${maint.identificador}</h4>
                                <p class="text-sm text-gray-600">${maint.ubicacion}${maint.marca_modelo ? ' | ' + maint.marca_modelo : ''}</p>
                                <div class="mt-2 grid grid-cols-2 gap-2 text-sm">
                                    <div><strong>Tipo:</strong> ${maint.tipo_mantenimiento}</div>
                                    <div><strong>Frecuencia:</strong> ${maint.frecuencia}</div>
                                    <div><strong>√öltimo:</strong> ${maint.ultima_fecha}</div>
                                    <div><strong>Pr√≥ximo:</strong> ${maint.proxima_fecha}</div>
                                </div>
                                <div class="mt-2">
                                    <span class="inline-block px-2 py-1 text-xs rounded ${diasRestantes < 0 ? 'bg-red-200 text-red-800' : diasRestantes <= 30 ? 'bg-yellow-200 text-yellow-800' : 'bg-green-200 text-green-800'}">
                                        ${statusText}
                                    </span>
                                </div>
                                ${maint.tecnico || maint.empresa ? `<p class="text-xs text-gray-500 mt-2">${maint.tecnico ? 'T√©cnico: ' + maint.tecnico : ''} ${maint.empresa ? '| ' + maint.empresa : ''}</p>` : ''}
                            </div>
                            <button onclick="deleteMaintenance('${maint.id}')" class="text-red-600 hover:text-red-800">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function deleteMaintenance(id) {
            if (!confirm('¬øEliminar este registro de mantenimiento?')) return;
            appData.maintenances = appData.maintenances.filter(m => m.id !== id);
            saveData();
            loadMaintenances();
        }

        // ============= MEDICAL SURVEILLANCE MODULE =============
        function showNewMedical() {
            document.getElementById('newMedicalForm').classList.remove('hidden');
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('#newMedicalForm input[name="fecha_examen"]').value = today;
        }

        function cancelNewMedical() {
            document.getElementById('newMedicalForm').classList.add('hidden');
            document.getElementById('newMedicalForm').querySelector('form').reset();
        }

        function saveMedical(event) {
            event.preventDefault();
            if (!currentEstablishment) {
                alert('Seleccione un establecimiento primero');
                return;
            }

            const form = event.target;
            const formData = new FormData(form);

            const medical = {
                id: 'med-' + Date.now(),
                establecimiento_id: currentEstablishment.id,
                legajo: formData.get('legajo'),
                nombre_completo: formData.get('nombre_completo'),
                puesto: formData.get('puesto'),
                sector: formData.get('sector'),
                fecha_ingreso: formData.get('fecha_ingreso'),
                tipo_examen: formData.get('tipo_examen'),
                fecha_examen: formData.get('fecha_examen'),
                resultado: formData.get('resultado'),
                proximo_control: formData.get('proximo_control'),
                medico: formData.get('medico'),
                matricula_medico: formData.get('matricula_medico'),
                observaciones: formData.get('observaciones'),
                creado: new Date().toISOString()
            };

            if (!appData.medicals) appData.medicals = [];
            appData.medicals.push(medical);
            saveData();
            
            form.reset();
            cancelNewMedical();
            loadMedicals();
            alert('‚úÖ Examen m√©dico registrado correctamente');
        }

        function loadMedicals() {
            if (!currentEstablishment) return;
            if (!appData.medicals) appData.medicals = [];
            
            const medicals = appData.medicals.filter(m => m.establecimiento_id === currentEstablishment.id);
            const container = document.getElementById('medicalList');
            const summaryContainer = document.getElementById('medicalSummary');
            
            // Calcular resumen
            const hoy = new Date();
            const en30dias = new Date();
            en30dias.setDate(hoy.getDate() + 30);
            
            const totalTrabajadores = new Set(medicals.map(m => m.legajo)).size;
            const proximosVencer = medicals.filter(m => {
                if (!m.proximo_control) return false;
                const fecha = new Date(m.proximo_control);
                return fecha > hoy && fecha <= en30dias;
            }).length;
            const vencidos = medicals.filter(m => {
                if (!m.proximo_control) return false;
                return new Date(m.proximo_control) < hoy;
            }).length;

            summaryContainer.innerHTML = `
                <div class="bg-blue-50 border-l-4 border-blue-600 p-4 rounded">
                    <div class="text-sm text-gray-600">Total Trabajadores</div>
                    <div class="text-2xl font-bold text-blue-600">${totalTrabajadores}</div>
                </div>
                <div class="bg-yellow-50 border-l-4 border-yellow-600 p-4 rounded">
                    <div class="text-sm text-gray-600">Pr√≥ximos a Vencer</div>
                    <div class="text-2xl font-bold text-yellow-600">${proximosVencer}</div>
                </div>
                <div class="bg-red-50 border-l-4 border-red-600 p-4 rounded">
                    <div class="text-sm text-gray-600">Ex√°menes Vencidos</div>
                    <div class="text-2xl font-bold text-red-600">${vencidos}</div>
                </div>
            `;
            
            if (medicals.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay ex√°menes m√©dicos registrados</p>';
                return;
            }

            // Ordenar por fecha de pr√≥ximo control
            medicals.sort((a, b) => {
                if (!a.proximo_control) return 1;
                if (!b.proximo_control) return -1;
                return new Date(a.proximo_control) - new Date(b.proximo_control);
            });

            container.innerHTML = medicals.map(med => {
                let statusColor = 'border-gray-300';
                let statusText = '';
                
                if (med.proximo_control) {
                    const proximaFecha = new Date(med.proximo_control);
                    const diasRestantes = Math.ceil((proximaFecha - hoy) / (1000 * 60 * 60 * 24));
                    
                    if (diasRestantes < 0) {
                        statusColor = 'border-red-500 bg-red-50';
                        statusText = `‚ö†Ô∏è VENCIDO hace ${Math.abs(diasRestantes)} d√≠as`;
                    } else if (diasRestantes <= 30) {
                        statusColor = 'border-yellow-500 bg-yellow-50';
                        statusText = `‚ö†Ô∏è Vence en ${diasRestantes} d√≠as`;
                    } else {
                        statusColor = 'border-green-500';
                        statusText = `‚úÖ Vigente (${diasRestantes} d√≠as)`;
                    }
                }

                const resultadoColor = 
                    med.resultado === 'Apto' ? 'text-green-600' : 
                    med.resultado === 'Apto con observaciones' ? 'text-yellow-600' : 'text-red-600';
                
                return `
                    <div class="border-l-4 ${statusColor} rounded-lg p-4 hover:shadow-md transition">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="font-bold text-lg">${med.nombre_completo}</h4>
                                <p class="text-sm text-gray-600">Legajo: ${med.legajo} | ${med.puesto}${med.sector ? ' - ' + med.sector : ''}</p>
                                <div class="mt-2 text-sm">
                                    <div><strong>Tipo:</strong> ${med.tipo_examen}</div>
                                    <div><strong>Fecha examen:</strong> ${med.fecha_examen}</div>
                                    <div><strong>Resultado:</strong> <span class="${resultadoColor} font-semibold">${med.resultado}</span></div>
                                    ${med.proximo_control ? `<div><strong>Pr√≥ximo control:</strong> ${med.proximo_control}</div>` : ''}
                                </div>
                                ${statusText ? `<div class="mt-2"><span class="inline-block px-2 py-1 text-xs rounded ${statusColor.includes('red') ? 'bg-red-200 text-red-800' : statusColor.includes('yellow') ? 'bg-yellow-200 text-yellow-800' : 'bg-green-200 text-green-800'}">${statusText}</span></div>` : ''}
                                ${med.medico ? `<p class="text-xs text-gray-500 mt-2">M√©dico: ${med.medico}${med.matricula_medico ? ' (Mat: ' + med.matricula_medico + ')' : ''}</p>` : ''}
                            </div>
                            <button onclick="deleteMedical('${med.id}')" class="text-red-600 hover:text-red-800">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function deleteMedical(id) {
            if (!confirm('¬øEliminar este registro de examen m√©dico?')) return;
            appData.medicals = appData.medicals.filter(m => m.id !== id);
            saveData();
            loadMedicals();
        }

        // ============= NIOSH CALCULATOR =============
        function calculateNIOSH() {
            // Obtener valores
            const peso = parseFloat(document.getElementById('niosh_peso').value);
            const H = parseFloat(document.getElementById('niosh_h').value);
            const V = parseFloat(document.getElementById('niosh_v').value);
            const D = parseFloat(document.getElementById('niosh_d').value);
            const A = parseFloat(document.getElementById('niosh_a').value);
            const F = parseFloat(document.getElementById('niosh_f').value);
            const duracion = parseInt(document.getElementById('niosh_duracion').value);
            const agarre = document.getElementById('niosh_agarre').value;

            // Validar entradas
            if (!peso || !H || V === undefined || !D || A === undefined || F === undefined) {
                alert('Por favor complete todos los campos obligatorios');
                return;
            }

            // Constante de carga
            const LC = 23;

            // Factor de distancia horizontal (HM)
            const HM = H > 0 ? Math.min(25 / H, 1) : 0;

            // Factor de altura vertical (VM)
            const VM = 1 - (0.003 * Math.abs(V - 75));

            // Factor de desplazamiento vertical (DM)
            const DM = 0.82 + (4.5 / D);

            // Factor de asimetr√≠a (AM)
            const AM = 1 - (0.0032 * A);

            // Factor de frecuencia (FM)
            let FM;
            if (duracion === 1) { // ‚â§1 hora
                if (V < 75) {
                    if (F <= 0.2) FM = 1.00;
                    else if (F <= 1) FM = 0.97;
                    else if (F <= 2) FM = 0.94;
                    else if (F <= 3) FM = 0.91;
                    else if (F <= 4) FM = 0.88;
                    else if (F <= 5) FM = 0.84;
                    else if (F <= 6) FM = 0.80;
                    else if (F <= 7) FM = 0.75;
                    else if (F <= 8) FM = 0.70;
                    else if (F <= 9) FM = 0.60;
                    else if (F <= 10) FM = 0.52;
                    else if (F <= 11) FM = 0.45;
                    else if (F <= 12) FM = 0.41;
                    else if (F <= 13) FM = 0.37;
                    else if (F <= 14) FM = 0.34;
                    else FM = 0.31;
                } else {
                    if (F <= 0.2) FM = 1.00;
                    else if (F <= 1) FM = 0.94;
                    else if (F <= 2) FM = 0.91;
                    else if (F <= 3) FM = 0.88;
                    else if (F <= 4) FM = 0.84;
                    else if (F <= 5) FM = 0.80;
                    else if (F <= 6) FM = 0.75;
                    else if (F <= 7) FM = 0.70;
                    else if (F <= 8) FM = 0.60;
                    else if (F <= 9) FM = 0.52;
                    else if (F <= 10) FM = 0.45;
                    else if (F <= 11) FM = 0.41;
                    else if (F <= 12) FM = 0.37;
                    else if (F <= 13) FM = 0.34;
                    else if (F <= 14) FM = 0.31;
                    else FM = 0.28;
                }
            } else if (duracion === 2) { // 1-2 horas
                if (V < 75) {
                    if (F <= 0.2) FM = 0.95;
                    else if (F <= 1) FM = 0.92;
                    else if (F <= 2) FM = 0.88;
                    else if (F <= 3) FM = 0.84;
                    else if (F <= 4) FM = 0.79;
                    else if (F <= 5) FM = 0.72;
                    else if (F <= 6) FM = 0.60;
                    else if (F <= 7) FM = 0.50;
                    else if (F <= 8) FM = 0.42;
                    else if (F <= 9) FM = 0.35;
                    else if (F <= 10) FM = 0.30;
                    else if (F <= 11) FM = 0.26;
                    else FM = 0.00;
                } else {
                    if (F <= 0.2) FM = 0.95;
                    else if (F <= 1) FM = 0.88;
                    else if (F <= 2) FM = 0.84;
                    else if (F <= 3) FM = 0.79;
                    else if (F <= 4) FM = 0.72;
                    else if (F <= 5) FM = 0.60;
                    else if (F <= 6) FM = 0.50;
                    else if (F <= 7) FM = 0.42;
                    else if (F <= 8) FM = 0.35;
                    else if (F <= 9) FM = 0.30;
                    else if (F <= 10) FM = 0.26;
                    else if (F <= 11) FM = 0.23;
                    else FM = 0.00;
                }
            } else { // 2-8 horas
                if (V < 75) {
                    if (F <= 0.2) FM = 0.85;
                    else if (F <= 1) FM = 0.81;
                    else if (F <= 2) FM = 0.75;
                    else if (F <= 3) FM = 0.65;
                    else if (F <= 4) FM = 0.55;
                    else if (F <= 5) FM = 0.45;
                    else if (F <= 6) FM = 0.27;
                    else if (F <= 7) FM = 0.22;
                    else if (F <= 8) FM = 0.18;
                    else FM = 0.00;
                } else {
                    if (F <= 0.2) FM = 0.85;
                    else if (F <= 1) FM = 0.75;
                    else if (F <= 2) FM = 0.65;
                    else if (F <= 3) FM = 0.55;
                    else if (F <= 4) FM = 0.45;
                    else if (F <= 5) FM = 0.27;
                    else if (F <= 6) FM = 0.22;
                    else if (F <= 7) FM = 0.18;
                    else FM = 0.00;
                }
            }

            // Factor de agarre (CM)
            let CM;
            if (agarre === 'bueno') {
                CM = V < 75 ? 1.00 : 0.95;
            } else if (agarre === 'regular') {
                CM = V < 75 ? 0.95 : 0.90;
            } else { // malo
                CM = V < 75 ? 0.90 : 0.85;
            }

            // Calcular RWL
            const RWL = LC * HM * VM * DM * AM * FM * CM;

            // Calcular LI
            const LI = peso / RWL;

            // Determinar nivel de riesgo
            let riesgoColor, riesgoTexto, recomendacion;
            if (LI <= 1.0) {
                riesgoColor = 'bg-green-100 border-green-500 text-green-800';
                riesgoTexto = 'RIESGO LIMITADO';
                recomendacion = 'La tarea es aceptable para la mayor√≠a de los trabajadores. No se requieren cambios inmediatos, pero se recomienda monitoreo peri√≥dico.';
            } else if (LI <= 3.0) {
                riesgoColor = 'bg-yellow-100 border-yellow-500 text-yellow-800';
                riesgoTexto = 'RIESGO INCREMENTADO';
                recomendacion = 'Algunos trabajadores pueden estar en riesgo. Se recomienda implementar controles de ingenier√≠a o administrativos para reducir la carga.';
            } else {
                riesgoColor = 'bg-red-100 border-red-500 text-red-800';
                riesgoTexto = 'RIESGO ELEVADO';
                recomendacion = 'La mayor√≠a de los trabajadores est√° en riesgo. Se requieren cambios ergon√≥micos inmediatos: redise√±o del puesto, ayudas mec√°nicas, o redistribuci√≥n de tareas.';
            }

            // Mostrar resultados
            document.getElementById('nioshResults').innerHTML = `
                <div class="border-l-4 ${riesgoColor} p-4 rounded-lg">
                    <div class="text-center mb-3">
                        <div class="text-sm font-semibold">√çNDICE DE LEVANTAMIENTO (LI)</div>
                        <div class="text-5xl font-bold my-2">${LI.toFixed(2)}</div>
                        <div class="text-lg font-bold">${riesgoTexto}</div>
                    </div>
                    <div class="text-sm mt-3 pt-3 border-t border-gray-300">
                        <p class="font-semibold mb-2">Recomendaci√≥n:</p>
                        <p>${recomendacion}</p>
                    </div>
                </div>

                <div class="bg-white border border-gray-300 rounded-lg p-4 mt-4">
                    <h4 class="font-bold mb-3">Desglose del C√°lculo</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span>Peso Recomendado (RWL):</span>
                            <span class="font-bold">${RWL.toFixed(2)} kg</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Peso Real de la Carga:</span>
                            <span class="font-bold">${peso.toFixed(2)} kg</span>
                        </div>
                        <div class="mt-3 pt-3 border-t border-gray-200">
                            <div class="text-xs text-gray-600 space-y-1">
                                <div>LC (Constante): ${LC} kg</div>
                                <div>HM (Horizontal): ${HM.toFixed(3)}</div>
                                <div>VM (Vertical): ${VM.toFixed(3)}</div>
                                <div>DM (Desplazamiento): ${DM.toFixed(3)}</div>
                                <div>AM (Asimetr√≠a): ${AM.toFixed(3)}</div>
                                <div>FM (Frecuencia): ${FM.toFixed(3)}</div>
                                <div>CM (Agarre): ${CM.toFixed(3)}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mt-4 text-sm">
                    <h4 class="font-bold mb-2">Posibles Mejoras Ergon√≥micas</h4>
                    <ul class="space-y-1 text-xs">
                        ${H > 30 ? '<li>‚Ä¢ Reducir la distancia horizontal acercando la carga al cuerpo</li>' : ''}
                        ${V < 70 || V > 80 ? '<li>‚Ä¢ Ajustar la altura de trabajo entre 70-80 cm del suelo</li>' : ''}
                        ${D > 25 ? '<li>‚Ä¢ Minimizar el desplazamiento vertical de la carga</li>' : ''}
                        ${A > 30 ? '<li>‚Ä¢ Evitar giros del tronco durante el levantamiento</li>' : ''}
                        ${F > 1 ? '<li>‚Ä¢ Reducir la frecuencia de levantamientos o implementar rotaci√≥n de personal</li>' : ''}
                        ${agarre !== 'bueno' ? '<li>‚Ä¢ Mejorar el agarre con asas, contenedores adecuados o guantes antideslizantes</li>' : ''}
                        ${LI > 1 ? '<li>‚Ä¢ Considerar ayudas mec√°nicas: carretillas, elevadores, gr√∫as</li>' : ''}
                    </ul>
                </div>
            `;
        }

        // ============= PDF EXPORT FUNCTIONS =============
        
        // Funci√≥n auxiliar para crear encabezado del PDF
        function addPDFHeader(doc, title) {
            doc.setFillColor(30, 64, 175); // Blue
            doc.rect(0, 0, 210, 30, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('Sistema de Seguridad e Higiene', 15, 15);
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(title, 15, 23);
            doc.setTextColor(0, 0, 0);
        }

        // Funci√≥n auxiliar para agregar footer
        function addPDFFooter(doc, pageNumber) {
            const pageHeight = doc.internal.pageSize.height;
            doc.setFontSize(8);
            doc.setTextColor(128, 128, 128);
            doc.text(`Ley 19.587 | Decreto 351/79 | Res. SRT 905/2015`, 15, pageHeight - 10);
            doc.text(`P√°gina ${pageNumber}`, doc.internal.pageSize.width - 30, pageHeight - 10);
            doc.text(`Generado: ${new Date().toLocaleString('es-AR')}`, 15, pageHeight - 5);
        }

        // 2. ACCIONES PDF
        function exportActionsPDF() {
            if (!currentEstablishment) {
                alert('Seleccione un establecimiento primero');
                return;
            }
            
            const actions = appData.actions.filter(a => a.establecimiento_id === currentEstablishment.id);
            
            if (actions.length === 0) {
                alert('No hay acciones registradas');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            addPDFHeader(doc, 'Informe de Acciones Correctivas');
            
            let yPos = 40;
            
            // Info del establecimiento
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('ESTABLECIMIENTO:', 15, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(currentEstablishment.nombre, 60, yPos);
            yPos += 12;
            
            // Resumen por estado
            const pendientes = actions.filter(a => a.estado === 'pendiente').length;
            const enProgreso = actions.filter(a => a.estado === 'en_progreso').length;
            const cerradas = actions.filter(a => a.estado === 'cerrado').length;
            
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Resumen de Acciones', 15, yPos);
            yPos += 8;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Total: ${actions.length} | Pendientes: ${pendientes} | En Progreso: ${enProgreso} | Cerradas: ${cerradas}`, 15, yPos);
            yPos += 10;
            
            // Tabla de acciones
            const tableData = actions.map(action => {
                const estadoText = action.estado === 'pendiente' ? 'Pendiente' : 
                                  action.estado === 'en_progreso' ? 'En Progreso' : 'Cerrado';
                return [
                    action.titulo.substring(0, 40),
                    action.prioridad,
                    estadoText,
                    action.responsable,
                    action.vencimiento
                ];
            });
            
            doc.autoTable({
                startY: yPos,
                head: [['Acci√≥n', 'Prioridad', 'Estado', 'Responsable', 'Vencimiento']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [234, 88, 12], textColor: 255 },
                styles: { fontSize: 8, cellPadding: 2 },
                columnStyles: {
                    0: { cellWidth: 70 },
                    1: { cellWidth: 25 },
                    2: { cellWidth: 30 },
                    3: { cellWidth: 35 },
                    4: { cellWidth: 25 }
                }
            });
            
            addPDFFooter(doc, 1);
            doc.save(`Acciones_${currentEstablishment.nombre.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        // 3. EXTINTORES PDF
        function exportExtinguishersReport() {
            if (!currentEstablishment) {
                alert('Seleccione un establecimiento primero');
                return;
            }
            
            const extinguishers = appData.extinguishers.filter(e => e.establecimiento_id === currentEstablishment.id);
            
            if (extinguishers.length === 0) {
                alert('No hay extintores registrados');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            addPDFHeader(doc, 'Informe de Extintores');
            
            let yPos = 40;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('ESTABLECIMIENTO:', 15, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(currentEstablishment.nombre, 60, yPos);
            yPos += 12;
            
            // Estad√≠sticas
            const vencidos = extinguishers.filter(ext => {
                const fechaRecarga = new Date(ext.ultima_recarga);
                const proxVenc = new Date(fechaRecarga);
                proxVenc.setFullYear(proxVenc.getFullYear() + 1);
                return proxVenc < new Date();
            }).length;
            
            const porVencer = extinguishers.filter(ext => {
                const fechaRecarga = new Date(ext.ultima_recarga);
                const proxVenc = new Date(fechaRecarga);
                proxVenc.setFullYear(proxVenc.getFullYear() + 1);
                const diasHastaVenc = Math.floor((proxVenc - new Date()) / (1000*60*60*24));
                return diasHastaVenc >= 0 && diasHastaVenc <= 30;
            }).length;
            
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Resumen', 15, yPos);
            yPos += 8;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Total de extintores: ${extinguishers.length}`, 15, yPos);
            yPos += 6;
            doc.setTextColor(255, 0, 0);
            doc.text(`ALERTA - Vencidos: ${vencidos}`, 15, yPos);
            yPos += 6;
            doc.setTextColor(255, 165, 0);
            doc.text(`ADVERTENCIA - Por vencer (proximos 30 dias): ${porVencer}`, 15, yPos);
            doc.setTextColor(0, 0, 0);
            yPos += 10;
            
            // Tabla de extintores
            const tableData = extinguishers.map(ext => {
                const fechaRecarga = new Date(ext.ultima_recarga);
                const proxVenc = new Date(fechaRecarga);
                proxVenc.setFullYear(proxVenc.getFullYear() + 1);
                const estado = proxVenc < new Date() ? 'VENCIDO' : 
                              (Math.floor((proxVenc - new Date()) / (1000*60*60*24)) <= 30) ? 'Por Vencer' : 'OK';
                
                return [
                    ext.codigo,
                    ext.tipo,
                    `${ext.capacidad} kg`,
                    ext.ubicacion,
                    ext.ultima_recarga,
                    proxVenc.toISOString().split('T')[0],
                    estado
                ];
            });
            
            doc.autoTable({
                startY: yPos,
                head: [['C√≥digo', 'Tipo', 'Capacidad', 'Ubicaci√≥n', '√ölt. Recarga', 'Vencimiento', 'Estado']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [220, 38, 38], textColor: 255 },
                styles: { fontSize: 8, cellPadding: 2 },
                columnStyles: {
                    0: { cellWidth: 20 },
                    1: { cellWidth: 20 },
                    2: { cellWidth: 20 },
                    3: { cellWidth: 40 },
                    4: { cellWidth: 25 },
                    5: { cellWidth: 25 },
                    6: { cellWidth: 25 }
                },
                didParseCell: function(data) {
                    if (data.section === 'body' && data.column.index === 6) {
                        if (data.cell.text[0] === 'VENCIDO') {
                            data.cell.styles.textColor = [255, 0, 0];
                            data.cell.styles.fontStyle = 'bold';
                        } else if (data.cell.text[0] === 'Por Vencer') {
                            data.cell.styles.textColor = [255, 165, 0];
                            data.cell.styles.fontStyle = 'bold';
                        }
                    }
                }
            });
            
            addPDFFooter(doc, 1);
            doc.save(`Extintores_${currentEstablishment.nombre.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        // 4. MATRIZ DE RIESGOS PDF
        function exportRiskMatrixReport() {
            if (!currentEstablishment) {
                alert('Seleccione un establecimiento primero');
                return;
            }
            
            const risks = appData.risks.filter(r => r.establecimiento_id === currentEstablishment.id);
            
            if (risks.length === 0) {
                alert('No hay riesgos registrados');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            addPDFHeader(doc, 'Matriz de Riesgos Laborales');
            
            let yPos = 40;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('ESTABLECIMIENTO:', 15, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(currentEstablishment.nombre, 60, yPos);
            yPos += 12;
            
            // Resumen por nivel
            const criticos = risks.filter(r => r.nivel === 'Cr√≠tico').length;
            const altos = risks.filter(r => r.nivel === 'Alto').length;
            const moderados = risks.filter(r => r.nivel === 'Moderado').length;
            const bajos = risks.filter(r => r.nivel === 'Bajo').length;
            
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Resumen de Riesgos', 15, yPos);
            yPos += 8;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Total: ${risks.length} | Cr√≠ticos: ${criticos} | Altos: ${altos} | Moderados: ${moderados} | Bajos: ${bajos}`, 15, yPos);
            yPos += 10;
            
            // Ordenar por score
            risks.sort((a, b) => b.score - a.score);
            
            // Tabla de riesgos
            const tableData = risks.map(risk => [
                risk.score.toString(),
                risk.nivel,
                risk.descripcion.substring(0, 50),
                risk.sector || 'General',
                `P:${risk.probabilidad}`,
                `S:${risk.severidad}`,
                (risk.controles || 'No especificado').substring(0, 40)
            ]);
            
            doc.autoTable({
                startY: yPos,
                head: [['Score', 'Nivel', 'Descripci√≥n', 'Sector', 'Prob.', 'Sev.', 'Controles']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [234, 179, 8], textColor: 0 },
                styles: { fontSize: 7, cellPadding: 2 },
                columnStyles: {
                    0: { cellWidth: 15, halign: 'center', fontStyle: 'bold' },
                    1: { cellWidth: 20 },
                    2: { cellWidth: 50 },
                    3: { cellWidth: 25 },
                    4: { cellWidth: 15, halign: 'center' },
                    5: { cellWidth: 15, halign: 'center' },
                    6: { cellWidth: 40 }
                },
                didParseCell: function(data) {
                    if (data.section === 'body' && data.column.index === 1) {
                        if (data.cell.text[0] === 'Cr√≠tico') {
                            data.cell.styles.fillColor = [254, 226, 226];
                            data.cell.styles.textColor = [127, 29, 29];
                        } else if (data.cell.text[0] === 'Alto') {
                            data.cell.styles.fillColor = [255, 237, 213];
                            data.cell.styles.textColor = [154, 52, 18];
                        } else if (data.cell.text[0] === 'Moderado') {
                            data.cell.styles.fillColor = [254, 249, 195];
                            data.cell.styles.textColor = [113, 63, 18];
                        } else {
                            data.cell.styles.fillColor = [220, 252, 231];
                            data.cell.styles.textColor = [20, 83, 45];
                        }
                    }
                }
            });
            
            addPDFFooter(doc, 1);
            doc.save(`Matriz_Riesgos_${currentEstablishment.nombre.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        // 5. INCIDENTES PDF
        function exportIncidentsReport() {
            if (!currentEstablishment) {
                alert('Seleccione un establecimiento primero');
                return;
            }
            
            const incidents = appData.incidents.filter(i => i.establecimiento_id === currentEstablishment.id);
            
            if (incidents.length === 0) {
                alert('No hay incidentes registrados');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            addPDFHeader(doc, 'Registro de Incidentes y Accidentes');
            
            let yPos = 40;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('ESTABLECIMIENTO:', 15, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(currentEstablishment.nombre, 60, yPos);
            yPos += 12;
            
            // Estad√≠sticas
            const accidentes = incidents.filter(i => i.tipo === 'Accidente').length;
            const incidentesSinLesion = incidents.filter(i => i.tipo === 'Incidente').length;
            const cuasiAccidentes = incidents.filter(i => i.tipo === 'Cuasi-accidente').length;
            
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Resumen de Incidentes', 15, yPos);
            yPos += 8;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Total: ${incidents.length}`, 15, yPos);
            yPos += 6;
            doc.text(`Accidentes: ${accidentes} | Incidentes: ${incidentesSinLesion} | Cuasi-accidentes: ${cuasiAccidentes}`, 15, yPos);
            yPos += 10;
            
            // Tabla de incidentes
            const tableData = incidents.map(inc => [
                inc.fecha,
                inc.tipo,
                inc.gravedad,
                inc.lugar.substring(0, 30),
                inc.involucrado || 'N/A',
                inc.descripcion.substring(0, 40)
            ]);
            
            doc.autoTable({
                startY: yPos,
                head: [['Fecha', 'Tipo', 'Gravedad', 'Lugar', 'Involucrado', 'Descripci√≥n']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [239, 68, 68], textColor: 255 },
                styles: { fontSize: 7, cellPadding: 2 },
                columnStyles: {
                    0: { cellWidth: 22 },
                    1: { cellWidth: 28 },
                    2: { cellWidth: 22 },
                    3: { cellWidth: 35 },
                    4: { cellWidth: 28 },
                    5: { cellWidth: 45 }
                },
                didParseCell: function(data) {
                    if (data.section === 'body' && data.column.index === 2) {
                        if (data.cell.text[0] === 'Fatal' || data.cell.text[0] === 'Grave') {
                            data.cell.styles.textColor = [255, 0, 0];
                            data.cell.styles.fontStyle = 'bold';
                        }
                    }
                }
            });
            
            addPDFFooter(doc, 1);
            doc.save(`Incidentes_${currentEstablishment.nombre.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        // 6. EPP PDF
        function exportPPEReport() {
            if (!currentEstablishment) {
                alert('Seleccione un establecimiento primero');
                return;
            }
            
            const ppeRecords = appData.ppe.filter(p => p.establecimiento_id === currentEstablishment.id);
            
            if (ppeRecords.length === 0) {
                alert('No hay entregas de EPP registradas');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape'); // Cambiar a landscape para m√°s columnas
            
            addPDFHeader(doc, 'Registro de Entrega de EPP');
            
            let yPos = 40;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('ESTABLECIMIENTO:', 15, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(currentEstablishment.nombre, 60, yPos);
            yPos += 12;
            
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Entregas de Elementos de Protecci√≥n Personal', 15, yPos);
            yPos += 8;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            const enUso = ppeRecords.filter(p => !p.fecha_devolucion).length;
            const devueltos = ppeRecords.filter(p => p.fecha_devolucion).length;
            doc.text(`Total de entregas: ${ppeRecords.length} | En uso: ${enUso} | Devueltos: ${devueltos}`, 15, yPos);
            yPos += 10;
            
            // Tabla de EPP con informaci√≥n de devoluci√≥n
            const tableData = ppeRecords.map(ppe => [
                ppe.fecha_entrega,
                ppe.empleado.substring(0, 25),
                ppe.articulo.substring(0, 20),
                ppe.talla || 'N/A',
                ppe.cantidad.toString(),
                ppe.fecha_devolucion || 'En uso',
                ppe.estado_devolucion || '-',
                ppe.observaciones_devolucion ? ppe.observaciones_devolucion.substring(0, 30) : '-'
            ]);
            
            doc.autoTable({
                startY: yPos,
                head: [['F. Entrega', 'Empleado', 'Art√≠culo', 'Talla', 'Cant.', 'F. Devoluci√≥n', 'Estado', 'Obs. Devoluci√≥n']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [34, 197, 94], textColor: 255 },
                styles: { fontSize: 7, cellPadding: 2 },
                columnStyles: {
                    0: { cellWidth: 22 },
                    1: { cellWidth: 40 },
                    2: { cellWidth: 30 },
                    3: { cellWidth: 15 },
                    4: { cellWidth: 15, halign: 'center' },
                    5: { cellWidth: 22 },
                    6: { cellWidth: 25 },
                    7: { cellWidth: 45 }
                }
            });
            
            addPDFFooter(doc, 1);
            doc.save(`EPP_${currentEstablishment.nombre.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        // 7. DASHBOARD PDF - Nueva versi√≥n mejorada
        function exportDashboardPDFReport() {
            if (!currentEstablishment) {
                alert('Seleccione un establecimiento primero');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const inspections = appData.inspections.filter(i => i.establecimiento_id === currentEstablishment.id);
            const actions = appData.actions.filter(a => a.establecimiento_id === currentEstablishment.id);
            const risks = appData.risks.filter(r => r.establecimiento_id === currentEstablishment.id);
            const trainings = appData.trainings.filter(t => t.establecimiento_id === currentEstablishment.id);
            const incidents = appData.incidents.filter(i => i.establecimiento_id === currentEstablishment.id);
            const extinguishers = appData.extinguishers.filter(e => e.establecimiento_id === currentEstablishment.id);
            
            const pendingActions = actions.filter(a => a.estado === 'pendiente');
            const criticalRisks = risks.filter(r => r.nivel === 'Cr√≠tico');
            const accionesCerradas = actions.filter(a => a.estado === 'cerrado');
            
            // Calcular KPIs
            const hoy = new Date();
            const haceUnMes = new Date();
            haceUnMes.setMonth(haceUnMes.getMonth() - 1);
            
            const inspectionsLastMonth = inspections.filter(i => new Date(i.fecha) >= haceUnMes).length;
            
            let totalCapacitados = 0;
            trainings.forEach(t => totalCapacitados += (t.participantes?.length || 0));
            
            const extintoresVigentes = extinguishers.filter(e => {
                if (!e.proxima_recarga) return false;
                const fechaRecarga = new Date(e.proxima_recarga);
                return fechaRecarga >= hoy;
            }).length;
            
            const accionesCerradasMes = actions.filter(a => {
                if (!a.fecha_cierre || a.estado !== 'cerrado') return false;
                return new Date(a.fecha_cierre) >= haceUnMes;
            }).length;
            
            let totalHallazgos = 0;
            let hallazgosOK = 0;
            inspections.forEach(insp => {
                if (insp.resumen) {
                    totalHallazgos += insp.resumen.total || 0;
                    hallazgosOK += insp.resumen.ok || 0;
                }
            });
            const porcentajeCumplimiento = totalHallazgos > 0 ? 
                Math.round((hallazgosOK / totalHallazgos) * 100) : 0;
            
            const incidentesLastMonth = incidents.filter(i => new Date(i.fecha) >= haceUnMes).length;
            const accidentes = incidents.filter(i => i.tipo === 'Accidente').length;
            
            let tiempoMedioCierre = 0;
            if (accionesCerradas.length > 0) {
                const tiempos = accionesCerradas.map(a => {
                    const creacion = new Date(a.fecha_creacion);
                    const cierre = new Date(a.fecha_cierre);
                    return Math.floor((cierre - creacion) / (1000*60*60*24));
                });
                tiempoMedioCierre = Math.round(tiempos.reduce((a, b) => a + b, 0) / tiempos.length);
            }
            
            addPDFHeader(doc, 'Dashboard Ejecutivo de Seguridad e Higiene');
            
            let yPos = 40;
            
            // Informaci√≥n del establecimiento
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('ESTABLECIMIENTO:', 15, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(currentEstablishment.nombre, 60, yPos);
            yPos += 6;
            doc.setFont(undefined, 'bold');
            doc.text('CUIT:', 15, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(currentEstablishment.cuit, 60, yPos);
            yPos += 6;
            doc.setFont(undefined, 'bold');
            doc.text('Fecha de Reporte:', 15, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(new Date().toLocaleDateString('es-AR'), 60, yPos);
            yPos += 12;
            
            // === INDICADORES PROACTIVOS ===
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.setFillColor(34, 197, 94); // Verde
            doc.rect(15, yPos-4, 180, 7, 'F');
            doc.setTextColor(255, 255, 255);
            doc.text('INDICADORES PROACTIVOS (Prevenci√≥n)', 105, yPos, { align: 'center' });
            doc.setTextColor(0, 0, 0);
            yPos += 10;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            
            const kpiProactivosData = [
                ['Inspecciones Realizadas', inspections.length.toString(), `${inspectionsLastMonth} √∫ltimo mes`],
                ['Capacitaciones Realizadas', trainings.length.toString(), `${totalCapacitados} personas`],
                ['Extintores Vigentes', extintoresVigentes.toString(), `de ${extinguishers.length} total`],
                ['Acciones Cerradas', accionesCerradas.length.toString(), `${accionesCerradasMes} √∫ltimo mes`],
                ['% Cumplimiento Inspecciones', porcentajeCumplimiento + '%', `${hallazgosOK} de ${totalHallazgos}`]
            ];
            
            doc.autoTable({
                startY: yPos,
                body: kpiProactivosData,
                theme: 'grid',
                styles: { fontSize: 9, cellPadding: 3 },
                columnStyles: {
                    0: { cellWidth: 80, fontStyle: 'bold' },
                    1: { cellWidth: 40, halign: 'center', fillColor: [220, 252, 231], fontStyle: 'bold', fontSize: 11 },
                    2: { cellWidth: 60, fontSize: 8, textColor: [100, 100, 100] }
                }
            });
            
            yPos = doc.lastAutoTable.finalY + 12;
            
            // === INDICADORES REACTIVOS ===
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.setFillColor(239, 68, 68); // Rojo
            doc.rect(15, yPos-4, 180, 7, 'F');
            doc.setTextColor(255, 255, 255);
            doc.text('INDICADORES REACTIVOS (Incidentes y Correctivos)', 105, yPos, { align: 'center' });
            doc.setTextColor(0, 0, 0);
            yPos += 10;
            
            const kpiReactivosData = [
                ['Incidentes Totales', incidents.length.toString(), `${incidentesLastMonth} √∫ltimo mes`],
                ['Accidentes con Lesi√≥n', accidentes.toString(), accidentes > 0 ? 'Requieren acci√≥n' : 'Sin accidentes'],
                ['Acciones Pendientes', pendingActions.length.toString(), pendingActions.filter(a => a.prioridad === 'Alta').length + ' cr√≠ticas'],
                ['Riesgos Cr√≠ticos', criticalRisks.length.toString(), criticalRisks.length > 0 ? 'Atenci√≥n urgente' : 'Controlados'],
                ['Tiempo Medio Cierre', tiempoMedioCierre.toString() + ' d√≠as', 'acciones correctivas']
            ];
            
            doc.autoTable({
                startY: yPos,
                body: kpiReactivosData,
                theme: 'grid',
                styles: { fontSize: 9, cellPadding: 3 },
                columnStyles: {
                    0: { cellWidth: 80, fontStyle: 'bold' },
                    1: { cellWidth: 40, halign: 'center', fillColor: [254, 226, 226], fontStyle: 'bold', fontSize: 11 },
                    2: { cellWidth: 60, fontSize: 8, textColor: [100, 100, 100] }
                }
            });
            
            yPos = doc.lastAutoTable.finalY + 12;
            
            // Nueva p√°gina si es necesario
            if (yPos > 220) {
                doc.addPage();
                addPDFHeader(doc, 'Dashboard Ejecutivo de Seguridad e Higiene');
                yPos = 40;
            }
            
            // === RESUMEN ESTAD√çSTICO ===
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.setFillColor(59, 130, 246); // Azul
            doc.rect(15, yPos-4, 180, 7, 'F');
            doc.setTextColor(255, 255, 255);
            doc.text('RESUMEN ESTAD√çSTICO', 105, yPos, { align: 'center' });
            doc.setTextColor(0, 0, 0);
            yPos += 10;
            
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            
            // Acciones por estado
            const actionsByStatus = {
                pendiente: actions.filter(a => a.estado === 'pendiente').length,
                en_progreso: actions.filter(a => a.estado === 'en_progreso').length,
                cerrado: accionesCerradas.length
            };
            
            doc.text(`Acciones: ${actions.length} total | ${actionsByStatus.pendiente} Pendientes | ${actionsByStatus.en_progreso} En Progreso | ${actionsByStatus.cerrado} Cerradas`, 15, yPos);
            yPos += 5;
            
            // Incidentes por tipo
            const accidentesCount = incidents.filter(i => i.tipo === 'Accidente').length;
            const incidentesCount = incidents.filter(i => i.tipo === 'Incidente').length;
            const cuasiAccidentesCount = incidents.filter(i => i.tipo === 'Cuasi-accidente').length;
            
            doc.text(`Incidentes: ${incidents.length} total | ${accidentesCount} Accidentes | ${incidentesCount} Incidentes | ${cuasiAccidentesCount} Cuasi-accidentes`, 15, yPos);
            yPos += 5;
            
            // Riesgos por nivel
            const risksByLevel = {
                bajo: risks.filter(r => r.nivel === 'Bajo').length,
                medio: risks.filter(r => r.nivel === 'Medio').length,
                alto: risks.filter(r => r.nivel === 'Alto').length,
                critico: risks.filter(r => r.nivel === 'Cr√≠tico').length
            };
            
            doc.text(`Riesgos: ${risks.length} total | ${risksByLevel.bajo} Bajos | ${risksByLevel.medio} Medios | ${risksByLevel.alto} Altos | ${risksByLevel.critico} Cr√≠ticos`, 15, yPos);
            yPos += 5;
            
            // Capacitaciones
            let horasTotales = 0;
            trainings.forEach(t => horasTotales += (t.duracion || 2));
            doc.text(`Capacitaciones: ${trainings.length} realizadas | ${horasTotales} horas | ${totalCapacitados} personas capacitadas`, 15, yPos);
            yPos += 12;
            
            // === ACCIONES PENDIENTES DE ALTA PRIORIDAD ===
            const highPriorityActions = pendingActions.filter(a => a.prioridad === 'Alta');
            
            if (highPriorityActions.length > 0) {
                if (yPos > 220) {
                    doc.addPage();
                    addPDFHeader(doc, 'Dashboard Ejecutivo de Seguridad e Higiene');
                    yPos = 40;
                }
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('ACCIONES PENDIENTES DE ALTA PRIORIDAD', 15, yPos);
                yPos += 8;
                
                const actionData = highPriorityActions.slice(0, 15).map(action => [
                    action.titulo.substring(0, 60),
                    action.responsable.substring(0, 25),
                    action.vencimiento
                ]);
                
                doc.autoTable({
                    startY: yPos,
                    head: [['Acci√≥n', 'Responsable', 'Vencimiento']],
                    body: actionData,
                    theme: 'grid',
                    headStyles: { fillColor: [239, 68, 68], textColor: 255 },
                    styles: { fontSize: 8, cellPadding: 2 },
                    columnStyles: {
                        0: { cellWidth: 100 },
                        1: { cellWidth: 50 },
                        2: { cellWidth: 30 }
                    }
                });
                
                yPos = doc.lastAutoTable.finalY + 12;
            }
            
            // === RIESGOS CR√çTICOS ===
            if (criticalRisks.length > 0) {
                if (yPos > 220) {
                    doc.addPage();
                    addPDFHeader(doc, 'Dashboard Ejecutivo de Seguridad e Higiene');
                    yPos = 40;
                }
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('RIESGOS CR√çTICOS', 15, yPos);
                yPos += 8;
                
                const riskData = criticalRisks.slice(0, 15).map(risk => [
                    risk.descripcion.substring(0, 80),
                    risk.sector || 'General',
                    risk.score.toString()
                ]);
                
                doc.autoTable({
                    startY: yPos,
                    head: [['Descripci√≥n', 'Sector', 'Score']],
                    body: riskData,
                    theme: 'grid',
                    headStyles: { fillColor: [239, 68, 68], textColor: 255 },
                    styles: { fontSize: 8, cellPadding: 2 },
                    columnStyles: {
                        0: { cellWidth: 120 },
                        1: { cellWidth: 40 },
                        2: { cellWidth: 20, halign: 'center', fontStyle: 'bold' }
                    }
                });
                
                yPos = doc.lastAutoTable.finalY + 12;
            }
            
            // === RECOMENDACIONES ===
            if (yPos > 220) {
                doc.addPage();
                addPDFHeader(doc, 'Dashboard Ejecutivo de Seguridad e Higiene');
                yPos = 40;
            }
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('AN√ÅLISIS Y RECOMENDACIONES', 15, yPos);
            yPos += 8;
            
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            
            const recommendations = [];
            
            if (criticalRisks.length > 0) {
                recommendations.push(`‚Ä¢ CR√çTICO: Hay ${criticalRisks.length} riesgo(s) cr√≠tico(s) que requieren atenci√≥n inmediata.`);
            }
            
            if (pendingActions.length > 10) {
                recommendations.push(`‚Ä¢ ALERTA: M√°s de 10 acciones pendientes (${pendingActions.length}). Priorizar cierre.`);
            }
            
            const accidentesGraves = incidents.filter(i => i.gravedad === 'Grave' || i.gravedad === 'Fatal').length;
            if (accidentesGraves > 0) {
                recommendations.push(`‚Ä¢ IMPORTANTE: Hay ${accidentesGraves} incidente(s) grave(s). Verificar acciones correctivas.`);
            }
            
            if (trainings.length === 0) {
                recommendations.push(`‚Ä¢ RECOMENDACI√ìN: No hay capacitaciones registradas. Implementar programa seg√∫n Res. SRT 905/2015.`);
            }
            
            if (porcentajeCumplimiento < 70) {
                recommendations.push(`‚Ä¢ ATENCI√ìN: Cumplimiento del ${porcentajeCumplimiento}% en inspecciones. Implementar mejoras.`);
            } else if (porcentajeCumplimiento >= 90) {
                recommendations.push(`‚Ä¢ EXCELENTE: Cumplimiento del ${porcentajeCumplimiento}% en inspecciones.`);
            }
            
            if (recommendations.length === 0) {
                recommendations.push(`‚Ä¢ Los indicadores se encuentran en niveles aceptables. Continuar con el monitoreo preventivo.`);
            }
            
            recommendations.forEach(rec => {
                const lines = doc.splitTextToSize(rec, 175);
                lines.forEach(line => {
                    if (yPos > 270) {
                        doc.addPage();
                        addPDFHeader(doc, 'Dashboard Ejecutivo de Seguridad e Higiene');
                        yPos = 40;
                    }
                    doc.text(line, 15, yPos);
                    yPos += 5;
                });
            });
            
            yPos += 10;
            
            // === GR√ÅFICOS ===
            // Ocultar selectores de tipo de gr√°fico antes de capturar
            const chartSelectors = document.querySelectorAll('.chart-type-selector');
            chartSelectors.forEach(selector => selector.style.display = 'none');
            
            // Capturar y agregar los gr√°ficos al PDF usando el canvas nativo de Chart.js
            const chartIds = ['actionsChart', 'incidentsChart', 'risksChart', 'trainingsChart'];
            const chartTitles = ['Acciones por Estado', 'Incidentes por Tipo', 'Riesgos por Nivel', 'Capacitaciones'];
            
            for (let i = 0; i < chartIds.length; i++) {
                const chartElement = document.getElementById(chartIds[i]);
                
                if (chartElement && chartElement.offsetParent !== null) {
                    try {
                        // Nueva p√°gina si es necesario
                        if (yPos > 200) {
                            doc.addPage();
                            addPDFHeader(doc, 'Dashboard Ejecutivo de Seguridad e Higiene');
                            yPos = 40;
                        }
                        
                        // T√≠tulo del gr√°fico
                        doc.setFontSize(11);
                        doc.setFont(undefined, 'bold');
                        doc.text(chartTitles[i], 15, yPos);
                        yPos += 8;
                        
                        // Crear un nuevo canvas con fondo blanco para evitar el fondo negro
                        const originalCanvas = chartElement;
                        const tempCanvas = document.createElement('canvas');
                        tempCanvas.width = originalCanvas.width;
                        tempCanvas.height = originalCanvas.height;
                        const tempCtx = tempCanvas.getContext('2d');
                        
                        // Rellenar con fondo blanco
                        tempCtx.fillStyle = '#ffffff';
                        tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                        
                        // Dibujar el gr√°fico original encima
                        tempCtx.drawImage(originalCanvas, 0, 0);
                        
                        // Convertir a imagen con alta calidad
                        const imgData = tempCanvas.toDataURL('image/jpeg', 0.96);
                        
                        // Calcular dimensiones manteniendo la proporci√≥n original
                        const maxWidth = 170; // Ancho m√°ximo en mm
                        const aspectRatio = tempCanvas.height / tempCanvas.width;
                        const imgWidth = maxWidth;
                        const imgHeight = maxWidth * aspectRatio;
                        
                        // Verificar si hay espacio suficiente
                        if (yPos + imgHeight > 270) {
                            doc.addPage();
                            addPDFHeader(doc, 'Dashboard Ejecutivo de Seguridad e Higiene');
                            yPos = 40;
                            doc.setFontSize(11);
                            doc.setFont(undefined, 'bold');
                            doc.text(chartTitles[i], 15, yPos);
                            yPos += 8;
                        }
                        
                        doc.addImage(imgData, 'JPEG', 15, yPos, imgWidth, imgHeight);
                        yPos += imgHeight + 10;
                    } catch (error) {
                        console.error(`Error capturando gr√°fico ${chartIds[i]}:`, error);
                        // Continuar con el siguiente gr√°fico si hay un error
                    }
                }
            }
            
            // Volver a mostrar los selectores despu√©s de capturar
            chartSelectors.forEach(selector => selector.style.display = '');
            
            // Marco Normativo
            if (yPos > 250) {
                doc.addPage();
                addPDFHeader(doc, 'Dashboard Ejecutivo de Seguridad e Higiene');
                yPos = 40;
            }
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('MARCO NORMATIVO', 15, yPos);
            yPos += 6;
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            doc.text('‚Ä¢ Ley 19.587: Higiene y Seguridad en el Trabajo', 15, yPos);
            yPos += 5;
            doc.text('‚Ä¢ Decreto 351/79: Reglamentaci√≥n Ley 19.587', 15, yPos);
            yPos += 5;
            doc.text('‚Ä¢ Resoluci√≥n SRT 905/2015: Relevamiento General de Riesgos Laborales', 15, yPos);
            
            // A√±adir footer a todas las p√°ginas
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                addPDFFooter(doc, i);
            }
            
            doc.save(`Dashboard_Ejecutivo_${currentEstablishment.nombre.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
        }
        
        // Mantener compatibilidad con c√≥digo antiguo
        function exportDashboardReport() {
            exportDashboardPDFReport();
        }

        // 8. JSA/PERMISOS PDF
        function exportJSAReport() {
            if (!currentEstablishment) {
                alert('Seleccione un establecimiento primero');
                return;
            }
            
            const jsas = appData.jsas.filter(j => j.establecimiento_id === currentEstablishment.id);
            
            if (jsas.length === 0) {
                alert('No hay JSA/Permisos registrados');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            addPDFHeader(doc, 'Registro de JSA / Permisos de Trabajo');
            
            let yPos = 40;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('ESTABLECIMIENTO:', 15, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(currentEstablishment.nombre, 60, yPos);
            yPos += 12;
            
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Job Safety Analysis / Permisos', 15, yPos);
            yPos += 8;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Total de JSA registrados: ${jsas.length}`, 15, yPos);
            yPos += 10;
            
            // Tabla de JSAs
            const tableData = jsas.map(jsa => [
                jsa.fecha,
                jsa.tarea.substring(0, 40),
                jsa.ubicacion.substring(0, 25),
                jsa.tipo_permiso,
                jsa.supervisor
            ]);
            
            doc.autoTable({
                startY: yPos,
                head: [['Fecha', 'Tarea', 'Ubicaci√≥n', 'Tipo Permiso', 'Supervisor']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [59, 130, 246], textColor: 255 },
                styles: { fontSize: 8, cellPadding: 2 },
                columnStyles: {
                    0: { cellWidth: 22 },
                    1: { cellWidth: 55 },
                    2: { cellWidth: 35 },
                    3: { cellWidth: 35 },
                    4: { cellWidth: 33 }
                }
            });
            
            addPDFFooter(doc, 1);
            doc.save(`JSA_Permisos_${currentEstablishment.nombre.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        // 9. CAPACITACIONES PDF
        function exportTrainingsReport() {
            if (!currentEstablishment) {
                alert('Seleccione un establecimiento primero');
                return;
            }
            
            const trainings = appData.trainings.filter(t => t.establecimiento_id === currentEstablishment.id);
            
            if (trainings.length === 0) {
                alert('No hay capacitaciones registradas');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            addPDFHeader(doc, 'Registro de Capacitaciones');
            
            let yPos = 40;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('ESTABLECIMIENTO:', 15, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(currentEstablishment.nombre, 60, yPos);
            yPos += 12;
            
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Capacitaciones de Seguridad e Higiene', 15, yPos);
            yPos += 8;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Total de capacitaciones: ${trainings.length}`, 15, yPos);
            const totalParticipantes = trainings.reduce((sum, t) => sum + t.participantes.length, 0);
            yPos += 6;
            doc.text(`Total de participantes: ${totalParticipantes}`, 15, yPos);
            yPos += 10;
            
            // Tabla de capacitaciones
            const tableData = trainings.map(training => [
                training.fecha,
                training.titulo.substring(0, 50),
                training.instructor,
                `${training.duracion} hs`,
                training.participantes.length.toString()
            ]);
            
            doc.autoTable({
                startY: yPos,
                head: [['Fecha', 'T√≠tulo', 'Instructor', 'Duraci√≥n', 'Participantes']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [16, 185, 129], textColor: 255 },
                styles: { fontSize: 8, cellPadding: 2 },
                columnStyles: {
                    0: { cellWidth: 22 },
                    1: { cellWidth: 70 },
                    2: { cellWidth: 40 },
                    3: { cellWidth: 22, halign: 'center' },
                    4: { cellWidth: 26, halign: 'center' }
                }
            });
            
            addPDFFooter(doc, 1);
            doc.save(`Capacitaciones_${currentEstablishment.nombre.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        // ============= PHOTO PREVIEW FUNCTIONS =============
        // Funci√≥n para comprimir im√°genes
        function compressImage(file, maxWidth = 1200, quality = 0.95) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // Calcular nuevas dimensiones manteniendo la proporci√≥n
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convertir a base64 con compresi√≥n
                        const compressedDataURL = canvas.toDataURL('image/jpeg', quality);
                        resolve(compressedDataURL);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function previewChecklistPhoto(input, category, idx) {
            const file = input.files[0];
            if (file) {
                compressImage(file).then(compressedDataURL => {
                    const previewDiv = document.getElementById(`preview-${category}-${idx}`);
                    if (previewDiv) {
                        previewDiv.innerHTML = `
                            <img src="${compressedDataURL}" class="max-w-xs rounded border mt-2" alt="Vista previa">
                            <button type="button" onclick="removeChecklistPhoto('${category}', ${idx})" class="text-xs text-red-600 hover:text-red-800 mt-1">
                                üóëÔ∏è Eliminar foto
                            </button>
                        `;
                    }
                });
            }
        }

        function removeChecklistPhoto(category, idx) {
            const previewDiv = document.getElementById(`preview-${category}-${idx}`);
            const input = document.querySelector(`input[name="photo-${category}-${idx}"]`);
            if (previewDiv) previewDiv.innerHTML = '';
            if (input) input.value = '';
        }

        function previewPPEPhoto(input, formType) {
            const file = input.files[0];
            if (file) {
                compressImage(file).then(compressedDataURL => {
                    let previewId;
                    if (formType === 'new') {
                        previewId = 'ppePhotoPreview';
                    } else if (formType === 'edit') {
                        previewId = 'editPpePhotoPreview';
                    } else if (formType === 'return') {
                        previewId = 'returnPpePhotoPreview';
                    }
                    
                    const previewDiv = document.getElementById(previewId);
                    if (previewDiv) {
                        previewDiv.innerHTML = `
                            <img src="${compressedDataURL}" class="max-w-xs rounded border mt-2" alt="Vista previa">
                            <button type="button" onclick="removePPEPhoto('${formType}')" class="text-xs text-red-600 hover:text-red-800 mt-1">
                                üóëÔ∏è Eliminar foto
                            </button>
                        `;
                    }
                });
            }
        }

        function removePPEPhoto(formType) {
            let previewId, inputId;
            if (formType === 'new') {
                previewId = 'ppePhotoPreview';
                inputId = 'ppePhotoInput';
            } else if (formType === 'edit') {
                previewId = 'editPpePhotoPreview';
                inputId = 'editPpePhotoInput';
            } else if (formType === 'return') {
                previewId = 'returnPpePhotoPreview';
                inputId = 'returnPpePhotoInput';
            }
            
            const previewDiv = document.getElementById(previewId);
            const input = document.getElementById(inputId);
            if (previewDiv) previewDiv.innerHTML = '';
            if (input) input.value = '';
        }

        // ============= DATA MANAGEMENT FUNCTIONS =============
        function exportAllData() {
            if (!confirm('¬øDesea exportar todos los datos incluyendo fotos? Esto puede generar un archivo grande.')) {
                return;
            }

            const exportData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                data: appData
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `higiene-seguridad-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            alert('‚úÖ Datos exportados correctamente. Guarde el archivo en un lugar seguro.');
        }

        function importAllData(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!confirm('‚ö†Ô∏è ATENCI√ìN: Importar datos REEMPLAZAR√Å todos los datos actuales. ¬øDesea continuar?')) {
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validar estructura
                    if (!importedData.version || !importedData.data) {
                        throw new Error('Formato de archivo inv√°lido');
                    }

                    // Restaurar datos
                    appData = importedData.data;
                    saveData();
                    
                    // Recargar interfaz
                    populateEstablishments();
                    if (currentEstablishment) {
                        loadEstablishment();
                    }

                    alert('‚úÖ Datos importados correctamente.\n\nüìä Resumen:\n' +
                          `Establecimientos: ${appData.establishments.length}\n` +
                          `Inspecciones: ${appData.inspections.length}\n` +
                          `Acciones: ${appData.actions.length}\n` +
                          `EPP: ${appData.ppe.length}`);
                    
                    showHome();
                } catch (error) {
                    alert('‚ùå Error al importar datos: ' + error.message);
                    console.error('Error de importaci√≥n:', error);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ============= DOCUMENT MANAGEMENT FUNCTIONS =============
        
        const documentTypes = {
            laboralSeguridad: [
                'Programa de Seguridad e Higiene',
                'Plan Anual de Prevenci√≥n',
                'Registros de Entrega de EPP',
                'Registro de Capacitaciones',
                'Plan de Evacuaci√≥n',
                'Plan de Emergencia',
                'Hojas de Seguridad (MSDS/FDS)',
                'Registro de Accidentes/Incidentes',
                'Carteler√≠a Reglamentaria (Res. SRT 295/03)',
                'Informe CyMAT',
                'Actas de Inspecci√≥n ART',
                'Protocolos de Trabajos Espec√≠ficos',
                'Control de Mantenimiento de Extintores'
            ],
            habilitacion: [
                'Planos Aprobados por Planeamiento Urbano',
                'Certificado de Final de Obra',
                'Certificaci√≥n de Instalaciones El√©ctricas',
                'Certificado de Instalaci√≥n de Gas',
                'Verificaci√≥n de Rutas de Evacuaci√≥n',
                'Plano de Evacuaci√≥n',
                'Memoria T√©cnica de Seguridad',
                'Habilitaci√≥n Municipal'
            ],
            incendios: [
                'Plan de Protecci√≥n Contra Incendios',
                'C√°lculo de Carga de Fuego',
                'Certificado de Inspecci√≥n de Bomberos',
                'Certificado de Mantenimiento de Extintores',
                'Certificado de Luces de Emergencia',
                'Certificado de Detectores y Alarmas'
            ],
            ambiental: [
                'Evaluaci√≥n de Impacto Ambiental (Ley 6571)',
                'Estudio de Impacto Ambiental',
                'Registro de Generadores de Residuos Peligrosos',
                'Control de Segregaci√≥n de Residuos',
                'Registro de Auditor√≠as Ambientales',
                'Certificado de Disposici√≥n Final de Residuos'
            ],
            sanitario: [
                'Certificado de Servicio OSSE',
                'Autorizaci√≥n de Descargas Cloacales',
                'Registro de Limpieza de Tanques',
                'Certificado de Libre Deuda OSSE',
                'An√°lisis de Agua Potable'
            ],
            salud: [
                'Control de Ex√°menes Preocupacionales',
                'Control de Ex√°menes Peri√≥dicos',
                'Registro de Vacunaci√≥n',
                'Certificados M√©dicos/Aptos',
                'Coordinaci√≥n con ART',
                'Registro de Enfermedades Profesionales'
            ],
            complementaria: [
                'Habilitaci√≥n Municipal',
                'CUIT y Alta en AFIP',
                'Certificado de Bomberos',
                'Certificado OSSE',
                'Certificado Medio Ambiente',
                'Certificado Planeamiento',
                'Libro de Actas de Seguridad',
                'Certificados de Calibraci√≥n de Instrumentos'
            ]
        };

        function loadDocuments() {
            if (!currentEstablishment) return;
            
            // Cargar documentos para cada categor√≠a
            const categories = ['laboralSeguridad', 'habilitacion', 'incendios', 'ambiental', 'sanitario', 'salud', 'complementaria'];
            
            categories.forEach(category => {
                const docs = appData.documents.filter(d => 
                    d.establishmentId === currentEstablishment.id && d.categoria === category
                );
                displayDocuments(docs, category);
            });
            
            // Mostrar la primera categor√≠a por defecto
            showDocCategory('laboralSeguridad');
            
            // Actualizar estad√≠sticas
            updateDocumentStats();
        }

        function displayDocuments(documents, category) {
            const container = document.getElementById(`${category}List`);
            if (!container) return;
            
            if (documents.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No hay documentos registrados en esta categor√≠a</p>';
                return;
            }
            
            container.innerHTML = documents.map(doc => {
                const statusColors = {
                    vigente: 'bg-green-50 border-green-200 text-green-800',
                    por_vencer: 'bg-yellow-50 border-yellow-200 text-yellow-800',
                    vencido: 'bg-red-50 border-red-200 text-red-800',
                    faltante: 'bg-gray-50 border-gray-200 text-gray-800',
                    en_tramite: 'bg-blue-50 border-blue-200 text-blue-800'
                };
                
                const statusIcons = {
                    vigente: '<i class="fas fa-check-circle text-green-600"></i>',
                    por_vencer: '<i class="fas fa-exclamation-triangle text-yellow-600"></i>',
                    vencido: '<i class="fas fa-times-circle text-red-600"></i>',
                    faltante: '<i class="fas fa-inbox"></i>',
                    en_tramite: '<i class="fas fa-sync"></i>'
                };
                
                const statusLabels = {
                    vigente: 'Vigente',
                    por_vencer: 'Por vencer',
                    vencido: 'Vencido',
                    faltante: 'Faltante',
                    en_tramite: 'En tr√°mite'
                };
                
                let daysUntilExpiration = '';
                if (doc.fecha_vencimiento) {
                    const days = Math.ceil((new Date(doc.fecha_vencimiento) - new Date()) / (1000 * 60 * 60 * 24));
                    if (days > 0 && days <= 90) {
                        daysUntilExpiration = `<span class="text-xs ${days <= 30 ? 'text-red-600' : 'text-yellow-600'}"> (${days} d√≠as)</span>`;
                    } else if (days < 0) {
                        daysUntilExpiration = `<span class="text-xs text-red-600"> (vencido hace ${Math.abs(days)} d√≠as)</span>`;
                    }
                }
                
                return `
                    <div class="border ${statusColors[doc.estado]} rounded-lg p-4">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex-1">
                                <h4 class="font-bold text-gray-800">${statusIcons[doc.estado]} ${doc.tipo}</h4>
                                <div class="text-sm text-gray-600 mt-1 space-y-1">
                                    <div><strong>Estado:</strong> ${statusLabels[doc.estado]}${daysUntilExpiration}</div>
                                    ${doc.fecha_emision ? `<div><strong>Emisi√≥n:</strong> ${formatDate(doc.fecha_emision)}</div>` : ''}
                                    ${doc.fecha_vencimiento ? `<div><strong>Vencimiento:</strong> ${formatDate(doc.fecha_vencimiento)}</div>` : ''}
                                    ${doc.responsable ? `<div><strong>Responsable:</strong> ${doc.responsable}</div>` : ''}
                                    ${doc.numero_expediente ? `<div><strong>Expediente:</strong> ${doc.numero_expediente}</div>` : ''}
                                    ${doc.organismo ? `<div><strong>Organismo:</strong> ${doc.organismo}</div>` : ''}
                                    ${doc.observaciones ? `<div class="mt-2 text-xs italic">${doc.observaciones}</div>` : ''}
                                    ${doc.archivo ? `<div class="mt-2"><span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">üìé Archivo adjunto</span></div>` : ''}
                                </div>
                            </div>
                            <div class="flex gap-2 ml-4">
                                <button onclick="editDocument('${doc.id}')" class="text-blue-600 hover:text-blue-800 p-1">
                                    ‚úèÔ∏è
                                </button>
                                <button onclick="deleteDocument('${doc.id}')" class="text-red-600 hover:text-red-800 p-1">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showDocCategory(category) {
            // Ocultar todas las categor√≠as
            const allCategories = ['laboralSeguridad', 'habilitacion', 'incendios', 'ambiental', 'sanitario', 'salud', 'complementaria'];
            allCategories.forEach(cat => {
                const content = document.getElementById(`docContent-${cat}`);
                const tab = document.getElementById(`tab-${cat}`);
                if (content) content.classList.add('hidden');
                if (tab) {
                    tab.classList.remove('bg-teal-600', 'text-white');
                    tab.classList.add('text-gray-600', 'hover:bg-gray-100');
                }
            });
            
            // Mostrar la categor√≠a seleccionada
            const selectedContent = document.getElementById(`docContent-${category}`);
            const selectedTab = document.getElementById(`tab-${category}`);
            if (selectedContent) selectedContent.classList.remove('hidden');
            if (selectedTab) {
                selectedTab.classList.add('bg-teal-600', 'text-white');
                selectedTab.classList.remove('text-gray-600', 'hover:bg-gray-100');
            }
        }

        function showAddDocument(category) {
            document.getElementById('documentModalTitle').textContent = 'Agregar Documento';
            document.getElementById('documentForm').reset();
            document.getElementById('documentId').value = '';
            document.getElementById('documentCategory').value = category;
            
            // Cargar tipos de documentos seg√∫n la categor√≠a
            const typeSelect = document.getElementById('documentType');
            typeSelect.innerHTML = '<option value="">Seleccionar...</option>' +
                documentTypes[category].map(type => 
                    `<option value="${type}">${type}</option>`
                ).join('');
            
            document.getElementById('documentModal').classList.remove('hidden');
        }

        function editDocument(id) {
            const doc = appData.documents.find(d => d.id === id);
            if (!doc) return;
            
            document.getElementById('documentModalTitle').textContent = 'Editar Documento';
            document.getElementById('documentId').value = doc.id;
            document.getElementById('documentCategory').value = doc.categoria;
            
            // Cargar tipos de documentos seg√∫n la categor√≠a
            const typeSelect = document.getElementById('documentType');
            typeSelect.innerHTML = '<option value="">Seleccionar...</option>' +
                documentTypes[doc.categoria].map(type => 
                    `<option value="${type}" ${type === doc.tipo ? 'selected' : ''}>${type}</option>`
                ).join('');
            
            // Llenar el formulario con los datos del documento
            const form = document.getElementById('documentForm');
            form.elements.tipo.value = doc.tipo;
            form.elements.estado.value = doc.estado;
            form.elements.fecha_emision.value = doc.fecha_emision || '';
            form.elements.fecha_vencimiento.value = doc.fecha_vencimiento || '';
            form.elements.responsable.value = doc.responsable || '';
            form.elements.numero_expediente.value = doc.numero_expediente || '';
            form.elements.organismo.value = doc.organismo || '';
            form.elements.observaciones.value = doc.observaciones || '';
            
            if (doc.archivo) {
                document.getElementById('documentFilePreview').innerHTML = 
                    '<div class="text-xs text-green-600">‚úÖ Archivo actual: ' + doc.archivoNombre + '</div>';
            }
            
            document.getElementById('documentModal').classList.remove('hidden');
        }

        function saveDocument(event) {
            event.preventDefault();
            
            if (!currentEstablishment) {
                alert('Por favor seleccione un establecimiento primero');
                return;
            }
            
            const formData = new FormData(event.target);
            const id = formData.get('id');
            const categoria = formData.get('category');
            
            const docData = {
                id: id || Date.now().toString(),
                establishmentId: currentEstablishment.id,
                categoria: categoria,
                tipo: formData.get('tipo'),
                estado: formData.get('estado'),
                fecha_emision: formData.get('fecha_emision'),
                fecha_vencimiento: formData.get('fecha_vencimiento'),
                responsable: formData.get('responsable'),
                numero_expediente: formData.get('numero_expediente'),
                organismo: formData.get('organismo'),
                observaciones: formData.get('observaciones'),
                fecha_registro: new Date().toISOString()
            };
            
            // Procesar archivo adjunto
            const fileInput = document.getElementById('documentFileInput');
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                if (file.size > 5 * 1024 * 1024) {
                    alert('El archivo es demasiado grande. M√°ximo 5MB.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    docData.archivo = e.target.result;
                    docData.archivoNombre = file.name;
                    docData.archivoTipo = file.type;
                    finalizeSaveDocument(docData, id);
                };
                reader.readAsDataURL(file);
            } else {
                // Si estamos editando y no se subi√≥ nuevo archivo, mantener el existente
                if (id) {
                    const existingDoc = appData.documents.find(d => d.id === id);
                    if (existingDoc && existingDoc.archivo) {
                        docData.archivo = existingDoc.archivo;
                        docData.archivoNombre = existingDoc.archivoNombre;
                        docData.archivoTipo = existingDoc.archivoTipo;
                    }
                }
                finalizeSaveDocument(docData, id);
            }
        }

        function finalizeSaveDocument(docData, id) {
            if (id) {
                // Actualizar documento existente
                const index = appData.documents.findIndex(d => d.id === id);
                if (index !== -1) {
                    appData.documents[index] = docData;
                }
            } else {
                // Agregar nuevo documento
                appData.documents.push(docData);
            }
            
            saveData();
            loadDocuments();
            closeDocumentModal();
            
            alert('‚úÖ Documento guardado correctamente');
        }

        function deleteDocument(id) {
            if (!confirm('¬øEst√° seguro de que desea eliminar este documento?')) return;
            
            appData.documents = appData.documents.filter(d => d.id !== id);
            saveData();
            loadDocuments();
            
            alert('‚úÖ Documento eliminado');
        }

        function closeDocumentModal() {
            document.getElementById('documentModal').classList.add('hidden');
            document.getElementById('documentForm').reset();
            document.getElementById('documentFilePreview').innerHTML = '';
        }

        function updateDocumentStats() {
            if (!currentEstablishment) return;
            
            const docs = appData.documents.filter(d => d.establishmentId === currentEstablishment.id);
            
            let completeCount = 0;
            let pendingCount = 0;
            let expiredCount = 0;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            docs.forEach(doc => {
                if (doc.estado === 'vigente') {
                    // Verificar si est√° por vencer en los pr√≥ximos 30 d√≠as
                    if (doc.fecha_vencimiento) {
                        const vencimiento = new Date(doc.fecha_vencimiento);
                        const diffDays = Math.ceil((vencimiento - today) / (1000 * 60 * 60 * 24));
                        
                        if (diffDays <= 30 && diffDays > 0) {
                            pendingCount++;
                        } else if (diffDays > 30) {
                            completeCount++;
                        } else if (diffDays <= 0) {
                            expiredCount++;
                        }
                    } else {
                        completeCount++;
                    }
                } else if (doc.estado === 'vencido' || doc.estado === 'faltante') {
                    expiredCount++;
                } else if (doc.estado === 'por_vencer') {
                    pendingCount++;
                }
            });
            
            // Verificar si existen los elementos antes de actualizar
            const docCompleteCount = document.getElementById('docCompleteCount');
            const docPendingCount = document.getElementById('docPendingCount');
            const docExpiredCount = document.getElementById('docExpiredCount');
            
            if (docCompleteCount) docCompleteCount.textContent = completeCount;
            if (docPendingCount) docPendingCount.textContent = pendingCount;
            if (docExpiredCount) docExpiredCount.textContent = expiredCount;
        }

        function exportDocumentsSummary() {
            if (!currentEstablishment) {
                alert('Seleccione un establecimiento primero');
                return;
            }
            
            const establishment = appData.establishments.find(e => e.id === currentEstablishment.id);
            const docs = appData.documents.filter(d => d.establishmentId === currentEstablishment.id);
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Header con membrete azul
            addPDFHeader(doc, 'Resumen de Gesti√≥n Documental');
            
            let y = 40;
            
            // Informaci√≥n del establecimiento
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('ESTABLECIMIENTO:', 15, y);
            doc.setFont(undefined, 'normal');
            doc.text(establishment.nombre, 55, y);
            y += 6;
            doc.setFont(undefined, 'bold');
            doc.text('FECHA:', 15, y);
            doc.setFont(undefined, 'normal');
            doc.text(formatDate(new Date().toISOString().split('T')[0]), 55, y);
            y += 12;
            
            // Estad√≠sticas generales
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.setFillColor(59, 130, 246);
            doc.rect(15, y-4, 180, 7, 'F');
            doc.setTextColor(255, 255, 255);
            doc.text('ESTADISTICAS GENERALES', 105, y, { align: 'center' });
            doc.setTextColor(0, 0, 0);
            y += 10;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            
            const completeCount = parseInt(document.getElementById('docCompleteCount').textContent);
            const pendingCount = parseInt(document.getElementById('docPendingCount').textContent);
            const expiredCount = parseInt(document.getElementById('docExpiredCount').textContent);
            const totalDocs = docs.length;
            
            doc.text(`Total de documentos registrados: ${totalDocs}`, 20, y);
            y += 6;
            doc.text(`Documentos al dia: ${completeCount}`, 20, y);
            y += 6;
            doc.text(`Por vencer (30 dias): ${pendingCount}`, 20, y);
            y += 6;
            doc.text(`Vencidos o faltantes: ${expiredCount}`, 20, y);
            y += 12;
            
            // Listado por categor√≠as
            const categories = {
                laboralSeguridad: 'Laboral y Seguridad e Higiene',
                habilitacion: 'Habilitacion Comercial y Edilicia',
                incendios: 'Prevencion de Incendios',
                ambiental: 'Cuestiones Ambientales',
                sanitario: 'Aspectos Sanitarios y OSSE',
                salud: 'Salud Laboral',
                complementaria: 'Documentacion Complementaria'
            };
            
            let pageNumber = 1;
            
            Object.entries(categories).forEach(([key, label]) => {
                const categoryDocs = docs.filter(d => d.categoria === key);
                
                if (y > 240) {
                    addPDFFooter(doc, pageNumber);
                    doc.addPage();
                    pageNumber++;
                    y = 20;
                }
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setFillColor(240, 240, 240);
                doc.rect(15, y-3, 180, 7, 'F');
                doc.text(label, 20, y);
                y += 10;
                
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                
                if (categoryDocs.length === 0) {
                    doc.text('No hay documentos registrados', 25, y);
                    y += 8;
                } else {
                    categoryDocs.forEach(d => {
                        if (y > 260) {
                            addPDFFooter(doc, pageNumber);
                            doc.addPage();
                            pageNumber++;
                            y = 20;
                        }
                        
                        const statusLabels = {
                            vigente: 'Vigente',
                            por_vencer: 'Por vencer',
                            vencido: 'Vencido',
                            faltante: 'Faltante',
                            en_tramite: 'En tramite'
                        };
                        
                        doc.text(`- ${d.tipo}`, 25, y);
                        y += 5;
                        doc.text(`  Estado: ${statusLabels[d.estado]}`, 28, y);
                        if (d.fecha_vencimiento) {
                            doc.text(`  Vencimiento: ${formatDate(d.fecha_vencimiento)}`, 95, y);
                        }
                        y += 6;
                    });
                }
                y += 3;
            });
            
            // Footer en la √∫ltima p√°gina
            addPDFFooter(doc, pageNumber);
            
            doc.save(`gestion-documental-${establishment.nombre.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function resetAllData() {
            if (!confirm('‚ö†Ô∏è ATENCI√ìN: Esta acci√≥n eliminar√° TODOS los datos de forma PERMANENTE.\n\n¬øEst√° seguro de que desea continuar?')) {
                return;
            }

            if (!confirm('‚ö†Ô∏è √öLTIMA CONFIRMACI√ìN: Se borrar√°n:\n\n' +
                         `‚Ä¢ ${appData.establishments.length} establecimientos\n` +
                         `‚Ä¢ ${appData.inspections.length} inspecciones\n` +
                         `‚Ä¢ ${appData.actions.length} acciones\n` +
                         `‚Ä¢ ${appData.fireloads.length} cargas de fuego\n` +
                         `‚Ä¢ ${appData.extinguishers.length} extintores\n` +
                         `‚Ä¢ ${appData.risks.length} riesgos\n` +
                         `‚Ä¢ ${appData.trainings.length} capacitaciones\n` +
                         `‚Ä¢ ${appData.incidents.length} incidentes\n` +
                         `‚Ä¢ ${appData.ppe.length} entregas de EPP\n\n` +
                         'Esta acci√≥n NO se puede deshacer.\n\n¬øConfirmar eliminaci√≥n?')) {
                return;
            }

            // Resetear todos los datos
            appData = {
                establishments: [],
                inspections: [],
                actions: [],
                fireloads: [],
                extinguishers: [],
                risks: [],
                trainings: [],
                incidents: [],
                ppe: [],
                jsas: [],
                chemicals: [],
                measurements: [],
                drills: [],
                contractors: [],
                maintenances: [],
                medicals: [],
                documents: [],
                annualTrainingPlan: []
            };

            currentEstablishment = null;
            saveData();
            populateEstablishments();
            showHome();

            alert('‚úÖ Todos los datos han sido eliminados correctamente.');
        }

        // ============= RGRL MODULE =============
        const RGRL_DATA = {
            sections: [
                {
                    title: "SERVICIO DE HIGIENE Y SEGURIDAD EN EL TRABAJO",
                    questions: [
                        { num: 1, text: "¬øDispone del Servicio de Higiene y Seguridad?", normativa: "Art. 3 Dec. 1338/96" },
                        { num: 2, text: "¬øCumple con las horas profesionales seg√∫n decreto 1338/96?", normativa: "Dec. 1338/96" },
                        { num: 3, text: "¬øPosee documentaci√≥n actualizada sobre an√°lisis de riesgos y medidas preventivas en los puestos de trabajo?", normativa: "Art. 10 Dec. 1338/96" }
                    ]
                },
                {
                    title: "SERVICIO DE MEDICINA EN EL TRABAJO",
                    questions: [
                        { num: 4, text: "¬øDispone del Servicio de Medicina del Trabajo?", normativa: "Art. 3 Dec. 1338/96" },
                        { num: 5, text: "¬øPosee documentaci√≥n actualizada sobre acciones tales como educaci√≥n sanitaria, socorro, vacunaci√≥n y estudios de ausentismo por morbilidad?", normativa: "Art. 5 Dec. 1338/96" },
                        { num: 6, text: "¬øSe realizan los ex√°menes peri√≥dicos?", normativa: "Res. 43/97 y 54/98 Art. 9 a) Ley 19587" }
                    ]
                },
                {
                    title: "HERRAMIENTAS",
                    questions: [
                        { num: 7, text: "¬øLas herramientas est√°n en estado de conservaci√≥n adecuado?", normativa: "Cap.15 Art.110 Dec. 351/79" },
                        { num: 8, text: "¬øLa empresa provee herramientas aptas y seguras?", normativa: "Cap. 15 Arts. 103 y 110 Dec. 351/79" },
                        { num: 9, text: "¬øLas herramientas corto-punzantes poseen fundas o vainas?", normativa: "Cap.15 Art.110 Dec. 351/79" },
                        { num: 10, text: "¬øExiste un lugar destinado para la ubicaci√≥n ordenada de las herramientas?", normativa: "Cap.15 Art.110 Dec. 351/79" },
                        { num: 11, text: "¬øLas port√°tiles el√©ctricas poseen protecciones para evitar riesgos?", normativa: "Cap. 15 Arts. 103 y 110 Dec. 351/79" },
                        { num: 12, text: "¬øLas neum√°ticas e hidr√°ulicas poseen v√°lvulas de cierre autom√°tico al dejar de accionarla?", normativa: "Cap. 15 Arts. 103 y 110 Dec. 351/79" }
                    ]
                },
                {
                    title: "M√ÅQUINAS",
                    questions: [
                        { num: 13, text: "¬øTienen todas las m√°quinas y herramientas, protecciones para evitar riesgos al trabajador?", normativa: "Cap. 15 Arts. 103 y 104 Dec. 351/79" },
                        { num: 14, text: "¬øExisten dispositivos de parada de emergencia?", normativa: "Cap. 15 Arts. 108 y 109 Dec. 351/79" },
                        { num: 15, text: "¬øSe han previsto sistemas de bloqueo de la m√°quina para operaciones de mantenimiento?", normativa: "Cap.14 Anexo VI Pto 3.3.1 Dec. 351/79" },
                        { num: 16, text: "¬øTienen las m√°quinas el√©ctricas, sistema de puesta a tierra?", normativa: "Cap. 12 Arts. 77, 78 y 81 Dec. 351/79" },
                        { num: 17, text: "¬øEst√°n identificadas conforme a las normas IRAM todas las partes de m√°quinas y equipos que en accionamiento puedan causar da√±o a los trabajadores?", normativa: "Cap. 15 Arts. 103, 104, 105, 106, 107 y110 Dec. 351/79" }
                    ]
                },
                {
                    title: "ESPACIOS DE TRABAJO",
                    questions: [
                        { num: 18, text: "¬øExiste orden y limpieza en los puestos de trabajo?", normativa: "Art. 9 b) Ley 19587" },
                        { num: 19, text: "¬øExisten dep√≥sitos de residuos en los puestos de trabajo?", normativa: "Art. 9 b) Ley 19587" },
                        { num: 20, text: "¬øTienen las salientes y partes m√≥viles de m√°quinas y/o instalaciones, se√±alizaci√≥n y protecci√≥n?", normativa: "Art. 9 b) Ley 19587" }
                    ]
                },
                {
                    title: "ERGONOM√çA",
                    questions: [
                        { num: 21, text: "¬øSe desarrolla un programa de ergonom√≠a integrado para los distintos puestos de trabajo?", normativa: "Anexo I Resoluci√≥n 295/03" },
                        { num: 22, text: "¬øSe realizan controles de ingenier√≠a a los puestos de trabajo?", normativa: "Anexo I Resoluci√≥n 295/03" },
                        { num: 23, text: "¬øSe realizan controles administrativos y seguimientos a los puestos de trabajo?", normativa: "Anexo I Resoluci√≥n 295/03" }
                    ]
                },
                {
                    title: "PROTECCI√ìN CONTRA INCENDIOS",
                    questions: [
                        { num: 24, text: "¬øExisten medios o v√≠as de escape adecuadas en caso de incendio?", normativa: "Cap.12 Art. 80 y Cap. 18" },
                        { num: 25, text: "¬øCuentan con estudio de carga de fuego?", normativa: "Cap.18 Art. 183 Dec. 351/79" },
                        { num: 26, text: "¬øLa cantidad de matafuegos es acorde a la carga de fuego?", normativa: "Cap.18 Art. 175 y 176 Dec. 351/79" },
                        { num: 27, text: "¬øSe registra el control de recargas y/o reparaci√≥n?", normativa: "Cap.18 Art. 183 a 186 Dec. 351/79" },
                        { num: 28, text: "¬øSe registra el control de prueba hidr√°ulica de carros y/o matafuegos?", normativa: "Cap.18 Art. 183 a 185 Dec. 351/79" },
                        { num: 29, text: "¬øExisten sistemas de detecci√≥n de incendios?", normativa: "Cap.18 Art. 182 Dec. 351/79" },
                        { num: 30, text: "¬øCuentan con habilitaci√≥n, los carros y/o matafuegos y dem√°s instalaciones para extinci√≥n?", normativa: "Cap.18 Art. 183 Dec. 351/79" },
                        { num: 31, text: "¬øEl dep√≥sito de combustibles cumple con la legislaci√≥n vigente?", normativa: "Cap.18 Art. 164 a 168 Dec. 351/79" },
                        { num: 32, text: "¬øSe acredita la realizaci√≥n peri√≥dica de simulacros de evacuaci√≥n?", normativa: "Cap.18 Art. 187 Dec. 351/79" },
                        { num: 33, text: "¬øSe disponen de estanter√≠as o elementos equivalentes de material no combustible o met√°lico?", normativa: "Cap.18 Art. 169 Dec. 351/79" },
                        { num: 34, text: "¬øSe separan en forma alternada, las de materiales combustibles con las no combustibles y las que puedan reaccionar entre s√≠?", normativa: "Cap.18 Art. 169 Dec. 351/79" }
                    ]
                },
                {
                    title: "ALMACENAJE",
                    questions: [
                        { num: 35, text: "¬øSe almacenan los productos respetando la distancia m√≠nima de 1 mt. entre la parte superior de las estibas y el techo?", normativa: "Cap. 18 Art. 169 Dec. 351/79" },
                        { num: 36, text: "¬øLos sistemas de almacenaje permiten una adecuada circulaci√≥n y son seguros?", normativa: "Cap. 5 Art. 42 y 43 Dec. 351/79" },
                        { num: 37, text: "¬øEn los almacenajes a granel, las estibas cuentan con elementos de contenci√≥n?", normativa: "Cap. 5 Art. 42 y 43 Dec. 351/79" }
                    ]
                },
                {
                    title: "ALMACENAJE DE SUSTANCIAS PELIGROSAS",
                    questions: [
                        { num: 38, text: "¬øSe encuentran separados los productos incompatibles?", normativa: "Art. 9 h) Ley 19587" },
                        { num: 39, text: "¬øSe identifican los productos riesgosos almacenados?", normativa: "Art. 8 d) Ley 19587" },
                        { num: 40, text: "¬øSe proveen elementos de protecci√≥n adecuados al personal?", normativa: "Art. 8 d) Ley 19587" },
                        { num: 41, text: "¬øExisten duchas de emergencia y/o lava ojos en los sectores con productos peligrosos?", normativa: "Cap. 17 Art.145 Dec. 351/79" },
                        { num: 42, text: "¬øEn atm√≥sferas inflamables la instalaci√≥n el√©ctrica es antiexplosiva?", normativa: "Cap. 17 Art.145 Dec. 351/79" },
                        { num: 43, text: "¬øExiste un sistema para control de derrames de productos peligrosos?", normativa: "Cap. 17 Art.145 Dec. 351/79" }
                    ]
                },
                {
                    title: "SUSTANCIAS PELIGROSAS",
                    questions: [
                        { num: 44, text: "¬øSu fabricaci√≥n y/o manipuleo cumplimenta la legislaci√≥n vigente?", normativa: "Cap. 17 Art. 145 y 147 a 150 Dec. 351/79" },
                        { num: 45, text: "¬øTodas las sustancias que se utilizan poseen su respectivas hojas de seguridad?", normativa: "Cap. 17 Art. 145 y 147 a 150 Dec. 351/79" },
                        { num: 46, text: "¬øLas instalaciones y equipos se encuentran protegidos contra el efecto corrosivo de las sustancias empleadas?", normativa: "Cap. 17 Art.148 Dec. 351/79" },
                        { num: 47, text: "¬øSe fabrican, depositan o manipulan sustancias explosivas, teniendo en cuenta lo reglamentado por Fabricaciones Militares?", normativa: "Cap. 17 Art 146 Dec. 351/79" },
                        { num: 48, text: "¬øExisten dispositivos de alarma ac√∫stico y visuales donde se manipulen sustancias infectantes y/o contaminantes?", normativa: "Cap. 17 Art. 149 Dec. 351/79" },
                        { num: 49, text: "¬øSe ha se√±alizado y resguardado la zona o los elementos afectados ante casos de derrame de sustancias corrosivas?", normativa: "Cap. 17 Art. 148 Dec. 351/79" },
                        { num: 50, text: "¬øSe ha evitado la acumulaci√≥n de desechos org√°nicos en estado de putrefacci√≥n, e implementado la desinfecci√≥n correspondiente?", normativa: "Cap. 17 Art. 150 Dec. 351/79" },
                        { num: 51, text: "¬øSe confeccion√≥ un plan de seguridad para casos de emergencia, y se coloc√≥ en lugar visible?", normativa: "Cap. 17 Art. 145 Dec. 351/79" }
                    ]
                },
                {
                    title: "RIESGO EL√âCTRICO",
                    questions: [
                        { num: 52, text: "¬øEst√°n todos los cableados el√©ctricos adecuadamente contenidos?", normativa: "Cap. 14 Art. 95 y 96 Dec. 351/79" },
                        { num: 53, text: "¬øLos conectores el√©ctricos se encuentran en buen estado?", normativa: "Cap. 14 Art. 95 y 96 Dec. 351/79" },
                        { num: 54, text: "¬øLas instalaciones y equipos el√©ctricos cumplen con la legislaci√≥n?", normativa: "Cap. 14 Art. 95 y 96 Dec. 351/79" },
                        { num: 55, text: "¬øLas tareas de mantenimiento son efectuadas por personal capacitado y autorizado por la empresa?", normativa: "Cap. 14 Art. 98 Dec. 351/79" },
                        { num: 56, text: "¬øSe efect√∫a y registra los resultados del mantenimiento de las instalaciones, en base a programas confeccionados de acuerdo a normas de seguridad?", normativa: "Cap. 14 Art. 98 Dec. 351/79" },
                        { num: 57, text: "¬øLos proyectos de instalaciones y equipos el√©ctricos de m√°s de 1000 voltios cumplimentan con lo establecido en la legislaci√≥n vigente y est√°n aprobados por el responsable de Higiene y Seguridad en el rubro de su competencia?", normativa: "Cap. 14 Art. 97 Dec. 351/79" },
                        { num: 58, text: "¬øSe adoptan las medidas de seguridad en locales donde se manipule sustancias corrosivas, inflamables y/o explosivas √≥ de alto riesgo y en locales h√∫medos?", normativa: "Cap. 14 Art. 99 Dec. 351/79" },
                        { num: 59, text: "¬øSe han adoptado las medidas para la protecci√≥n contra riesgos de contactos directos e indirectos?", normativa: "Cap. 14 Art. 100 Dec. 351/79 y punto 3.3.2. Anexo VI" },
                        { num: 60, text: "¬øSe han adoptado medidas para eliminar la electricidad est√°tica en todas las operaciones que pueda producirse?", normativa: "Cap. 14 Art. 101 Dec. 351/79 y punto 3.6 Anexo VI" },
                        { num: 61, text: "¬øPosee instalaci√≥n para prevenir sobretensiones producidas por descargas atmosf√©ricas (pararrayos)?", normativa: "Cap. 14 Art. 102 y Anexo VI, pto. 3.3.1 Dec. 351/79" },
                        { num: 62, text: "¬øPoseen las instalaciones tomas a tierra independientes de la instalada para descargas atmosf√©ricas?", normativa: "Cap. 14 Art. 102 Dec. 351/79" },
                        { num: 63, text: "¬øLas puestas a tierra se verifican peri√≥dicamente mediante mediciones?", normativa: "Anexo VI pto. 3.1 Dec. 351/79" }
                    ]
                },
                {
                    title: "APARATOS SOMETIDOS A PRESI√ìN",
                    questions: [
                        { num: 64, text: "¬øSe realizan los controles e inspecciones peri√≥dicas establecidos en calderas y todo otro aparato sometido a presi√≥n?", normativa: "Cap. 16 Art. 142 Dec. 351/79" },
                        { num: 65, text: "¬øSe han fijado las instrucciones detalladas con esquemas de la instalaci√≥n, y los procedimientos operativos?", normativa: "Cap. 16 Art. 138 Dec. 351/79" },
                        { num: 66, text: "¬øSe protegen los hornos, calderas, etc., para evitar la acci√≥n del calor?", normativa: "Cap. 16 Art. 139 Dec. 351/79" },
                        { num: 67, text: "¬øEst√°n los cilindros que contengan gases sometidos a presi√≥n adecuadamente almacenados?", normativa: "Cap. 16 Art. 142 Dec. 351/79" },
                        { num: 68, text: "¬øLos restantes aparatos sometidos a presi√≥n, cuentan con dispositivos de protecci√≥n y seguridad?", normativa: "Cap. 16 Art. 141 y Art. 143" },
                        { num: 69, text: "¬øCuenta el operador con la capacitaci√≥n y/o habilitaci√≥n pertinente?", normativa: "Cap. 16 Art. 138 Dec. 351/79" },
                        { num: 70, text: "¬øEst√°n aislados y convenientemente ventilados los aparatos capaces de producir fr√≠o, con posibilidad de desprendimiento de contaminantes?", normativa: "Cap. 16 Art. 144 Dec. 351/79" }
                    ]
                },
                {
                    title: "EQUIPOS Y ELEMENTOS DE PROTECCI√ìN PERSONAL (E.P.P.)",
                    questions: [
                        { num: 71, text: "¬øSe provee a todos los trabajadores, de los elementos de protecci√≥n personal adecuado, acorde a los riesgos a los que se hallan expuestos?", normativa: "Cap.19 Art. 188 a 190 Dec. 351/79" },
                        { num: 72, text: "¬øExisten se√±alizaciones visibles en los puestos y/o lugares de trabajo sobre la obligatoriedad del uso de los elementos de protecci√≥n personal?", normativa: "Cap. 12 Art. 84 Dec. 351/79" },
                        { num: 73, text: "¬øSe verifica la existencia de registros de entrega de los E.P.P.?", normativa: "Cap. 19 Art. 188 Dec. 351/79" },
                        { num: 74, text: "¬øSe realiz√≥ un estudio por puesto de trabajo o sector donde se detallen los E.P.P. necesarios?", normativa: "Art. 28 inc. h) Dto. 170/96 Dec. 351/79 y Art. 10 Dec. 1338/96" }
                    ]
                },
                {
                    title: "ILUMINACI√ìN Y COLOR",
                    questions: [
                        { num: 75, text: "¬øSe cumple con los requisitos de iluminaci√≥n establecidos en la legislaci√≥n vigente?", normativa: "Cap. 12 Art. 71 Dec. 351/79" },
                        { num: 76, text: "¬øSe ha instalado un sistema de iluminaci√≥n de emergencia, en casos necesarios, acorde a los requerimientos de la legislaci√≥n vigente?", normativa: "Cap. 12 Art. 76 Dec. 351/79" },
                        { num: 77, text: "¬øSe registran las mediciones en los puestos y/o lugares de trabajo?", normativa: "Cap. 12 Art. 73 a 75" },
                        { num: 78, text: "¬øLos niveles existentes cumplen con la legislaci√≥n vigente?", normativa: "Cap. 12 Art. 73 a 75 Dec. 351/79" },
                        { num: 79, text: "¬øExiste marcaci√≥n visible de pasillos, circulaciones de tr√°nsito y lugares de cruce donde circulen cargas suspendidas y otros elementos de transporte?", normativa: "Cap. 12 Art. 79 Dec. 351/79" },
                        { num: 80, text: "¬øSe encuentran se√±alizados los caminos de evacuaci√≥n en caso de peligro e indicadas las salidas normales y de emergencia?", normativa: "Cap. 12 Art. 80 y Cap. 18 Art. 172 Inc. 2 Dec. 351/79" },
                        { num: 81, text: "¬øSe encuentran identificadas las ca√±er√≠as?", normativa: "Cap. 12 Art. 82 Dec. 351/79" }
                    ]
                },
                {
                    title: "CONDICIONES HIGROT√âRMICAS",
                    questions: [
                        { num: 82, text: "¬øSe registran las mediciones en los puestos y/o lugares de trabajo?", normativa: "Cap. 8 Art. 60 Dec. 351/79 Anexo III Res. 295/03 y Art. 10 Dec. 1338/96" },
                        { num: 83, text: "¬øEl personal sometido a estr√©s por fr√≠o, est√° protegido adecuadamente?", normativa: "Cap. 8 Art. 60 Dec. 351/79 y Anexo III Res. 295/03" },
                        { num: 84, text: "¬øSe adoptaron las correcciones en los puestos y/o lugares de trabajo del personal sometido a estr√©s por fr√≠o?", normativa: "Cap. 8 Art. 60 Dec. 351/79 y Anexo III Res. 295/03" },
                        { num: 85, text: "¬øEl personal sometido a estr√©s t√©rmico y tensi√≥n t√©rmica, est√° protegido adecuadamente?", normativa: "Cap. 8 Art. 60 Dec. 351/79 y Anexo III Res. 295/03" },
                        { num: 86, text: "¬øSe adoptaron las correcciones en los puestos y/o lugares de trabajo del personal sometido a estr√©s t√©rmico tensi√≥n t√©rmica?", normativa: "Cap. 8 Art. 60 inc. 4 Dec. 351/79" }
                    ]
                },
                {
                    title: "RADIACIONES IONIZANTES",
                    questions: [
                        { num: 87, text: "¬øEn caso de existir fuentes generadoras de radiaciones ionizantes (Ej. Rayos X en radiograf√≠as), los trabajadores y las fuentes cuentan con la autorizaci√≥n del organismo competente?", normativa: "Cap. 10 Art. 62 Dec. 351/79" },
                        { num: 88, text: "¬øSe encuentran habilitados los operadores y los equipos generadores de radiaciones ionizantes ante el organismo competente?", normativa: "Cap. 10 Art. 62 Dec. 351/79" },
                        { num: 89, text: "¬øSe lleva el control y registro de las dosis individuales?", normativa: "Anexo II Res. 295/03" },
                        { num: 90, text: "¬øLos valores hallados, se encuentran dentro de lo establecido en la normativa vigente?", normativa: "Anexo II Res. 295/03" }
                    ]
                },
                {
                    title: "L√ÅSERES",
                    questions: [
                        { num: 91, text: "¬øSe han aplicado las medidas de control a la clase de riesgo?", normativa: "Anexo I Res. 295/03" },
                        { num: 92, text: "¬øLas medidas aplicadas cumplen con lo establecido en la normativa vigente?", normativa: "Anexo I Res. 295/03" }
                    ]
                },
                {
                    title: "RADIACIONES NO IONIZANTES",
                    questions: [
                        { num: 93, text: "¬øEn caso de existir fuentes generadoras de radiaciones no ionizantes (Ej. Soldadura), que puedan generar da√±os a los trabajadores, est√°n √©stos protegidos?", normativa: "Cap. 10 Art. 61 Dec. 351/79" },
                        { num: 94, text: "¬øSe cumple con la normativa vigente para campos magn√©ticos est√°ticos?", normativa: "Anexo II Res. 295/03" },
                        { num: 95, text: "¬øSe registran las mediciones de radiofrecuencia y/o microondas en los lugares de trabajo?", normativa: "Cap. 9 Art. 61 Dec. 351/79 Anexo IV Res. 295/03" },
                        { num: 96, text: "¬øSe encuentran dentro de lo establecido en la normativa vigente?", normativa: "Anexo II Res. 295/03" },
                        { num: 97, text: "¬øEn caso de existir radiaci√≥n infrarroja, se registran las mediciones de la misma?", normativa: "Art. 10 Dec. 1338/96 y Anexo II Res. 295/03" },
                        { num: 98, text: "¬øLos valores hallados, se encuentran dentro de lo establecido en la normativa vigente?", normativa: "Anexo II Res. 295/03" },
                        { num: 99, text: "¬øEn caso de existir radiaci√≥n ultravioleta, se registran las mediciones de la misma?", normativa: "Anexo II Res. 295/03" },
                        { num: 100, text: "¬øLos valores hallados, se encuentran dentro de lo establecido en la normativa vigente?", normativa: "Anexo II Res. 295/03" }
                    ]
                },
                {
                    title: "PROVISI√ìN DE AGUA",
                    questions: [
                        { num: 101, text: "¬øExiste provisi√≥n de agua potable para el consumo e higiene de los trabajadores?", normativa: "Cap. 6 Art. 57 Dec. 351/79" },
                        { num: 102, text: "¬øSe registran los an√°lisis bacteriol√≥gico y f√≠sico qu√≠mico del agua de consumo humano con la frecuencia requerida?", normativa: "Cap. 6 Art. 57 Dec. 351/79" },
                        { num: 103, text: "¬øSe ha evitado el consumo humano del agua para uso industrial?", normativa: "Cap. 6 Art. 57 Dec. 351/79" }
                    ]
                },
                {
                    title: "DESAG√úES INDUSTRIALES",
                    questions: [
                        { num: 104, text: "¬øSe recogen y canalizan por conductos, impidiendo su libre escurrimiento?", normativa: "Cap. 7 Art. 59 Dec. 351/79" },
                        { num: 105, text: "¬øSe ha evitado el contacto de l√≠quidos que puedan reaccionar originando desprendimiento de gases t√≥xicos √≥ contaminantes?", normativa: "Cap. 7 Art. 59 Dec. 351/79" },
                        { num: 106, text: "¬øSon evacuados los efluentes a plantas de tratamiento?", normativa: "Cap. 7 Art. 59 Dec. 351/79" },
                        { num: 107, text: "¬øSe limpia peri√≥dicamente la planta de tratamiento, con las precauciones necesarias de protecci√≥n para el personal que efect√∫e estas tareas?", normativa: "Cap. 7 Art. 59 Dec. 351/79" }
                    ]
                },
                {
                    title: "BA√ëOS, VESTUARIOS Y COMEDORES",
                    questions: [
                        { num: 108, text: "¬øExisten ba√±os aptos higi√©nicamente?", normativa: "Cap. 5 Art. 46 a 49 Dec. 351/79" },
                        { num: 109, text: "¬øExisten vestuarios aptos higi√©nicamente y poseen armarios adecuados e individuales?", normativa: "Cap. 5 Art. 50 y 51 Dec. 351/79" },
                        { num: 110, text: "¬øExisten comedores aptos higi√©nicamente?", normativa: "Cap. 5 Art. 52 Dec. 351/79" },
                        { num: 111, text: "¬øLa cocina re√∫ne los requisitos establecidos?", normativa: "Cap. 5 Art. 53 Dec. 351/79" },
                        { num: 112, text: "¬øLos establecimientos temporarios cumplen con las exigencias de la legislaci√≥n vigente?", normativa: "Cap. 5 Art. 56 Dec. 351/79" }
                    ]
                },
                {
                    title: "APARATOS PARA IZAR, MONTACARGAS Y ASCENSORES",
                    questions: [
                        { num: 113, text: "¬øSe encuentra identificada la carga m√°xima en dichos equipos?", normativa: "Cap. 15 Art. 114 y 122 Dec. 351/79" },
                        { num: 114, text: "¬øPoseen parada de m√°ximo nivel de sobrecarga en el sistema de fuerza motriz?", normativa: "Cap. 15 Art. 117 Dec. 351/79" },
                        { num: 115, text: "¬øSe halla la alimentaci√≥n el√©ctrica del equipo en buenas condiciones?", normativa: "Cap. 14 Art. 95 y 96 Dec. 351/79" },
                        { num: 116, text: "¬øTienen los ganchos de izar traba de seguridad?", normativa: "Cap. 15 Art 126 Dec. 351/79" },
                        { num: 117, text: "¬øLos elementos auxiliares de elevaci√≥n se encuentran en buen estado (cadenas, perchas, eslingas, fajas etc.)?", normativa: "Cap. 15 Art. 122, 123, 124 y 125 Dec. 351/79" },
                        { num: 118, text: "¬øSe registra el mantenimiento preventivo de estos equipos?", normativa: "Cap. 21 Art. 208 a 210 Dec. 351/79" },
                        { num: 119, text: "¬øReciben los operadores instrucci√≥n respecto a la operaci√≥n y uso correcto del equipo de izar?", normativa: "Cap. 15 Art. 137 Dec. 351/79" },
                        { num: 120, text: "¬øLos ascensores y montacargas cumplen los requisitos y condiciones m√°ximas de seguridad en lo relativo a la construcci√≥n, instalaci√≥n y mantenimiento?", normativa: "Cap. 15 Art. 114 a 132 Dec. 351/79" },
                        { num: 121, text: "¬øLos aparatos para izar, aparejos, puentes gr√∫a, transportadores cumplen los requisitos y condiciones m√°ximas de seguridad?", normativa: "Cap. 15 Art. 114 a 132 Dec. 351/79" }
                    ]
                },
                {
                    title: "CAPACITACI√ìN",
                    questions: [
                        { num: 122, text: "¬øSe capacita a los trabajadores acerca de los riesgos espec√≠ficos a los que se encuentren expuestos en su puesto de trabajo?", normativa: "Cap. 21 Art. 208 a 210 Dec. 351/79" },
                        { num: 123, text: "¬øExisten programas de capacitaci√≥n con planificaci√≥n en forma anual?", normativa: "Cap. 21 Art. 208 a 210 Dec. 351/79" },
                        { num: 124, text: "¬øSe entrega por escrito al personal las medidas preventivas tendientes a evitar las enfermedades profesionales y accidentes de trabajo?", normativa: "Cap. 21 Art. 211 Dec. 351/79" }
                    ]
                },
                {
                    title: "PRIMEROS AUXILIOS",
                    questions: [
                        { num: 125, text: "¬øExisten botiquines de primeros auxilios acorde a los riesgos existentes?", normativa: "Cap. 21 Art. 213 Dec. 351/79" }
                    ]
                },
                {
                    title: "VEH√çCULOS",
                    questions: [
                        { num: 126, text: "¬øCuentan los veh√≠culos con los elementos de seguridad?", normativa: "Cap. 15 Art. 134 Dec. 351/79" },
                        { num: 127, text: "¬øSe ha evitado la utilizaci√≥n de veh√≠culos con motor a explosi√≥n en lugares con peligro de incendio o explosi√≥n, √≥ bien aquellos cuentan con dispositivos de seguridad apropiados para evitar dichos riesgos?", normativa: "Cap. 15 Art. 134 Dec. 351/79" },
                        { num: 128, text: "¬øDisponen de asientos que neutralicen las vibraciones, tengan respaldo y apoya pies?", normativa: "Cap. 15 Art. 134 Dec. 351/79" },
                        { num: 129, text: "¬øSon adecuadas las cabinas de protecci√≥n para las inclemencias del tiempo?", normativa: "Cap. 15 Art. 103 Dec. 351/79" },
                        { num: 130, text: "¬øSon adecuadas las cabinas para proteger del riesgo de vuelco?", normativa: "Cap. 15 Art. 103 Dec. 351/79" },
                        { num: 131, text: "¬øEst√°n protegidas para los riesgos de desplazamiento de cargas?", normativa: "Cap. 15 Art. 134 Dec. 351/79" },
                        { num: 132, text: "¬øPoseen los operadores capacitaci√≥n respecto a los riesgos inherentes al veh√≠culo que conducen?", normativa: "Cap. 21 Art. 208 y 209 Dec. 351/79" },
                        { num: 133, text: "¬øEst√°n los veh√≠culos equipados con luces, frenos, dispositivo de aviso ac√∫stico-luminosos, espejos, cintur√≥n de seguridad, bocina y matafuegos?", normativa: "Cap.15 Art.134 Dec. 351/79" },
                        { num: 134, text: "¬øSe cumplen las condiciones que deben reunir los ferrocarriles para el transporte interno?", normativa: "Cap.15 Art.136 Dec. 351/79" }
                    ]
                },
                {
                    title: "CONTAMINACI√ìN AMBIENTAL",
                    questions: [
                        { num: 135, text: "¬øSe registran las mediciones en los puestos y/o lugares de trabajo?", normativa: "Cap. 9 Art. 61 incs. 2 y 3 Dec. 351/79 Anexo IV Res. 295/03" },
                        { num: 136, text: "¬øSe adoptaron las correcciones en los puestos y/o lugares de trabajo?", normativa: "Cap. 9 Art. 61 Dec. 351/79" }
                    ]
                },
                {
                    title: "RUIDOS",
                    questions: [
                        { num: 137, text: "¬øSe registran las mediciones de nivel sonoro continuo equivalente en los puestos y/o lugares de trabajo?", normativa: "Cap. 13 Art. 85 y 86 Dec. 351/79 Anexo V Res. 295/03 Art. 10 Dec. 1338/96" },
                        { num: 138, text: "¬øSe adoptaron las correcciones en los puestos y/o lugares de trabajo?", normativa: "Cap. 13 Art. 87 Dec. 351/79 Anexo V Res. 295/03" }
                    ]
                },
                {
                    title: "ULTRASONIDOS E INFRASONIDOS",
                    questions: [
                        { num: 139, text: "¬øSe registran las mediciones en los puestos y/o lugares de trabajo?", normativa: "Cap. 13 Art. 94 Dec 351/79 Anexo V Res. 295/03 Art. 10 Dec. 1338/96" },
                        { num: 140, text: "¬øSe adoptaron las correcciones en los puestos y/o lugares de trabajo?", normativa: "Cap. 13 Art. 94 Dec 351/79 Anexo V Res. 295/03 Art. 10 Dec. 1338/96" }
                    ]
                },
                {
                    title: "VIBRACIONES",
                    questions: [
                        { num: 141, text: "¬øSe registran las mediciones en los puestos y/o lugares de trabajo?", normativa: "Cap. 13 Art. 85 y 86 Dec. 351/79 Anexo V Res. 295/03 Art. 10 Dec. 1338/96" },
                        { num: 142, text: "¬øSe adoptaron las correcciones en los puestos y/o lugares de trabajo?", normativa: "Cap. 13 Art. 87 Dec. 351/79 Anexo V Res. 295/03" }
                    ]
                },
                {
                    title: "UTILIZACI√ìN DE GASES",
                    questions: [
                        { num: 143, text: "¬øLos recipientes con gases se almacenan adecuadamente?", normativa: "Cap. 16 Art. 142 Dec. 351/79" },
                        { num: 144, text: "¬øLos cilindros de gases son transportados en carretillas adecuadas?", normativa: "Cap. 16 Art. 142 Dec. 351/79" },
                        { num: 145, text: "¬øLos cilindros de gases almacenados cuentan con el capuch√≥n protector y tienen la v√°lvula cerrada?", normativa: "Cap. 16 Art. 142 Dec. 351/79" },
                        { num: 146, text: "¬øLos cilindros de ox√≠geno y acetileno cuentan con v√°lvulas antirretroceso de llama?", normativa: "Cap. 17 Art. 153 Dec. 351/79" }
                    ]
                },
                {
                    title: "SOLDADURA",
                    questions: [
                        { num: 147, text: "¬øExiste captaci√≥n localizada de humos de soldadura?", normativa: "Cap. 17 Art. 152 y 157 Dec. 351/79" },
                        { num: 148, text: "¬øSe utilizan pantallas para la proyecci√≥n de part√≠culas y chispas?", normativa: "Cap. 17 Art. 152 y 156 Dec. 351/79" },
                        { num: 149, text: "¬øLas mangueras, reguladores, man√≥metros, sopletes y v√°lvulas antirretornos se encuentran en buen estado?", normativa: "Cap. 17 Art. 153 Dec. 351/79" }
                    ]
                },
                {
                    title: "ESCALERAS",
                    questions: [
                        { num: 150, text: "¬øTodas las escaleras cumplen con las condiciones de seguridad?", normativa: "Anexo VII Punto 8 Dec. 351/79" },
                        { num: 151, text: "¬øTodas las plataformas de trabajo y rampas cumplen con las condiciones de seguridad?", normativa: "Anexo VII Punto 8.11 y 8.12 Dec. 351/79" }
                    ]
                },
                {
                    title: "MANTENIMIENTO PREVENTIVO DE LAS MAQUINAS, EQUIPOS E INSTALACIONES EN GENERAL",
                    questions: [
                        { num: 152, text: "¬øPosee programa de mantenimiento preventivo, en base a razones de riesgos y otras situaciones similares, para m√°quinas e instalaciones?", normativa: "Art. 9 b) y Ley 19587 Cap. 14 Art. 98 Dec. 351/79" },
                        { num: 153, text: "¬øCumplimenta dicho programa de mantenimiento preventivo?", normativa: "Art. 9 b) y Ley 19587" }
                    ]
                },
                {
                    title: "OTRAS RESOLUCIONES LEGALES RELACIONADAS",
                    questions: [
                        { num: 154, text: "¬øEl establecimiento se encuentra comprendido dentro de la Resoluci√≥n 415/02 Registro de Agentes Cancer√≠genos?", normativa: "" },
                        { num: 155, text: "¬øEl establecimiento se encuentra comprendido dentro de la Resoluci√≥n 497/03 Registro de PCBs?", normativa: "" },
                        { num: 156, text: "¬øEl establecimiento se encuentra comprendido dentro de la Resoluci√≥n 743/03 Registro de Accidentes Mayores?", normativa: "" }
                    ]
                }
            ],
            planillaA: [
                "4 aminobifenilo",
                "Ars√©nico y sus compuestos",
                "Amianto (asbesto)",
                "Benceno",
                "Bencidina",
                "Berilio y sus compuestos",
                "Clorometil metil eter, grado tecnico en conjunto con bis (clorometil) eter",
                "Cadmio y compuestos",
                "Cloruro de vinilo",
                "Cromo hexavalente y sus compuestos",
                "Beta Naftilamina / 2-Naftilamina",
                "√ìxido de etileno",
                "Gas mostaza",
                "N√≠quel y sus compuestos",
                "Rad√≥n-222 y sus productos de decaimiento",
                "Silice (inhalado en forma de cuarzo o cristobalita de origen ocupacional)",
                "Talco conteniendo fibras asbestiformes",
                "Alquitranes",
                "Asfaltos",
                "Holl√≠n",
                "Aceites minerales (no tratados o ligeramente tratados)",
                "Alcohol isoprop√≠lico (manufactura por el m√©todo de los √°cidos fuertes)",
                "Auramina, manufactura de",
                "Hematita, mineria de profundidad con exposici√≥n al rad√≥n",
                "Magenta, manufactura de"
            ],
            planillaB: [
                "Aceclor", "Adkarel", "ALC", "Apirolio", "Apirorlio", "Arochlor", "Arochlors", "Aroclor", "Aroclors",
                "Arubren", "Asbestol", "ASK", "Askael", "Askarel", "Auxol", "Bakola", "Biphenyl, chlorinated",
                "Chlophen", "Chloretol", "Chlorextol", "Chlorinated biphenyl", "Chlorinated diphenyl", "Chlorinol",
                "Chlorobiphenyl", "Chlorodiphenyl", "Chlorphen", "Chorextol", "Chorinol", "Clophen", "Clophenharz",
                "Cloresil", "Clorinal", "Clorphen", "Decachlorodiphenyl", "Delor", "Delorene", "Diaclor", "Dicolor",
                "Diconal", "Diphenyl, chlorinated", "DK", "Duconal", "Dykanol", "Educarel", "EEC-18", "Elaol",
                "Electrophenyl", "Elemex", "Elinol", "Eucarel", "Fenchlor", "Fenclor", "Fenocloro", "Gilotherm",
                "Hydol", "Hyrol", "Hyvol", "Inclor", "Inerteen", "Inertenn", "Kanechlor", "Kaneclor", "Kennechlor",
                "Kenneclor", "Leromoll", "Magvar", "MCS 1489", "Montar", "Nepolin", "No-Flamol", "NoFlamol",
                "Non-Flamol", "Olex-sf-d", "Orophene", "PCB", "PCB's", "PCBs", "Pheaoclor", "Phenochlor", "Phenoclor",
                "Plastivar", "Polychlorinated biphenyl", "Polychlorinated biphenyls", "Polychlorinated diphenyl",
                "Polychlorinated diphenyls", "Polychlorobiphenyl", "Polychlorodiphenyl", "Prodelec", "Pydraul",
                "Pyraclor", "Pyralene", "Pyranol", "Pyroclor", "Pyronol", "Saf-T-Kuhl", "Saf-T-Kohl", "Santosol",
                "Santotherm", "Santothern", "Santovac", "Solvol", "Sorol", "Soval", "Sovol", "Sovtol",
                "Terphenychlore", "Therminal", "Therminol", "Turbinol"
            ],
            planillaC: [
                { nombre: "Nitrato de amonio", umbral: 350 },
                { nombre: "Pent√≥xido de ars√©nico, √°cido ars√©nico (V) y-o sus sales", umbral: 1 },
                { nombre: "Tri√≥xido de ars√©nico, √°cido ars√©nico (III) y-o sus sales", umbral: 0.1 },
                { nombre: "Bromo", umbral: 20 },
                { nombre: "Cloro", umbral: 10 },
                { nombre: "Compuestos de n√≠quel en forma pulverulenta inhalable (mon√≥xido de n√≠quel, di√≥xido de n√≠quel, sulfuro de n√≠quel, disulfuro de trin√≠quel, tri√≥xido de din√≠quel)", umbral: 1 },
                { nombre: "Etilenimina", umbral: 10 },
                { nombre: "Fl√∫or", umbral: 10 },
                { nombre: "Formaldehido (concentraci√≥n ‚â• 90 por 100)", umbral: 5 },
                { nombre: "Hidr√≥geno", umbral: 5 },
                { nombre: "Acido clorh√≠drico (gas licuado)", umbral: 25 },
                { nombre: "Alquilos de plomo", umbral: 5 },
                { nombre: "Gases licuados extremadamente inflamables (incluidos GPL) y gas natural", umbral: 50 },
                { nombre: "Acetileno", umbral: 5 },
                { nombre: "√ìxido de etileno", umbral: 5 },
                { nombre: "√ìxido de propileno", umbral: 5 },
                { nombre: "Metanol", umbral: 500 },
                { nombre: "4,4 metilen-bis (2-cloroanilina) y-o sus sales en forma pulverulenta", umbral: 0.01 },
                { nombre: "Isocianato de metilo", umbral: 0.15 },
                { nombre: "Ox√≠geno", umbral: 200 },
                { nombre: "Diisocianato de tolueno", umbral: 10 },
                { nombre: "Dicloruro de carbonilo (fosgeno)", umbral: 0.3 },
                { nombre: "Trihidruro de ars√©nico (arsina)", umbral: 0.2 },
                { nombre: "Trihidruro de f√≥sforo (fosfina)", umbral: 0.2 },
                { nombre: "Dicloruro de azufre", umbral: 1 },
                { nombre: "Tri√≥xido de azufre", umbral: 15 },
                { nombre: "Policlorodibenzofuranos y p√≥liclorodibenzodioxinas (incluida la TCDD) calculadas en equivalente TCDD", umbral: 0.001 },
                { nombre: "Naftas y otros cortes livianos", umbral: 5000 }
            ]
        };
        const RGRL_OBRAS_DATA = {
            sections: [
                {
                    title: "LEGAJO T√âCNICO (Res. 51/97)",
                    questions: [
                        { num: 1, text: "Memoria descriptiva de la obra", normativa: "Art. 3 inc. a) Res. 231/96 regl. Art. 20 Cap. 4 Dec. 911/96" },
                        { num: 2, text: "Programa de capacitaci√≥n al personal", normativa: "Art. 2 y 3 Res. 51/97" },
                        { num: 3, text: "Registro de visitas del Servicio de Higiene y Seguridad", normativa: "Anexo I inc. b) Res. 51/97" },
                        { num: 4, text: "Afiliaci√≥n obligatoria del personal a una ART", normativa: "Art. 27 Cap. VIII Ley 24557" },
                        { num: 5, text: "Aviso de inicio de obra a la ART", normativa: "Art. 3 inc. a) Res. 231/96 regl. Art. 20 Cap. 4 Dec. 911/96" },
                        { num: 6, text: "Programa de seguridad aprobado por la ART", normativa: "Art. 3 inc. c) Res. 231/96 regl. Art. 20 Cap. 4 Dec. 911/96" },
                        { num: 7, text: "N√≥mina del personal que trabaja en la obra con N¬∞ de C.U.I.L.", normativa: "Art. 3 inc. d) Res. 231/96 regl. Art. 20 Cap. 4 Dec. 911/96" },
                        { num: 8, text: "Aviso de inicio de obra a la ART", normativa: "Art. 2 Res. 035/98" },
                        { num: 9, text: "Programa √∫nico de seguridad Cont. Princ. Aprob. ART", normativa: "Art. 1 Res. 035/98" },
                        { num: 10, text: "Afiche de la ART", normativa: "Res. 70/97" }
                    ]
                },
                {
                    title: "DISPOSICIONES GENERALES (Dec. 911/96 - Cap. 1)",
                    questions: [
                        { num: 11, text: "Programas de seguridad tareas corta duraci√≥n, aprob. ART", normativa: "Art. 5 Res. 319/99" },
                        { num: 12, text: "Comitente a cargo del S.H. y Seguridad", normativa: "Art. 1 Res. 319/99" },
                        { num: 13, text: "Ba√±os y vestuarios adecuados", normativa: "Art. 1 inc. b) Res. 231/96" },
                        { num: 14, text: "Provisi√≥n de agua potable", normativa: "Art. 1inc. e) Res. 231/96" },
                        { num: 15, text: "Entrega de E.P.P. (constancia de entrega firmada por el trabajador)", normativa: "Art. 1 inc. f) Res. 231/96" },
                        { num: 16, text: "Implementaci√≥n del Servicio de Seguridad del comitente y/o contratista", normativa: "Art. 1 inc. g) Res. 231/96" },
                        { num: 17, text: "Programa de capacitaci√≥n b√°sico (constancias firmadas por el trabajador)", normativa: "Art. 1 inc. g) Res. 231/96" },
                        { num: 18, text: "Medidas preventivas de protecci√≥n de ca√≠da de personas o derrumbes, tales como: barandas, vallas, pantallas, se√±alizaci√≥n, submuraci√≥n o tablestacado", normativa: "Art. 1 inc. h) Res. 231/96" },
                        { num: 19, text: "Disyuntores el√©ctricos, malla P a T. Cables doble aislaci√≥n", normativa: "Art. 1 inc. j) Res. 231/96" },
                        { num: 20, text: "Extinguidor triclase 10 kg.", normativa: "Art. 1 inc. k) Res. 231/96" },
                        { num: 21, text: "Protecci√≥n sistemas de transmisi√≥n de maquinarias y equipos", normativa: "Art. 1 inc. l) Res. 231/96" },
                        { num: 22, text: "A los 7 d√≠as entrega ropa de trabajo", normativa: "Art. 1 inc. m) Res. 231/96" },
                        { num: 23, text: "A los 15 d√≠as completar capacitaci√≥n b√°sica", normativa: "Art. 1 inc. m) Res. 231/96" },
                        { num: 24, text: "Instalar carteles de seguridad", normativa: "Art. 1 inc. n) Res. 231/96" },
                        { num: 25, text: "Horas asignadas personal de Higiene y Seguridad", normativa: "Art. 2 Res. 231/96 regl. Art. 17 Cap. 3 Dec. 911/96" },
                        { num: 26, text: "Instalaci√≥n de matafuegos seg√∫n norma", normativa: "Art. 172 Dec. 351/79" },
                        { num: 27, text: "El comitente es solidario responsable con el empleador", normativa: "Art. 4 Cap. 1 Dec. 911/96" },
                        { num: 28, text: "Con 2 o m√°s contrat. la coordinaci√≥n de la seguridad contrat. Princ. o Com.", normativa: "Art. 6 Cap. 1 Dec. 911/96" },
                        { num: 29, text: "Capacitar a los empleados en acciones de prevenci√≥n", normativa: "Art. 8 Cap. 1 Dec. 911/96" },
                        { num: 30, text: "Asignaci√≥n de hs. de Higiene y Seguridad a cargo del empleador", normativa: "Art. 17 Cap. 3 Dec. 911/96" },
                        { num: 31, text: "Legajo T√©cnico a cargo del responsable de Higiene y Seguridad para el control efectivo de riesgos", normativa: "Art. 20 Cap. 4 Dec. 911/96" }
                    ]
                },
                {
                    title: "SERVICIO DE INFRAESTRUCTURA DE OBRA (Dec. 911/96 - Cap. 5)",
                    questions: [
                        { num: 32, text: "Vivienda personal 6 m2 por dormitorio", normativa: "Art. 22 inc a) Cap. 5 Dec. 911/96" },
                        { num: 33, text: "Sanitarios en proporci√≥n al personal cada 15 (1 inodoro, 1 migitorio, 2 lavamanos y 5 duchas)", normativa: "Art. 24 Cap. 5 Dec. 911/96" },
                        { num: 34, text: "Vestuarios con armarios incombustibles", normativa: "Art. 29 Cap. 5 Dec. 911/96" },
                        { num: 35, text: "Cocina con mesada agua fr√≠a y caliente", normativa: "Art. 31 Cap. 5 Dec. 911/96" }
                    ]
                },
                {
                    title: "ALMACENAMIENTO DE MATERIALES (Dec. 911/96 - Cap. 6)",
                    questions: [
                        { num: 36, text: "V√≠as de circulaci√≥n apropiadas en la obra", normativa: "Art. 45 inc.b) Cap. 6 Dec. 911/96" },
                        { num: 37, text: "Se evitar√°n deslizamiento de materiales o ca√≠das", normativa: "Art. 45 inc.c) Cap. 6 Dec. 911/96" },
                        { num: 38, text: "Cuando se estiban materiales dejar pasillos de 0,60 mts.", normativa: "Art. 45 inc. e) Cap. 6 Dec. 911/96" },
                        { num: 39, text: "Barras de acero sujetas para evitar que rueden", normativa: "Art. 45 inc. h) Cap. 6 Dec. 911/96" },
                        { num: 40, text: "Orden y limpieza", normativa: "Art. 46 Cap. 6 Dec. 911/96" },
                        { num: 41, text: "Preveer medios de acceso y salidas seguros en todos los lugares de trabajo", normativa: "Art. 47 Cap. 6 Dec 911/96" },
                        { num: 42, text: "Protecci√≥n contra la ca√≠da de objetos por encima del plano de trabajo, delimitar la altura de la estiva y colocar pantallas", normativa: "Art. 50 Cap. 6 Dec. 911/96" }
                    ]
                },
                {
                    title: "CA√çDA DE PERSONAS (Dec. 911/96 - Cap. 6)",
                    questions: [
                        { num: 43, text: "Proteger aberturas de pisos con cubiertas o barandas 1,00/0,50/z√≥calo", normativa: "Art. 52 inc. b) Cap. 6 Dec. 911/96" },
                        { num: 44, text: "Aberturas en paredes se proteger√°n con barandas 1,00/0,50/z√≥calo", normativa: "Art. 52 inc. c) Cap. 6 Dec. 911/96" },
                        { num: 45, text: "Sin barandas, colocar redes salvavidas a 3 mts. por debajo del plano trabajo", normativa: "Art. 52 inc. d) Cap. 6 Dec. 911/96" },
                        { num: 46, text: "Identificaci√≥n de los lugares que presenten riesgo de ca√≠das de personas se√±alizaci√≥n", normativa: "Art. 52 inc. d) Cap. 6 Dec. 911/96" },
                        { num: 47, text: "Riesgo de ca√≠da al agua, chalecos salvavidas, redes, botes", normativa: "Art. 53 Cap. 6 Dec. 911/96" }
                    ]
                },
                {
                    title: "RIESGO DE CA√çDA A DISTINTO NIVEL (Dec. 911/96 - Cap. 6)",
                    questions: [
                        { num: 48, text: "Circular o trabajar a una diferencia de cota de 2,00 mts.", normativa: "Art. 54 Cap. 6 Dec. 911/96" },
                        { num: 49, text: "Obligaci√≥n de protecciones seg√∫n lo establecido en el Art√≠culo 52", normativa: "Art. 55 Cap. 6 Dec. 911/96" },
                        { num: 50, text: "Tareas de corta duraci√≥n cinturones anclados a puntos fijos, sujetaci√≥n inercial", normativa: "Art. 57 Cap. 6 Dec. 911/96" },
                        { num: 51, text: "Se instalar√° cubierta por encima del piso de trabajo para proteger a los trabajadores contra la ca√≠da de objetos", normativa: "Art. 58 Cap. 6 Dec. 911/96" }
                    ]
                },
                {
                    title: "TRABAJOS EN V√çA P√öBLICA (Dec. 911/96 - Cap. 6)",
                    questions: [
                        { num: 52, text: "Se√±alizar y vallar: obras, m√°quinas y equipamiento", normativa: "Art. 61 Cap. 6 Dec. 911/96" },
                        { num: 53, text: "Se√±ales y vallados en buenas condiciones, colocar se√±aleros", normativa: "Art. 62 Cap. 6 Dec. 911/96" },
                        { num: 54, text: "Trabajos nocturnos ropa reflectiva e iluminaci√≥n", normativa: "Art. 63 Cap. 6 Dec. 911/96" },
                        { num: 55, text: "Trabajos cercanos a l√≠neas de servicio, identificar y aislar riesgo", normativa: "Art. 64 Cap. 6 Dec. 911/96" },
                        { num: 56, text: "Interrupci√≥n de tareas por lluvias o vientos", normativa: "Art. 65 Cap. 6 Dec. 911/96" }
                    ]
                },
                {
                    title: "SE√ëALIZACI√ìN DE LA CONSTRUCCI√ìN (Dec. 911/96 - Cap. 6)",
                    questions: [
                        { num: 57, text: "Indicaci√≥n de se√±alizaciones y sus caracter√≠sticas para la obra", normativa: "Art. 66 Cap. 6 Dec. 911/96" },
                        { num: 58, text: "Se√±alar lugares de acceso, caminos de obras, salidas, rutas de escape, incluso en el obrador", normativa: "Art. 69 Cap. 6 Dec. 911/96" },
                        { num: 59, text: "Veh√≠culos y m√°quinas de obra deben tener se√±ales fono luminosas", normativa: "Art. 71 Cap. 6 Dec. 911/96" }
                    ]
                },
                {
                    title: "INSTALACIONES EL√âCTRICAS (Dec. 911/96 - Cap. 6)",
                    questions: [
                        { num: 60, text: "Mantener distancias m√≠nimas, para 220 vols., 0,80 mts.", normativa: "Art. 75 Cap. 6 Dec. 911/96" },
                        { num: 61, text: "Tendido de cables a√©reo a no menos de 2,40 mts. de altura o subterr√°neo", normativa: "Art. 86 Cap. 6 Dec. 911/96" },
                        { num: 62, text: "Mantenimiento de las instalaciones y todos sus elementos", normativa: "Art. 87 Cap. 6 Dec. 911/96" }
                    ]
                },
                {
                    title: "PREVENCI√ìN CONTRA INCENDIOS (Dec. 911/96 - Cap. 6)",
                    questions: [
                        { num: 63, text: "Definici√≥n por el responsable de HyS de cantidad y ubicaci√≥n de equipamiento", normativa: "Art. 88 Cap. 6 Dec. 911/96" },
                        { num: 64, text: "Equipos de incendio, libres de obst√°culos", normativa: "Art. 91 Cap. 6 Dec. 911/96" },
                        { num: 65, text: "Avisos visibles con n√∫meros y direcciones de emergencias", normativa: "Art. 93 Cap. 6 Dec. 911/96" }
                    ]
                },
                {
                    title: "DEP√ìSITOS INFLAMABLES (Dec. 911/96 - Cap. 6)",
                    questions: [
                        { num: 66, text: "Almac√©n independiente restringido a nivel de piso", normativa: "Art. 95 inc. a) Cap. 6 Dec. 911/96" },
                        { num: 67, text: "Locales ventilados y protegidos de la acci√≥n solar, apartados del obrador", normativa: "Art. 95 inc. b) Cap. 6 Dec. 911/96" },
                        { num: 68, text: "Elementos estancos para contenci√≥n de derrames", normativa: "Art. 95 inc c) Cap. 6 Dec. 911/96" },
                        { num: 69, text: "Instalaci√≥n el√©ctrica antiexplosiva", normativa: "Art. 95 inc. d) Cap.6 Dec. 911/96" },
                        { num: 70, text: "Carteles indicando peligro", normativa: "Art. 93 Cap. 6 Dec. 911/96" }
                    ]
                },
                {
                    title: "ELEMENTOS DE PROTECCI√ìN PERSONAL (E.P.P.) (Dec. 911/96 - Cap. 6)",
                    questions: [
                        { num: 71, text: "Entrega de elementos de trabajo y equipo de protecci√≥n personal", normativa: "Art. 98 Cap. 6 Dec. 911/96" },
                        { num: 72, text: "Ropa y calzado de lluvia", normativa: "Art.104 Cap. 6 Dec. 911/96" },
                        { num: 73, text: "Casco de seguridad", normativa: "Art.107 Cap. 6 Dec. 911/96" },
                        { num: 74, text: "Protecci√≥n ocular", normativa: "Art. 108 Cap. 6 Dec. 911/96" },
                        { num: 75, text: "Protecci√≥n auditiva", normativa: "Art. 109 Cap. 6 Dec. 911/96" },
                        { num: 76, text: "Protecci√≥n de miembros superiores guantes, mitones", normativa: "Art. 110 Cap. 6 Dec. 911/96" },
                        { num: 77, text: "Calzado de seguridad con puntera de acero", normativa: "Art. 111 Cap. 6 Dec. 911/96" },
                        { num: 78, text: "Cintur√≥n de seguridad para diferencia de nivel de 2,50 mts.", normativa: "Art. 112 Cap. 6 Dec. 911/96" },
                        { num: 79, text: "Protecci√≥n respiratoria, por polvo, humo fibras, etc.", normativa: "Art. 113 Cap. 6 Dec. 911/96" },
                        { num: 80, text: "Protecci√≥n respiratoria sustancias qu√≠micas con inyecci√≥n de aire", normativa: "Art. 114 Cap. 6 Dec. 911/96" }
                    ]
                },
                {
                    title: "NORMAS HIGI√âNICO/AMBIENTALES EN OBRA (Dec. 911/96 - Cap. 7)",
                    questions: [
                        { num: 81, text: "Medidas de prevenci√≥n y control de contaminantes o entrega de E.P.P. adecuados", normativa: "Art. 117 Cap. 7 Dec.911/96" },
                        { num: 82, text: "Los locales confinados, deben ser ventilados", normativa: "Art. 120 Cap 7 Dec. 911/96" },
                        { num: 83, text: "Ning√∫n trabajador puede estar expuesto a m√°s de 90 decibeles", normativa: "Art. 127 Cap. 7 Dec. 911/96" },
                        { num: 84, text: "Iluminaci√≥n general adecuada", normativa: "Art. 133 inc. a) Cap. 7 Dec. 911/96" },
                        { num: 85, text: "Iluminaci√≥n localizada", normativa: "Art. 135 inc. a/g) Cap. 7 Dec. 911/96" },
                        { num: 86, text: "Iluminaci√≥n de emergencia en los medios de salida", normativa: "Art. 136 inc a) Cap. 7 Dec. 911/96" }
                    ]
                },
                {
                    title: "TRABAJOS DE DEMOLICI√ìN (Dec. 911/96 - Cap. 8)",
                    questions: [
                        { num: 87, text: "Programa de trabajo que contemple medidas de seguridad", normativa: "Art. 138 inc. a) Cap. 8 Dec 911/96" },
                        { num: 88, text: "Afianzar las partes inestables de la construcci√≥n", normativa: "Art. 138 inc. b) Cap. 8 Dec 911/96" },
                        { num: 89, text: "Interrupci√≥n de los servicios de gas, luz, tel√©fono, electricidad", normativa: "Art. 138 inc. d) Cap. 8 Dec 911/96" },
                        { num: 90, text: "Establecer zonas de exclusi√≥n", normativa: "Art. 139 Cap. 8 Dec. 911/96" },
                        { num: 91, text: "Distancia de seguridad de la zona de demolici√≥n", normativa: "Art. 140 inc. a/b) Cap. 8 Dec 911/96" },
                        { num: 92, text: "Demolici√≥n en altura uso obligatorio de andamios, evitar riesgos de ca√≠das, uso de arn√©s", normativa: "Art. 140 inc. d) Cap. 8 Dec 911/96" },
                        { num: 93, text: "Apuntalamiento de muros medianeros", normativa: "Art. 140 inc. g) Cap. 8 Dec 911/96" }
                    ]
                },
                {
                    title: "EXCAVACIONES Y TRABAJOS SUBTERR√ÅNEOS (Dec. 911/96 - Cap. 8)",
                    questions: [
                        { num: 94, text: "Se verificar√° las condiciones de seguridad por responsable habilitado antes de comenzar cada jornada, debe estar documentado", normativa: "Art. 142 Cap. 8 Dec. 911/96" },
                        { num: 95, text: "Se√±alizaci√≥n de zanjas y excavaciones", normativa: "Art 145 Cap. 8 Dec. 911/96" },
                        { num: 96, text: "Obras subterr√°neas obligaci√≥n de iluminaci√≥n de emergencia", normativa: "Art. 146 Cap. 8 Dec. 911/96" },
                        { num: 97, text: "Protecci√≥n contra ca√≠da de personas y objetos", normativa: "Art. 147 Cap. 8 Dec. 911/96" },
                        { num: 98, text: "Deber√° tenerse en cuenta la resistencia del suelo en los bordes de la excavaci√≥n, cuando √©stos se utilicen para colocar materiales o desplazar cargas", normativa: "Art. 148 Cap. 8 Dec. 911/96" },
                        { num: 99, text: "Riesgo de desprendimientos se deber√° colocar tablestacas o entibados", normativa: "Art 149 Cap. 8 Dec. 911/96" },
                        { num: 100, text: "Profundidad de la excavaci√≥n mayor de 1,00 mt. uso de escaleras", normativa: "Art. 150 inc. b) Cap. 8 Dec. 911/96" },
                        { num: 101, text: "Trabajadores, fondo de pozo, dist. min. de la m√°quina 2 veces el largo del brazo", normativa: "Art. 150 inc. d) Cap. 8 Dec. 911/96" },
                        { num: 102, text: "Planificaci√≥n de trabajos en t√∫nel, capacitaci√≥n sobre riesgos", normativa: "Art. 151 Cap. 8 Dec. 911/96" },
                        { num: 103, text: "2 sistemas de comunicaci√≥n independientes", normativa: "Art. 152 Cap. 8 Dec. 911/96" },
                        { num: 104, text: "Submuraci√≥n, recalce de muros", normativa: "Art. 155 Cap. 8 Dec. 911/96" }
                    ]
                },
                {
                    title: "TRABAJOS CON HORMIG√ìN (Dec. 911/96 - Cap. 8)",
                    questions: [
                        { num: 105, text: "Materiales utilizados en encofrados que sean de buena calidad", normativa: "Art. 167 Cap. 8 Dec. 911/96" },
                        { num: 106, text: "Todas las partes componentes se deben encontrar en condiciones seguras", normativa: "Art. 168 Cap. 8 Dec. 911/96" },
                        { num: 107, text: "No deben acumularse pesos durante el per√≠odo constructivo s/ las estruc.", normativa: "Art. 169 Cap. 8 Dec. 911/96" },
                        { num: 108, text: "Apuntalamientos de madera, cada puntal no debe tener mas de un empalme", normativa: "Art. 170 Cap. 8 Dec.911/96" },
                        { num: 109, text: "Durante la soldadura de armaduras, prevenir riesgos de incendio, protecci√≥n personal", normativa: "Art. 171 Cap. 8 Dec. 911/96" },
                        { num: 110, text: "Est√° prohibido trasladar personas en el balde de hormigonar", normativa: "Art: 174 Cap. 8 dec. 911/96" },
                        { num: 111, text: "Operaciones de pretensados, protegidos por pantallas", normativa: "Art. 176 Cap. 8 Dec. 911/96" }
                    ]
                },
                {
                    title: "TUBER√çAS Y BOMBAS PARA TRANSPORTE DE HORMIG√ìN (Dec. 911/96 - Cap. 8)",
                    questions: [
                        { num: 112, text: "Andamios o estructuras que sostengan tuber√≠as para hormig√≥n bombeado, c√°lculo s/peso ca√±er√≠a llena, trabajadores etc. con coef. de segurid. de 4", normativa: "Art. 177 Cap. 8 Dec. 911/96" },
                        { num: 113, text: "Ca√±er√≠as de bombeo s√≥lidamente amarradas/v√°lvula de escape de aire", normativa: "Art. 178 Cap. 8 Dec. 911/96" },
                        { num: 114, text: "Mantener distancia de seguridad en purgas de ca√±er√≠as", normativa: "Art. 179 Cap. 8 Dec. 911/96" }
                    ]
                },
                {
                    title: "TRABAJOS DE PINTURA (Dec. 911/96 - Cap. 8)",
                    questions: [
                        { num: 115, text: "Personal con protecci√≥n adecuada, con capacitaci√≥n, riesgo de incendio", normativa: "Art. 182 Cap. 8 Dec. 911/96" }
                    ]
                },
                {
                    title: "SILOS Y TOLVA (Dec. 911/96 - Cap. 9)",
                    questions: [
                        { num: 116, text: "Protecci√≥n contra riesgo de ca√≠das", normativa: "Art. 187 Cap. 9 Dec. 911/96" }
                    ]
                },
                {
                    title: "M√ÅQUINAS PARA TRABAJAR LA MADERA (Dec. 911/96 - Cap. 9)",
                    questions: [
                        { num: 117, text: "Uso de elementos de protecci√≥n personal (E.P.P.)", normativa: "Art. 189 Cap. 9 Dec. 911/96" },
                        { num: 118, text: "Protecci√≥n con accionamiento de parada, cubrir los sectores de corte", normativa: "Art. 190 Cap. 9 Dec. 911/96" },
                        { num: 119, text: "Sierra circular, provista por resguardos inferior y superior", normativa: "Art. 193 Cap. 9 Dec. 911/96" },
                        { num: 120, text: "Sierra sin fin hoja recubierta hasta punto de corte", normativa: "Art. 194 Cap. 9 Dec. 911/96" },
                        { num: 121, text: "Cepilladora resguardo que cubra la ranura en su largo", normativa: "Art. 195 Cap. 9 Dec. 911/96" }
                    ]
                },
                {
                    title: "HERRAMIENTAS DE ACCIONAMIENTO MANUAL Y MEC√ÅNICAS (Dec. 911/96 - Cap. 9)",
                    questions: [
                        { num: 122, text: "Capacitaci√≥n en relaci√≥n a los riesgos de la herramienta que emplean", normativa: "Art. 199 Cap. 9 Dec. 911/96" },
                        { num: 123, text: "Herramientas port√°tiles acci√≥n por energ√≠a interna protegidas para evitar contacto", normativa: "Art. 200 Cap. 9 Dec. 911/96" },
                        { num: 124, text: "Con materiales inflamables, uso de herramientas que no hagan chispa", normativa: "Art. 203 Cap. 9 Dec. 911/96" }
                    ]
                },
                {
                    title: "HERRAMIENTAS NEUM√ÅTICAS (Dec. 911/96 - Cap. 9)",
                    questions: [
                        { num: 125, text: "De percusi√≥n debe contar con grapas para impedir que las brocas salgan desp.", normativa: "Art. 205 Cap. 9 Dec. 911/96" },
                        { num: 126, text: "Neum√°ticas con acople r√°pido c/seguro mangueras sujetas c/ abrazaderas", normativa: "Art. 206 Cap. 9 Dec. 911/96" }
                    ]
                },
                {
                    title: "HERRAMIENTAS EL√âCTRICAS (Dec. 911/96 - Cap. 9)",
                    questions: [
                        { num: 127, text: "Cables y accesorios c/protecci√≥n mec√°nica", normativa: "Art. 208 Cap. 9 Dec. 911/96" }
                    ]
                },
                {
                    title: "ESCALERAS Y SUS PROTECCIONES (Dec. 911/96 - Cap. 9)",
                    questions: [
                        { num: 128, text: "Escaleras m√≥viles se deben usar para ascenso y descenso. No para trabajar", normativa: "Art. 210 Cap. 9 Dec. 911/96" },
                        { num: 129, text: "Escalera fija a m√°s de 6 mts. de altura, debe tener rellanos c/ 3 mts.", normativa: "Art. 212 Cap. 9 Dec. 911/96" },
                        { num: 130, text: "Las escaleras de madera no se deben pintar", normativa: "Art. 213 Cap. 9 Dec. 911/96" }
                    ]
                },
                {
                    title: "ESCALERAS DE MANO (Dec. 911/96 - Cap. 9)",
                    questions: [
                        { num: 131, text: "Deben sobrepasar 1,00 mts. el lugar de acceso", normativa: "Art. 214 inc. b) Cap. 9 Dec. 911/96" },
                        { num: 132, text: "Apoyada sobre plano firme", normativa: "Art. 214 inc. c) Cap. 9 Dec. 911/96" },
                        { num: 133, text: "Escaleras de 2 hojas, no deben sobrepasar los 6 mts. de longitud", normativa: "Art. 215 inc. a) Cap. 9 Dec. 911/96" },
                        { num: 134, text: "Deben asegurar estabilidad y rigidez", normativa: "Art. 215 inc. b) Cap. 9 Dec. 911/96" },
                        { num: 135, text: "Escaleras extensibles superposici√≥n entre tramos 1,00 mts.", normativa: "Art. 216 Cap. 9 Dec. 911/96" }
                    ]
                },
                {
                    title: "ESCALERAS ESTRUCTURALES TEMPORARIAS (Dec. 911/96 - Cap. 9)",
                    questions: [
                        { num: 136, text: "Deben soportar sin peligro las cargas previstas", normativa: "Art. 219 inc. a) Cap. 9 Dec. 911/96" },
                        { num: 137, text: "Tener un ancho de 0,60 mts.", normativa: "Art. 219 inc. b) Cap. 9 Dec. 911/96" },
                        { num: 138, text: "Con m√°s de 1,00 mts. de altura debe tener 2 pasamanos", normativa: "Art. 219 inc. c) Cap. 9 Dec. 911/96" },
                        { num: 139, text: "Alzada m√°xima 0,20 mts. pedada m√≠nima 0,25 mts.", normativa: "Art. 219 inc. d) Cap. 9 Dec. 911/96" }
                    ]
                },
                {
                    title: "ANDAMIOS (Dec. 911/96 - Cap. 9)",
                    questions: [
                        { num: 140, text: "Rigidez, resistencia y estabilidad", normativa: "Art. 222 inc. a/b/c) Cap. 9 Dec. 911/96" },
                        { num: 141, text: "Estar dotados de los dispositivos de seguridad correspondientes", normativa: "Art. 222 inc. e) Cap. 9 Dec. 911/96" },
                        { num: 142, text: "Asegurar inmovilidad lateral y vertical", normativa: "Art. 222 inc. f ) Cap. 9 Dec. 911/96" },
                        { num: 143, text: "Plataformas ubicadas a mas de 2,00 mts. barandas a 1,00/0,50 mts. y z√≥calos", normativa: "Art. 223 Cap. 9 Dec. 911/96" },
                        { num: 144, text: "Plataformas debe tener un ancho total de 0,60 mts.", normativa: "Art. 224 Cap. 9 Dec. 911/96" },
                        { num: 145, text: "Los tablones de la plataforma deben estar trabados y amarrados", normativa: "Art. 225 Cap. 9 Dec. 911/96" },
                        { num: 146, text: "Las plataformas de mas de 2,00 mts. de altura deben tener barandas", normativa: "Art. 226 Cap. 9 Dec.911/96" },
                        { num: 147, text: "El espacio m√°ximo entre muro y plataforma no debe ser mayor de 0,20 mts. si es mayor debe colocarse baranda a una altura de 0,70 mts.", normativa: "Art. 227 Cap 9 Dec. 911/96" },
                        { num: 148, text: "Montantes de andamios: verticales, distancia m√°xima. 3,00 mts., empotrada al suelo sustentados sobre calces apropiados que eviten deslizamientos", normativa: "Art. 228 Cap. 9 Dec. 911/96" }
                    ]
                },
                {
                    title: "ANDAMIOS COLGANTES (Dec. 911/96 - Cap. 9)",
                    questions: [
                        { num: 149, text: "Plataf. susp. de equipos de izar sistema eficaz p/enclavar mov. verticales", normativa: "Art. 229 Cap. 9 dec. 911/96" },
                        { num: 150, text: "La suspensi√≥n de andamios respetara lo relativo a: cables cadenas eslingas", normativa: "Art. 230 Cap. 9 dec. 911/96" },
                        { num: 151, text: "Resp. de tarea verifica si el andamio se encuentra en cond. de seguridad", normativa: "Art. 231 Cap. 9 dec. 911/96" },
                        { num: 152, text: "Los trabajadores deben usar arn√©s de seguridad, amarrado a punto fijo", normativa: "Art. 232 Cap. 9, dec. 911/96" }
                    ]
                },
                {
                    title: "ANDAMIOS DE MADERA (Dec. 911/96 - Cap. 9)",
                    questions: [
                        { num: 153, text: "Madera resistente, sin pintura, tablones zunchados en los extremos", normativa: "Art. 233 Cap. 9 Dec. 911/96" }
                    ]
                },
                {
                    title: "ANDAMIOS MET√ÅLICOS TUBULARES (Dec. 911/96 - Cap. 9)",
                    questions: [
                        { num: 154, text: "Los elementos deben estar r√≠gidamente unidos entre s√≠, c/elementos esp.", normativa: "Art. 235 Cap. 9 Dec. 911/96" },
                        { num: 155, text: "Reforzados en sentido diagonal, longitudinal y transversalmente", normativa: "Art. 237 Cap. 9 Dec. 911/96" },
                        { num: 156, text: "Vinculados a una estructura fija, anclados al edificio 1 de c/ 2 montantes", normativa: "Art. 238 Cap. 9 dec. 911/96" }
                    ]
                },
                {
                    title: "SILLETAS (Dec. 911/96 - Cap. 9)",
                    questions: [
                        { num: 157, text: "Asientos de 0,60 x 0,30 mts. con topes para evitar golpes contra el muro", normativa: "Art. 239 Cap. 9 Dec. 911/96" },
                        { num: 158, text: "La eslinga o soga debe ser pasante, por lo menos por 4 agujeros o puntos", normativa: "Art. 240 inc. b) Cap. 9 dec. 911/96" },
                        { num: 159, text: "Uso de cintur√≥n de seguridad anclado a punto fijo independiente", normativa: "Art. 241 Cap. 9 Dec. 911/96" }
                    ]
                },
                {
                    title: "CABALLETES (Dec. 911/96 - Cap. 9)",
                    questions: [
                        { num: 160, text: "Dimensiones no inferiores a 0,70 mt. de ancho y 2,00 mts. de altura m√°ximo", normativa: "Art. 242 inc. a) Cap. 9 Dec. 911/96" }
                    ]
                },
                {
                    title: "PASARELAS Y RAMPAS (Dec. 911/96 - Cap. 9)",
                    questions: [
                        { num: 161, text: "Con algunas de sus partes a 2,00 mts. de altura debe tener un ancho de 0,60 mts., barandas y z√≥calos", normativa: "Art. 244 Cap. 9 Dec. 911/96" },
                        { num: 162, text: "Uso de listones de madera a manera de pelda√±os cada 0,50 mts.", normativa: "Art. 245 Cap. 9 Dec. 911/96" }
                    ]
                },
                {
                    title: "VEH√çCULOS Y MAQUINARIA AUTOMOTRIZ (Dec. 911/96 - Cap. 9)",
                    questions: [
                        { num: 163, text: "Para operaciones c/ m√°quinas el personal debe estar capacitado", normativa: "Art. 246 Cap. 9 Dec. 911/96" },
                        { num: 164, text: "Sistema de frenos luces frontales traseras y bocinas", normativa: "Art. 248 inc. a) Cap. 9 Dec. 911/96" },
                        { num: 165, text: "Espejos retrovisores, luces de marcha atr√°s, se√±al de marcha atr√°s audible, cintur√≥n de seguridad, marcas reflectantes", normativa: "Art. 248 inc. a) Cap. 9 Dec. 911/96" },
                        { num: 166, text: "R√≥tulo visible con indicaci√≥n de carga m√°xima", normativa: "Art. 249 Cap. 9 Dec. 911/96" },
                        { num: 167, text: "Todos los veh√≠culos llevar√°n obligatoriamente cintur√≥n de seguridad", normativa: "Art. 257 Cap. 9 Dec. 911/96" }
                    ]
                },
                {
                    title: "CAMIONES Y MAQUINARIA DE TRANSPORTE (Dec. 911/96 - Cap. 9)",
                    questions: [
                        { num: 168, text: "Los camiones volacadores deben tener obligatoriamente una visera", normativa: "Art. 261 Cap. 9 Dec. 911/96" }
                    ]
                },
                {
                    title: "HORMIGONERAS (Dec. 911/96 - Cap. 9)",
                    questions: [
                        { num: 169, text: "Todos los engranajes, cadenas protegidos", normativa: "Art. 262 Cap. 9 Dec. 911/96" }
                    ]
                },
                {
                    title: "APARATOS ELEVADORES Y EQUIPAMIENTOS VIALES (Dec. 911/96 - Cap. 9)",
                    questions: [
                        { num: 170, text: "Personal adiestrado y capacitado", normativa: "Art. 265 Cap. 9 Dec. 911/96" },
                        { num: 171, text: "C√≥digo de se√±ales para comunicarse, el √°rea de desplazamiento debe ser se√±alizada, prohibiendo el paso de personas mientras se ejecuta la tarea", normativa: "Art. 268 Cap. 9 Dec. 911/96" },
                        { num: 172, text: "Las cargas suspendidas deben ser guiadas por sogas", normativa: "Art. 271 Cap. 9 Dec. 911/96" },
                        { num: 173, text: "Riesgo para los trabajadores en la recepci√≥n de cargas a distinto nivel", normativa: "Art. 272 Cap. 9 Dec. 911/96" },
                        { num: 174, text: "Accionamiento autom√°tico de corte cuando sobrepasa altura o carga m√°xima", normativa: "Art. 273 Cap. 9 Dec. 911/96" }
                    ]
                },
                {
                    title: "CABINAS (Dec. 911/96 - Cap. 9)",
                    questions: [
                        { num: 175, text: "Deben tener resistencia contra la ca√≠da de objetos", normativa: "Art. 274 Cap. 9 Dec. 911/96" }
                    ]
                },
                {
                    title: "GR√öAS (Dec. 911/96 - Cap. 9)",
                    questions: [
                        { num: 176, text: "Cuando la gr√∫a requiera uso de apoyos no se debe operar con cargas", normativa: "Art. 278 Cap. 9 Dec. 911/96" }
                    ]
                },
                {
                    title: "AUTOELEVADORES (Dec. 911/96 - Cap. 9)",
                    questions: [
                        { num: 177, text: "No deben circular en superficies con desniveles que comprometan su estabilidad", normativa: "Art. 282 Cap. 9 Dec. 911/96" }
                    ]
                },
                {
                    title: "MONTACARGAS (Dec. 911/96 - Cap. 9)",
                    questions: [
                        { num: 178, text: "Huecos protegidos con mallas rejas para evitar ca√≠da de personas o cosas", normativa: "Art. 283 Cap. 9 Dec. 911/96" },
                        { num: 179, text: "Accesos al montacargas puertas resistentes o protecciones an√°logas", normativa: "Art. 284 Cap. 9 Dec. 911/96" }
                    ]
                },
                {
                    title: "ASCENSOR Y MONTACARGAS PARA PERSONAS (Dec. 911/96 - Cap. 9)",
                    questions: [
                        { num: 180, text: "Puertas con trabas electromec√°nicas", normativa: "Art. 288 inc. a) Cap. 9 Dec. 911/96" },
                        { num: 181, text: "Sistemas que provoquen la detenci√≥n inmediata y trabado contra las gu√≠as", normativa: "Art. 288 inc. e) Cap. Dec. 911/96" },
                        { num: 182, text: "Indicar peso m√°ximo y cantidad de pasajeros", normativa: "Art. 288 inc. f) Cap. 9 Dec. 911/96" }
                    ]
                },
                {
                    title: "CABLES, CADENAS, CUERDAS, GANCHOS Y ESLINGAS (Dec. 911/96 - Cap. 9)",
                    questions: [
                        { num: 183, text: "Deben ser ensayados antes de iniciar la obra, o se lo destine a otro uso", normativa: "Art. 289 inc. a y b) Cap. 9 Dec. 911/96" },
                        { num: 184, text: "Controles del estado con la periodicidad que indique el resp. de HyS", normativa: "Art. 289 inc. d) Cap. 9 Dec. 911/96" },
                        { num: 185, text: "Debe tener identificada la carga m√°xima", normativa: "Art 290 Cap. 9 Dec. 911/96" },
                        { num: 186, text: "Todo elemento defectuoso debe cambiarse, evitar contactos con cantos vivos", normativa: "Art. 292 Cap 9 Dec. 911/96" }
                    ]
                },
                {
                    title: "CABLES MET√ÅLICOS DE USO GENERAL (Dec. 911/96 - Cap. 9)",
                    questions: [
                        { num: 187, text: "No tendr√°n defectos visibles", normativa: "Art. 293 inc. c) Cap. 9 Dec. 911/96" },
                        { num: 188, text: "Deben ser lubricados peri√≥dicamente", normativa: "Art. 293 inc. e) Cap. 9 Dec. 911/96" }
                    ]
                },
                {
                    title: "CUERDAS (Dec. 911/96 - Cap. 9)",
                    questions: [
                        { num: 189, text: "Se deben reemplazar las que presentan desgastes", normativa: "Art. 295 Cap. 9 Dec. 911/96" },
                        { num: 190, text: "Almacenamiento no deben estar en contacto con tierra, arena, etc.", normativa: "Art. 296 Cap. 9 Dec. 911/96" },
                        { num: 191, text: "No deben emplearse cuando est√°n h√∫medas", normativa: "Art. 298 Cap. 9 Dec. 911/96" },
                        { num: 192, text: "Uso obligatorio de la tabla de resistencia al tracci√≥n", normativa: "Art. 301 Cap. 9 Dec. 911/96" }
                    ]
                },
                {
                    title: "CADENAS (Dec. 911/96 - Cap. 9)",
                    questions: [
                        { num: 193, text: "No deben usarse con eslabones deformados", normativa: "Art. 302 Cap. 9 Dec. 911/96" },
                        { num: 194, text: "Las poleas deben ser apropiadas al tipo de cadenas", normativa: "Art. 305 Cap. 9 Dec. 911/96" }
                    ]
                },
                {
                    title: "ESLINGAS (Dec. 911/96 - Cap. 9)",
                    questions: [
                        { num: 195, text: "Deben mantenerse limpias y lubricadas", normativa: "Art. 309 Cap. 9 Dec. 911/96" },
                        { num: 196, text: "Deben estar protegidas de cantos vivos", normativa: "Art. 311 Cap. 9 Dec. 911/96" }
                    ]
                },
                {
                    title: "ESLINGAS DE FIBRA SINT√âTICA (Dec. 911/96 - Cap. 9)",
                    questions: [
                        { num: 197, text: "No deben estar deshilachados", normativa: "Art. 319 inc. d) Cap. 9 Dec. 911/96" },
                        { num: 198, text: "Debe estar identificada la capacidad de carga", normativa: "Art. 321 Cap. 9 Dec. 911/96" }
                    ]
                },
                {
                    title: "SOLDADURA Y CORTE A GAS (Dec. 911/96 - Cap. 9)",
                    questions: [
                        { num: 199, text: "Protecci√≥n de personal de las radiaciones con pantallas", normativa: "Art. 341 Cap. 9 Dec. 911" }
                    ]
                },
                {
                    title: "REGULADORES (Dec. 911/96 - Cap. 9)",
                    questions: [
                        { num: 200, text: "Todos los reguladores para ox√≠geno u otros gases deben tener man√≥metro alta presi√≥n y baja presi√≥n", normativa: "Art. 351 Cap. 9 Dec. 911/96" }
                    ]
                },
                {
                    title: "MANGUERAS (Dec. 911/96 - Cap. 9)",
                    questions: [
                        { num: 201, text: "Estar protegidas c/el paso de veh√≠culos, contar con v√°lvula de bloqueo con abrazaderas", normativa: "Art. 355 Cap. 9 Dec. 311/96" }
                    ]
                },
                {
                    title: "COMPRESORES (Dec. 911/96 - Cap. 9)",
                    questions: [
                        { num: 202, text: "Con man√≥metros prot. c/ estallidos y con disposit. autom√°ticos que impidan sobrepasar la presi√≥n m√°xima de trabajo y con resguardos de partes m√≥viles", normativa: "Art. 361 Cap. 9 Dec. 911/96" }
                    ]
                },
                {
                    title: "CILINDROS DE GASES A PRESI√ìN (Dec. 911/96 - Cap. 9)",
                    questions: [
                        { num: 203, text: "Indicar contenido del cilindro en el cabezal y capuch√≥n", normativa: "Art. 362 inc. b) Cap. 9 Dec. 911/96" },
                        { num: 204, text: "Provistos de v√°lvulas con man√≥metros", normativa: "Art. 362 inc. c) Cap. 9 Dec. 911/96" },
                        { num: 205, text: "Almacenamiento bajo estrictas condiciones de seguridad apartados y sujetos a elementos fijos", normativa: "Art. 363 Cap. 9 Dec. 911/96" },
                        { num: 206, text: "Los cilindros deben estar protegidos de las variaciones de temperaturas y descargas el√©ctricas", normativa: "Art. 364 Cap. 9 Dec. 911/96" },
                        { num: 207, text: "Las conexiones a los cil√≠ndros deben tener abrazaderas", normativa: "Art. 366 Cap. 9 Dec. 911/96" }
                    ]
                },
                {
                    title: "REGISTROS (Resoluciones SRT)",
                    questions: [
                        { num: 208, text: "¬øEl establecimiento se encuentra comprendido dentro de la Resoluci√≥n 415/02 Registro de Agentes Cancer√≠genos?", normativa: "Res. 415/02 SRT" },
                        { num: 209, text: "¬øEl establecimiento se encuentra comprendido dentro de la Resoluci√≥n 497/03 Registro de PCBs?", normativa: "Res. 497/03 SRT" },
                        { num: 210, text: "¬øEl establecimiento se encuentra comprendido dentro de la Resoluci√≥n 743/03 Registro de Accidentes Mayores?", normativa: "Res. 743/03 SRT" }
                    ]
                }
            ],
            planillaA: [
                "4 aminobifenilo",
                "Ars√©nico y sus compuestos",
                "Amianto (asbesto)",
                "Benceno",
                "Bencidina",
                "Berilio y sus compuestos",
                "Clorometil metil eter, grado tecnico en conjunto con bis (clorometil) eter",
                "Cadmio y compuestos",
                "Cloruro de vinilo",
                "Cromo hexavalente y sus compuestos",
                "Beta Naftilamina / 2-Naftilamina",
                "√ìxido de etileno",
                "Gas mostaza",
                "N√≠quel y sus compuestos",
                "Rad√≥n-222 y sus productos de decaimiento",
                "Silice (inhalado en forma de cuarzo o cristobalita de origen ocupacional)",
                "Talco conteniendo fibras asbestiformes",
                "Alquitranes",
                "Asfaltos",
                "Holl√≠n",
                "Aceites minerales (no tratados o ligeramente tratados)",
                "Alcohol isoprop√≠lico (manufactura por el m√©todo de los √°cidos fuertes)",
                "Auramina, manufactura de",
                "Hematita, miner√≠a de profundidad con exposici√≥n al rad√≥n",
                "Magenta, manufactura de"
            ],
            planillaB: [
                "Aceclor", "Adkarel", "ALC", "Apirolio", "Arochlor", "Aroclor", "Arubren", "Asbestol", "ASK", "Askael", "Askarel", 
                "Auxol", "Bakola", "Biphenyl, chlorinated", "Chlophen", "Chloretol", "Chlorextol", "Chlorinated biphenyl", "Chlorinated diphenyl",
                "Chlorinol", "Chlorobiphenyl", "Chlorodiphenyl", "Chlorphen", "Chorextol", "Chorinol", "Clophen", "Clophenharz", "Cloresil",
                "Clorinal", "Clorphen", "Decachlorodiphenyl", "Delor", "Delorene", "Diaclor", "Dicolor", "Diconal", "Diphenyl, chlorinated",
                "DK", "Duconal", "Dykanol", "Educarel", "EEC-18", "Elaol", "Electrophenyl", "Elemex", "Elinol", "Eucarel", "Fenchlor",
                "Fenclor", "Fenocloro", "Gilotherm", "Hydol", "Hyrol", "Hyvol", "Inclor", "Inerteen", "Inertenn", "Kanechlor", "Kaneclor",
                "Kennechlor", "Kenneclor", "Leromoll", "Magvar", "MCS 1489", "Montar", "Nepolin", "No-Flamol", "NoFlamol", "Non-Flamol",
                "Olex-sf-d", "Orophene", "PCB", "PCB's", "PCBs", "Pheaoclor", "Phenochlor", "Phenoclor", "Plastivar", "Polychlorinated biphenyl",
                "Polychlorinated biphenyls", "Polychlorinated diphenyl", "Polychlorinated diphenyls", "Polychlorobiphenyl", "Polychlorodiphenyl",
                "Prodelec", "Pydraul", "Pyraclor", "Pyralene", "Pyranol", "Pyroclor", "Pyronol", "Saf-T-Kuhl", "Saf-T-Kohl", "Santosol",
                "Santotherm", "Santothern", "Santovac", "Solvol", "Sorol", "Soval", "Sovol", "Sovtol", "Terphenychlore", "Therminal",
                "Therminol", "Turbinol"
            ],
            planillaC: [
                { nombre: "Nitrato de amonio", umbral: "350" },
                { nombre: "Pent√≥xido de ars√©nico, √°cido ars√©nico (V) y-o sus sales", umbral: "1" },
                { nombre: "Tri√≥xido de ars√©nico, √°cido ars√©nico (III) y-o sus sales", umbral: "0.1" },
                { nombre: "Bromo", umbral: "20" },
                { nombre: "Cloro", umbral: "10" },
                { nombre: "Compuestos de n√≠quel en forma pulverulenta inhalable (mon√≥xido de n√≠quel, di√≥xido de n√≠quel, sulfuro de n√≠quel, disulfuro de trin√≠quel, tri√≥xido de din√≠quel)", umbral: "1" },
                { nombre: "Etilenimina", umbral: "10" },
                { nombre: "Fl√∫or", umbral: "10" },
                { nombre: "Formaldehido (concentraci√≥n ‚â• 90 por 100)", umbral: "5" },
                { nombre: "Hidr√≥geno", umbral: "5" },
                { nombre: "Acido clorh√≠drico (gas licuado)", umbral: "25" },
                { nombre: "Alquilos de plomo", umbral: "5" },
                { nombre: "Gases licuados extremadamente inflamables (incluidos GPL) y gas natural", umbral: "50" },
                { nombre: "Acetileno", umbral: "5" },
                { nombre: "√ìxido de etileno", umbral: "5" },
                { nombre: "√ìxido de propileno", umbral: "5" },
                { nombre: "Metanol", umbral: "500" },
                { nombre: "4,4 metilen-bis (2-cloroanilina) y-o sus sales en forma pulverulenta", umbral: "0.01" },
                { nombre: "Isocianato de metilo", umbral: "0.15" },
                { nombre: "Ox√≠geno", umbral: "200" },
                { nombre: "Diisocianato de tolueno", umbral: "10" },
                { nombre: "Dicloruro de carbonilo (fosgeno)", umbral: "0.3" },
                { nombre: "Trihidruro de ars√©nico (arsina)", umbral: "0.2" },
                { nombre: "Trihidruro de f√≥sforo (fosfina)", umbral: "0.2" },
                { nombre: "Dicloruro de azufre", umbral: "1" },
                { nombre: "Tri√≥xido de azufre", umbral: "15" },
                { nombre: "Policlorodibenzofuranos y p√≥liclorodibenzodioxinas (incluida la TCDD) calculadas en equivalente TCDD", umbral: "0.001" },
                { nombre: "Las siguientes sustancias cancer√≠genas: 4. Aminodifenilo y-o sus sales, Bencidina y-o sus sales, √âter bis (cloromet√≠lico), Clorometil metil √©ter, Cloruro de dimetil carbamoilo, Dimetilnitrosamina, Triamida hexametilfosf√≥rica, 2-Naftilamina y-o sus sales y 4-nitrofenil 1,3-Propanosultona", umbral: "0.001" },
                { nombre: "Naftas y otros cortes livianos", umbral: "5.000" }
            ]
        };

        let rgrlResponses = {};
        let currentRGRLId = null;

        // Funci√≥n para formatear fechas
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString + 'T00:00:00');
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function initRGRL() {
            if (!currentEstablishment) {
                alert('Seleccione un establecimiento primero');
                showHome();
                return;
            }
            
            // Mostrar lista de formularios y ocultar el formulario
            document.getElementById('rgrlListContainer').classList.remove('hidden');
            document.getElementById('rgrlFormContainer').classList.add('hidden');
            
            // Cargar lista de formularios guardados
            loadRGRLList();
        }

        function loadRGRLList() {
            const listContainer = document.getElementById('rgrlFormsList');
            const key = `rgrl_list_${currentEstablishment.id}`;
            const savedList = localStorage.getItem(key);
            
            let formularios = savedList ? JSON.parse(savedList) : [];
            
            if (formularios.length === 0) {
                listContainer.innerHTML = `
                    <div class="bg-gray-50 border border-gray-300 rounded-lg p-6 text-center">
                        <p class="text-gray-600">No hay formularios guardados. Haz clic en "Nuevo Formulario" para comenzar.</p>
                    </div>
                `;
                return;
            }
            
            listContainer.innerHTML = formularios.map(form => `
                <div class="bg-white border border-gray-300 rounded-lg p-4 hover:shadow-md transition">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <h4 class="font-bold text-lg text-gray-800">${form.datosEstablecimiento.nombre || 'Sin nombre'}</h4>
                            <p class="text-sm text-gray-600">CUIT: ${form.datosEstablecimiento.cuit || 'N/A'}</p>
                            <p class="text-sm text-gray-500">Fecha: ${formatDate(form.fecha.split('T')[0])}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editRGRLForm('${form.id}')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition text-sm">
                                ‚úèÔ∏è Editar
                            </button>
                            <button onclick="deleteRGRLForm('${form.id}')" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold transition text-sm">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showNewRGRLForm(isEditing = false) {
            // Solo limpiar si NO estamos editando
            if (!isEditing) {
                currentRGRLId = null;
                rgrlResponses = {};
                
                // Limpiar campos del establecimiento
                document.getElementById('rgrlEmpresaNombre').value = '';
                document.getElementById('rgrlCuit').value = '';
                document.getElementById('rgrlNumEstablecimiento').value = '';
                document.getElementById('rgrlCiiu').value = '';
                document.getElementById('rgrlSuperficie').value = '';
                document.getElementById('rgrlCodigoActividad').value = '';
                document.getElementById('rgrlCantTrabajadores').value = '';
                document.getElementById('rgrlDescActividad').value = '';
                document.getElementById('rgrlDomicilio').value = '';
                document.getElementById('rgrlProvincia').value = '';
                document.getElementById('rgrlCodigoPostal').value = '';
                document.getElementById('rgrlLocalidad').value = '';
                document.getElementById('rgrlTelefono').value = '';
            }
            
            // Mostrar formulario y ocultar lista
            document.getElementById('rgrlListContainer').classList.add('hidden');
            document.getElementById('rgrlFormContainer').classList.remove('hidden');
            
            // Inicializar tablas del formulario
            const container = document.getElementById('rgrlTablesContainer');
            container.innerHTML = '';
            
            RGRL_DATA.sections.forEach((section, sectionIndex) => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'border border-gray-300 rounded-lg p-4';
                
                const title = document.createElement('h3');
                title.className = 'font-bold text-lg mb-4 bg-gray-100 p-2 rounded';
                title.textContent = section.title;
                sectionDiv.appendChild(title);
                
                const tableDiv = document.createElement('div');
                tableDiv.className = 'overflow-x-auto';
                
                const table = document.createElement('table');
                table.className = 'w-full text-sm border-collapse';
                
                // Header
                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr class="bg-gray-200">
                        <th class="border border-gray-300 p-2 text-left w-10">N¬∞</th>
                        <th class="border border-gray-300 p-2 text-left">Condici√≥n a Cumplir</th>
                        <th class="border border-gray-300 p-2 text-center w-20">S√ç</th>
                        <th class="border border-gray-300 p-2 text-center w-20">NO</th>
                        <th class="border border-gray-300 p-2 text-center w-24">NO APLICA</th>
                        <th class="border border-gray-300 p-2 text-center w-40">Fecha Regular.</th>
                        <th class="border border-gray-300 p-2 text-left w-48">Normativa</th>
                    </tr>
                `;
                table.appendChild(thead);
                
                // Body
                const tbody = document.createElement('tbody');
                section.questions.forEach(q => {
                    const row = document.createElement('tr');
                    const key = `q${q.num}`;
                    const saved = rgrlResponses[key] || {};
                    
                    row.innerHTML = `
                        <td class="border border-gray-300 p-2 text-center font-semibold">${q.num}</td>
                        <td class="border border-gray-300 p-2">${q.text}</td>
                        <td class="border border-gray-300 p-2 text-center">
                            <input type="radio" name="${key}" value="si" ${saved.respuesta === 'si' ? 'checked' : ''} 
                                   onchange="updateRGRLResponse('${key}', 'respuesta', 'si')" class="w-4 h-4">
                        </td>
                        <td class="border border-gray-300 p-2 text-center">
                            <input type="radio" name="${key}" value="no" ${saved.respuesta === 'no' ? 'checked' : ''} 
                                   onchange="updateRGRLResponse('${key}', 'respuesta', 'no')" class="w-4 h-4">
                        </td>
                        <td class="border border-gray-300 p-2 text-center">
                            <input type="radio" name="${key}" value="na" ${saved.respuesta === 'na' ? 'checked' : ''} 
                                   onchange="updateRGRLResponse('${key}', 'respuesta', 'na')" class="w-4 h-4">
                        </td>
                        <td class="border border-gray-300 p-2 text-center">
                            <input type="date" value="${saved.fecha || ''}" 
                                   onchange="updateRGRLResponse('${key}', 'fecha', this.value)" 
                                   class="border border-gray-300 rounded px-2 py-1 text-xs w-full">
                        </td>
                        <td class="border border-gray-300 p-2 text-xs">${q.normativa}</td>
                    `;
                    tbody.appendChild(row);
                });
                table.appendChild(tbody);
                
                tableDiv.appendChild(table);
                sectionDiv.appendChild(tableDiv);
                container.appendChild(sectionDiv);
            });
            
            // Inicializar Planilla A
            initPlanillaA();
            
            // Inicializar Planilla B
            initPlanillaB();
            
            // Inicializar Planilla C
            initPlanillaC();
        }

        function editRGRLForm(formId) {
            const key = `rgrl_list_${currentEstablishment.id}`;
            const savedList = localStorage.getItem(key);
            const formularios = savedList ? JSON.parse(savedList) : [];
            
            const form = formularios.find(f => f.id === formId);
            if (!form) {
                alert('Formulario no encontrado');
                return;
            }
            
            currentRGRLId = formId;
            rgrlResponses = form.responses || {};
            
            // Cargar datos del establecimiento
            document.getElementById('rgrlEmpresaNombre').value = form.datosEstablecimiento.nombre || '';
            document.getElementById('rgrlCuit').value = form.datosEstablecimiento.cuit || '';
            document.getElementById('rgrlNumEstablecimiento').value = form.datosEstablecimiento.numEstablecimiento || '';
            document.getElementById('rgrlCiiu').value = form.datosEstablecimiento.ciiu || '';
            document.getElementById('rgrlSuperficie').value = form.datosEstablecimiento.superficie || '';
            document.getElementById('rgrlCodigoActividad').value = form.datosEstablecimiento.codigoActividad || '';
            document.getElementById('rgrlCantTrabajadores').value = form.datosEstablecimiento.cantTrabajadores || '';
            document.getElementById('rgrlDescActividad').value = form.datosEstablecimiento.descActividad || '';
            document.getElementById('rgrlDomicilio').value = form.datosEstablecimiento.domicilio || '';
            document.getElementById('rgrlProvincia').value = form.datosEstablecimiento.provincia || '';
            document.getElementById('rgrlCodigoPostal').value = form.datosEstablecimiento.codigoPostal || '';
            document.getElementById('rgrlLocalidad').value = form.datosEstablecimiento.localidad || '';
            document.getElementById('rgrlTelefono').value = form.datosEstablecimiento.telefono || '';
            
            // Mostrar formulario con isEditing=true para NO limpiar las respuestas
            showNewRGRLForm(true);
        }

        function deleteRGRLForm(formId) {
            if (!confirm('¬øEst√° seguro de que desea eliminar este formulario?')) {
                return;
            }
            
            const key = `rgrl_list_${currentEstablishment.id}`;
            const savedList = localStorage.getItem(key);
            let formularios = savedList ? JSON.parse(savedList) : [];
            
            formularios = formularios.filter(f => f.id !== formId);
            localStorage.setItem(key, JSON.stringify(formularios));
            
            loadRGRLList();
            alert('‚úÖ Formulario eliminado correctamente');
        }

        function cancelRGRLForm() {
            if (confirm('¬øDesea cancelar? Los cambios no guardados se perder√°n.')) {
                // Limpiar el estado actual
                currentRGRLId = null;
                rgrlResponses = {};
                
                // Volver a la vista de lista
                document.getElementById('rgrlListContainer').classList.remove('hidden');
                document.getElementById('rgrlFormContainer').classList.add('hidden');
                loadRGRLList();
            }
        }

        function initPlanillaA() {
            const tbody = document.getElementById('planillaATable');
            tbody.innerHTML = '';
            
            RGRL_DATA.planillaA.forEach((item, index) => {
                const key = `planillaA_${index}`;
                const saved = rgrlResponses[key] || '';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="border border-gray-300 p-2">${item}</td>
                    <td class="border border-gray-300 p-2 text-center">
                        <input type="radio" name="${key}" value="si" ${saved === 'si' ? 'checked' : ''} 
                               onchange="updateRGRLResponse('${key}', 'value', 'si')" class="w-4 h-4">
                    </td>
                    <td class="border border-gray-300 p-2 text-center">
                        <input type="radio" name="${key}" value="no" ${saved === 'no' ? 'checked' : ''} 
                               onchange="updateRGRLResponse('${key}', 'value', 'no')" class="w-4 h-4">
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function initPlanillaB() {
            const tbody = document.getElementById('planillaBTable');
            tbody.innerHTML = '';
            
            const itemsPerColumn = Math.ceil(RGRL_DATA.planillaB.length / 3);
            let column1 = '', column2 = '', column3 = '';
            
            RGRL_DATA.planillaB.forEach((item, index) => {
                const key = `planillaB_${index}`;
                const saved = rgrlResponses[key] || '';
                
                const row = `
                    <tr>
                        <td class="border border-gray-300 p-2">${item}</td>
                        <td class="border border-gray-300 p-2 text-center">
                            <input type="radio" name="${key}" value="si" ${saved === 'si' ? 'checked' : ''} 
                                   onchange="updateRGRLResponse('${key}', 'value', 'si')" class="w-4 h-4">
                        </td>
                        <td class="border border-gray-300 p-2 text-center">
                            <input type="radio" name="${key}" value="no" ${saved === 'no' ? 'checked' : ''} 
                                   onchange="updateRGRLResponse('${key}', 'value', 'no')" class="w-4 h-4">
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function initPlanillaC() {
            const tbody = document.getElementById('planillaCTable');
            tbody.innerHTML = '';
            
            RGRL_DATA.planillaC.forEach((item, index) => {
                const key = `planillaC_${index}`;
                const saved = rgrlResponses[key] || '';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="border border-gray-300 p-2">${item.nombre}</td>
                    <td class="border border-gray-300 p-2 text-center font-semibold">${item.umbral}</td>
                    <td class="border border-gray-300 p-2 text-center">
                        <input type="radio" name="${key}" value="si" ${saved === 'si' ? 'checked' : ''} 
                               onchange="updateRGRLResponse('${key}', 'value', 'si')" class="w-4 h-4">
                    </td>
                    <td class="border border-gray-300 p-2 text-center">
                        <input type="radio" name="${key}" value="no" ${saved === 'no' ? 'checked' : ''} 
                               onchange="updateRGRLResponse('${key}', 'value', 'no')" class="w-4 h-4">
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateRGRLResponse(key, field, value) {
            // Esta funci√≥n maneja dos tipos de respuestas:
            // 1. Para Planillas A, B, C: field='value', guarda el valor directamente como string ('si' o 'no')
            // 2. Para formulario principal: field='respuesta' o 'fecha', guarda como objeto { respuesta: '...', fecha: '...' }
            
            if (!rgrlResponses[key]) {
                rgrlResponses[key] = {};
            }
            
            if (field === 'value') {
                // Para Planillas A, B, C guardamos el valor directamente como string
                rgrlResponses[key] = value;
            } else {
                // Para el formulario principal guardamos como objeto con campos
                rgrlResponses[key][field] = value;
            }
        }

        function saveRGRLForm() {
            if (!currentEstablishment) {
                alert('‚ö†Ô∏è Seleccione un establecimiento primero');
                return;
            }
            
            // Validar campos requeridos
            const nombre = document.getElementById('rgrlEmpresaNombre').value.trim();
            const cuit = document.getElementById('rgrlCuit').value.trim();
            const ciiu = document.getElementById('rgrlCiiu').value.trim();
            const descActividad = document.getElementById('rgrlDescActividad').value.trim();
            const domicilio = document.getElementById('rgrlDomicilio').value.trim();
            
            if (!nombre || !cuit || !ciiu || !descActividad || !domicilio) {
                alert('‚ö†Ô∏è Por favor complete todos los campos requeridos (*) de Datos Generales del Establecimiento');
                return;
            }
            
            // Recopilar datos del establecimiento
            const datosEstablecimiento = {
                nombre: nombre,
                cuit: cuit,
                numEstablecimiento: document.getElementById('rgrlNumEstablecimiento').value,
                ciiu: ciiu,
                superficie: document.getElementById('rgrlSuperficie').value,
                codigoActividad: document.getElementById('rgrlCodigoActividad').value,
                cantTrabajadores: document.getElementById('rgrlCantTrabajadores').value,
                descActividad: descActividad,
                domicilio: domicilio,
                provincia: document.getElementById('rgrlProvincia').value,
                codigoPostal: document.getElementById('rgrlCodigoPostal').value,
                localidad: document.getElementById('rgrlLocalidad').value,
                telefono: document.getElementById('rgrlTelefono').value
            };
            
            // Crear o actualizar formulario
            const formId = currentRGRLId || `rgrl_${Date.now()}`;
            const formData = {
                id: formId,
                fecha: new Date().toISOString(),
                datosEstablecimiento: datosEstablecimiento,
                responses: JSON.parse(JSON.stringify(rgrlResponses)), // Copia profunda para evitar referencias
                establecimiento: currentEstablishment.id
            };
            
            // Obtener lista de formularios
            const listKey = `rgrl_list_${currentEstablishment.id}`;
            const savedList = localStorage.getItem(listKey);
            let formularios = savedList ? JSON.parse(savedList) : [];
            
            // Actualizar o agregar formulario
            const existingIndex = formularios.findIndex(f => f.id === formId);
            if (existingIndex >= 0) {
                formularios[existingIndex] = formData;
                alert('‚úÖ Formulario RGRL actualizado correctamente');
            } else {
                formularios.push(formData);
                alert('‚úÖ Formulario RGRL guardado correctamente');
            }
            
            // Guardar en localStorage
            try {
                localStorage.setItem(listKey, JSON.stringify(formularios));
            } catch (e) {
                alert('‚ùå Error al guardar: ' + e.message);
                return;
            }
            
            // Resetear el ID actual y volver a la lista
            currentRGRLId = null;
            rgrlResponses = {};
            document.getElementById('rgrlListContainer').classList.remove('hidden');
            document.getElementById('rgrlFormContainer').classList.add('hidden');
            loadRGRLList();
        }

        function loadRGRLData() {
            // Esta funci√≥n ya no se usa, se reemplaz√≥ por loadRGRLList
        }

        function exportRGRLToPDF() {
            if (!currentEstablishment) {
                alert('Seleccione un establecimiento primero');
                return;
            }
            
            // Validar datos del establecimiento
            const nombre = document.getElementById('rgrlEmpresaNombre').value.trim();
            const cuit = document.getElementById('rgrlCuit').value.trim();
            
            if (!nombre || !cuit) {
                alert('‚ö†Ô∏è Por favor complete los datos del establecimiento antes de exportar');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Funci√≥n auxiliar para agregar el header en cada p√°gina
            function addHeader() {
                doc.setFillColor(30, 64, 175);
                doc.rect(0, 0, 210, 35, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('RELEVAMIENTO GENERAL DE RIESGOS LABORALES', 105, 13, { align: 'center' });
                doc.setFontSize(12);
                doc.text('FORMULARIO A - RGRL', 105, 21, { align: 'center' });
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                doc.text('Sistema de Seguridad e Higiene', 15, 30);
                doc.text(`Fecha: ${formatDate(new Date().toISOString().split('T')[0])}`, 165, 30);
                
                // Resetear color de texto a negro despu√©s del header
                doc.setTextColor(0, 0, 0);
            }
            
            // Primera p√°gina con header
            addHeader();
            
            // Datos del Establecimiento
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('DATOS GENERALES DEL ESTABLECIMIENTO', 15, 42);
            
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            let y = 47;
            doc.text(`Nombre: ${document.getElementById('rgrlEmpresaNombre').value}`, 15, y);
            y += 4;
            doc.text(`CUIT: ${document.getElementById('rgrlCuit').value}`, 15, y);
            doc.text(`N Establecimiento: ${document.getElementById('rgrlNumEstablecimiento').value || 'N/A'}`, 115, y);
            y += 4;
            doc.text(`CIIU: ${document.getElementById('rgrlCiiu').value}`, 15, y);
            doc.text(`Superficie: ${document.getElementById('rgrlSuperficie').value || 'N/A'} m2`, 115, y);
            y += 4;
            doc.text(`Codigo Actividad: ${document.getElementById('rgrlCodigoActividad').value || 'N/A'}`, 15, y);
            doc.text(`Cant. Trabajadores: ${document.getElementById('rgrlCantTrabajadores').value || 'N/A'}`, 115, y);
            y += 4;
            doc.text(`Actividad: ${document.getElementById('rgrlDescActividad').value}`, 15, y);
            y += 4;
            doc.text(`Domicilio: ${document.getElementById('rgrlDomicilio').value}`, 15, y);
            y += 4;
            doc.text(`Provincia: ${document.getElementById('rgrlProvincia').value || 'N/A'}`, 15, y);
            doc.text(`Localidad: ${document.getElementById('rgrlLocalidad').value || 'N/A'}`, 75, y);
            doc.text(`CP: ${document.getElementById('rgrlCodigoPostal').value || 'N/A'}`, 135, y);
            y += 4;
            doc.text(`Telefono: ${document.getElementById('rgrlTelefono').value || 'N/A'}`, 15, y);
            
            y += 6;
            doc.setDrawColor(200, 200, 200);
            doc.line(15, y, 195, y);
            y += 6;
            
            // Recorrer todas las secciones del formulario principal
            RGRL_DATA.sections.forEach((section, sectionIdx) => {
                if (y > 268) {
                    doc.addPage();
                    addHeader();
                    y = 42;
                }
                
                // T√≠tulo de secci√≥n con fondo morado (igual que las planillas)
                doc.setFillColor(220, 200, 255);
                doc.rect(15, y-4, 180, 7, 'F');
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.text(section.title, 105, y, { align: 'center' });
                y += 6;
                
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                
                section.questions.forEach((q, qIdx) => {
                    const key = `q${q.num}`;
                    const response = rgrlResponses[key] || {};
                    
                    if (y > 273) {
                        doc.addPage();
                        addHeader();
                        y = 42;
                    }
                    
                    // Dividir texto largo en m√∫ltiples l√≠neas
                    const lines = doc.splitTextToSize(`${q.num}. ${q.text}`, 155);
                    lines.forEach((line, lineIdx) => {
                        if (y > 273) {
                            doc.addPage();
                            addHeader();
                            y = 42;
                        }
                        doc.text(line, 17, y);
                        y += 3.5;
                    });
                    
                    const respText = response.respuesta ? response.respuesta.toUpperCase() : 'NO RESPONDIDA';
                    doc.text(`Resp: ${respText}`, 20, y);
                    if (response.fecha) {
                        doc.text(`Fecha Reg.: ${formatDate(response.fecha)}`, 70, y);
                    }
                    y += 4;
                });
                y += 2;
            });
            
            // AGREGAR PLANILLAS A, B Y C
            
            // PLANILLA A: Sustancias Cancer√≠genas
            doc.addPage();
            addHeader();
            y = 42;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.setFillColor(220, 200, 255);
            doc.rect(15, y-4, 180, 7, 'F');
            doc.setTextColor(0, 0, 0);
            doc.text('PLANILLA A | LISTADO DE SUSTANCIAS Y AGENTES CANCERIGENOS', 105, y, { align: 'center' });
            y += 7;
            
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            
            RGRL_DATA.planillaA.forEach((item, index) => {
                if (y > 273) {
                    doc.addPage();
                    addHeader();
                    y = 42;
                }
                
                const key = `planillaA_${index}`;
                const saved = rgrlResponses[key] || 'NO RESPONDIDA';
                
                const lines = doc.splitTextToSize(item, 155);
                lines.forEach((line, lineIdx) => {
                    if (y > 273) {
                        doc.addPage();
                        addHeader();
                        y = 42;
                    }
                    doc.text(line, 17, y);
                    y += 3.5;
                });
                
                doc.text(`Resp: ${saved.toString().toUpperCase()}`, 170, y-3.5);
                y += 1;
            });
            
            // PLANILLA B: Difenilos Policlorados
            doc.addPage();
            addHeader();
            y = 42;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.setFillColor(220, 200, 255);
            doc.rect(15, y-4, 180, 7, 'F');
            doc.setTextColor(0, 0, 0);
            doc.text('PLANILLA B | DIFENILOS POLICLORADOS (PCBs)', 105, y, { align: 'center' });
            y += 7;
            
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            
            RGRL_DATA.planillaB.forEach((item, index) => {
                if (y > 273) {
                    doc.addPage();
                    addHeader();
                    y = 42;
                }
                
                const key = `planillaB_${index}`;
                const saved = rgrlResponses[key] || 'NO RESPONDIDA';
                
                const lines = doc.splitTextToSize(item, 155);
                lines.forEach((line, lineIdx) => {
                    if (y > 273) {
                        doc.addPage();
                        addHeader();
                        y = 42;
                    }
                    doc.text(line, 17, y);
                    y += 3.5;
                });
                
                doc.text(`Resp: ${saved.toString().toUpperCase()}`, 170, y-3.5);
                y += 1;
            });
            
            // PLANILLA C: Sustancias Qu√≠micas
            doc.addPage();
            addHeader();
            y = 42;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.setFillColor(220, 200, 255);
            doc.rect(15, y-4, 180, 7, 'F');
            doc.setTextColor(0, 0, 0);
            doc.text('PLANILLA C | SUSTANCIAS QUIMICAS A DECLARAR', 105, y, { align: 'center' });
            y += 7;
            
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            
            RGRL_DATA.planillaC.forEach((item, index) => {
                if (y > 273) {
                    doc.addPage();
                    addHeader();
                    y = 42;
                }
                
                const key = `planillaC_${index}`;
                const saved = rgrlResponses[key] || 'NO RESPONDIDA';
                
                const lines = doc.splitTextToSize(item.nombre, 135);
                lines.forEach((line, lineIdx) => {
                    if (y > 273) {
                        doc.addPage();
                        addHeader();
                        y = 42;
                    }
                    doc.text(line, 17, y);
                    y += 3.5;
                });
                
                doc.text(`Umbral: ${item.umbral} TN`, 145, y-3.5);
                doc.text(`Resp: ${saved.toString().toUpperCase()}`, 175, y-3.5);
                y += 1;
            });
            
            // Pie de p√°gina en todas las p√°ginas
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                doc.text(`Pagina ${i} de ${pageCount}`, 105, 290, { align: 'center' });
            }
            
            const fileName = `RGRL-${nombre.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
        }

        // ============= RGRL OBRAS FUNCTIONS =============
        
        function loadRGRLObrasFromLocalStorage() {
            const savedForms = JSON.parse(localStorage.getItem('rgrlObrasFormularios')) || [];
            const container = document.getElementById('rgrlObrasFormsList');
            
            if (savedForms.length === 0) {
                container.innerHTML = '<p class="text-gray-500 italic">No hay formularios guardados</p>';
                return;
            }
            
            container.innerHTML = savedForms.map((form, index) => `
                <div class="border border-gray-300 rounded-lg p-4 bg-white hover:shadow-md transition">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <h4 class="font-bold text-lg">${form.datosGenerales.empresaNombre}</h4>
                            <p class="text-sm text-gray-600">CUIT: ${form.datosGenerales.cuit} | Fecha: ${new Date(form.fechaCreacion).toLocaleDateString()}</p>
                            <p class="text-sm text-gray-600">Domicilio: ${form.datosGenerales.domicilio}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editRGRLObrasForm(${index})" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition text-sm">
                                ‚úèÔ∏è Editar
                            </button>
                            <button onclick="exportRGRLObrasFormToPDF(${index})" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition text-sm">
                                <i class="fas fa-file-alt"></i> PDF
                            </button>
                            <button onclick="deleteRGRLObrasForm(${index})" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold transition text-sm">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function showNewRGRLObrasForm(isEditing = false) {
            document.getElementById('rgrlObrasListContainer').classList.add('hidden');
            document.getElementById('rgrlObrasFormContainer').classList.remove('hidden');
            
            if (!isEditing) {
                // Limpiar formulario
                document.getElementById('rgrlObrasEmpresaNombre').value = '';
                document.getElementById('rgrlObrasCuit').value = '';
                document.getElementById('rgrlObrasNumEstablecimiento').value = '';
                document.getElementById('rgrlObrasCiiu').value = '';
                document.getElementById('rgrlObrasSuperficie').value = '';
                document.getElementById('rgrlObrasCodigoActividad').value = '';
                document.getElementById('rgrlObrasCantTrabajadores').value = '';
                document.getElementById('rgrlObrasDescActividad').value = '';
                document.getElementById('rgrlObrasDomicilio').value = '';
                document.getElementById('rgrlObrasProvincia').value = '';
                document.getElementById('rgrlObrasCodigoPostal').value = '';
                document.getElementById('rgrlObrasLocalidad').value = '';
                document.getElementById('rgrlObrasTelefono').value = '';
            }
            
            renderRGRLObrasForm();
        }
        
        function cancelRGRLObrasForm() {
            document.getElementById('rgrlObrasListContainer').classList.remove('hidden');
            document.getElementById('rgrlObrasFormContainer').classList.add('hidden');
            currentEditingRGRLObrasIndex = null;
        }
        
        let currentEditingRGRLObrasIndex = null;
        
        function editRGRLObrasForm(index) {
            const savedForms = JSON.parse(localStorage.getItem('rgrlObrasFormularios')) || [];
            const form = savedForms[index];
            currentEditingRGRLObrasIndex = index;
            
            // Llenar datos generales
            document.getElementById('rgrlObrasEmpresaNombre').value = form.datosGenerales.empresaNombre || '';
            document.getElementById('rgrlObrasCuit').value = form.datosGenerales.cuit || '';
            document.getElementById('rgrlObrasNumEstablecimiento').value = form.datosGenerales.numEstablecimiento || '';
            document.getElementById('rgrlObrasCiiu').value = form.datosGenerales.ciiu || '';
            document.getElementById('rgrlObrasSuperficie').value = form.datosGenerales.superficie || '';
            document.getElementById('rgrlObrasCodigoActividad').value = form.datosGenerales.codigoActividad || '';
            document.getElementById('rgrlObrasCantTrabajadores').value = form.datosGenerales.cantTrabajadores || '';
            document.getElementById('rgrlObrasDescActividad').value = form.datosGenerales.descActividad || '';
            document.getElementById('rgrlObrasDomicilio').value = form.datosGenerales.domicilio || '';
            document.getElementById('rgrlObrasProvincia').value = form.datosGenerales.provincia || '';
            document.getElementById('rgrlObrasCodigoPostal').value = form.datosGenerales.codigoPostal || '';
            document.getElementById('rgrlObrasLocalidad').value = form.datosGenerales.localidad || '';
            document.getElementById('rgrlObrasTelefono').value = form.datosGenerales.telefono || '';
            
            // Guardar respuestas en variable temporal
            window.currentRGRLObrasResponses = form.respuestas;
            
            showNewRGRLObrasForm(true);
        }
        
        function deleteRGRLObrasForm(index) {
            if (confirm('¬øEst√° seguro de que desea eliminar este formulario?')) {
                const savedForms = JSON.parse(localStorage.getItem('rgrlObrasFormularios')) || [];
                savedForms.splice(index, 1);
                localStorage.setItem('rgrlObrasFormularios', JSON.stringify(savedForms));
                loadRGRLObrasFromLocalStorage();
            }
        }
        
        function renderRGRLObrasForm() {
            const container = document.getElementById('rgrlObrasTablesContainer');
            container.innerHTML = '';
            
            RGRL_OBRAS_DATA.sections.forEach((section, sectionIdx) => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'border border-gray-300 rounded-lg p-4 mb-6';
                
                const sectionTitle = document.createElement('h3');
                sectionTitle.className = 'font-bold text-lg mb-4 bg-yellow-100 p-2 rounded';
                sectionTitle.textContent = section.title;
                sectionDiv.appendChild(sectionTitle);
                
                const table = document.createElement('table');
                table.className = 'w-full text-sm border-collapse';
                table.innerHTML = `
                    <thead>
                        <tr class="bg-gray-200">
                            <th class="border border-gray-300 p-2 text-left">N¬∫</th>
                            <th class="border border-gray-300 p-2 text-left">Condiciones a Cumplir</th>
                            <th class="border border-gray-300 p-2 text-center w-20">S√ç</th>
                            <th class="border border-gray-300 p-2 text-center w-20">NO</th>
                            <th class="border border-gray-300 p-2 text-center w-28">NO APLICA</th>
                            <th class="border border-gray-300 p-2 text-center w-32">Fecha Reg.</th>
                        </tr>
                    </thead>
                    <tbody id="rgrlObrasSection${sectionIdx}"></tbody>
                `;
                
                sectionDiv.appendChild(table);
                container.appendChild(sectionDiv);
                
                const tbody = document.getElementById(`rgrlObrasSection${sectionIdx}`);
                section.questions.forEach((q, qIdx) => {
                    const savedResponse = window.currentRGRLObrasResponses?.[`q${q.num}`];
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="border border-gray-300 p-2 font-semibold">${q.num}</td>
                        <td class="border border-gray-300 p-2">
                            ${q.text}
                            <div class="text-xs text-gray-500 mt-1">Normativa: ${q.normativa}</div>
                        </td>
                        <td class="border border-gray-300 p-2 text-center">
                            <input type="radio" name="rgrlObras_q${q.num}" value="SI" ${savedResponse?.respuesta === 'SI' ? 'checked' : ''}>
                        </td>
                        <td class="border border-gray-300 p-2 text-center">
                            <input type="radio" name="rgrlObras_q${q.num}" value="NO" ${savedResponse?.respuesta === 'NO' ? 'checked' : ''}>
                        </td>
                        <td class="border border-gray-300 p-2 text-center">
                            <input type="radio" name="rgrlObras_q${q.num}" value="NO_APLICA" ${savedResponse?.respuesta === 'NO_APLICA' ? 'checked' : ''}>
                        </td>
                        <td class="border border-gray-300 p-2 text-center">
                            <input type="date" id="rgrlObrasFecha_q${q.num}" class="border border-gray-300 rounded p-1 text-xs w-full" 
                                value="${savedResponse?.fecha || ''}">
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            });
            
            // Renderizar Planillas
            renderRGRLObrasPlanillas();
        }
        
        function renderRGRLObrasPlanillas() {
            // Planilla A
            const planillaATable = document.getElementById('planillaObrasATable');
            planillaATable.innerHTML = '';
            RGRL_OBRAS_DATA.planillaA.forEach((item, index) => {
                const savedResponse = window.currentRGRLObrasResponses?.[`planillaA_${index}`];
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="border border-gray-300 p-2">${item}</td>
                    <td class="border border-gray-300 p-2 text-center">
                        <input type="radio" name="rgrlObrasPlanillaA_${index}" value="SI" ${savedResponse === 'SI' ? 'checked' : ''}>
                    </td>
                    <td class="border border-gray-300 p-2 text-center">
                        <input type="radio" name="rgrlObrasPlanillaA_${index}" value="NO" ${savedResponse === 'NO' ? 'checked' : ''}>
                    </td>
                `;
                planillaATable.appendChild(tr);
            });
            
            // Planilla B
            const planillaBTable = document.getElementById('planillaObrasBTable');
            planillaBTable.innerHTML = '';
            RGRL_OBRAS_DATA.planillaB.forEach((item, index) => {
                const savedResponse = window.currentRGRLObrasResponses?.[`planillaB_${index}`];
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="border border-gray-300 p-2">${item}</td>
                    <td class="border border-gray-300 p-2 text-center">
                        <input type="radio" name="rgrlObrasPlanillaB_${index}" value="SI" ${savedResponse === 'SI' ? 'checked' : ''}>
                    </td>
                    <td class="border border-gray-300 p-2 text-center">
                        <input type="radio" name="rgrlObrasPlanillaB_${index}" value="NO" ${savedResponse === 'NO' ? 'checked' : ''}>
                    </td>
                `;
                planillaBTable.appendChild(tr);
            });
            
            // Planilla C
            const planillaCTable = document.getElementById('planillaObrasCTable');
            planillaCTable.innerHTML = '';
            RGRL_OBRAS_DATA.planillaC.forEach((item, index) => {
                const savedResponse = window.currentRGRLObrasResponses?.[`planillaC_${index}`];
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="border border-gray-300 p-2">${item.nombre}</td>
                    <td class="border border-gray-300 p-2 text-center">${item.umbral}</td>
                    <td class="border border-gray-300 p-2 text-center">
                        <input type="radio" name="rgrlObrasPlanillaC_${index}" value="SI" ${savedResponse === 'SI' ? 'checked' : ''}>
                    </td>
                    <td class="border border-gray-300 p-2 text-center">
                        <input type="radio" name="rgrlObrasPlanillaC_${index}" value="NO" ${savedResponse === 'NO' ? 'checked' : ''}>
                    </td>
                `;
                planillaCTable.appendChild(tr);
            });
        }
        
        function saveRGRLObrasForm() {
            // Validar datos generales
            const empresaNombre = document.getElementById('rgrlObrasEmpresaNombre').value;
            const cuit = document.getElementById('rgrlObrasCuit').value;
            const ciiu = document.getElementById('rgrlObrasCiiu').value;
            const descActividad = document.getElementById('rgrlObrasDescActividad').value;
            const domicilio = document.getElementById('rgrlObrasDomicilio').value;
            
            if (!empresaNombre || !cuit || !ciiu || !descActividad || !domicilio) {
                alert('Por favor complete todos los campos obligatorios marcados con *');
                return;
            }
            
            const formData = {
                datosGenerales: {
                    empresaNombre: empresaNombre,
                    cuit: cuit,
                    numEstablecimiento: document.getElementById('rgrlObrasNumEstablecimiento').value,
                    ciiu: ciiu,
                    superficie: document.getElementById('rgrlObrasSuperficie').value,
                    codigoActividad: document.getElementById('rgrlObrasCodigoActividad').value,
                    cantTrabajadores: document.getElementById('rgrlObrasCantTrabajadores').value,
                    descActividad: descActividad,
                    domicilio: domicilio,
                    provincia: document.getElementById('rgrlObrasProvincia').value,
                    codigoPostal: document.getElementById('rgrlObrasCodigoPostal').value,
                    localidad: document.getElementById('rgrlObrasLocalidad').value,
                    telefono: document.getElementById('rgrlObrasTelefono').value
                },
                respuestas: {},
                fechaCreacion: new Date().toISOString()
            };
            
            // Recopilar respuestas del formulario principal
            RGRL_OBRAS_DATA.sections.forEach(section => {
                section.questions.forEach(q => {
                    const respuesta = document.querySelector(`input[name="rgrlObras_q${q.num}"]:checked`)?.value;
                    const fecha = document.getElementById(`rgrlObrasFecha_q${q.num}`)?.value;
                    formData.respuestas[`q${q.num}`] = { respuesta, fecha };
                });
            });
            
            // Recopilar respuestas de Planilla A
            RGRL_OBRAS_DATA.planillaA.forEach((item, index) => {
                const respuesta = document.querySelector(`input[name="rgrlObrasPlanillaA_${index}"]:checked`)?.value;
                formData.respuestas[`planillaA_${index}`] = respuesta;
            });
            
            // Recopilar respuestas de Planilla B
            RGRL_OBRAS_DATA.planillaB.forEach((item, index) => {
                const respuesta = document.querySelector(`input[name="rgrlObrasPlanillaB_${index}"]:checked`)?.value;
                formData.respuestas[`planillaB_${index}`] = respuesta;
            });
            
            // Recopilar respuestas de Planilla C
            RGRL_OBRAS_DATA.planillaC.forEach((item, index) => {
                const respuesta = document.querySelector(`input[name="rgrlObrasPlanillaC_${index}"]:checked`)?.value;
                formData.respuestas[`planillaC_${index}`] = respuesta;
            });
            
            // Guardar en localStorage
            const savedForms = JSON.parse(localStorage.getItem('rgrlObrasFormularios')) || [];
            
            if (currentEditingRGRLObrasIndex !== null) {
                savedForms[currentEditingRGRLObrasIndex] = formData;
                currentEditingRGRLObrasIndex = null;
            } else {
                savedForms.push(formData);
            }
            
            localStorage.setItem('rgrlObrasFormularios', JSON.stringify(savedForms));
            
            alert('Formulario RGRL Obras guardado correctamente');
            cancelRGRLObrasForm();
            loadRGRLObrasFromLocalStorage();
            window.currentRGRLObrasResponses = null;
        }
        
        function exportRGRLObrasFormToPDF(index) {
            const savedForms = JSON.parse(localStorage.getItem('rgrlObrasFormularios')) || [];
            const form = index !== undefined ? savedForms[index] : getCurrentRGRLObrasFormData();
            
            if (!form) {
                alert('No hay datos para exportar');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let y = 15;
            
            const addHeader = () => {
                doc.setFillColor(25, 55, 109);
                doc.rect(0, 0, 210, 25, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('RGRL - FORMULARIO B (OBRAS DE CONSTRUCCI√ìN)', 105, 12, { align: 'center' });
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text('Relevamiento General de Riesgos Laborales - Dec. 911/96', 105, 19, { align: 'center' });
            };
            
            addHeader();
            y = 32;
            
            // Datos Generales
            doc.setFillColor(255, 250, 205);
            doc.rect(15, y-5, 180, 8, 'F');
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('DATOS GENERALES DEL ESTABLECIMIENTO (OBRA)', 105, y, { align: 'center' });
            y += 8;
            
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            const datosGenerales = [
                `Empresa: ${form.datosGenerales.empresaNombre}`,
                `CUIT: ${form.datosGenerales.cuit}`,
                `N¬∞ Establecimiento: ${form.datosGenerales.numEstablecimiento || 'N/A'}`,
                `CIIU: ${form.datosGenerales.ciiu}`,
                `Superficie: ${form.datosGenerales.superficie || 'N/A'} m¬≤`,
                `Cant. Trabajadores: ${form.datosGenerales.cantTrabajadores || 'N/A'}`,
                `Domicilio: ${form.datosGenerales.domicilio}`,
                `Localidad: ${form.datosGenerales.localidad || 'N/A'}`,
                `Provincia: ${form.datosGenerales.provincia || 'N/A'}`,
                `C√≥digo Postal: ${form.datosGenerales.codigoPostal || 'N/A'}`,
                `Tel√©fono: ${form.datosGenerales.telefono || 'N/A'}`,
                `Descripci√≥n: ${form.datosGenerales.descActividad}`
            ];
            
            datosGenerales.forEach(dato => {
                if (y > 273) {
                    doc.addPage();
                    addHeader();
                    y = 32;
                }
                doc.text(dato, 17, y);
                y += 5;
            });
            
            y += 3;
            doc.setDrawColor(200, 200, 200);
            doc.line(15, y, 195, y);
            y += 6;
            
            // Secciones del formulario
            RGRL_OBRAS_DATA.sections.forEach((section, sectionIdx) => {
                if (y > 268) {
                    doc.addPage();
                    addHeader();
                    y = 32;
                }
                
                doc.setFillColor(255, 247, 205);
                doc.rect(15, y-4, 180, 7, 'F');
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.text(section.title, 105, y, { align: 'center' });
                y += 6;
                
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                
                section.questions.forEach((q, qIdx) => {
                    const key = `q${q.num}`;
                    const response = form.respuestas[key] || {};
                    
                    if (y > 273) {
                        doc.addPage();
                        addHeader();
                        y = 32;
                    }
                    
                    const lines = doc.splitTextToSize(`${q.num}. ${q.text}`, 155);
                    lines.forEach((line, lineIdx) => {
                        if (y > 273) {
                            doc.addPage();
                            addHeader();
                            y = 32;
                        }
                        doc.text(line, 17, y);
                        y += 3.5;
                    });
                    
                    const respText = response.respuesta ? response.respuesta.toUpperCase() : 'NO RESPONDIDA';
                    doc.text(`Resp: ${respText}`, 20, y);
                    if (response.fecha) {
                        doc.text(`Fecha Reg.: ${new Date(response.fecha).toLocaleDateString()}`, 70, y);
                    }
                    y += 4;
                });
                y += 2;
            });
            
            // Planillas A, B y C (similar a RGRL A)
            doc.addPage();
            addHeader();
            y = 32;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.setFillColor(220, 200, 255);
            doc.rect(15, y-4, 180, 7, 'F');
            doc.setTextColor(0, 0, 0);
            doc.text('PLANILLA A | LISTADO DE SUSTANCIAS Y AGENTES CANCERIGENOS', 105, y, { align: 'center' });
            y += 7;
            
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            
            RGRL_OBRAS_DATA.planillaA.forEach((item, index) => {
                if (y > 273) {
                    doc.addPage();
                    addHeader();
                    y = 32;
                }
                
                const key = `planillaA_${index}`;
                const saved = form.respuestas[key] || 'NO RESPONDIDA';
                
                const lines = doc.splitTextToSize(item, 155);
                lines.forEach((line, lineIdx) => {
                    if (y > 273) {
                        doc.addPage();
                        addHeader();
                        y = 32;
                    }
                    doc.text(line, 17, y);
                    y += 3.5;
                });
                
                doc.text(`Resp: ${saved.toString().toUpperCase()}`, 170, y-3.5);
                y += 1;
            });
            
            // Planilla B
            doc.addPage();
            addHeader();
            y = 32;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.setFillColor(220, 200, 255);
            doc.rect(15, y-4, 180, 7, 'F');
            doc.setTextColor(0, 0, 0);
            doc.text('PLANILLA B | DIFENILOS POLICLORADOS (PCBs)', 105, y, { align: 'center' });
            y += 7;
            
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            
            RGRL_OBRAS_DATA.planillaB.forEach((item, index) => {
                if (y > 273) {
                    doc.addPage();
                    addHeader();
                    y = 32;
                }
                
                const key = `planillaB_${index}`;
                const saved = form.respuestas[key] || 'NO RESPONDIDA';
                
                const lines = doc.splitTextToSize(item, 155);
                lines.forEach((line, lineIdx) => {
                    if (y > 273) {
                        doc.addPage();
                        addHeader();
                        y = 32;
                    }
                    doc.text(line, 17, y);
                    y += 3.5;
                });
                
                doc.text(`Resp: ${saved.toString().toUpperCase()}`, 170, y-3.5);
                y += 1;
            });
            
            // Planilla C
            doc.addPage();
            addHeader();
            y = 32;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.setFillColor(220, 200, 255);
            doc.rect(15, y-4, 180, 7, 'F');
            doc.setTextColor(0, 0, 0);
            doc.text('PLANILLA C | SUSTANCIAS QUIMICAS A DECLARAR', 105, y, { align: 'center' });
            y += 7;
            
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            
            RGRL_OBRAS_DATA.planillaC.forEach((item, index) => {
                if (y > 273) {
                    doc.addPage();
                    addHeader();
                    y = 32;
                }
                
                const key = `planillaC_${index}`;
                const saved = form.respuestas[key] || 'NO RESPONDIDA';
                
                const lines = doc.splitTextToSize(item.nombre, 135);
                lines.forEach((line, lineIdx) => {
                    if (y > 273) {
                        doc.addPage();
                        addHeader();
                        y = 32;
                    }
                    doc.text(line, 17, y);
                    y += 3.5;
                });
                
                doc.text(`Umbral: ${item.umbral} TN`, 145, y-3.5);
                doc.text(`Resp: ${saved.toString().toUpperCase()}`, 175, y-3.5);
                y += 1;
            });
            
            // Pie de p√°gina
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                doc.text(`P√°gina ${i} de ${pageCount}`, 105, 290, { align: 'center' });
            }
            
            const fileName = `RGRL-OBRAS-${form.datosGenerales.empresaNombre.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
        }
        
        function getCurrentRGRLObrasFormData() {
            // Esta funci√≥n es similar a la de RGRL A pero para Obras
            // Se usa cuando se exporta sin guardar
            const empresaNombre = document.getElementById('rgrlObrasEmpresaNombre').value;
            if (!empresaNombre) return null;
            
            const formData = {
                datosGenerales: {
                    empresaNombre: empresaNombre,
                    cuit: document.getElementById('rgrlObrasCuit').value,
                    numEstablecimiento: document.getElementById('rgrlObrasNumEstablecimiento').value,
                    ciiu: document.getElementById('rgrlObrasCiiu').value,
                    superficie: document.getElementById('rgrlObrasSuperficie').value,
                    codigoActividad: document.getElementById('rgrlObrasCodigoActividad').value,
                    cantTrabajadores: document.getElementById('rgrlObrasCantTrabajadores').value,
                    descActividad: document.getElementById('rgrlObrasDescActividad').value,
                    domicilio: document.getElementById('rgrlObrasDomicilio').value,
                    provincia: document.getElementById('rgrlObrasProvincia').value,
                    codigoPostal: document.getElementById('rgrlObrasCodigoPostal').value,
                    localidad: document.getElementById('rgrlObrasLocalidad').value,
                    telefono: document.getElementById('rgrlObrasTelefono').value
                },
                respuestas: {},
                fechaCreacion: new Date().toISOString()
            };
            
            // Recopilar respuestas
            RGRL_OBRAS_DATA.sections.forEach(section => {
                section.questions.forEach(q => {
                    const respuesta = document.querySelector(`input[name="rgrlObras_q${q.num}"]:checked`)?.value;
                    const fecha = document.getElementById(`rgrlObrasFecha_q${q.num}`)?.value;
                    formData.respuestas[`q${q.num}`] = { respuesta, fecha };
                });
            });
            
            RGRL_OBRAS_DATA.planillaA.forEach((item, index) => {
                const respuesta = document.querySelector(`input[name="rgrlObrasPlanillaA_${index}"]:checked`)?.value;
                formData.respuestas[`planillaA_${index}`] = respuesta;
            });
            
            RGRL_OBRAS_DATA.planillaB.forEach((item, index) => {
                const respuesta = document.querySelector(`input[name="rgrlObrasPlanillaB_${index}"]:checked`)?.value;
                formData.respuestas[`planillaB_${index}`] = respuesta;
            });
            
            RGRL_OBRAS_DATA.planillaC.forEach((item, index) => {
                const respuesta = document.querySelector(`input[name="rgrlObrasPlanillaC_${index}"]:checked`)?.value;
                formData.respuestas[`planillaC_${index}`] = respuesta;
            });
            
            return formData;
        }
        
        function exportRGRLObrasToPDF() {
            exportRGRLObrasFormToPDF();
        }

        function initRGRLObras() {
            if (!currentEstablishment) {
                alert('Seleccione un establecimiento primero');
                showHome();
                return;
            }
            
            // Mostrar lista de formularios y ocultar el formulario
            document.getElementById('rgrlObrasListContainer').classList.remove('hidden');
            document.getElementById('rgrlObrasFormContainer').classList.add('hidden');
            
            // Cargar lista de formularios guardados
            loadRGRLObrasFromLocalStorage();
        }




        // ============= VEHICLES MANAGEMENT FUNCTIONS =============
        let inspectionPhotosData = [];

        function showNewVehicle() {
            currentEditVehicleId = null;
            document.getElementById('newVehicleForm').classList.remove('hidden');
            document.getElementById('vehiclesList').closest('.bg-white').classList.add('hidden');
            document.getElementById('vehicleInspectionForm').classList.add('hidden');
            
            // Restaurar t√≠tulo y bot√≥n
            document.querySelector('#newVehicleForm h3').textContent = 'Nuevo Veh√≠culo';
            const submitButton = document.querySelector('#newVehicleForm form button[type="submit"]');
            submitButton.innerHTML = '<i class="fas fa-save"></i> Guardar Veh√≠culo';
        }

        function cancelNewVehicle() {
            currentEditVehicleId = null;
            document.getElementById('newVehicleForm').classList.add('hidden');
            document.getElementById('vehiclesList').closest('.bg-white').classList.remove('hidden');
            document.getElementById('newVehicleForm').querySelector('form').reset();
            document.getElementById('vehiclePhotoPreview').innerHTML = '';
            
            // Restaurar t√≠tulo y bot√≥n
            document.querySelector('#newVehicleForm h3').textContent = 'Nuevo Veh√≠culo';
            const submitButton = document.querySelector('#newVehicleForm form button[type="submit"]');
            submitButton.innerHTML = '<i class="fas fa-save"></i> Guardar Veh√≠culo';
        }

        function saveVehicle(event) {
            event.preventDefault();
            if (!currentEstablishment) {
                alert('Seleccione un establecimiento primero');
                return;
            }

            const form = event.target;
            const formData = new FormData(form);
            
            // Verificar si estamos editando o creando
            if (currentEditVehicleId) {
                // MODO EDICI√ìN
                const vehicle = appData.vehicles.find(v => v.id === currentEditVehicleId);
                if (!vehicle) {
                    alert('Veh√≠culo no encontrado');
                    return;
                }

                // Actualizar datos del veh√≠culo
                vehicle.patente = formData.get('patente').toUpperCase();
                vehicle.tipo = formData.get('tipo');
                vehicle.estado = formData.get('estado');
                vehicle.marca = formData.get('marca');
                vehicle.modelo = formData.get('modelo');
                vehicle.anio = formData.get('anio');
                vehicle.kilometraje = formData.get('kilometraje');
                vehicle.combustible = formData.get('combustible');
                vehicle.chasis = formData.get('chasis');
                vehicle.motor = formData.get('motor');
                vehicle.cedula = formData.get('cedula');
                vehicle.cedula_vencimiento = formData.get('cedula_vencimiento');
                vehicle.seguro = formData.get('seguro');
                vehicle.seguro_vencimiento = formData.get('seguro_vencimiento');
                vehicle.seguro_compania = formData.get('seguro_compania');
                vehicle.seguro_poliza = formData.get('seguro_poliza');
                vehicle.vtv = formData.get('vtv');
                vehicle.vtv_vencimiento = formData.get('vtv_vencimiento');
                vehicle.conductor = formData.get('conductor');
                vehicle.sector = formData.get('sector');
                vehicle.observaciones = formData.get('observaciones');

                // Capturar foto si existe
                const photoInput = document.getElementById('vehiclePhotoInput');
                if (photoInput && photoInput.files && photoInput.files[0]) {
                    const previewImg = document.querySelector('#vehiclePhotoPreview img');
                    if (previewImg) {
                        vehicle.foto = previewImg.src;
                    }
                }

                saveData();
                alert('Veh√≠culo actualizado exitosamente');
                currentEditVehicleId = null;
                cancelNewVehicle();
                loadVehicles();
            } else {
                // MODO CREACI√ìN
                const vehicle = {
                    id: Date.now(),
                    establecimiento_id: currentEstablishment.id,
                    patente: formData.get('patente').toUpperCase(),
                    tipo: formData.get('tipo'),
                    estado: formData.get('estado'),
                    marca: formData.get('marca'),
                    modelo: formData.get('modelo'),
                    anio: formData.get('anio'),
                    kilometraje: formData.get('kilometraje'),
                    combustible: formData.get('combustible'),
                    chasis: formData.get('chasis'),
                    motor: formData.get('motor'),
                    cedula: formData.get('cedula'),
                    cedula_vencimiento: formData.get('cedula_vencimiento'),
                    seguro: formData.get('seguro'),
                    seguro_vencimiento: formData.get('seguro_vencimiento'),
                    seguro_compania: formData.get('seguro_compania'),
                    seguro_poliza: formData.get('seguro_poliza'),
                    vtv: formData.get('vtv'),
                    vtv_vencimiento: formData.get('vtv_vencimiento'),
                    conductor: formData.get('conductor'),
                    sector: formData.get('sector'),
                    observaciones: formData.get('observaciones'),
                    foto: null,
                    inspecciones: [],
                    fecha_registro: new Date().toISOString()
                };

                // Capturar foto si existe
                const photoInput = document.getElementById('vehiclePhotoInput');
                if (photoInput && photoInput.files && photoInput.files[0]) {
                    const previewImg = document.querySelector('#vehiclePhotoPreview img');
                    if (previewImg) {
                        vehicle.foto = previewImg.src;
                    }
                }

                if (!appData.vehicles) {
                    appData.vehicles = [];
                }
                appData.vehicles.push(vehicle);
                saveData();
                
                alert('Veh√≠culo registrado exitosamente');
                cancelNewVehicle();
                loadVehicles();
            }
        }

        function loadVehicles() {
            if (!currentEstablishment) return;
            
            const vehicles = appData.vehicles ? appData.vehicles.filter(v => v.establecimiento_id === currentEstablishment.id) : [];
            const listDiv = document.getElementById('vehiclesList');
            
            if (vehicles.length === 0) {
                listDiv.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <div class="text-6xl mb-3"><i class="fas fa-car"></i></div>
                        <p class="font-semibold">No hay veh√≠culos registrados</p>
                        <p class="text-sm">Comience registrando el primer veh√≠culo de la empresa</p>
                    </div>
                `;
                return;
            }

            listDiv.innerHTML = vehicles.map(vehicle => {
                const docStatus = getDocumentationStatus(vehicle);
                const lastInspection = vehicle.inspecciones && vehicle.inspecciones.length > 0 
                    ? vehicle.inspecciones[vehicle.inspecciones.length - 1] 
                    : null;
                
                let estadoBadge = '';
                if (vehicle.estado === 'activo') {
                    estadoBadge = '<span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs font-semibold">Activo</span>';
                } else if (vehicle.estado === 'mantenimiento') {
                    estadoBadge = '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs font-semibold">Mantenimiento</span>';
                } else {
                    estadoBadge = '<span class="px-2 py-1 bg-gray-100 text-gray-800 rounded text-xs font-semibold">Inactivo</span>';
                }

                return `
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition vehicle-item" data-status="${vehicle.estado}" data-type="${vehicle.tipo}">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-start gap-4 flex-1">
                                ${vehicle.foto ? `
                                    <img src="${vehicle.foto}" class="w-24 h-24 object-cover rounded-lg cursor-pointer hover:opacity-80 transition" onclick="openImageModal('${vehicle.foto}')" alt="Veh√≠culo">
                                ` : `
                                    <div class="w-24 h-24 bg-gray-200 rounded-lg flex items-center justify-center text-3xl"><i class="fas fa-car"></i></div>
                                `}
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <h3 class="text-lg font-bold text-gray-800">${vehicle.patente}</h3>
                                        ${estadoBadge}
                                    </div>
                                    <p class="text-gray-700 font-semibold">${vehicle.marca} ${vehicle.modelo} ${vehicle.anio ? `(${vehicle.anio})` : ''}</p>
                                    <p class="text-sm text-gray-600">Tipo: ${vehicle.tipo.charAt(0).toUpperCase() + vehicle.tipo.slice(1)}</p>
                                    ${vehicle.kilometraje ? `<p class="text-sm text-gray-600">Kilometraje: ${parseInt(vehicle.kilometraje).toLocaleString('es-AR')} km</p>` : ''}
                                    ${vehicle.conductor ? `<p class="text-sm text-gray-600">Conductor: ${vehicle.conductor}</p>` : ''}
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editVehicle(${vehicle.id})" class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded text-sm font-semibold transition">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button onclick="showVehicleInspection(${vehicle.id})" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm font-semibold transition">
                                    <i class="fas fa-search"></i> Inspeccionar
                                </button>
                                <button onclick="viewVehicleDetail(${vehicle.id})" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm font-semibold transition">
                                    üëÅÔ∏è Ver
                                </button>
                                <button onclick="deleteVehicle(${vehicle.id})" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm font-semibold transition">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        
                        <!-- Documentation Status -->
                        <div class="grid grid-cols-3 gap-2 text-xs mb-3">
                            ${docStatus.cedula}
                            ${docStatus.seguro}
                            ${docStatus.vtv}
                        </div>

                        <!-- Last Inspection -->
                        ${lastInspection ? `
                            <div class="bg-gray-50 p-2 rounded mt-2">
                                <p class="text-xs font-semibold text-gray-700">√öltima Inspecci√≥n:</p>
                                <p class="text-xs text-gray-600">${new Date(lastInspection.fecha).toLocaleDateString('es-AR')} - ${lastInspection.estado_general === 'apto' ? '‚úÖ Apto' : lastInspection.estado_general === 'apto_con_observaciones' ? '‚ö†Ô∏è Apto c/obs' : '‚ùå No Apto'}</p>
                            </div>
                        ` : '<p class="text-xs text-gray-500 italic mt-2">Sin inspecciones registradas</p>'}
                    </div>
                `;
            }).join('');
        }

        function getDocumentationStatus(vehicle) {
            const today = new Date();
            
            const getCedulaStatus = () => {
                if (vehicle.cedula === 'no_tiene') return '<div class="bg-red-100 text-red-800 p-1 rounded text-center"><div class="font-semibold">C√©dula</div><div>Sin documento</div></div>';
                if (vehicle.cedula === 'vencida') return '<div class="bg-red-100 text-red-800 p-1 rounded text-center"><div class="font-semibold">C√©dula</div><div>Vencida</div></div>';
                if (vehicle.cedula_vencimiento) {
                    const vencimiento = new Date(vehicle.cedula_vencimiento);
                    const daysUntil = Math.floor((vencimiento - today) / (1000 * 60 * 60 * 24));
                    if (daysUntil < 0) return '<div class="bg-red-100 text-red-800 p-1 rounded text-center"><div class="font-semibold">C√©dula</div><div>Vencida</div></div>';
                    if (daysUntil < 30) return '<div class="bg-yellow-100 text-yellow-800 p-1 rounded text-center"><div class="font-semibold">C√©dula</div><div>Por vencer</div></div>';
                    return '<div class="bg-green-100 text-green-800 p-1 rounded text-center"><div class="font-semibold">C√©dula</div><div>Vigente</div></div>';
                }
                return '<div class="bg-green-100 text-green-800 p-1 rounded text-center"><div class="font-semibold">C√©dula</div><div>Vigente</div></div>';
            };

            const getSeguroStatus = () => {
                if (vehicle.seguro === 'no_tiene') return '<div class="bg-red-100 text-red-800 p-1 rounded text-center"><div class="font-semibold">Seguro</div><div>Sin seguro</div></div>';
                if (vehicle.seguro === 'vencido') return '<div class="bg-red-100 text-red-800 p-1 rounded text-center"><div class="font-semibold">Seguro</div><div>Vencido</div></div>';
                if (vehicle.seguro_vencimiento) {
                    const vencimiento = new Date(vehicle.seguro_vencimiento);
                    const daysUntil = Math.floor((vencimiento - today) / (1000 * 60 * 60 * 24));
                    if (daysUntil < 0) return '<div class="bg-red-100 text-red-800 p-1 rounded text-center"><div class="font-semibold">Seguro</div><div>Vencido</div></div>';
                    if (daysUntil < 30) return '<div class="bg-yellow-100 text-yellow-800 p-1 rounded text-center"><div class="font-semibold">Seguro</div><div>Por vencer</div></div>';
                    return '<div class="bg-green-100 text-green-800 p-1 rounded text-center"><div class="font-semibold">Seguro</div><div>Vigente</div></div>';
                }
                return '<div class="bg-green-100 text-green-800 p-1 rounded text-center"><div class="font-semibold">Seguro</div><div>Vigente</div></div>';
            };

            const getVTVStatus = () => {
                if (vehicle.vtv === 'no_tiene') return '<div class="bg-red-100 text-red-800 p-1 rounded text-center"><div class="font-semibold">VTV</div><div>Sin VTV</div></div>';
                if (vehicle.vtv === 'vencida') return '<div class="bg-red-100 text-red-800 p-1 rounded text-center"><div class="font-semibold">VTV</div><div>Vencida</div></div>';
                if (vehicle.vtv_vencimiento) {
                    const vencimiento = new Date(vehicle.vtv_vencimiento);
                    const daysUntil = Math.floor((vencimiento - today) / (1000 * 60 * 60 * 24));
                    if (daysUntil < 0) return '<div class="bg-red-100 text-red-800 p-1 rounded text-center"><div class="font-semibold">VTV</div><div>Vencida</div></div>';
                    if (daysUntil < 30) return '<div class="bg-yellow-100 text-yellow-800 p-1 rounded text-center"><div class="font-semibold">VTV</div><div>Por vencer</div></div>';
                    return '<div class="bg-green-100 text-green-800 p-1 rounded text-center"><div class="font-semibold">VTV</div><div>Vigente</div></div>';
                }
                return '<div class="bg-green-100 text-green-800 p-1 rounded text-center"><div class="font-semibold">VTV</div><div>Vigente</div></div>';
            };

            return {
                cedula: getCedulaStatus(),
                seguro: getSeguroStatus(),
                vtv: getVTVStatus()
            };
        }

        function filterVehicles() {
            const statusFilter = document.getElementById('vehicleFilterStatus').value;
            const typeFilter = document.getElementById('vehicleFilterType').value;
            const searchText = document.getElementById('vehicleSearch').value.toLowerCase();

            const items = document.querySelectorAll('.vehicle-item');
            items.forEach(item => {
                const status = item.getAttribute('data-status');
                const type = item.getAttribute('data-type');
                const text = item.textContent.toLowerCase();

                const matchesStatus = !statusFilter || status === statusFilter;
                const matchesType = !typeFilter || type === typeFilter;
                const matchesSearch = !searchText || text.includes(searchText);

                if (matchesStatus && matchesType && matchesSearch) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function deleteVehicle(id) {
            if (!confirm('¬øEst√° seguro de eliminar este veh√≠culo? Esta acci√≥n no se puede deshacer.')) {
                return;
            }

            const index = appData.vehicles.findIndex(v => v.id === id);
            if (index !== -1) {
                appData.vehicles.splice(index, 1);
                saveData();
                loadVehicles();
                alert('Veh√≠culo eliminado');
            }
        }

        let currentEditVehicleId = null;

        function editVehicle(id) {
            const vehicle = appData.vehicles.find(v => v.id === id);
            if (!vehicle) {
                alert('Veh√≠culo no encontrado');
                return;
            }

            currentEditVehicleId = id;

            // Mostrar el formulario
            document.getElementById('newVehicleForm').classList.remove('hidden');
            document.getElementById('vehiclesList').closest('.bg-white').classList.add('hidden');
            
            // Cambiar t√≠tulo del formulario
            document.querySelector('#newVehicleForm h3').textContent = 'Editar Veh√≠culo';
            
            // Cargar datos en el formulario
            const form = document.getElementById('newVehicleForm').querySelector('form');
            form.patente.value = vehicle.patente || '';
            form.tipo.value = vehicle.tipo || '';
            form.estado.value = vehicle.estado || '';
            form.marca.value = vehicle.marca || '';
            form.modelo.value = vehicle.modelo || '';
            form.anio.value = vehicle.anio || '';
            form.kilometraje.value = vehicle.kilometraje || '';
            form.combustible.value = vehicle.combustible || '';
            form.chasis.value = vehicle.chasis || '';
            form.motor.value = vehicle.motor || '';
            form.cedula.value = vehicle.cedula || '';
            form.cedula_vencimiento.value = vehicle.cedula_vencimiento || '';
            form.seguro.value = vehicle.seguro || '';
            form.seguro_vencimiento.value = vehicle.seguro_vencimiento || '';
            form.seguro_compania.value = vehicle.seguro_compania || '';
            form.seguro_poliza.value = vehicle.seguro_poliza || '';
            form.vtv.value = vehicle.vtv || '';
            form.vtv_vencimiento.value = vehicle.vtv_vencimiento || '';
            form.conductor.value = vehicle.conductor || '';
            form.sector.value = vehicle.sector || '';
            form.observaciones.value = vehicle.observaciones || '';

            // Mostrar foto si existe
            if (vehicle.foto) {
                const previewDiv = document.getElementById('vehiclePhotoPreview');
                previewDiv.innerHTML = `
                    <img src="${vehicle.foto}" class="max-w-xs rounded border mt-2" alt="Vista previa">
                    <button type="button" onclick="removeVehiclePhoto()" class="text-xs text-red-600 hover:text-red-800 mt-1">
                        üóëÔ∏è Eliminar foto
                    </button>
                `;
            }

            // Cambiar texto del bot√≥n
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.innerHTML = '<i class="fas fa-save"></i> Actualizar Veh√≠culo';
        }


        function showVehicleInspection(vehicleId) {
            const vehicle = appData.vehicles.find(v => v.id === vehicleId);
            if (!vehicle) return;

            document.getElementById('vehiclesList').closest('.bg-white').classList.add('hidden');
            document.getElementById('newVehicleForm').classList.add('hidden');
            document.getElementById('vehicleInspectionForm').classList.remove('hidden');
            
            document.getElementById('inspectionVehicleId').value = vehicleId;
            
            // Pre-rellenar fecha actual
            const form = document.getElementById('vehicleInspectionForm').querySelector('form');
            const fechaInput = form.querySelector('input[name="fecha"]');
            if (fechaInput && !fechaInput.value) {
                fechaInput.value = new Date().toISOString().split('T')[0];
            }

            // Pre-rellenar kilometraje actual del veh√≠culo
            const kmInput = form.querySelector('input[name="kilometraje"]');
            if (kmInput && vehicle.kilometraje) {
                kmInput.value = vehicle.kilometraje;
            }

            // Limpiar fotos previas
            inspectionPhotosData = [];
            document.getElementById('inspectionPhotosPreview').innerHTML = '';
        }

        function cancelVehicleInspection() {
            document.getElementById('vehicleInspectionForm').classList.add('hidden');
            document.getElementById('vehiclesList').closest('.bg-white').classList.remove('hidden');
            document.getElementById('vehicleInspectionForm').querySelector('form').reset();
            document.getElementById('inspectionPhotosPreview').innerHTML = '';
            inspectionPhotosData = [];
        }

        function saveVehicleInspection(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            const vehicleId = parseInt(formData.get('vehicle_id'));
            
            const vehicle = appData.vehicles.find(v => v.id === vehicleId);
            if (!vehicle) {
                alert('Veh√≠culo no encontrado');
                return;
            }

            const inspection = {
                id: Date.now(),
                fecha: formData.get('fecha'),
                inspector: formData.get('inspector'),
                kilometraje: formData.get('kilometraje'),
                matafuegos: formData.get('matafuegos') === 'OK',
                balizas: formData.get('balizas') === 'OK',
                botiquin: formData.get('botiquin') === 'OK',
                rueda_auxilio: formData.get('rueda_auxilio') === 'OK',
                herramientas: formData.get('herramientas') === 'OK',
                chaleco: formData.get('chaleco') === 'OK',
                luces_delanteras: formData.get('luces_delanteras'),
                luces_traseras: formData.get('luces_traseras'),
                luces_giro: formData.get('luces_giro'),
                frenos: formData.get('frenos'),
                neumaticos: formData.get('neumaticos'),
                cinturones: formData.get('cinturones'),
                espejos: formData.get('espejos'),
                limpiaparabrisas: formData.get('limpiaparabrisas'),
                bocina: formData.get('bocina'),
                carroceria: formData.get('carroceria'),
                aceite_motor: formData.get('aceite_motor'),
                liquido_frenos: formData.get('liquido_frenos'),
                refrigerante: formData.get('refrigerante'),
                liquido_limpia: formData.get('liquido_limpia'),
                estado_general: formData.get('estado_general'),
                observaciones: formData.get('observaciones'),
                fotos: inspectionPhotosData
            };

            if (!vehicle.inspecciones) {
                vehicle.inspecciones = [];
            }
            vehicle.inspecciones.push(inspection);

            // Actualizar kilometraje del veh√≠culo si se ingres√≥
            if (inspection.kilometraje) {
                vehicle.kilometraje = inspection.kilometraje;
            }

            saveData();
            alert('Inspecci√≥n registrada exitosamente');
            cancelVehicleInspection();
            loadVehicles();
        }

        function viewVehicleDetail(vehicleId) {
            const vehicle = appData.vehicles.find(v => v.id === vehicleId);
            if (!vehicle) return;

            const modal = document.getElementById('inspectionModal');
            const content = document.getElementById('inspectionModalContent');

            let inspectionsHTML = '';
            if (vehicle.inspecciones && vehicle.inspecciones.length > 0) {
                inspectionsHTML = `
                    <div class="mt-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-3"><i class="fas fa-clipboard-list"></i> Historial de Inspecciones</h3>
                        <div class="space-y-3">
                            ${vehicle.inspecciones.slice().reverse().map(insp => `
                                <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                                    <div class="flex justify-between items-start mb-2">
                                        <div>
                                            <p class="font-semibold text-gray-800">${new Date(insp.fecha).toLocaleDateString('es-AR')}</p>
                                            <p class="text-sm text-gray-600">Inspector: ${insp.inspector}</p>
                                            ${insp.kilometraje ? `<p class="text-sm text-gray-600">Km: ${parseInt(insp.kilometraje).toLocaleString('es-AR')}</p>` : ''}
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="px-3 py-1 rounded-full text-sm font-semibold ${
                                                insp.estado_general === 'apto' ? 'bg-green-100 text-green-800' :
                                                insp.estado_general === 'apto_con_observaciones' ? 'bg-yellow-100 text-yellow-800' :
                                                'bg-red-100 text-red-800'
                                            }">
                                                ${insp.estado_general === 'apto' ? 'Apto' :
                                                  insp.estado_general === 'apto_con_observaciones' ? 'Apto c/Observaciones' :
                                                  'No Apto'}
                                            </span>
                                            <button onclick="deleteInspection(${vehicle.id}, ${insp.id})" class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-xs font-semibold transition">
                                                üóëÔ∏è Eliminar
                                            </button>
                                        </div>
                                    </div>
                                    ${insp.observaciones ? `<p class="text-sm text-gray-700 mt-2"><strong>Observaciones:</strong> ${insp.observaciones}</p>` : ''}
                                    ${insp.fotos && insp.fotos.length > 0 ? `
                                        <div class="mt-3 grid grid-cols-3 gap-2">
                                            ${insp.fotos.map(foto => `
                                                <img src="${foto}" class="w-full h-24 object-cover rounded cursor-pointer hover:opacity-80 transition" onclick="openImageModal('${foto}')" alt="Foto inspecci√≥n">
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                inspectionsHTML = '<p class="text-gray-500 italic mt-4">No hay inspecciones registradas para este veh√≠culo.</p>';
            }

            content.innerHTML = `
                <div class="space-y-6">
                    <!-- Foto y datos principales -->
                    <div class="flex gap-6">
                        ${vehicle.foto ? `
                            <img src="${vehicle.foto}" class="w-48 h-48 object-cover rounded-lg cursor-pointer hover:opacity-80 transition" onclick="openImageModal('${vehicle.foto}')" alt="Veh√≠culo">
                        ` : `
                            <div class="w-48 h-48 bg-gray-200 rounded-lg flex items-center justify-center text-6xl"><i class="fas fa-car"></i></div>
                        `}
                        <div class="flex-1">
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">${vehicle.patente}</h2>
                            <p class="text-xl text-gray-700 mb-1">${vehicle.marca} ${vehicle.modelo} ${vehicle.anio ? `(${vehicle.anio})` : ''}</p>
                            <p class="text-gray-600">Tipo: ${vehicle.tipo.charAt(0).toUpperCase() + vehicle.tipo.slice(1)}</p>
                            ${vehicle.kilometraje ? `<p class="text-gray-600">Kilometraje: ${parseInt(vehicle.kilometraje).toLocaleString('es-AR')} km</p>` : ''}
                            ${vehicle.combustible ? `<p class="text-gray-600">Combustible: ${vehicle.combustible.charAt(0).toUpperCase() + vehicle.combustible.slice(1)}</p>` : ''}
                            <span class="inline-block mt-2 px-3 py-1 rounded-full text-sm font-semibold ${
                                vehicle.estado === 'activo' ? 'bg-green-100 text-green-800' :
                                vehicle.estado === 'mantenimiento' ? 'bg-yellow-100 text-yellow-800' :
                                'bg-gray-100 text-gray-800'
                            }">
                                ${vehicle.estado.charAt(0).toUpperCase() + vehicle.estado.slice(1)}
                            </span>
                        </div>
                    </div>

                    <!-- Informaci√≥n t√©cnica -->
                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-bold text-gray-800 mb-2">Informaci√≥n T√©cnica</h3>
                            ${vehicle.chasis ? `<p class="text-sm text-gray-700"><strong>Chasis:</strong> ${vehicle.chasis}</p>` : ''}
                            ${vehicle.motor ? `<p class="text-sm text-gray-700"><strong>Motor:</strong> ${vehicle.motor}</p>` : ''}
                            ${vehicle.conductor ? `<p class="text-sm text-gray-700"><strong>Conductor:</strong> ${vehicle.conductor}</p>` : ''}
                            ${vehicle.sector ? `<p class="text-sm text-gray-700"><strong>Sector:</strong> ${vehicle.sector}</p>` : ''}
                        </div>

                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-bold text-gray-800 mb-2">Documentaci√≥n</h3>
                            <div class="space-y-1 text-sm">
                                <p><strong>C√©dula:</strong> ${vehicle.cedula || 'No especificado'} ${vehicle.cedula_vencimiento ? `(Venc: ${new Date(vehicle.cedula_vencimiento).toLocaleDateString('es-AR')})` : ''}</p>
                                <p><strong>Seguro:</strong> ${vehicle.seguro || 'No especificado'} ${vehicle.seguro_vencimiento ? `(Venc: ${new Date(vehicle.seguro_vencimiento).toLocaleDateString('es-AR')})` : ''}</p>
                                ${vehicle.seguro_compania ? `<p><strong>Compa√±√≠a:</strong> ${vehicle.seguro_compania}</p>` : ''}
                                ${vehicle.seguro_poliza ? `<p><strong>P√≥liza:</strong> ${vehicle.seguro_poliza}</p>` : ''}
                                <p><strong>VTV:</strong> ${vehicle.vtv || 'No especificado'} ${vehicle.vtv_vencimiento ? `(Venc: ${new Date(vehicle.vtv_vencimiento).toLocaleDateString('es-AR')})` : ''}</p>
                            </div>
                        </div>
                    </div>

                    ${vehicle.observaciones ? `
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h3 class="font-bold text-gray-800 mb-2">Observaciones</h3>
                            <p class="text-sm text-gray-700">${vehicle.observaciones}</p>
                        </div>
                    ` : ''}

                    ${inspectionsHTML}
                </div>
            `;

            modal.classList.remove('hidden');
        }

        function deleteInspection(vehicleId, inspectionId) {
            if (!confirm('¬øEst√° seguro de eliminar esta inspecci√≥n? Esta acci√≥n no se puede deshacer.')) {
                return;
            }

            const vehicle = appData.vehicles.find(v => v.id === vehicleId);
            if (!vehicle) {
                alert('Veh√≠culo no encontrado');
                return;
            }

            const index = vehicle.inspecciones.findIndex(i => i.id === inspectionId);
            if (index !== -1) {
                vehicle.inspecciones.splice(index, 1);
                saveData();
                alert('Inspecci√≥n eliminada exitosamente');
                
                // Cerrar el modal actual y volver a cargar el detalle
                closeModal();
                viewVehicleDetail(vehicleId);
            } else {
                alert('Inspecci√≥n no encontrada');
            }
        }

        function previewVehiclePhoto(input, formType) {
            const file = input.files[0];
            if (file) {
                compressImage(file).then(compressedDataURL => {
                    const previewDiv = document.getElementById('vehiclePhotoPreview');
                    if (previewDiv) {
                        previewDiv.innerHTML = `
                            <img src="${compressedDataURL}" class="max-w-xs rounded border mt-2" alt="Vista previa">
                            <button type="button" onclick="removeVehiclePhoto()" class="text-xs text-red-600 hover:text-red-800 mt-1">
                                üóëÔ∏è Eliminar foto
                            </button>
                        `;
                    }
                });
            }
        }

        function removeVehiclePhoto() {
            const previewDiv = document.getElementById('vehiclePhotoPreview');
            const input = document.getElementById('vehiclePhotoInput');
            if (previewDiv) previewDiv.innerHTML = '';
            if (input) input.value = '';
        }

        function previewInspectionPhotos(input) {
            const files = input.files;
            if (!files || files.length === 0) return;

            const previewDiv = document.getElementById('inspectionPhotosPreview');
            inspectionPhotosData = [];

            Array.from(files).forEach((file, index) => {
                compressImage(file).then(compressedDataURL => {
                    inspectionPhotosData.push(compressedDataURL);
                    
                    const photoElement = document.createElement('div');
                    photoElement.className = 'relative';
                    photoElement.innerHTML = `
                        <img src="${compressedDataURL}" class="w-full h-24 object-cover rounded border" alt="Foto ${index + 1}">
                        <button type="button" onclick="removeInspectionPhoto(${index})" class="absolute top-1 right-1 bg-red-600 hover:bg-red-700 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">
                            √ó
                        </button>
                    `;
                    previewDiv.appendChild(photoElement);
                });
            });
        }

        function removeInspectionPhoto(index) {
            inspectionPhotosData.splice(index, 1);
            const previewDiv = document.getElementById('inspectionPhotosPreview');
            if (previewDiv) {
                previewDiv.innerHTML = '';
                inspectionPhotosData.forEach((photo, idx) => {
                    const photoElement = document.createElement('div');
                    photoElement.className = 'relative';
                    photoElement.innerHTML = `
                        <img src="${photo}" class="w-full h-24 object-cover rounded border" alt="Foto ${idx + 1}">
                        <button type="button" onclick="removeInspectionPhoto(${idx})" class="absolute top-1 right-1 bg-red-600 hover:bg-red-700 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">
                            √ó
                        </button>
                    `;
                    previewDiv.appendChild(photoElement);
                });
            }
        }

        function exportVehiclesPDF() {
            if (!currentEstablishment) {
                alert('Seleccione un establecimiento primero');
                return;
            }

            const vehicles = appData.vehicles ? appData.vehicles.filter(v => v.establecimiento_id === currentEstablishment.id) : [];
            if (vehicles.length === 0) {
                alert('No hay veh√≠culos registrados para exportar');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let yPos = 20;
            const pageHeight = doc.internal.pageSize.height;
            const pageWidth = doc.internal.pageSize.width;
            const margin = 15;

            // Funci√≥n auxiliar para verificar espacio y agregar p√°gina
            function checkPageBreak(needed = 20) {
                if (yPos + needed > pageHeight - 20) {
                    doc.addPage();
                    yPos = 20;
                    return true;
                }
                return false;
            }

            // HEADER/PORTADA
            doc.setFillColor(30, 58, 138);
            doc.rect(0, 0, pageWidth, 60, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text('GESTI√ìN DE MOVILIDADES', margin, 25);
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text('Control de Veh√≠culos e Inspecciones - Ley 19.587 / Dec. 351/79', margin, 35);
            doc.text(`Generado: ${new Date().toLocaleDateString('es-AR')}`, margin, 42);
            
            yPos = 80;
            doc.setTextColor(0, 0, 0);

            // DATOS DEL ESTABLECIMIENTO
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('ESTABLECIMIENTO', margin, yPos);
            yPos += 10;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Nombre: ${currentEstablishment.nombre}`, margin, yPos);
            yPos += 6;
            doc.text(`CUIT: ${currentEstablishment.cuit}`, margin, yPos);
            yPos += 6;
            doc.text(`Direcci√≥n: ${currentEstablishment.direccion}`, margin, yPos);
            yPos += 15;

            // RESUMEN
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('RESUMEN DE FLOTA', margin, yPos);
            yPos += 8;

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Total de Veh√≠culos: ${vehicles.length}`, margin, yPos);
            yPos += 6;
            doc.text(`Activos: ${vehicles.filter(v => v.estado === 'activo').length}`, margin, yPos);
            yPos += 6;
            doc.text(`En Mantenimiento: ${vehicles.filter(v => v.estado === 'mantenimiento').length}`, margin, yPos);
            yPos += 6;
            doc.text(`Inactivos: ${vehicles.filter(v => v.estado === 'inactivo').length}`, margin, yPos);
            yPos += 15;

            // DETALLE DE VEH√çCULOS
            doc.addPage();
            yPos = 20;
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('DETALLE DE VEH√çCULOS', margin, yPos);
            yPos += 12;

            vehicles.forEach((vehicle, idx) => {
                checkPageBreak(60);
                
                doc.setFillColor(240, 240, 240);
                doc.rect(margin, yPos - 4, pageWidth - 2 * margin, 8, 'F');
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text(`${idx + 1}. ${vehicle.patente} - ${vehicle.marca} ${vehicle.modelo}`, margin + 2, yPos);
                yPos += 10;

                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                doc.text(`Tipo: ${vehicle.tipo} | Estado: ${vehicle.estado}`, margin + 2, yPos);
                yPos += 5;
                if (vehicle.anio) {
                    doc.text(`A√±o: ${vehicle.anio} | Km: ${vehicle.kilometraje ? parseInt(vehicle.kilometraje).toLocaleString('es-AR') : 'N/D'}`, margin + 2, yPos);
                    yPos += 5;
                }

                // Documentaci√≥n
                doc.setFont(undefined, 'bold');
                doc.text('Documentaci√≥n:', margin + 2, yPos);
                yPos += 4;
                doc.setFont(undefined, 'normal');
                doc.text(`C√©dula: ${vehicle.cedula || 'N/D'} ${vehicle.cedula_vencimiento ? `(Venc: ${new Date(vehicle.cedula_vencimiento).toLocaleDateString('es-AR')})` : ''}`, margin + 4, yPos);
                yPos += 4;
                doc.text(`Seguro: ${vehicle.seguro || 'N/D'} ${vehicle.seguro_vencimiento ? `(Venc: ${new Date(vehicle.seguro_vencimiento).toLocaleDateString('es-AR')})` : ''}`, margin + 4, yPos);
                yPos += 4;
                doc.text(`VTV: ${vehicle.vtv || 'N/D'} ${vehicle.vtv_vencimiento ? `(Venc: ${new Date(vehicle.vtv_vencimiento).toLocaleDateString('es-AR')})` : ''}`, margin + 4, yPos);
                yPos += 6;

                // Inspecciones
                if (vehicle.inspecciones && vehicle.inspecciones.length > 0) {
                    doc.setFont(undefined, 'bold');
                    doc.text(`Inspecciones (${vehicle.inspecciones.length}):`, margin + 2, yPos);
                    yPos += 4;
                    doc.setFont(undefined, 'normal');
                    
                    vehicle.inspecciones.slice(-3).forEach(insp => {
                        if (checkPageBreak(8)) {
                            doc.setFontSize(9);
                            doc.setFont(undefined, 'normal');
                        }
                        doc.text(`- ${new Date(insp.fecha).toLocaleDateString('es-AR')}: ${insp.estado_general} (${insp.inspector})`, margin + 4, yPos);
                        yPos += 4;
                    });
                } else {
                    doc.setFont(undefined, 'italic');
                    doc.setTextColor(150, 150, 150);
                    doc.text('Sin inspecciones registradas', margin + 2, yPos);
                    doc.setTextColor(0, 0, 0);
                    yPos += 4;
                }

                yPos += 8;
            });

            // Pie de p√°gina
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                doc.text(`P√°gina ${i} de ${pageCount}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
                doc.text('Sistema de Seguridad e Higiene - Gesti√≥n de Movilidades', pageWidth / 2, pageHeight - 5, { align: 'center' });
            }

            const fileName = `Movilidades-${currentEstablishment.nombre.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
        }




        // ============= MACHINERY MANAGEMENT FUNCTIONS =============
        let machineryInspectionPhotosData = [];

        function showNewMachinery() {
            document.getElementById('newMachineryForm').classList.remove('hidden');
            document.getElementById('machineryList').closest('.bg-white').classList.add('hidden');
            document.getElementById('machineryInspectionForm').classList.add('hidden');
        }

        function cancelNewMachinery() {
            document.getElementById('newMachineryForm').classList.add('hidden');
            document.getElementById('machineryList').closest('.bg-white').classList.remove('hidden');
            document.getElementById('newMachineryForm').querySelector('form').reset();
            document.getElementById('machineryPhotoPreview').innerHTML = '';
        }

        function saveMachinery(event) {
            event.preventDefault();
            if (!currentEstablishment) {
                alert('Seleccione un establecimiento primero');
                return;
            }

            const form = event.target;
            const formData = new FormData(form);
            
            const machinery = {
                id: Date.now(),
                establecimiento_id: currentEstablishment.id,
                codigo: formData.get('codigo').toUpperCase(),
                tipo: formData.get('tipo'),
                estado: formData.get('estado'),
                marca: formData.get('marca'),
                modelo: formData.get('modelo'),
                anio: formData.get('anio'),
                numero_serie: formData.get('numero_serie'),
                potencia: formData.get('potencia'),
                tension: formData.get('tension'),
                sector: formData.get('sector'),
                ubicacion: formData.get('ubicacion'),
                operador: formData.get('operador'),
                turno: formData.get('turno'),
                manual: formData.get('manual'),
                certificacion_carga: formData.get('certificacion_carga'),
                cert_vencimiento: formData.get('cert_vencimiento'),
                habilitacion_operador: formData.get('habilitacion_operador'),
                hab_vencimiento: formData.get('hab_vencimiento'),
                puesta_tierra: formData.get('puesta_tierra'),
                frecuencia_mant: formData.get('frecuencia_mant'),
                ultimo_mantenimiento: formData.get('ultimo_mantenimiento'),
                proximo_mantenimiento: formData.get('proximo_mantenimiento'),
                riesgos: formData.get('riesgos'),
                observaciones: formData.get('observaciones'),
                foto: null,
                inspecciones: [],
                fecha_registro: new Date().toISOString()
            };

            // Capturar foto si existe
            const photoInput = document.getElementById('machineryPhotoInput');
            if (photoInput && photoInput.files && photoInput.files[0]) {
                const previewImg = document.querySelector('#machineryPhotoPreview img');
                if (previewImg) {
                    machinery.foto = previewImg.src;
                }
            }

            if (!appData.machinery) {
                appData.machinery = [];
            }
            appData.machinery.push(machinery);
            saveData();
            
            alert('Maquinaria registrada exitosamente');
            cancelNewMachinery();
            loadMachinery();
        }

        function loadMachinery() {
            if (!currentEstablishment) return;
            
            const machineryList = appData.machinery ? appData.machinery.filter(m => m.establecimiento_id === currentEstablishment.id) : [];
            const listDiv = document.getElementById('machineryList');
            
            if (machineryList.length === 0) {
                listDiv.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <div class="text-6xl mb-3"><i class="fas fa-cog"></i></div>
                        <p class="font-semibold">No hay maquinarias registradas</p>
                        <p class="text-sm">Comience registrando la primera maquinaria del establecimiento</p>
                    </div>
                `;
                return;
            }

            listDiv.innerHTML = machineryList.map(machinery => {
                const docStatus = getMachineryDocumentationStatus(machinery);
                const lastInspection = machinery.inspecciones && machinery.inspecciones.length > 0 
                    ? machinery.inspecciones[machinery.inspecciones.length - 1] 
                    : null;
                
                let estadoBadge = '';
                if (machinery.estado === 'operativo') {
                    estadoBadge = '<span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs font-semibold">Operativo</span>';
                } else if (machinery.estado === 'mantenimiento') {
                    estadoBadge = '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs font-semibold">Mantenimiento</span>';
                } else if (machinery.estado === 'fuera_servicio') {
                    estadoBadge = '<span class="px-2 py-1 bg-orange-100 text-orange-800 rounded text-xs font-semibold">Fuera de Servicio</span>';
                } else {
                    estadoBadge = '<span class="px-2 py-1 bg-gray-100 text-gray-800 rounded text-xs font-semibold">Baja</span>';
                }

                return `
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition machinery-item" data-status="${machinery.estado}" data-type="${machinery.tipo}">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-start gap-4 flex-1">
                                ${machinery.foto ? `
                                    <img src="${machinery.foto}" class="w-24 h-24 object-cover rounded-lg cursor-pointer hover:opacity-80 transition" onclick="openImageModal('${machinery.foto}')" alt="Maquinaria">
                                ` : `
                                    <div class="w-24 h-24 bg-gray-200 rounded-lg flex items-center justify-center text-3xl"><i class="fas fa-cog"></i></div>
                                `}
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <h3 class="text-lg font-bold text-gray-800">${machinery.codigo}</h3>
                                        ${estadoBadge}
                                    </div>
                                    <p class="text-gray-700 font-semibold">${machinery.marca} ${machinery.modelo}</p>
                                    <p class="text-sm text-gray-600">Tipo: ${machinery.tipo.charAt(0).toUpperCase() + machinery.tipo.slice(1).replace('_', ' ')}</p>
                                    <p class="text-sm text-gray-600">Sector: ${machinery.sector}</p>
                                    ${machinery.operador ? `<p class="text-sm text-gray-600">Operador: ${machinery.operador}</p>` : ''}
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="showMachineryInspection(${machinery.id})" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm font-semibold transition">
                                    <i class="fas fa-search"></i> Inspeccionar
                                </button>
                                <button onclick="viewMachineryDetail(${machinery.id})" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm font-semibold transition">
                                    üëÅÔ∏è Ver
                                </button>
                                <button onclick="deleteMachinery(${machinery.id})" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm font-semibold transition">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        
                        <!-- Documentation Status -->
                        <div class="grid grid-cols-3 gap-2 text-xs mb-3">
                            ${docStatus.certificacion}
                            ${docStatus.habilitacion}
                            ${docStatus.mantenimiento}
                        </div>

                        <!-- Last Inspection -->
                        ${lastInspection ? `
                            <div class="bg-gray-50 p-2 rounded mt-2">
                                <p class="text-xs font-semibold text-gray-700">√öltima Inspecci√≥n:</p>
                                <p class="text-xs text-gray-600">${new Date(lastInspection.fecha).toLocaleDateString('es-AR')} - ${lastInspection.estado_general === 'apto' ? '‚úÖ Apto' : lastInspection.estado_general === 'apto_con_observaciones' ? '‚ö†Ô∏è Apto c/obs' : '‚ùå No Apto'}</p>
                            </div>
                        ` : '<p class="text-xs text-gray-500 italic mt-2">Sin inspecciones registradas</p>'}
                    </div>
                `;
            }).join('');
        }

        function getMachineryDocumentationStatus(machinery) {
            const today = new Date();
            
            const getCertificacionStatus = () => {
                if (machinery.certificacion_carga === 'no_aplica') return '<div class="bg-gray-100 text-gray-800 p-1 rounded text-center"><div class="font-semibold">Certificaci√≥n</div><div>No Aplica</div></div>';
                if (machinery.certificacion_carga === 'pendiente') return '<div class="bg-yellow-100 text-yellow-800 p-1 rounded text-center"><div class="font-semibold">Certificaci√≥n</div><div>Pendiente</div></div>';
                if (machinery.certificacion_carga === 'vencida') return '<div class="bg-red-100 text-red-800 p-1 rounded text-center"><div class="font-semibold">Certificaci√≥n</div><div>Vencida</div></div>';
                if (machinery.cert_vencimiento) {
                    const vencimiento = new Date(machinery.cert_vencimiento);
                    const daysUntil = Math.floor((vencimiento - today) / (1000 * 60 * 60 * 24));
                    if (daysUntil < 0) return '<div class="bg-red-100 text-red-800 p-1 rounded text-center"><div class="font-semibold">Certificaci√≥n</div><div>Vencida</div></div>';
                    if (daysUntil < 30) return '<div class="bg-yellow-100 text-yellow-800 p-1 rounded text-center"><div class="font-semibold">Certificaci√≥n</div><div>Por vencer</div></div>';
                    return '<div class="bg-green-100 text-green-800 p-1 rounded text-center"><div class="font-semibold">Certificaci√≥n</div><div>Vigente</div></div>';
                }
                return '<div class="bg-green-100 text-green-800 p-1 rounded text-center"><div class="font-semibold">Certificaci√≥n</div><div>Vigente</div></div>';
            };

            const getHabilitacionStatus = () => {
                if (machinery.habilitacion_operador === 'no_requerida') return '<div class="bg-gray-100 text-gray-800 p-1 rounded text-center"><div class="font-semibold">Habilitaci√≥n</div><div>No Requerida</div></div>';
                if (machinery.habilitacion_operador === 'pendiente') return '<div class="bg-yellow-100 text-yellow-800 p-1 rounded text-center"><div class="font-semibold">Habilitaci√≥n</div><div>Pendiente</div></div>';
                if (machinery.habilitacion_operador === 'vencida') return '<div class="bg-red-100 text-red-800 p-1 rounded text-center"><div class="font-semibold">Habilitaci√≥n</div><div>Vencida</div></div>';
                if (machinery.hab_vencimiento) {
                    const vencimiento = new Date(machinery.hab_vencimiento);
                    const daysUntil = Math.floor((vencimiento - today) / (1000 * 60 * 60 * 24));
                    if (daysUntil < 0) return '<div class="bg-red-100 text-red-800 p-1 rounded text-center"><div class="font-semibold">Habilitaci√≥n</div><div>Vencida</div></div>';
                    if (daysUntil < 30) return '<div class="bg-yellow-100 text-yellow-800 p-1 rounded text-center"><div class="font-semibold">Habilitaci√≥n</div><div>Por vencer</div></div>';
                    return '<div class="bg-green-100 text-green-800 p-1 rounded text-center"><div class="font-semibold">Habilitaci√≥n</div><div>Vigente</div></div>';
                }
                return '<div class="bg-green-100 text-green-800 p-1 rounded text-center"><div class="font-semibold">Habilitaci√≥n</div><div>Vigente</div></div>';
            };

            const getMantenimientoStatus = () => {
                if (!machinery.proximo_mantenimiento) return '<div class="bg-gray-100 text-gray-800 p-1 rounded text-center"><div class="font-semibold">Mantenimiento</div><div>No Programado</div></div>';
                const proximo = new Date(machinery.proximo_mantenimiento);
                const daysUntil = Math.floor((proximo - today) / (1000 * 60 * 60 * 24));
                if (daysUntil < 0) return '<div class="bg-red-100 text-red-800 p-1 rounded text-center"><div class="font-semibold">Mantenimiento</div><div>Vencido</div></div>';
                if (daysUntil < 7) return '<div class="bg-yellow-100 text-yellow-800 p-1 rounded text-center"><div class="font-semibold">Mantenimiento</div><div>Pr√≥ximo</div></div>';
                return '<div class="bg-green-100 text-green-800 p-1 rounded text-center"><div class="font-semibold">Mantenimiento</div><div>Al d√≠a</div></div>';
            };

            return {
                certificacion: getCertificacionStatus(),
                habilitacion: getHabilitacionStatus(),
                mantenimiento: getMantenimientoStatus()
            };
        }

        function filterMachinery() {
            const statusFilter = document.getElementById('machineryFilterStatus').value;
            const typeFilter = document.getElementById('machineryFilterType').value;
            const searchText = document.getElementById('machinerySearch').value.toLowerCase();

            const items = document.querySelectorAll('.machinery-item');
            items.forEach(item => {
                const status = item.getAttribute('data-status');
                const type = item.getAttribute('data-type');
                const text = item.textContent.toLowerCase();

                const matchesStatus = !statusFilter || status === statusFilter;
                const matchesType = !typeFilter || type === typeFilter;
                const matchesSearch = !searchText || text.includes(searchText);

                if (matchesStatus && matchesType && matchesSearch) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function deleteMachinery(id) {
            if (!confirm('¬øEst√° seguro de eliminar esta maquinaria? Esta acci√≥n no se puede deshacer.')) {
                return;
            }

            const index = appData.machinery.findIndex(m => m.id === id);
            if (index !== -1) {
                appData.machinery.splice(index, 1);
                saveData();
                loadMachinery();
                alert('Maquinaria eliminada');
            }
        }

        function showMachineryInspection(machineryId) {
            const machinery = appData.machinery.find(m => m.id === machineryId);
            if (!machinery) return;

            document.getElementById('machineryList').closest('.bg-white').classList.add('hidden');
            document.getElementById('newMachineryForm').classList.add('hidden');
            document.getElementById('machineryInspectionForm').classList.remove('hidden');
            
            document.getElementById('inspectionMachineryId').value = machineryId;
            
            // Pre-rellenar fecha actual
            const form = document.getElementById('machineryInspectionForm').querySelector('form');
            const fechaInput = form.querySelector('input[name="fecha"]');
            if (fechaInput && !fechaInput.value) {
                fechaInput.value = new Date().toISOString().split('T')[0];
            }

            // Limpiar fotos previas
            machineryInspectionPhotosData = [];
            document.getElementById('machineryInspectionPhotosPreview').innerHTML = '';
        }

        function cancelMachineryInspection() {
            document.getElementById('machineryInspectionForm').classList.add('hidden');
            document.getElementById('machineryList').closest('.bg-white').classList.remove('hidden');
            document.getElementById('machineryInspectionForm').querySelector('form').reset();
            document.getElementById('machineryInspectionPhotosPreview').innerHTML = '';
            machineryInspectionPhotosData = [];
        }

        function saveMachineryInspection(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            const machineryId = parseInt(formData.get('machinery_id'));
            
            const machinery = appData.machinery.find(m => m.id === machineryId);
            if (!machinery) {
                alert('Maquinaria no encontrada');
                return;
            }

            const inspection = {
                id: Date.now(),
                fecha: formData.get('fecha'),
                inspector: formData.get('inspector'),
                tipo_inspeccion: formData.get('tipo_inspeccion'),
                protecciones_mecanicas: formData.get('protecciones_mecanicas'),
                resguardos_fijos: formData.get('resguardos_fijos'),
                resguardos_moviles: formData.get('resguardos_moviles'),
                parada_emergencia: formData.get('parada_emergencia'),
                senalizacion: formData.get('senalizacion'),
                enclavamientos: formData.get('enclavamientos'),
                conexion_tierra: formData.get('conexion_tierra'),
                disyuntor: formData.get('disyuntor'),
                cables: formData.get('cables'),
                tablero_electrico: formData.get('tablero_electrico'),
                estructura: formData.get('estructura'),
                componentes_moviles: formData.get('componentes_moviles'),
                lubricacion: formData.get('lubricacion'),
                sistema_hidraulico: formData.get('sistema_hidraulico'),
                niveles_fluidos: formData.get('niveles_fluidos'),
                ruidos_vibraciones: formData.get('ruidos_vibraciones'),
                botoneras: formData.get('botoneras'),
                palancas: formData.get('palancas'),
                indicadores: formData.get('indicadores'),
                sistema_control: formData.get('sistema_control'),
                estado_general: formData.get('estado_general'),
                observaciones: formData.get('observaciones'),
                acciones_correctivas: formData.get('acciones_correctivas'),
                fotos: machineryInspectionPhotosData
            };

            if (!machinery.inspecciones) {
                machinery.inspecciones = [];
            }
            machinery.inspecciones.push(inspection);

            // Actualizar √∫ltimo mantenimiento si la inspecci√≥n es preventiva
            if (inspection.tipo_inspeccion === 'preventiva') {
                machinery.ultimo_mantenimiento = inspection.fecha;
            }

            saveData();
            alert('Inspecci√≥n registrada exitosamente');
            cancelMachineryInspection();
            loadMachinery();
        }

        function viewMachineryDetail(machineryId) {
            const machinery = appData.machinery.find(m => m.id === machineryId);
            if (!machinery) return;

            const modal = document.getElementById('inspectionModal');
            const content = document.getElementById('inspectionModalContent');

            let inspectionsHTML = '';
            if (machinery.inspecciones && machinery.inspecciones.length > 0) {
                inspectionsHTML = `
                    <div class="mt-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-3"><i class="fas fa-clipboard-list"></i> Historial de Inspecciones</h3>
                        <div class="space-y-3">
                            ${machinery.inspecciones.slice().reverse().map(insp => `
                                <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                                    <div class="flex justify-between items-start mb-2">
                                        <div>
                                            <p class="font-semibold text-gray-800">${new Date(insp.fecha).toLocaleDateString('es-AR')} - ${insp.tipo_inspeccion.charAt(0).toUpperCase() + insp.tipo_inspeccion.slice(1)}</p>
                                            <p class="text-sm text-gray-600">Inspector: ${insp.inspector}</p>
                                        </div>
                                        <span class="px-3 py-1 rounded-full text-sm font-semibold ${
                                            insp.estado_general === 'apto' ? 'bg-green-100 text-green-800' :
                                            insp.estado_general === 'apto_con_observaciones' ? 'bg-yellow-100 text-yellow-800' :
                                            'bg-red-100 text-red-800'
                                        }">
                                            ${insp.estado_general === 'apto' ? 'Apto' :
                                              insp.estado_general === 'apto_con_observaciones' ? 'Apto c/Observaciones' :
                                              insp.estado_general === 'no_apto' ? 'No Apto' : 'Fuera de Servicio'}
                                        </span>
                                    </div>
                                    ${insp.observaciones ? `<p class="text-sm text-gray-700 mt-2"><strong>Hallazgos:</strong> ${insp.observaciones}</p>` : ''}
                                    ${insp.acciones_correctivas ? `<p class="text-sm text-gray-700 mt-1"><strong>Acciones Correctivas:</strong> ${insp.acciones_correctivas}</p>` : ''}
                                    ${insp.fotos && insp.fotos.length > 0 ? `
                                        <div class="mt-3 grid grid-cols-3 gap-2">
                                            ${insp.fotos.map(foto => `
                                                <img src="${foto}" class="w-full h-24 object-cover rounded cursor-pointer hover:opacity-80 transition" onclick="openImageModal('${foto}')" alt="Foto inspecci√≥n">
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                inspectionsHTML = '<p class="text-gray-500 italic mt-4">No hay inspecciones registradas para esta maquinaria.</p>';
            }

            content.innerHTML = `
                <div class="space-y-6">
                    <!-- Foto y datos principales -->
                    <div class="flex gap-6">
                        ${machinery.foto ? `
                            <img src="${machinery.foto}" class="w-48 h-48 object-cover rounded-lg cursor-pointer hover:opacity-80 transition" onclick="openImageModal('${machinery.foto}')" alt="Maquinaria">
                        ` : `
                            <div class="w-48 h-48 bg-gray-200 rounded-lg flex items-center justify-center text-6xl"><i class="fas fa-cog"></i></div>
                        `}
                        <div class="flex-1">
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">${machinery.codigo}</h2>
                            <p class="text-xl text-gray-700 mb-1">${machinery.marca} ${machinery.modelo}</p>
                            <p class="text-gray-600">Tipo: ${machinery.tipo.charAt(0).toUpperCase() + machinery.tipo.slice(1).replace('_', ' ')}</p>
                            <p class="text-gray-600">Sector: ${machinery.sector}${machinery.ubicacion ? ` - ${machinery.ubicacion}` : ''}</p>
                            ${machinery.numero_serie ? `<p class="text-gray-600">N¬∞ Serie: ${machinery.numero_serie}</p>` : ''}
                            ${machinery.potencia ? `<p class="text-gray-600">Potencia/Capacidad: ${machinery.potencia}</p>` : ''}
                            <span class="inline-block mt-2 px-3 py-1 rounded-full text-sm font-semibold ${
                                machinery.estado === 'operativo' ? 'bg-green-100 text-green-800' :
                                machinery.estado === 'mantenimiento' ? 'bg-yellow-100 text-yellow-800' :
                                machinery.estado === 'fuera_servicio' ? 'bg-orange-100 text-orange-800' :
                                'bg-gray-100 text-gray-800'
                            }">
                                ${machinery.estado.charAt(0).toUpperCase() + machinery.estado.slice(1).replace('_', ' ')}
                            </span>
                        </div>
                    </div>

                    <!-- Informaci√≥n t√©cnica -->
                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-bold text-gray-800 mb-2">Informaci√≥n T√©cnica</h3>
                            ${machinery.anio ? `<p class="text-sm text-gray-700"><strong>A√±o:</strong> ${machinery.anio}</p>` : ''}
                            ${machinery.tension ? `<p class="text-sm text-gray-700"><strong>Tensi√≥n:</strong> ${machinery.tension}</p>` : ''}
                            ${machinery.operador ? `<p class="text-sm text-gray-700"><strong>Operador:</strong> ${machinery.operador}</p>` : ''}
                            ${machinery.turno ? `<p class="text-sm text-gray-700"><strong>Turno:</strong> ${machinery.turno.charAt(0).toUpperCase() + machinery.turno.slice(1)}</p>` : ''}
                        </div>

                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-bold text-gray-800 mb-2">Documentaci√≥n</h3>
                            <div class="space-y-1 text-sm">
                                <p><strong>Manual:</strong> ${machinery.manual ? machinery.manual.replace('_', ' ').charAt(0).toUpperCase() + machinery.manual.slice(1).replace('_', ' ') : 'No especificado'}</p>
                                <p><strong>Certificaci√≥n:</strong> ${machinery.certificacion_carga || 'No especificado'} ${machinery.cert_vencimiento ? `(Venc: ${new Date(machinery.cert_vencimiento).toLocaleDateString('es-AR')})` : ''}</p>
                                <p><strong>Habilitaci√≥n Operador:</strong> ${machinery.habilitacion_operador ? machinery.habilitacion_operador.replace('_', ' ').charAt(0).toUpperCase() + machinery.habilitacion_operador.slice(1).replace('_', ' ') : 'No especificado'} ${machinery.hab_vencimiento ? `(Venc: ${new Date(machinery.hab_vencimiento).toLocaleDateString('es-AR')})` : ''}</p>
                                <p><strong>Puesta a Tierra:</strong> ${machinery.puesta_tierra ? machinery.puesta_tierra.replace('_', ' ').charAt(0).toUpperCase() + machinery.puesta_tierra.slice(1).replace('_', ' ') : 'No especificado'}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Mantenimiento -->
                    ${machinery.frecuencia_mant || machinery.ultimo_mantenimiento || machinery.proximo_mantenimiento ? `
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-bold text-gray-800 mb-2">Mantenimiento</h3>
                            <div class="space-y-1 text-sm">
                                ${machinery.frecuencia_mant ? `<p><strong>Frecuencia:</strong> ${machinery.frecuencia_mant.charAt(0).toUpperCase() + machinery.frecuencia_mant.slice(1)}</p>` : ''}
                                ${machinery.ultimo_mantenimiento ? `<p><strong>√öltimo:</strong> ${new Date(machinery.ultimo_mantenimiento).toLocaleDateString('es-AR')}</p>` : ''}
                                ${machinery.proximo_mantenimiento ? `<p><strong>Pr√≥ximo:</strong> ${new Date(machinery.proximo_mantenimiento).toLocaleDateString('es-AR')}</p>` : ''}
                            </div>
                        </div>
                    ` : ''}

                    ${machinery.riesgos ? `
                        <div class="bg-orange-50 p-4 rounded-lg border-l-4 border-orange-500">
                            <h3 class="font-bold text-orange-800 mb-2">‚ö†Ô∏è Riesgos Principales</h3>
                            <p class="text-sm text-orange-700">${machinery.riesgos}</p>
                        </div>
                    ` : ''}

                    ${machinery.observaciones ? `
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h3 class="font-bold text-gray-800 mb-2">Observaciones</h3>
                            <p class="text-sm text-gray-700">${machinery.observaciones}</p>
                        </div>
                    ` : ''}

                    ${inspectionsHTML}
                </div>
            `;

            modal.classList.remove('hidden');
        }

        function previewMachineryPhoto(input, formType) {
            const file = input.files[0];
            if (file) {
                compressImage(file).then(compressedDataURL => {
                    const previewDiv = document.getElementById('machineryPhotoPreview');
                    if (previewDiv) {
                        previewDiv.innerHTML = `
                            <img src="${compressedDataURL}" class="max-w-xs rounded border mt-2" alt="Vista previa">
                            <button type="button" onclick="removeMachineryPhoto()" class="text-xs text-red-600 hover:text-red-800 mt-1">
                                üóëÔ∏è Eliminar foto
                            </button>
                        `;
                    }
                });
            }
        }

        function removeMachineryPhoto() {
            const previewDiv = document.getElementById('machineryPhotoPreview');
            const input = document.getElementById('machineryPhotoInput');
            if (previewDiv) previewDiv.innerHTML = '';
            if (input) input.value = '';
        }

        function previewMachineryInspectionPhotos(input) {
            const files = input.files;
            if (!files || files.length === 0) return;

            const previewDiv = document.getElementById('machineryInspectionPhotosPreview');
            machineryInspectionPhotosData = [];

            Array.from(files).forEach((file, index) => {
                compressImage(file).then(compressedDataURL => {
                    machineryInspectionPhotosData.push(compressedDataURL);
                    
                    const photoElement = document.createElement('div');
                    photoElement.className = 'relative';
                    photoElement.innerHTML = `
                        <img src="${compressedDataURL}" class="w-full h-24 object-cover rounded border" alt="Foto ${index + 1}">
                        <button type="button" onclick="removeMachineryInspectionPhoto(${index})" class="absolute top-1 right-1 bg-red-600 hover:bg-red-700 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">
                            √ó
                        </button>
                    `;
                    previewDiv.appendChild(photoElement);
                });
            });
        }

        function removeMachineryInspectionPhoto(index) {
            machineryInspectionPhotosData.splice(index, 1);
            const previewDiv = document.getElementById('machineryInspectionPhotosPreview');
            if (previewDiv) {
                previewDiv.innerHTML = '';
                machineryInspectionPhotosData.forEach((photo, idx) => {
                    const photoElement = document.createElement('div');
                    photoElement.className = 'relative';
                    photoElement.innerHTML = `
                        <img src="${photo}" class="w-full h-24 object-cover rounded border" alt="Foto ${idx + 1}">
                        <button type="button" onclick="removeMachineryInspectionPhoto(${idx})" class="absolute top-1 right-1 bg-red-600 hover:bg-red-700 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">
                            √ó
                        </button>
                    `;
                    previewDiv.appendChild(photoElement);
                });
            }
        }

        function exportMachineryPDF() {
            if (!currentEstablishment) {
                alert('Seleccione un establecimiento primero');
                return;
            }

            const machineryList = appData.machinery ? appData.machinery.filter(m => m.establecimiento_id === currentEstablishment.id) : [];
            if (machineryList.length === 0) {
                alert('No hay maquinarias registradas para exportar');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let yPos = 20;
            const pageHeight = doc.internal.pageSize.height;
            const pageWidth = doc.internal.pageSize.width;
            const margin = 15;

            // Funci√≥n auxiliar para verificar espacio y agregar p√°gina
            function checkPageBreak(needed = 20) {
                if (yPos + needed > pageHeight - 20) {
                    doc.addPage();
                    yPos = 20;
                    return true;
                }
                return false;
            }

            // HEADER/PORTADA
            doc.setFillColor(30, 58, 138);
            doc.rect(0, 0, pageWidth, 60, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text('GESTI√ìN DE MAQUINARIAS', margin, 25);
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text('Control de Equipos e Inspecciones - Dec. 351/79 Anexo V - Res. SRT 896/99', margin, 35);
            doc.text(`Generado: ${new Date().toLocaleDateString('es-AR')}`, margin, 42);
            
            yPos = 80;
            doc.setTextColor(0, 0, 0);

            // DATOS DEL ESTABLECIMIENTO
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('ESTABLECIMIENTO', margin, yPos);
            yPos += 10;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Nombre: ${currentEstablishment.nombre}`, margin, yPos);
            yPos += 6;
            doc.text(`CUIT: ${currentEstablishment.cuit}`, margin, yPos);
            yPos += 6;
            doc.text(`Direcci√≥n: ${currentEstablishment.direccion}`, margin, yPos);
            yPos += 15;

            // RESUMEN
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('RESUMEN DE MAQUINARIAS', margin, yPos);
            yPos += 8;

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Total de Maquinarias: ${machineryList.length}`, margin, yPos);
            yPos += 6;
            doc.text(`Operativas: ${machineryList.filter(m => m.estado === 'operativo').length}`, margin, yPos);
            yPos += 6;
            doc.text(`En Mantenimiento: ${machineryList.filter(m => m.estado === 'mantenimiento').length}`, margin, yPos);
            yPos += 6;
            doc.text(`Fuera de Servicio: ${machineryList.filter(m => m.estado === 'fuera_servicio').length}`, margin, yPos);
            yPos += 15;

            // DETALLE DE MAQUINARIAS
            doc.addPage();
            yPos = 20;
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('DETALLE DE MAQUINARIAS', margin, yPos);
            yPos += 12;

            machineryList.forEach((machinery, idx) => {
                checkPageBreak(70);
                
                doc.setFillColor(240, 240, 240);
                doc.rect(margin, yPos - 4, pageWidth - 2 * margin, 8, 'F');
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text(`${idx + 1}. ${machinery.codigo} - ${machinery.marca} ${machinery.modelo}`, margin + 2, yPos);
                yPos += 10;

                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                doc.text(`Tipo: ${machinery.tipo} | Estado: ${machinery.estado} | Sector: ${machinery.sector}`, margin + 2, yPos);
                yPos += 5;

                // Documentaci√≥n
                doc.setFont(undefined, 'bold');
                doc.text('Documentaci√≥n:', margin + 2, yPos);
                yPos += 4;
                doc.setFont(undefined, 'normal');
                doc.text(`Manual: ${machinery.manual || 'N/D'} | Certificaci√≥n: ${machinery.certificacion_carga || 'N/D'}`, margin + 4, yPos);
                yPos += 4;
                doc.text(`Habilitaci√≥n: ${machinery.habilitacion_operador || 'N/D'} | Puesta a Tierra: ${machinery.puesta_tierra || 'N/D'}`, margin + 4, yPos);
                yPos += 6;

                // Inspecciones
                if (machinery.inspecciones && machinery.inspecciones.length > 0) {
                    doc.setFont(undefined, 'bold');
                    doc.text(`Inspecciones (${machinery.inspecciones.length}):`, margin + 2, yPos);
                    yPos += 4;
                    doc.setFont(undefined, 'normal');
                    
                    machinery.inspecciones.slice(-3).forEach(insp => {
                        if (checkPageBreak(8)) {
                            doc.setFontSize(9);
                            doc.setFont(undefined, 'normal');
                        }
                        doc.text(`- ${new Date(insp.fecha).toLocaleDateString('es-AR')}: ${insp.estado_general} (${insp.inspector})`, margin + 4, yPos);
                        yPos += 4;
                    });
                }

                yPos += 8;
            });

            // Pie de p√°gina
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                doc.text(`P√°gina ${i} de ${pageCount}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
                doc.text('Sistema de Seguridad e Higiene - Gesti√≥n de Maquinarias', pageWidth / 2, pageHeight - 5, { align: 'center' });
            }

            const fileName = `Maquinarias-${currentEstablishment.nombre.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
        }


        // ============= MAIN CALENDAR FUNCTIONS =============
        let mainCalendarMonth = new Date().getMonth();
        let mainCalendarYear = new Date().getFullYear();

        function renderMainCalendar() {
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                              'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            // Actualizar t√≠tulo del mes
            document.getElementById('mainCalendarMonthYear').textContent = 
                `${monthNames[mainCalendarMonth]} ${mainCalendarYear}`;
            
            // Obtener todos los eventos
            const eventosPorDia = getAllMainCalendarEvents();
            
            // Obtener primer y √∫ltimo d√≠a del mes
            const firstDay = new Date(mainCalendarYear, mainCalendarMonth, 1);
            const lastDay = new Date(mainCalendarYear, mainCalendarMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDayOfWeek = firstDay.getDay();
            
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            
            // Generar d√≠as del calendario
            const calendarDays = document.getElementById('mainCalendarDays');
            calendarDays.innerHTML = '';
            
            // Celdas vac√≠as antes del primer d√≠a
            for (let i = 0; i < startDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-day other-month';
                calendarDays.appendChild(emptyCell);
            }
            
            // D√≠as del mes
            for (let dia = 1; dia <= daysInMonth; dia++) {
                const dayCell = document.createElement('div');
                const fechaDia = new Date(mainCalendarYear, mainCalendarMonth, dia);
                const esHoy = fechaDia.toDateString() === hoy.toDateString();
                
                const eventos = eventosPorDia[dia] || [];
                
                dayCell.className = 'calendar-day';
                if (esHoy) {
                    dayCell.className += ' today';
                }
                
                let content = `<div class="calendar-day-number">${dia}</div>`;
                
                if (eventos.length > 0) {
                    dayCell.style.cursor = 'pointer';
                    dayCell.onclick = () => showMainCalendarDayEvents(dia, eventos);
                    
                    // Mostrar eventos (m√°ximo 3)
                    const maxEvents = 3;
                    eventos.slice(0, maxEvents).forEach(e => {
                        let eventClass = '';
                        if (e.tipo === 'extintor') {
                            // Para extintores, usar el color seg√∫n su estado de vencimiento
                            if (e.estadoVencimiento === 'vencido') eventClass = 'expired';
                            else if (e.estadoVencimiento === 'por_vencer') eventClass = 'warning';
                            else eventClass = 'extinguisher';
                        }
                        else if (e.tipo === 'vencido') eventClass = 'expired';
                        else if (e.tipo === 'por_vencer') eventClass = 'warning';
                        else if (e.tipo === 'capacitacion') eventClass = 'training';
                        else if (e.tipo === 'inspeccion') eventClass = 'upcoming';
                        
                        // Limpiar el t√≠tulo de cualquier HTML
                        const cleanTitle = e.titulo.replace(/<[^>]*>/g, '');
                        content += `<div class="calendar-event ${eventClass}">${cleanTitle.substring(0, 30)}</div>`;
                    });
                    
                    if (eventos.length > maxEvents) {
                        content += `<div class="calendar-more">+${eventos.length - maxEvents} m√°s</div>`;
                    }
                }
                
                dayCell.innerHTML = content;
                calendarDays.appendChild(dayCell);
            }
        }

        function getAllMainCalendarEvents() {
            const eventosPorDia = {};
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            
            // Get all establishments for context
            const establishments = appData.establishments || [];
            const establishmentMap = {};
            establishments.forEach(est => {
                establishmentMap[est.id] = est.nombre;
            });
            
            // Helper function to add event
            function addEvent(dia, evento) {
                if (!eventosPorDia[dia]) {
                    eventosPorDia[dia] = [];
                }
                eventosPorDia[dia].push(evento);
            }
            
            // 1. CAPACITACIONES
            if (appData.trainings) {
                appData.trainings.forEach(training => {
                    if (training.fecha) {
                        const fecha = new Date(training.fecha + 'T00:00:00');
                        if (fecha.getMonth() === mainCalendarMonth && fecha.getFullYear() === mainCalendarYear) {
                            const estName = establishmentMap[training.establecimiento_id] || 'Sin establecimiento';
                            addEvent(fecha.getDate(), {
                                tipo: 'capacitacion',
                                titulo: `Capacitaci√≥n: ${training.titulo}`,
                                establecimiento: estName,
                                detalles: {
                                    tema: training.titulo,
                                    instructor: training.instructor,
                                    participantes: Array.isArray(training.participantes) 
                                        ? training.participantes.length + ' personas'
                                        : training.participantes,
                                    horas: training.duracion + ' hs'
                                }
                            });
                        }
                    }
                });
            }
            
            // 2. MOVILIDADES - Vencimientos
            if (appData.vehicles) {
                appData.vehicles.forEach(vehicle => {
                    const estName = establishmentMap[vehicle.establecimiento_id] || 'Sin establecimiento';
                    
                    // C√©dula
                    if (vehicle.cedula_vencimiento) {
                        const fecha = new Date(vehicle.cedula_vencimiento + 'T00:00:00');
                        if (fecha.getMonth() === mainCalendarMonth && fecha.getFullYear() === mainCalendarYear) {
                            const daysUntil = Math.floor((fecha - hoy) / (1000 * 60 * 60 * 24));
                            const tipo = daysUntil < 0 ? 'vencido' : daysUntil < 30 ? 'por_vencer' : 'proximo';
                            
                            addEvent(fecha.getDate(), {
                                tipo: tipo,
                                titulo: `C√©dula ${vehicle.patente}`,
                                establecimiento: estName,
                                detalles: {
                                    documento: 'C√©dula',
                                    vehiculo: `${vehicle.marca} ${vehicle.modelo} (${vehicle.patente})`,
                                    estado: daysUntil < 0 ? `VENCIDO hace ${Math.abs(daysUntil)} d√≠as` : `Vence en ${daysUntil} d√≠as`
                                }
                            });
                        }
                    }
                    
                    // Seguro
                    if (vehicle.seguro_vencimiento) {
                        const fecha = new Date(vehicle.seguro_vencimiento + 'T00:00:00');
                        if (fecha.getMonth() === mainCalendarMonth && fecha.getFullYear() === mainCalendarYear) {
                            const daysUntil = Math.floor((fecha - hoy) / (1000 * 60 * 60 * 24));
                            const tipo = daysUntil < 0 ? 'vencido' : daysUntil < 30 ? 'por_vencer' : 'proximo';
                            
                            addEvent(fecha.getDate(), {
                                tipo: tipo,
                                titulo: `Seguro ${vehicle.patente}`,
                                establecimiento: estName,
                                detalles: {
                                    documento: 'Seguro',
                                    vehiculo: `${vehicle.marca} ${vehicle.modelo} (${vehicle.patente})`,
                                    compania: vehicle.seguro_compania || 'N/A',
                                    estado: daysUntil < 0 ? `VENCIDO hace ${Math.abs(daysUntil)} d√≠as` : `Vence en ${daysUntil} d√≠as`
                                }
                            });
                        }
                    }
                    
                    // VTV
                    if (vehicle.vtv_vencimiento) {
                        const fecha = new Date(vehicle.vtv_vencimiento + 'T00:00:00');
                        if (fecha.getMonth() === mainCalendarMonth && fecha.getFullYear() === mainCalendarYear) {
                            const daysUntil = Math.floor((fecha - hoy) / (1000 * 60 * 60 * 24));
                            const tipo = daysUntil < 0 ? 'vencido' : daysUntil < 30 ? 'por_vencer' : 'proximo';
                            
                            addEvent(fecha.getDate(), {
                                tipo: tipo,
                                titulo: `VTV ${vehicle.patente}`,
                                establecimiento: estName,
                                detalles: {
                                    documento: 'VTV/RTO',
                                    vehiculo: `${vehicle.marca} ${vehicle.modelo} (${vehicle.patente})`,
                                    estado: daysUntil < 0 ? `VENCIDO hace ${Math.abs(daysUntil)} d√≠as` : `Vence en ${daysUntil} d√≠as`
                                }
                            });
                        }
                    }
                    
                    // Inspecciones de veh√≠culos
                    if (vehicle.inspecciones) {
                        vehicle.inspecciones.forEach(insp => {
                            if (insp.fecha) {
                                const fecha = new Date(insp.fecha + 'T00:00:00');
                                if (fecha.getMonth() === mainCalendarMonth && fecha.getFullYear() === mainCalendarYear) {
                                    addEvent(fecha.getDate(), {
                                        tipo: 'inspeccion',
                                        titulo: `Inspecci√≥n Veh√≠culo ${vehicle.patente}`,
                                        establecimiento: estName,
                                        detalles: {
                                            tipo_inspeccion: 'Veh√≠culo',
                                            vehiculo: `${vehicle.marca} ${vehicle.modelo} (${vehicle.patente})`,
                                            inspector: insp.inspector,
                                            resultado: insp.estado_general
                                        }
                                    });
                                }
                            }
                        });
                    }
                });
            }
            
            // 3. MAQUINARIAS - Inspecciones
            if (appData.machinery) {
                appData.machinery.forEach(machine => {
                    const estName = establishmentMap[machine.establecimiento_id] || 'Sin establecimiento';
                    
                    if (machine.inspecciones) {
                        machine.inspecciones.forEach(insp => {
                            if (insp.fecha) {
                                const fecha = new Date(insp.fecha + 'T00:00:00');
                                if (fecha.getMonth() === mainCalendarMonth && fecha.getFullYear() === mainCalendarYear) {
                                    addEvent(fecha.getDate(), {
                                        tipo: 'inspeccion',
                                        titulo: `Inspecci√≥n Maquinaria ${machine.codigo}`,
                                        establecimiento: estName,
                                        detalles: {
                                            tipo_inspeccion: 'Maquinaria',
                                            maquinaria: `${machine.marca} ${machine.modelo} (${machine.codigo})`,
                                            inspector: insp.inspector,
                                            resultado: insp.estado_general
                                        }
                                    });
                                }
                            }
                        });
                    }
                });
            }
            
            // 4. CHECKLIST - Inspecciones
            if (appData.inspections) {
                appData.inspections.forEach(inspection => {
                    if (inspection.fecha) {
                        const fecha = new Date(inspection.fecha + 'T00:00:00');
                        if (fecha.getMonth() === mainCalendarMonth && fecha.getFullYear() === mainCalendarYear) {
                            const estName = establishmentMap[inspection.establecimiento_id] || 'Sin establecimiento';
                            const inspectorNombre = inspection.inspector?.nombre || inspection.inspector || 'No especificado';
                            const zona = inspection.sector || inspection.zona || 'Sin especificar';
                            
                            addEvent(fecha.getDate(), {
                                tipo: 'inspeccion',
                                titulo: `Inspecci√≥n ${zona}`,
                                establecimiento: estName,
                                detalles: {
                                    tipo_inspeccion: 'Zona',
                                    zona: zona,
                                    inspector: inspectorNombre,
                                    hallazgos: inspection.resumen?.nok || inspection.hallazgos?.length || 0,
                                    items_ok: inspection.resumen?.ok || 0,
                                    total_items: inspection.resumen?.total || 0
                                }
                            });
                        }
                    }
                });
            }
            
            // 5. EPP - Vencimientos
            if (appData.ppe) {
                appData.ppe.forEach(epp => {
                    if (epp.vencimiento) {
                        const fecha = new Date(epp.vencimiento + 'T00:00:00');
                        if (fecha.getMonth() === mainCalendarMonth && fecha.getFullYear() === mainCalendarYear) {
                            const estName = establishmentMap[epp.establecimiento_id] || 'Sin establecimiento';
                            const daysUntil = Math.floor((fecha - hoy) / (1000 * 60 * 60 * 24));
                            const tipo = daysUntil < 0 ? 'vencido' : daysUntil < 30 ? 'por_vencer' : 'proximo';
                            
                            addEvent(fecha.getDate(), {
                                tipo: tipo,
                                titulo: `EPP ${epp.tipo}`,
                                establecimiento: estName,
                                detalles: {
                                    elemento: epp.tipo,
                                    asignado: epp.trabajador,
                                    estado: daysUntil < 0 ? `VENCIDO hace ${Math.abs(daysUntil)} d√≠as` : `Vence en ${daysUntil} d√≠as`
                                }
                            });
                        }
                    }
                });
            }
            
            // 6. EXTINTORES - Vencimientos
            if (appData.extinguishers) {
                appData.extinguishers.forEach(ext => {
                    if (ext.fecha_vencimiento) {
                        const fecha = new Date(ext.fecha_vencimiento + 'T00:00:00');
                        if (fecha.getMonth() === mainCalendarMonth && fecha.getFullYear() === mainCalendarYear) {
                            const estName = establishmentMap[ext.establecimiento_id] || 'Sin establecimiento';
                            const daysUntil = Math.floor((fecha - hoy) / (1000 * 60 * 60 * 24));
                            const estadoVencimiento = daysUntil < 0 ? 'vencido' : daysUntil < 30 ? 'por_vencer' : 'proximo';
                            
                            addEvent(fecha.getDate(), {
                                tipo: 'extintor',
                                estadoVencimiento: estadoVencimiento,
                                titulo: `üßØ Extintor ${ext.codigo}`,
                                establecimiento: estName,
                                detalles: {
                                    codigo: ext.codigo,
                                    tipo_extintor: ext.tipo,
                                    capacidad: ext.capacidad + ' kg',
                                    ubicacion: ext.ubicacion,
                                    estado: daysUntil < 0 ? `VENCIDO hace ${Math.abs(daysUntil)} d√≠as` : `Vence en ${daysUntil} d√≠as`
                                }
                            });
                        }
                    }
                });
            }
            
            // 7. DOCUMENTOS - Vencimientos
            if (appData.documents) {
                appData.documents.forEach(doc => {
                    if (doc.fecha_vencimiento) {
                        const fecha = new Date(doc.fecha_vencimiento + 'T00:00:00');
                        if (fecha.getMonth() === mainCalendarMonth && fecha.getFullYear() === mainCalendarYear) {
                            const estName = establishmentMap[doc.establishmentId] || 'Sin establecimiento';
                            const daysUntil = Math.floor((fecha - hoy) / (1000 * 60 * 60 * 24));
                            const tipo = daysUntil < 0 ? 'vencido' : daysUntil < 30 ? 'por_vencer' : 'proximo';
                            
                            // Nombres de categor√≠as para mostrar
                            const categoryNames = {
                                laboralSeguridad: 'Laboral y S&H',
                                habilitacion: 'Habilitaci√≥n',
                                incendios: 'Incendios',
                                ambiental: 'Ambiental',
                                sanitario: 'Sanitario',
                                salud: 'Salud',
                                complementaria: 'Complementaria'
                            };
                            
                            const categoriaNombre = categoryNames[doc.categoria] || doc.categoria;
                            
                            addEvent(fecha.getDate(), {
                                tipo: tipo,
                                titulo: `${doc.tipo}`,
                                establecimiento: estName,
                                detalles: {
                                    documento: doc.tipo,
                                    categoria: categoriaNombre,
                                    organismo: doc.organismo || 'No especificado',
                                    responsable: doc.responsable || 'No asignado',
                                    numero_expediente: doc.numero_expediente || 'Sin n√∫mero',
                                    estado: daysUntil < 0 ? `VENCIDO hace ${Math.abs(daysUntil)} d√≠as` : `Vence en ${daysUntil} d√≠as`
                                }
                            });
                        }
                    }
                });
            }
            
            return eventosPorDia;
        }

        function showMainCalendarDayEvents(dia, eventos) {
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                              'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            const modal = document.getElementById('calendarEventsModal');
            const content = document.getElementById('calendarEventsContent');
            const title = document.getElementById('calendarModalTitle');
            
            title.textContent = `Eventos del ${dia} de ${monthNames[mainCalendarMonth]} ${mainCalendarYear}`;
            
            // Agrupar por tipo
            const extintores = eventos.filter(e => e.tipo === 'extintor');
            const vencidos = eventos.filter(e => e.tipo === 'vencido');
            const porVencer = eventos.filter(e => e.tipo === 'por_vencer');
            const capacitaciones = eventos.filter(e => e.tipo === 'capacitacion');
            const inspecciones = eventos.filter(e => e.tipo === 'inspeccion');
            
            let html = '<div class="space-y-6">';
            
            // Secci√≥n de extintores
            if (extintores.length > 0) {
                html += '<div><h3 class="text-lg font-bold text-red-800 mb-3">üßØ Extintores</h3><div class="space-y-2">';
                extintores.forEach(evento => {
                    const borderColor = evento.estadoVencimiento === 'vencido' ? 'border-red-600' : 
                                      evento.estadoVencimiento === 'por_vencer' ? 'border-yellow-600' : 'border-orange-600';
                    const bgColor = evento.estadoVencimiento === 'vencido' ? 'bg-red-50' : 
                                   evento.estadoVencimiento === 'por_vencer' ? 'bg-yellow-50' : 'bg-orange-50';
                    html += createMainEventCard(evento, `${bgColor} border-l-4 ${borderColor}`);
                });
                html += '</div></div>';
            }
            
            if (vencidos.length > 0) {
                html += '<div><h3 class="text-lg font-bold text-red-800 mb-3"><i class="fas fa-times-circle"></i> Vencidos</h3><div class="space-y-2">';
                vencidos.forEach(evento => {
                    html += createMainEventCard(evento, 'bg-red-50 border-l-4 border-red-600');
                });
                html += '</div></div>';
            }
            
            if (porVencer.length > 0) {
                html += '<div><h3 class="text-lg font-bold text-yellow-800 mb-3"><i class="fas fa-exclamation-triangle"></i> Pr√≥ximos a vencer</h3><div class="space-y-2">';
                porVencer.forEach(evento => {
                    html += createMainEventCard(evento, 'bg-yellow-50 border-l-4 border-yellow-600');
                });
                html += '</div></div>';
            }
            
            if (capacitaciones.length > 0) {
                html += '<div><h3 class="text-lg font-bold text-green-800 mb-3"><i class="fas fa-graduation-cap"></i> Capacitaciones</h3><div class="space-y-2">';
                capacitaciones.forEach(evento => {
                    html += createMainEventCard(evento, 'bg-green-50 border-l-4 border-green-600');
                });
                html += '</div></div>';
            }
            
            if (inspecciones.length > 0) {
                html += '<div><h3 class="text-lg font-bold text-purple-800 mb-3"><i class="fas fa-clipboard-check"></i> Inspecciones</h3><div class="space-y-2">';
                inspecciones.forEach(evento => {
                    html += createMainEventCard(evento, 'bg-purple-50 border-l-4 border-purple-600');
                });
                html += '</div></div>';
            }
            
            html += '</div>';
            content.innerHTML = html;
            modal.classList.remove('hidden');
        }

        function createMainEventCard(evento, className) {
            let detailsHTML = `<p class="text-sm"><strong>Establecimiento:</strong> ${evento.establecimiento || 'No especificado'}</p>`;
            
            if (evento.detalles && typeof evento.detalles === 'object') {
                for (const [key, value] of Object.entries(evento.detalles)) {
                    if (value !== undefined && value !== null && value !== '') {
                        const label = key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' ');
                        detailsHTML += `<p class="text-sm"><strong>${label}:</strong> ${value}</p>`;
                    }
                }
            }
            
            return `
                <div class="${className} p-4 rounded-lg">
                    <h4 class="font-bold text-gray-800 mb-2">${evento.titulo}</h4>
                    ${detailsHTML}
                </div>
            `;
        }

        function mainCalendarPreviousMonth() {
            mainCalendarMonth--;
            if (mainCalendarMonth < 0) {
                mainCalendarMonth = 11;
                mainCalendarYear--;
            }
            renderMainCalendar();
        }

        function mainCalendarNextMonth() {
            mainCalendarMonth++;
            if (mainCalendarMonth > 11) {
                mainCalendarMonth = 0;
                mainCalendarYear++;
            }
            renderMainCalendar();
        }

        function mainCalendarToday() {
            const today = new Date();
            mainCalendarMonth = today.getMonth();
            mainCalendarYear = today.getFullYear();
            renderMainCalendar();
        }

        function toggleMainCalendar() {
            const content = document.getElementById('mainCalendarContent');
            const icon = document.getElementById('toggleCalendarIcon');
            const text = document.getElementById('toggleCalendarText');
            
            if (content.style.maxHeight === '0px' || content.style.maxHeight === '') {
                // Mostrar calendario
                content.style.maxHeight = content.scrollHeight + 'px';
                setTimeout(() => {
                    content.style.maxHeight = '2000px'; // Altura m√°xima para permitir expansi√≥n
                }, 500);
                icon.textContent = '‚ñ≤';
                text.textContent = 'Ocultar Calendario';
            } else {
                // Ocultar calendario
                content.style.maxHeight = content.scrollHeight + 'px';
                setTimeout(() => {
                    content.style.maxHeight = '0px';
                }, 10);
                icon.textContent = '‚ñº';
                text.textContent = 'Mostrar Calendario';
            }
        }

        function closeCalendarModal() {
            document.getElementById('calendarEventsModal').classList.add('hidden');
        }


        // ============= INITIALIZE APP ON LOAD =============
        window.onload = initApp;
    </script>
    
    <!-- Developer Credits -->
    <div style="position: fixed; bottom: 10px; right: 10px; background: rgba(255, 255, 255, 0.95); padding: 8px 16px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15); font-size: 0.75rem; color: #4b5563; z-index: 800; backdrop-filter: blur(10px);">
        <div style="display: flex; align-items: center; gap: 6px;">
            <i class="fas fa-code" style="color: #2563eb;"></i>
            <span>Desarrollado por <strong style="color: #1f2937;">Maximiliano Pechieu</strong></span>
        </div>
    </div>
</body>
</html>
